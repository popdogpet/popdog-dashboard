<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pop Dog | 2025 CFO Dashboard (Sheet + WhatsApp + Weekly)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 600px at 10% -10%, #ecf2ff, transparent), radial-gradient(1200px 600px at 110% 110%, #f8fafc, transparent); }
    .dark body, .dark .pagebg { background: radial-gradient(1200px 600px at 10% -10%, #0b1220, transparent), radial-gradient(1200px 600px at 110% 110%, #0f172a, transparent) !important; }
    .glass { background: rgba(255,255,255,0.65); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.4); }
    .dark .glass { background: rgba(2,6,23,0.5); border-color: rgba(255,255,255,0.08) !important; }
    .hint { color:#64748b }
    .dark .hint { color:#93a4bd }
    .badge { font-size:10px; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; color:#334155; }
    .dark .badge { background:#0b1220; color:#cbd5e1; border:1px solid rgba(255,255,255,.08); }
    .progress-wrap{height:4px;background:rgba(0,0,0,.06);border-radius:999px;overflow:hidden}
    .target-card{padding:.65rem .75rem;border-radius:1rem}
    .target-card .ttl{font-size:.8rem}
    .target-card .val{font-weight:600; font-size:.8rem}
    .target-card .sub{font-size:.7rem; opacity:.75}
    .progress-bar{height:100%;background:linear-gradient(90deg,#6366f1,#22d3ee)}
    .kpi-up{color:#10b981}.kpi-down{color:#ef4444}
    .dot{width:.5rem;height:.5rem;border-radius:999px;display:inline-block;margin-right:.4rem}
    .card-3d{ box-shadow: 0 10px 30px rgba(2,6,23,.15), inset 0 1px 0 rgba(255,255,255,.3); transform: translateZ(0); }
    canvas{image-rendering: auto}
    /* === iOS-like glass chips (frosted) === */
    .chip-ios{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.3rem .6rem; border-radius:999px;
      background: rgba(255,255,255,0.35);
      border:1px solid rgba(255,255,255,0.55);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.45),
        0 8px 20px rgba(15,23,42,0.08);
    }
    .dark .chip-ios{
      background: rgba(2,6,23,0.45);
      border-color: rgba(255,255,255,0.10);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.06),
        0 10px 26px rgba(0,0,0,0.35);
    }
    .chip-ios .dot{
      width:.45rem; height:.45rem; border-radius:999px;
      background: currentColor;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.5) inset;
    }
    .chip-ios .label{ font-size:.75rem; color:#0f172a; }
    .dark .chip-ios .label{ color:#e2e8f0; }
.chip-ios .val{ font-weight:600; font-size:.75rem; color:#334155; }
.dark .chip-ios .val{ color:#cbd5e1; }
th, td { white-space: nowrap; }
/* === Frosted (iOS-like) for main charts === */
#lineTotal,
#barStack,
#pieShare{
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  padding: 8px;
}
/* === Compact tables (stock + sales/turnover) â€” ultra compact === */
.sales-turnover table th,
.sales-turnover table td,
#stockBlock table th,
#stockBlock table td{
  font-size: 7px;            /* ~6px'e yakÄ±n, her ekranda Ã§ok kompakt */
  padding: .15rem .25rem;    /* dar hÃ¼cre iÃ§i boÅŸluk */
}
@media (min-width: 1280px){
  .sales-turnover table th,
  .sales-turnover table td,
  #stockBlock table th,
  #stockBlock table td{ font-size: 10px; }
}

    /* === En BÃ¼yÃ¼k Kanal â€” sade liste + kÃ¼Ã§Ã¼k yÃ¼zde tablosu === */
#kpiOthers{ margin-top:.25rem; max-height:none; overflow:visible; }
#kpiOthers li{ font-size: 12px; line-height:1.2; }
#kpiShareTbl{ width:100%; margin-top:.35rem; border-collapse:collapse; }
#kpiShareTbl td{ font-size:11px; padding:.15rem .25rem; }
#kpiShareTbl td:first-child{ opacity:.85; }
  </style>
</head>
<body class="min-h-screen pagebg">
  <div class="max-w-7xl mx-auto p-6 space-y-6">

    <!-- Header -->
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">
          Pop Dog | 2025 CFO Dashboard
        </h1>
        <p class="hint">Google Sheet + CSV + WhatsApp yapÄ±ÅŸtÄ±r Â· HaftalÄ±k mini kartlar Â· Hedefler (YTD ortalama)</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="themeBtn" class="glass card-3d px-3 py-2 rounded-2xl text-slate-700 dark:text-slate-200">ðŸŒ— Tema</button>
        <input id="fileInput" type="file" accept=".csv" class="hidden">
        <button id="uploadBtn" class="glass card-3d px-4 py-2 rounded-2xl">CSV YÃ¼kle</button>
        <button id="downloadBtn" class="glass card-3d px-4 py-2 rounded-2xl">CSV Ä°ndir</button>
        <button id="writeSheetBtn" class="glass card-3d px-4 py-2 rounded-2xl">Sheetâ€™e Kaydet</button>
      </div>
    </header>



    <!-- KPIs + Alerts -->
    <div class="grid md:grid-cols-2 gap-4 items-start">
      <div class="grid gap-4">
        <div class="glass card-3d rounded-3xl p-5">
          <div class="hint text-sm">Toplam Ciro (YTD)</div>
          <div id="kpiYTD" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
          <div id="kpiYTD_USD" class="text-sm hint">â‰ˆ â€“ USD</div>
          <div id="kpiYTD_YoY" class="text-xs hint mt-1"></div>
          <div id="fxNote" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass card-3d rounded-3xl p-5">
          <div class="hint text-sm">En BÃ¼yÃ¼k Kanal</div>
          <div id="kpiTop" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
          <ul id="kpiOthers" class="text-sm hint mt-2 space-y-1"></ul>
          <table id="kpiShareTbl"></table>
        </div>
      </div>
      <div class="glass card-3d rounded-3xl p-5 space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4">
            <div class="hint text-sm">Stok DeÄŸeri (Maliyet)</div>
            <div id="kpiInvCost" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvCost_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
            <div class="hint text-xs mt-2">Vergi + Navlun dahil (+%65)</div>
            <div id="kpiInvCost_65" class="text-sm font-medium text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvCost_65_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="hint text-sm">Stok DeÄŸeri (SatÄ±ÅŸ)</div>
            <div id="kpiInvPrice" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvPrice_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
            <div class="hint text-xs mt-2">KDV HariÃ§ (âˆ’%20)</div>
            <div id="kpiInvPrice_exVAT" class="text-sm font-medium text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvPrice_exVAT_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">MoM DeÄŸiÅŸim <span id="momNote" class="text-xs"></span></div>
          <div id="kpiMoM" class="text-xl md:text-2xl font-semibold">â€“</div>
        </div>

        <div>
          <div class="hint text-sm mb-1">UyarÄ±lar</div>
          <ul id="alertsList" class="text-sm text-slate-700 dark:text-slate-200 space-y-1">
            <li class="hint">HenÃ¼z veri yok.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- HaftalÄ±k Mini Kartlar -->
    <section class="glass card-3d rounded-3xl p-5">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium flex items-center gap-3">
          HaftalÄ±k GÃ¶rÃ¼nÃ¼m
          <span id="weekLabel" class="badge"></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="weekPrev" class="glass card-3d px-3 py-1 rounded-xl">â—€ï¸Ž</button>
          <button id="weekNext" class="glass card-3d px-3 py-1 rounded-xl">â–¶ï¸Ž</button>
        </div>
      </div>
      <div id="weekCards" class="grid sm:grid-cols-3 lg:grid-cols-6 gap-3 mt-3"></div>
      <div id="weekWoW" class="hint text-xs mt-2"></div>
      <div class="mt-4">
        <div class="text-slate-700 dark:text-slate-200 text-sm font-medium">Son 7 GÃ¼n Ã–zeti</div>
        <div id="last7Wrap" class="grid sm:grid-cols-3 lg:grid-cols-6 gap-3 mt-2"></div>
        <div id="last7Note" class="hint text-xs mt-1"></div>
      </div>
    </section>

    <!-- Charts -->
    <div class="grid lg:grid-cols-3 gap-6">
      <div class="glass card-3d rounded-3xl p-5 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <div class="text-slate-700 dark:text-slate-200">AylÄ±k Toplam Ciro</div>
          <button id="yoyToggle" class="chip-ios text-xs" title="GeÃ§en yÄ±l serisini aÃ§/kapat">
            <span class="label">YoY</span>
            <span id="yoyState" class="val">AÃ§Ä±k</span>
          </button>
        </div>
        <canvas id="lineTotal" height="160"></canvas>
      </div>
      <div class="glass card-3d rounded-3xl p-5">
        <div class="text-slate-700 dark:text-slate-200 mb-2">Kanal PaylarÄ± (YTD)</div>
        <canvas id="pieShare" style="height: 160px; width: 100%;"></canvas>
      </div>
    </div>

    <div class="glass card-3d rounded-3xl p-5">
      <div class="text-slate-700 dark:text-slate-200 mb-2">Kanal BazlÄ± AylÄ±k Ciro</div>
      <canvas id="barStack" height="160"></canvas>
    </div>

    <!-- === Expenses (CFO) === -->
    <section class="glass card-3d rounded-3xl p-5 mt-6">
      <div class="flex items-center justify-between mb-3">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">Giderler (YTD) & Net KÃ¢r</div>
        <div class="flex items-center gap-3">
          <span class="chip-ios text-xs" title="Giderler YoY geÃ§iÅŸi" id="expYoyToggle">
            <span class="label">YoY</span>
            <span id="expYoyState" class="val">AÃ§Ä±k</span>
          </span>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4 items-stretch">
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Toplam Gider (YTD)</div>
          <div id="kpiExpYTD" class="text-xl md:text-2xl font-semibold">â€“</div>
          <div id="kpiExpYTD_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          <div id="kpiExpYoY" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Net KÃ¢r (YTD)</div>
          <div id="kpiNetYTD" class="text-xl md:text-2xl font-semibold">â€“</div>
          <div id="kpiNetYTD_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          <div id="kpiNetNote" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Gider MoM</div>
          <div id="kpiExpMoM" class="text-xl md:text-2xl font-semibold">â€“</div>
          <div id="kpiExpMoMNote" class="text-xs hint mt-1"></div>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6 mt-4">
        <div class="glass card-3d rounded-2xl p-4 lg:col-span-2">
          <div class="flex items-center justify-between mb-2">
            <div class="text-slate-700 dark:text-slate-200">AylÄ±k Giderler</div>
          </div>
          <canvas id="lineExpenses" height="220"></canvas>
          <style>
            #lineExpenses {
              background: rgba(255,255,255,0.25);
              backdrop-filter: blur(12px) saturate(180%);
              -webkit-backdrop-filter: blur(12px) saturate(180%);
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(0,0,0,0.2);
              padding: 8px;
            }
          </style>
        </div>
        <div class="glass card-3d rounded-2xl p-4">
          <div class="text-slate-700 dark:text-slate-200 mb-2">Gider DaÄŸÄ±lÄ±mÄ± (YTD)</div>
          <canvas id="pieExpenses" style="height: 320px; width: 100%;"></canvas>
        </div>
      </div>
      <div class="glass card-3d rounded-2xl p-4 mt-4">
        <div class="text-slate-700 dark:text-slate-200 mb-2">Ana Kategoriler (YTD)</div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left py-1 pr-3">Kategori</th>
                <th class="text-right py-1 pr-3">Tutar (â‚º)</th>
                <th class="text-right py-1 pr-3">USD</th>
                <th class="text-right py-1 pr-0">Pay</th>
              </tr>
            </thead>
            <tbody id="tblMainExpenses" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SatÄ±ÅŸ / Devir Listeleri -->
    <div class="mt-6 sales-turnover">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-base font-medium">SatÄ±ÅŸ &amp; Devir Listeleri</div>
        <div class="flex items-center gap-3">
          <label for="salesWindowSelect" class="hint text-xs">Pencere:</label>
          <select id="salesWindowSelect" class="glass rounded-xl px-2 py-1 text-sm">
            <option value="30">30 gÃ¼n</option>
            <option value="90">90 gÃ¼n</option>
            <option value="120">120 gÃ¼n</option>
            <option value="180">180 gÃ¼n</option>
          </select>
          <div id="stockExtraNote" class="hint text-xs"></div>
        </div>
      </div>
      <div class="mt-3 grid md:grid-cols-2 gap-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">En Ã§ok satan 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">SatÄ±lan (adet)</th></tr>
            </thead>
            <tbody id="tblTopSellers" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">En az satan 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">SatÄ±lan (adet)</th></tr>
            </thead>
            <tbody id="tblLeastSellers" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">StoÄŸu en hÄ±zlÄ± giden 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">Adet/gÃ¼n</th><th class="text-right py-1 pr-3">On-hand</th></tr>
            </thead>
            <tbody id="tblFastestMoving" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">Stokta en uzun sÃ¼redir kalan 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">YaÅŸ (gÃ¼n)</th><th class="text-right py-1 pr-3">On-hand</th></tr>
            </thead>
            <tbody id="tblMostStale" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- === Stock Block: KPI + Tablolar === -->
    <section id="stockBlock" class="glass card-3d rounded-3xl p-5">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">Stok Ã–zeti</div>
        <div class="hint text-xs">Kaynak: inventory_value + orders_raw</div>
      </div>

      <!-- Ek KPI'lar -->
      <div class="grid md:grid-cols-4 gap-4 mt-3">
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">90+ gÃ¼n elde <span class="ml-1 opacity-70 text-[10px]">(son satÄ±ÅŸ â‰¥90g olan stok toplamÄ±)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiAged90Value">â€“</div>
          <div class="hint text-xs" id="kpiAged90Qty">â€“ adet</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Median stok yaÅŸÄ± <span class="ml-1 opacity-70 text-[10px]">(SKU'larÄ±n son satÄ±ÅŸtan bugÃ¼ne medyan gÃ¼n)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiMedianAge">â€“ gÃ¼n</div>
        </div>
        <div class="glass rounded-2xl p-3" title="DIO(30/60/90) Ã¼Ã§lÃ¼: kart Ã¼stÃ¼ 60g, tooltip 30/90">
          <div class="hint text-xs">DIO (60g) <span class="ml-1 opacity-70 text-[10px]">(son 60g ort. satÄ±ÅŸ hÄ±zÄ±na gÃ¶re stokun yeteceÄŸi gÃ¼n)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiDIO60">â€“ gÃ¼n</div>
          <div class="hint text-[11px]" id="kpiDIOx">30g: â€“ â€¢ 90g: â€“</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Toplam ÃœrÃ¼n Adedi <span class="ml-1 opacity-70 text-[10px]">(depo bazÄ±nda daÄŸÄ±lÄ±m)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiTotalUnits">â€“ adet</div>
          <div class="hint text-xs" id="kpiTotalUnitsNote">Thrones: â€“ â€¢ Caddebostan: â€“</div>
        </div>
      </div>

      <!-- Tablolar -->
      <div class="mt-4 grid lg:grid-cols-2 gap-4">
        <div>
          <div class="hint text-sm mb-1">â‚º maliyet bazÄ±nda en yÃ¼ksek 10 SKU</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">Value @Cost</th>
                  <th class="text-right py-2 pr-4">Son SatÄ±ÅŸ</th>
                  <th class="text-right py-2 pr-4">YaÅŸ (gÃ¼n)</th>
                </tr>
              </thead>
              <tbody id="tblTopStock" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="hint text-sm mb-1">90+ gÃ¼n elde (â‚º bazÄ±nda ilk 10)</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">Value @Cost</th>
                  <th class="text-right py-2 pr-4">Son SatÄ±ÅŸ</th>
                  <th class="text-right py-2 pr-4">YaÅŸ (gÃ¼n)</th>
                </tr>
              </thead>
              <tbody id="tblAged90" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Stokout Risk (â‰¤14 gÃ¼n) -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">Stokout Riski (â‰¤14 gÃ¼n) â€” Pencere: <span id="riskWindowLbl" class="badge"></span></div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left  py-2 pr-4">SKU</th>
                <th class="text-left  py-2 pr-4">Title</th>
                <th class="text-right py-2 pr-4">On-hand</th>
                <th class="text-right py-2 pr-4">GÃ¼nlÃ¼k hÄ±z</th>
                <th class="text-right py-2 pr-4">Kalan gÃ¼n</th>
              </tr>
            </thead>
            <tbody id="tblStockoutRisk" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>

      <!-- Largest Stock (Top 25) -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">StoÄŸu En Fazla Olan (Top 25)</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left  py-2 pr-4">SKU</th>
                <th class="text-left  py-2 pr-4">Title</th>
                <th class="text-right py-2 pr-4">On-hand</th>
              </tr>
            </thead>
            <tbody id="tblLargestStock" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GÃ¼nlÃ¼k Rapor YapÄ±ÅŸtÄ±r -->
    <section class="glass card-3d rounded-3xl p-5">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">GÃ¼nlÃ¼k Rapor YapÄ±ÅŸtÄ±r â†’ SatÄ±r Ekle</div>
        <div class="hint text-sm">Format: Tarih, Kredi KartÄ±, QNB/Ä°ÅŸ/Garanti, Nakit, Toplam, Kasa Nakit, Pop Dog Online, Pop Dog Toptan, Trendyol, Hepsiburada</div>
      </div>
      <textarea id="dailyText" class="w-full mt-3 rounded-2xl border p-3 focus:outline-none bg-white/70 dark:bg-slate-800 dark:text-slate-100" rows="6" placeholder="WhatsApp raporunu yapÄ±ÅŸtÄ±r..."></textarea>
      <div class="mt-3 flex items-center gap-3">
        <button id="parseAddBtn" class="glass card-3d px-4 py-2 rounded-2xl">SatÄ±ra Ã§evir ve ekle</button>
        <button id="pushRowsBtn" class="glass card-3d px-4 py-2 rounded-2xl">Sheetâ€™e Yaz</button>
        <span id="parseInfo" class="hint text-sm"></span>
      </div>

      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-600 dark:text-slate-300">
            <tr>
              <th class="text-left py-2 pr-4">Date</th>
              <th class="text-right py-2 pr-4">Toptan</th>
              <th class="text-right py-2 pr-4">Online</th>
              <th class="text-right py-2 pr-4">CKM</th>
              <th class="text-right py-2 pr-4">CKM Nakit</th>
              <th class="text-right py-2 pr-4">Kasa Nakit (EoD)</th>
              <th class="text-right py-2 pr-4">Trendyol</th>
              <th class="text-right py-2 pr-4">Hepsiburada</th>
              <th class="text-right py-2 pr-4">Total</th>
            </tr>
          </thead>
          <tbody id="stagedTbody" class="text-slate-800 dark:text-slate-100"></tbody>
        </table>
      </div>
    </section>

    <!-- Targets -->
    <section class="glass card-3d rounded-3xl p-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-base font-medium">AylÄ±k Hedefler (YTD ortalama)</div>
        <div class="hint text-xs">Her ay: aynÄ± yÄ±l o aya kadar ortalama</div>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 mt-3" id="targetsWrap"></div>
    </section>

    <footer class="text-xs hint text-right">
      Pop Dog CFO Dashboard Â· Sheet/CSV/WhatsApp baÄŸlÄ± Â· HaftalÄ±k kartlar Â· Hedef & UyarÄ±
      <br>
      <span style="color:#22c55e;">âœ… Test deplooooy - 18.09.2025</span>
    </footer>
  </div>

<script>
/* ================== CONFIG ================== */
/* Apps Script Web App URLâ€™in (write-to-sheet iÃ§in) */
let SHEET_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxI11v-3QKXxod7fK6ErFnegN-XBT277j0DDF8xBCO4tAfoUhQUD24UYOJBe1iC4OGS/exec';
// === Hardcoded default CSV URLs (fallbacks if nothing set) ===
const DEFAULT_SHEET_CSV  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=1778107676&single=true&output=csv';
const DEFAULT_INV_CSV    = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=1049936864&single=true&output=csv';
const DEFAULT_ORDERS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=72488526&single=true&output=csv';
const DEFAULT_EXPENSES_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=798821160&single=true&output=csv';

/* ================== THEME ================== */
const root = document.documentElement;
function setTheme(mode){ if(mode==='dark'){ root.classList.add('dark'); } else { root.classList.remove('dark'); } localStorage.setItem('popdog_theme', mode); }
document.getElementById('themeBtn').onclick = ()=> setTheme(root.classList.contains('dark')?'light':'dark');
(function(){ setTheme(localStorage.getItem('popdog_theme')||'light'); })();

/* ================== HELPERS ================== */
const nfTL  = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 });
const nfUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
const numberTL  = n => nfTL.format(Math.round(n||0));
const numberUSD = n => nfUSD.format(Math.round(n||0));

function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function yyyymmddUTC(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

/* TRY sayÄ±larÄ± iÃ§in saÄŸlam parser */
function parseTL(v){
  if(v==null || v==='') return 0;
  if(typeof v === 'number') return v;
  let s = String(v).trim().replace(/\s|â‚º|TRY|TL/gi,'').replace(/\u00A0/g,'');
  if(s === '-' || s === 'â€“' || s === 'â€”') return 0;
  if(/^-?\d+$/.test(s)) return Number(s);
  if(s.includes('.') && s.includes(',')){
    const lastDot = s.lastIndexOf('.'), lastComma = s.lastIndexOf(',');
    if(lastComma > lastDot){ s = s.replace(/\./g,'').replace(',', '.'); } else { s = s.replace(/,/g,''); }
    const n = Number(s); return isNaN(n)?0:n;
  }
  if(s.includes(',') && !s.includes('.')){
    s = s.replace(/\./g,''); s = s.replace(',', '.');
    const n = Number(s); return isNaN(n)?0:n;
  }
  const n = Number(s.replace(/,/g,'')); return isNaN(n)?0:n;
}

function parseTRDateString(s){
  const m = s.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
  if(!m) return '';
  let dd=+m[1], mm=+m[2], yy=+m[3]; if(yy<100) yy += 2000;
  return yyyymmddUTC(yy, mm, dd);
}

function toMonday(d){
  const dt = new Date(d); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt;
}
function addDays(d, n){ const dt = new Date(d); dt.setDate(dt.getDate()+n); return dt; }
function weekRangeLabel(monday){
  const sun = addDays(monday, 6);
  const f = (x)=> `${x.getDate().toString().padStart(2,'0')}.${(x.getMonth()+1).toString().padStart(2,'0')}`;
  return `${f(monday)} â€“ ${f(sun)}`;
}

/* Cache-bust */
function withCacheBust(url){
  if(!url) return '';
  const sep = url.includes('?') ? '&' : '?';
  return `${url}${sep}t=${Date.now()}`;
}

/* ================== QUERY PARAM HELPERS ================== */
function getParam(name){
  try { return new URLSearchParams(location.search).get(name) || ''; } catch(e){ return ''; }
}

/* Clean-on-load flag: URL ?clean=1/0 overrides; falls back to localStorage; default = true */
function isCleanOnLoad(){
  try{
    const p = getParam('clean');
    if (p === '1') return true;
    if (p === '0') return false;
    const s = localStorage.getItem('popdog_clean_on_load');
    if (s === '1') return true;
    if (s === '0') return false;
  }catch(e){}
  return true; // default: clean enabled
}

/* ================== STATE ================== */
let loadedRows = [];     // revenue rows (sheet csv)
let stagedRows = [];     // whatsapp pasted rows
let fxRateUSDPerTRY = null;
let fxDate = null;
let mergedRowsCache = [];

/* ================== CSV LOADERS ================== */
async function loadFromSheet(url){
  const resp = await fetch(withCacheBust(url), { cache: 'no-store' });
  if(!resp.ok) throw new Error(`CSV fetch failed: ${resp.status}`);
  const csvText = await resp.text();
  return new Promise((resolve,reject)=>{
    Papa.parse(csvText, {
      header:true, skipEmptyLines:true,
      complete: (res)=>{
        try{
          const data = (res.data||[]).map(r=>{
            const iso = r.Date ? String(r.Date).trim().slice(0,10) : '';
            const row = {
              Date: iso,
              Toptan: parseTL(r.Toptan),
              Online: parseTL(r.Online),
              CKM: parseTL(r.CKM),
              "CKM Nakit": parseTL(r["CKM Nakit"]),
              Trendyol: parseTL(r.Trendyol),
              Hepsiburada: parseTL(r.Hepsiburada),
            };
            row.Total = row.Toptan + row.Online + row.CKM + row.Trendyol + row.Hepsiburada;
            return row;
          }).filter(r=>r.Date);
          // Optional cleaning while loading from Sheet:
          // - dedupe same-day rows (keeps the row with higher Total or more non-zero fields)
          // - sort by Date ascending
          const cleaned = isCleanOnLoad() ? dedupeDailyRows(data) : data;
          resolve(cleaned);
        }catch(e){ reject(e); }
      },
      error: reject
    });
  });
}

function loadCSV(url){
  return new Promise((resolve,reject)=>{
    if(!url) return resolve([]);
    Papa.parse(withCacheBust(url), {
      download:true, header:true, skipEmptyLines:true,
      complete: (res)=> resolve(res.data||[]),
      error: reject
    });
  });
}

/* ================== INVENTORY & ORDERS HELPERS ================== */
const SALES_WINDOW_OPTIONS = [30,90,120,180];
let salesWindowDays = Number(localStorage.getItem('popdog_sales_window_days') || '90');
if (!SALES_WINDOW_OPTIONS.includes(salesWindowDays)) salesWindowDays = 90;
function initSalesWindowSelector(){
  const sel = document.getElementById('salesWindowSelect');
  if(!sel) return;
  // Set current value
  sel.value = String(salesWindowDays);
  sel.onchange = () => {
    const v = Number(sel.value);
    if(!SALES_WINDOW_OPTIONS.includes(v)) return;
    salesWindowDays = v;
    localStorage.setItem('popdog_sales_window_days', String(v));
    renderStockBlock();
  };
}
/* inventory_value toplam Ã¶zet */
function summarizeInventoryValue(rows){
  // baÅŸlÄ±k varyasyonlarÄ±nÄ± tolere et
  let valCost = 0, valPrice = 0;
  for(const r of rows || []){
    const costRaw  = r['Value@Cost']  ?? r['Value @Cost']  ?? r['CostValue']   ?? r['Value_Cost']  ?? 0;
    const priceRaw = r['Value@Price'] ?? r['Value @Price'] ?? r['SalesValue']  ?? r['Value_Price'] ?? 0;
    valCost  += parseTL(costRaw);
    valPrice += parseTL(priceRaw);
  }
  return { valCost, valPrice };
}

// Shopify "Created at" tarihlerini saÄŸlam parse et
function parseShopifyDate(s){
  if(!s) return null;
  let t = String(s).trim();

  // "2025-09-07 12:34:56 +0300" â†’ "+03:00" biÃ§imine Ã§evir
  if(/\s\+\d{4}$/.test(t)){
    t = t.replace(/\s\+(\d{2})(\d{2})$/, (m,h,mn)=> `+${h}:${mn}`);
  }
  // "... UTC" â†’ Z
  if(/\sUTC$/i.test(t)){ t = t.replace(/\sUTC$/i,'Z'); }

  // "YYYY-MM-DD HH:mm:ss" â†’ "YYYY-MM-DDTHH:mm:ss"
  if(/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}/.test(t)){
    t = t.replace(' ', 'T');
  }

  // dd/mm/yyyy veya dd.mm.yyyy gibi olursa
  const m = t.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
  if(m){
    let dd=+m[1], mm=+m[2], yy=+m[3]; if(yy<100) yy+=2000;
    t = `${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}T00:00:00Z`;
  }

  const d = new Date(t);
  return isNaN(+d) ? null : d;
}

// localStorageâ†’orders okurken tarihleri Date'e yeniden Ã§evir
function getOrdersCache(){
  const raw = JSON.parse(localStorage.getItem('popdog_orders_cache') || '[]');
  return raw.map(o => ({
    sku: (o.sku||'').trim(),
    qty: Number(o.qty)||0,
    price: parseTL(o.price||0),
    date: o.date ? new Date(o.date) : null  // <- rehydrate
  })).filter(o => o.sku && o.qty>0 && o.date && !isNaN(+o.date));
}

/* stok listesi iÃ§inden (â‚º satÄ±ÅŸ deÄŸeri bazlÄ±) top N */
function topStockSKUs(rows, n=10){
  const arr = (rows||[]).map(r=>({
    sku: String(r['SKU']||'').trim(),
    title: r['Title'] || '',
    units: parseTL(r['TotalUnits'] || r['On hand total'] || 0),
    unitCost: parseTL(r['UnitCost'] || 0),
    unitPrice: parseTL(r['UnitPrice'] || 0),
    valueCost: parseTL(r['Value@Cost'] || r['Value @Cost'] || 0),
    valuePrice: parseTL(r['Value@Price']|| r['Value @Price']|| 0),
  }));
  return arr.filter(x=>x.sku && x.units>0)
            .sort((a,b)=> b.valuePrice - a.valuePrice)
            .slice(0,n);
}

/* Shopify orders + orders_clean (buildAll) uyumlu mapper */
function mapOrderRow(r){
  // SKU aliasâ€™larÄ±: Shopify (Lineitem sku / SKU / Variant SKU) + orders_clean (sku)
  const sku = (r['Lineitem sku'] || r['SKU'] || r['Variant SKU'] || r['sku'] || '').toString().trim();

  // Qty aliasâ€™larÄ±: Shopify (Lineitem quantity / Quantity / Qty) + orders_clean (qty)
  const qty = parseInt(r['Lineitem quantity'] || r['Quantity'] || r['Qty'] || r['qty'] || 0, 10) || 0;

  // Price (opsiyonel) â€“ gerekirse; orders_cleanâ€™de 'price'
  const price = parseTL(r['Lineitem price'] || r['Price'] || r['price'] || 0);

  // Tarih: Shopify (Created at / â€¦) + orders_clean (date)
  const rawDate = r['Created at'] || r['Created At'] || r['Created at (UTC)'] || r['Processed at'] || r['Paid at'] || r['Fulfilled at'] || r['date'] || '';
  const date = parseShopifyDate(rawDate);

  return { sku, qty, price, date };
}

/* stok yaÅŸlandÄ±rma (son satÄ±ÅŸa gÃ¶re gÃ¼n farkÄ±) */
function stockAging(inventoryRows, orderRows){
  const today = new Date();
  const lastSaleMap = {};
  (orderRows||[]).forEach(o=>{
    if(!o || !o.sku || !o.date) return;
    if(!lastSaleMap[o.sku] || o.date > lastSaleMap[o.sku]) lastSaleMap[o.sku] = o.date;
  });

  const buckets = { '0-30':0, '31-60':0, '61-90':0, '90+':0 };
  const bucketsVal = { '0-30':0, '31-60':0, '61-90':0, '90+':0 };
  const ages = [];

  (inventoryRows||[]).forEach(r=>{
    const sku = String(r['SKU']||'').trim();
    const units = parseTL(r['TotalUnits']||0);
    const valCost = parseTL(r['Value@Cost']||r['Value @Cost']||0);
    if(!sku || units<=0) return;
    const last = lastSaleMap[sku];
    const diff = last ? Math.floor((today-last)/(1000*60*60*24)) : 9999; // hiÃ§ satmamÄ±ÅŸsa 9999
    ages.push(diff);

    let bucket = '90+';
    if(diff<=30) bucket='0-30';
    else if(diff<=60) bucket='31-60';
    else if(diff<=90) bucket='61-90';
    buckets[bucket]+=units;
    bucketsVal[bucket]+=valCost;
  });

  const sorted = ages.sort((a,b)=>a-b);
  const medianAge = sorted.length ? sorted[Math.floor(sorted.length/2)] : 0;
  return { buckets, bucketsVal, medianAge };
}

/* DIO: Days of Inventory = On-hand / (gÃ¼nlÃ¼k satÄ±ÅŸ ort.) */
function daysOfInventory(inventoryRows, orderRows, days=60){
  const today = new Date();
  const cutoff = new Date(today.getTime() - days*24*60*60*1000);
  let totalUnitsSold=0;
  (orderRows||[]).forEach(o=>{
    if(!o.date || isNaN(+o.date) || o.date<cutoff) return;
    totalUnitsSold += (o.qty||0);
  });
  const dailyAvg = totalUnitsSold / (days||1);
  const totalOnHand = (inventoryRows||[]).reduce((a,r)=> a + parseTL(r['TotalUnits']||0), 0);
  return dailyAvg>0 ? (totalOnHand/dailyAvg) : null;
}

/* Stok tablolarÄ±nÄ± ve KPIâ€™larÄ± render et */
function renderStockBlock(){
  // cacheâ€™lerden oku
  const invRows   = JSON.parse(localStorage.getItem('popdog_inv_cache')   || '[]');
  const ordersMap = getOrdersCache();

  // 1) Stok deÄŸeri KPIâ€™larÄ±
  const inv = summarizeInventoryValue(invRows);
  document.getElementById('kpiInvCost').textContent  = numberTL(inv.valCost);
  document.getElementById('kpiInvPrice').textContent = numberTL(inv.valPrice);

  // USD equivalents (using latest fetched fxRateUSDPerTRY)
  try {
    const costUsdEl  = document.getElementById('kpiInvCost_USD');
    const priceUsdEl = document.getElementById('kpiInvPrice_USD');
    if (costUsdEl) {
      if (fxRateUSDPerTRY) {
        costUsdEl.textContent  = `â‰ˆ ${numberUSD(inv.valCost * fxRateUSDPerTRY)} USD`;
      } else {
        costUsdEl.textContent  = 'â‰ˆ â€“ USD';
      }
    }
    if (priceUsdEl) {
      if (fxRateUSDPerTRY) {
        priceUsdEl.textContent = `â‰ˆ ${numberUSD(inv.valPrice * fxRateUSDPerTRY)} USD`;
      } else {
        priceUsdEl.textContent = 'â‰ˆ â€“ USD';
      }
    }
  } catch (e) {
    // silent
  }

  // 1.c) TÃ¼retilmiÅŸ tutarlar: Maliyet +%65 (Vergi+Navlun) ve SatÄ±ÅŸ KDV HariÃ§ (âˆ’%20)
  try {
    const costPlus = inv.valCost * 1.65;           // +%65 eklendi
    const priceEx  = inv.valPrice / 1.20;          // %20 KDV Ã§Ä±kartÄ±ldÄ±

    const c65El      = document.getElementById('kpiInvCost_65');
    const c65UsdEl   = document.getElementById('kpiInvCost_65_USD');
    const exVatEl    = document.getElementById('kpiInvPrice_exVAT');
    const exVatUsdEl = document.getElementById('kpiInvPrice_exVAT_USD');

    if (c65El)    c65El.textContent    = numberTL(costPlus);
    if (exVatEl)  exVatEl.textContent  = numberTL(priceEx);

    if (c65UsdEl) {
      c65UsdEl.textContent = fxRateUSDPerTRY ? `â‰ˆ ${numberUSD(costPlus * fxRateUSDPerTRY)} USD` : 'â‰ˆ â€“ USD';
    }
    if (exVatUsdEl) {
      exVatUsdEl.textContent = fxRateUSDPerTRY ? `â‰ˆ ${numberUSD(priceEx * fxRateUSDPerTRY)} USD` : 'â‰ˆ â€“ USD';
    }
  } catch (e) { /* silent */ }

  // 1.b) Toplam ÃœrÃ¼n Adedi + depo bazÄ±nda daÄŸÄ±lÄ±m (Thrones / Caddebostan)
  try {
    // toplam on-hand (SKU bazÄ±nda TotalUnits)
    const totalUnitsAll = (invRows || []).reduce((acc, r) => acc + parseTL(r['TotalUnits'] || 0), 0);

    // location sÃ¼tunlarÄ±nÄ± tahmin et: Title ile TotalUnits arasÄ±ndaki baÅŸlÄ±klar
    let thronesUnits = 0, caddeUnits = 0;
    if (Array.isArray(invRows) && invRows.length) {
      const hdrs = Object.keys(invRows[0] || {});
      const iTitle = hdrs.indexOf('Title');
      const iTotal = hdrs.indexOf('TotalUnits');
      const locCols = (iTitle >= 0 && iTotal > iTitle) ? hdrs.slice(iTitle + 1, iTotal) : [];

      invRows.forEach(row => {
        locCols.forEach(col => {
          const v = parseTL(row[col] || 0);
          const key = (col || '').toLowerCase();
          if (key.includes('thrones')) thronesUnits += v;
          if (key.includes('caddebostan') || key.includes('ckm') || key.includes('cadde')) caddeUnits += v;
        });
      });
    }

    const totalEl = document.getElementById('kpiTotalUnits');
    const noteEl  = document.getElementById('kpiTotalUnitsNote');
    if (totalEl) totalEl.textContent = `${totalUnitsAll} adet`;
    if (noteEl)  noteEl.textContent  = `Thrones: ${thronesUnits} â€¢ Caddebostan: ${caddeUnits}`;
  } catch (e) {
    console.warn('Total units KPI calc error', e);
  }

  // 2) Top 10 â‚º stok tablosu
  const top10 = topStockSKUs(invRows, 10);
  const topTbody = document.getElementById('tblTopStock');
  topTbody.innerHTML = '';
  top10.forEach(row=>{
    // son satÄ±ÅŸ tarihi & yaÅŸ (gÃ¼n)
    const lastDate = lastSaleDateForSKU(row.sku, ordersMap);
    const age = lastDate ? Math.floor((Date.now() - lastDate.getTime())/(1000*60*60*24)) : 'â€”';
    const lastStr = lastDate ? lastDate.toISOString().slice(0,10) : 'â€”';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4">${row.sku}</td>
      <td class="py-2 pr-4">${row.title||''}</td>
      <td class="py-2 pr-4 text-right">${row.units}</td>
      <td class="py-2 pr-4 text-right">${numberTL(row.valueCost)}</td>
      <td class="py-2 pr-4 text-right">${lastStr}</td>
      <td class="py-2 pr-4 text-right">${age}</td>
    `;
    topTbody.appendChild(tr);
  });

  // 3) 90+ gÃ¼n elde olanlar (â‚º maliyet bazÄ±nda en bÃ¼yÃ¼k 10)
  const agedList = (invRows||[]).map(r=>{
    const sku = String(r['SKU']||'').trim();
    const units = parseTL(r['TotalUnits']||0);
    const valCost = parseTL(r['Value@Cost']||r['Value @Cost']||0);
    const last = lastSaleDateForSKU(sku, ordersMap);
    const age = last ? Math.floor((Date.now()-last.getTime())/(1000*60*60*24)) : 9999;
    return { sku, title:r['Title']||'', units, valCost, last, age };
  }).filter(x=>x.units>0 && x.age>=90)
    .sort((a,b)=> b.valCost - a.valCost)
    .slice(0,10);

  const agedTbody = document.getElementById('tblAged90');
  agedTbody.innerHTML='';
  agedList.forEach(x=>{
    const lastStr = x.last ? x.last.toISOString().slice(0,10) : 'â€”';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4">${x.sku}</td>
      <td class="py-2 pr-4">${x.title}</td>
      <td class="py-2 pr-4 text-right">${x.units}</td>
      <td class="py-2 pr-4 text-right">${numberTL(x.valCost)}</td>
      <td class="py-2 pr-4 text-right">${lastStr}</td>
      <td class="py-2 pr-4 text-right">${x.age}</td>
    `;
    agedTbody.appendChild(tr);
  });

  // 4) YaÅŸlandÄ±rma KPIâ€™larÄ± (toplam)
  const aging = stockAging(invRows, ordersMap);
  const agedQty = aging.buckets['90+'] || 0;
  const agedVal = aging.bucketsVal['90+'] || 0;
  document.getElementById('kpiAged90Qty').textContent   = `${agedQty} adet`;
  document.getElementById('kpiAged90Value').textContent = numberTL(agedVal);
  document.getElementById('kpiMedianAge').textContent   = `${aging.medianAge} gÃ¼n`;

  // 5) DIO KPI (60 gÃ¼n) + notlar
  const dio60 = daysOfInventory(invRows, ordersMap, 60);
  const dio30 = daysOfInventory(invRows, ordersMap, 30);
  const dio90 = daysOfInventory(invRows, ordersMap, 90);
  document.getElementById('kpiDIO60').textContent = dio60 ? `${dio60.toFixed(0)} gÃ¼n` : 'â€“ gÃ¼n';
document.getElementById('kpiDIO60').title =
  `DIO ~ On-hand / gÃ¼nlÃ¼k satÄ±ÅŸ ort.\n30g: ${dio30?dio30.toFixed(0):'â€“'} â€¢ 60g: ${dio60?dio60.toFixed(0):'â€“'} â€¢ 90g: ${dio90?dio90.toFixed(0):'â€“'}`;
  // also update the inline (30g / 90g) helper label
(function(){
  const diox = document.getElementById('kpiDIOx');
  if (diox) {
    diox.textContent = `30g: ${dio30?dio30.toFixed(0):'â€“'} â€¢ 90g: ${dio90?dio90.toFixed(0):'â€“'}`;
  }
})();

  // kÃ¼Ã§Ã¼k aÃ§Ä±klama (title attribute)
  document.getElementById('kpiDIO60').title =
    `DIO ~ On-hand / gÃ¼nlÃ¼k satÄ±ÅŸ ort.\n30g: ${dio30?dio30.toFixed(0):'â€“'} â€¢ 60g: ${dio60?dio60.toFixed(0):'â€“'} â€¢ 90g: ${dio90?dio90.toFixed(0):'â€“'}`;

  // 6) SatÄ±ÅŸ & Devir listeleri (son SALES_WINDOW_DAYS gÃ¼n)
  try {
    const cutoff = new Date(Date.now() - salesWindowDays*24*60*60*1000);
    const soldMap = new Map();   // sku -> sold qty (window)
    const lastMap = new Map();   // sku -> last sale date
    (ordersMap||[]).forEach(o=>{
      if(!o || !o.sku || !o.date) return;
      if(o.date >= cutoff){
        soldMap.set(o.sku, (soldMap.get(o.sku)||0) + (o.qty||0));
      }
      if(!lastMap.get(o.sku) || o.date > lastMap.get(o.sku)){
        lastMap.set(o.sku, o.date);
      }
    });

    // On-hand ve title mapâ€™leri
    const onHandMap = new Map();   // sku -> units
    const titleMap  = new Map();   // sku -> title
    (invRows||[]).forEach(r=>{
      const sku = String(r['SKU']||'').trim();
      if(!sku) return;
      const units = parseTL(r['TotalUnits']||r['On hand total']||r['On hand (current)']||0);
      onHandMap.set(sku, (onHandMap.get(sku)||0) + (units||0));
      const title = r['Title'] || '';
      if(title && !titleMap.has(sku)) titleMap.set(sku, title);
    });

    // Helper: Zee filter
    const isZee = (sku)=>{
      const t = (titleMap.get(sku) || '').toLowerCase();
      return t.includes('zee');
    };
    // Helper (already defined above for other lists) kept here for clarity:
    // const isZee = (sku)=> ((titleMap.get(sku) || '').toLowerCase().includes('zee'));

    // 6.a En Ã§ok satan 5 (satÄ±ÅŸ miktarÄ±na gÃ¶re, sadece Zee)
    const topSellers = Array.from(soldMap.entries())
      .map(([sku,qty])=>({sku, qty, title:titleMap.get(sku)||''}))
      .filter(x => isZee(x.sku))
      .sort((a,b)=> b.qty - a.qty)
      .slice(0,5);

    const topSellersTbody = document.getElementById('tblTopSellers');
    if(topSellersTbody){
      topSellersTbody.innerHTML = topSellers.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.qty}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="3">Veri yok.</td></tr>';
    }

    // 6.b En az satan 5 (pencerede satÄ±ÅŸ yapanlar arasÄ±ndan en az qty, sadece Zee ve stok>0)
    const leastSellers = Array.from(soldMap.entries())
      .map(([sku,qty])=>({sku, qty, title:titleMap.get(sku)||'', on:onHandMap.get(sku)||0}))
      .filter(x => x.on>0 && isZee(x.sku))
      .sort((a,b)=> a.qty - b.qty)
      .slice(0,5);

    const leastSellersTbody = document.getElementById('tblLeastSellers');
    if(leastSellersTbody){
      leastSellersTbody.innerHTML = leastSellers.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.qty}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="3">Veri yok.</td></tr>';
    }

    // 6.c StoÄŸu en hÄ±zlÄ± giden 5 (satÄ±ÅŸ hÄ±zÄ±: adet/gÃ¼n, sadece Zee)
    const winDays = salesWindowDays || 1;
    const speedArr = Array.from(new Set([...Array.from(soldMap.keys()), ...Array.from(onHandMap.keys())]))
      .map(sku=>{
        const sold = soldMap.get(sku)||0;
        const on   = onHandMap.get(sku)||0;
        const spd  = sold / winDays; // adet/gÃ¼n
        return { sku, title:titleMap.get(sku)||'', speed: spd, onHand:on };
      })
      .filter(x=> x.speed>0 && isZee(x.sku))
      .sort((a,b)=> b.speed - a.speed)
      .slice(0,5);

    const fastestTbody = document.getElementById('tblFastestMoving');
    if(fastestTbody){
      fastestTbody.innerHTML = speedArr.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.speed.toFixed(2)}</td><td class="py-1 pr-3 text-right">${x.onHand}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="4">Veri yok.</td></tr>';
    }

    // 6.d Stokta en uzun sÃ¼redir kalan 5 (en yaÅŸlÄ±, on-hand > 0, sadece Zee)
    const staleArr = Array.from(onHandMap.entries()).map(([sku,on])=>{
      const last = lastMap.get(sku);
      const age = last ? Math.floor((Date.now()-last.getTime())/(1000*60*60*24)) : 9999;
      return { sku, title:titleMap.get(sku)||'', age, onHand:on };
    }).filter(x=> x.onHand>0 && isZee(x.sku))
      .sort((a,b)=> b.age - a.age)
      .slice(0,5);

    const staleTbody = document.getElementById('tblMostStale');
    if(staleTbody){
      staleTbody.innerHTML = staleArr.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.age}</td><td class="py-1 pr-3 text-right">${x.onHand}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="4">Veri yok.</td></tr>';
    }

    const noteEl = document.getElementById('stockExtraNote');
    if(noteEl){
      const today = new Date(); const start = new Date(today.getTime() - salesWindowDays*24*60*60*1000);
      const fmt = d => `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      noteEl.textContent = `Pencere: ${fmt(start)} â€“ ${fmt(today)} Â· Kaynak: orders_raw`;
    }
    // 6.e Stokout Riski (â‰¤14 gÃ¼n): pencere = salesWindowDays
    try {
      const riskDays = 14;
      const days = salesWindowDays || 90;
      // sold qty per SKU in the selected window
      const soldMapWin = new Map();
      const cutoffWin = new Date(Date.now() - days*24*60*60*1000);
      (ordersMap||[]).forEach(o=>{
        if(!o || !o.sku || !o.date) return;
        if(o.date >= cutoffWin){
          soldMapWin.set(o.sku, (soldMapWin.get(o.sku)||0) + (o.qty||0));
        }
      });
      // on-hand and titles already computed above: onHandMap, titleMap
      // Only include SKUs where title includes "zee" (case-insensitive)
      const riskArr = [];
      onHandMap.forEach((on, sku)=>{
        const title = titleMap.get(sku) || '';
        if (!title.toLowerCase().includes('zee')) return;
        if (on <= 0) return;
        const sold = soldMapWin.get(sku)||0;
        const daily = sold / (days||1);
        if (daily > 0){
          const remain = on / daily;
          if (remain <= riskDays){
            riskArr.push({
              sku,
              title: title,
              onHand: on,
              daily: daily,
              remain: remain
            });
          }
        }
      });
      // Sort and slice to max 25 entries
      riskArr.sort((a,b)=> a.remain - b.remain);
      const riskArrSliced = riskArr.slice(0, 25);
      const riskTbody = document.getElementById('tblStockoutRisk');
      if (riskTbody){
        riskTbody.innerHTML = riskArrSliced.length
          ? riskArrSliced.map(x => `
              <tr>
                <td class="py-2 pr-4">${x.sku}</td>
                <td class="py-2 pr-4">${x.title}</td>
                <td class="py-2 pr-4 text-right">${x.onHand}</td>
                <td class="py-2 pr-4 text-right">${x.daily.toFixed(2)}</td>
                <td class="py-2 pr-4 text-right">${x.remain.toFixed(1)}</td>
              </tr>
            `).join('')
          : '<tr><td class="hint py-2 pr-4" colspan="5">Riskli Ã¼rÃ¼n bulunmadÄ±.</td></tr>';
      }
      const riskLbl = document.getElementById('riskWindowLbl');
      if (riskLbl) riskLbl.textContent = `${days} gÃ¼n`;
    } catch (e) {
      console.warn('Stockout risk render error', e);
    }

    // 6.f StoÄŸu En Fazla Olan (Top 25)
    try {
      const largest = (invRows || []).map(r => ({
        sku: String(r['SKU'] || '').trim(),
        title: r['Title'] || '',
        on: parseTL(r['TotalUnits'] || r['On hand total'] || r['On hand (current)'] || 0)
      }))
      .filter(x => x.sku && x.on > 0)
      .sort((a,b) => b.on - a.on)
      .slice(0, 25);

      const largestTbody = document.getElementById('tblLargestStock');
      if (largestTbody) {
        largestTbody.innerHTML = largest.length
          ? largest.map(x => `
              <tr>
                <td class="py-2 pr-4">${x.sku}</td>
                <td class="py-2 pr-4">${x.title}</td>
                <td class="py-2 pr-4 text-right">${x.on}</td>
              </tr>
            `).join('')
          : '<tr><td class="hint py-2 pr-4" colspan="3">Veri yok.</td></tr>';
      }
    } catch (e) {
      console.warn('Largest stock render error', e);
    }
  } catch(err) {
    console.warn('Sales/Turnover lists error', err);
  }
}

function lastSaleDateForSKU(sku, ordersMap){
  if(!sku || !Array.isArray(ordersMap)) return null;
  let last = null;
  for(const o of ordersMap){
    if(o.sku!==sku || !o.date) continue;
    if(!last || o.date>last) last = o.date;
  }
  return last;
}

/* ================== REVENUE AGGREGATIONS & UI ================== */
function buildMonthly(rows){
  const map = new Map();
  rows.forEach(r=>{
    if(!r.Date) return;
    const d = new Date(r.Date + "T00:00:00Z");
    if(isNaN(+d)) return;
    const key = monthKey(d);
    const tpt=+r.Toptan||0, onl=+r.Online||0, ckm=+r.CKM||0, ckmN=+r["CKM Nakit"]||0, trn=+r.Trendyol||0, hb=+r.Hepsiburada||0;
    const computedTotal = tpt + onl + ckm + trn + hb;
    const prev = map.get(key) || { month:key, year:d.getFullYear(), Toptan:0, Online:0, CKM:0, CKM_Nakit:0, Trendyol:0, Hepsiburada:0, Total:0 };
    prev.Toptan+=tpt; prev.Online+=onl; prev.CKM+=ckm; prev.CKM_Nakit+=ckmN; prev.Trendyol+=trn; prev.Hepsiburada+=hb; prev.Total+=computedTotal;
    map.set(key, prev);
  });
  return Array.from(map.values()).filter(m=>m.Total>0).sort((a,b)=>a.month.localeCompare(b.month));
}

function buildWeekly(rows){
  const map = new Map();
  rows.forEach(r=>{
    if(!r.Date) return;
    const d = new Date(r.Date + "T00:00:00Z");
    if(isNaN(+d)) return;
    const mon = toMonday(d);
    const key = `${mon.getFullYear()}-${String(mon.getMonth()+1).padStart(2,'0')}-${String(mon.getDate()).padStart(2,'0')}`;
    const tpt=+r.Toptan||0, onl=+r.Online||0, ckm=+r.CKM||0, trn=+r.Trendyol||0, hb=+r.Hepsiburada||0;
    const total = tpt + onl + ckm + trn + hb;
    const prev = map.get(key) || { monday:key, Toptan:0, Online:0, CKM:0, CKM_Nakit:0, Trendyol:0, Hepsiburada:0, Total:0 };
    prev.Toptan+=tpt; prev.Online+=onl; prev.CKM+=ckm; prev.Trendyol+=trn; prev.Hepsiburada+=hb; prev.Total+=total;
    map.set(key, prev);
  });
  return Array.from(map.values()).sort((a,b)=>a.monday.localeCompare(b.monday));
}

/* ================== KPIs (Revenue) ================== */
function setKPIs(monthly){
  // === KPIs sadece bu yÄ±l (YTD) Ã¼zerinden hesaplansÄ±n ===
  const now = new Date();
  const currentYearReal = now.getFullYear();

  // Bu yÄ±lki aylar
  const ytdRowsReal = (monthly || []).filter(m => m.year === currentYearReal);

  // EÄŸer bu yÄ±l yoksa: eldeki son yÄ±l
  const fallbackYear = ytdRowsReal.length
    ? currentYearReal
    : ((monthly || []).length ? monthly[(monthly.length - 1)].year : currentYearReal);

  const thisYear = ytdRowsReal.length ? currentYearReal : fallbackYear;
  const rowsThisYear = (monthly || []).filter(m => m.year === thisYear);

  // Toplam yardÄ±mcÄ± sadece seÃ§ilen yÄ±l iÃ§in
  const sumTY = k => rowsThisYear.reduce((a, r) => a + (r[k] || 0), 0);

  // === YTD Toplam (sadece bu yÄ±l) ===
  const ytdTotal = sumTY('Total');
  const elYTD = document.getElementById('kpiYTD');
  if (elYTD) elYTD.textContent = numberTL(ytdTotal);

  const elYTD_USD = document.getElementById('kpiYTD_USD');
  if (elYTD_USD) {
    if (fxRateUSDPerTRY) elYTD_USD.textContent = `â‰ˆ ${numberUSD(ytdTotal * fxRateUSDPerTRY)} USD`;
    else elYTD_USD.textContent = 'â‰ˆ â€“ USD';
  }

  // === YTD YoY: geÃ§en yÄ±lÄ±n aynÄ± ay sayÄ±sÄ± ile hizalanmÄ±ÅŸ toplam ===
  try {
    const prevYear = thisYear - 1;
    // Bu yÄ±l var olan aylarÄ±n MM listesini Ã§Ä±kar
    const monthsThisYear = rowsThisYear.map(r => r.month.slice(5, 7));
    const mmSet = new Set(monthsThisYear);

    // GeÃ§en yÄ±l aynÄ± aylarÄ±n toplamÄ±
    const prevYtd = (monthly || []).reduce((acc, r) => {
      if (r.year !== prevYear) return acc;
      const mm = r.month.slice(5, 7);
      if (mmSet.has(mm)) acc += (r.Total || 0);
      return acc;
    }, 0);

    const yoy = prevYtd ? ((ytdTotal - prevYtd) / prevYtd) : 0;
    const elYoY = document.getElementById('kpiYTD_YoY');
    if (elYoY) elYoY.textContent = `YTD YoY: ${(yoy * 100).toFixed(1)}%`;
  } catch (e) {
    // sessiz geÃ§
  }

  // === En bÃ¼yÃ¼k kanal + paylar (yalnÄ±zca bu yÄ±l) ===
  const channels = [
    { k: 'Toptan',      v: sumTY('Toptan') },
    { k: 'Online',      v: sumTY('Online') },
    { k: 'CKM',         v: sumTY('CKM') },
    { k: 'Trendyol',    v: sumTY('Trendyol') },
    { k: 'Hepsiburada', v: sumTY('Hepsiburada') },
  ].sort((a, b) => b.v - a.v);

  const totalCh = channels.reduce((a, b) => a + b.v, 0) || 1;
  const top = channels[0] || { k: 'â€”', v: 0 };

  const kpiTopEl = document.getElementById('kpiTop');
  if (kpiTopEl) {
    kpiTopEl.textContent =
      `${top.k}: ${numberTL(top.v)}  â€¢  ${fxRateUSDPerTRY ? numberUSD(top.v * fxRateUSDPerTRY) : 'â€“ USD'}`;
  }

  const ul = document.getElementById('kpiOthers');
  if (ul) {
    ul.innerHTML = '';
    channels.slice(1).forEach(c => {
      const li = document.createElement('li');
      li.textContent = `${c.k}: ${numberTL(c.v)}  â€¢  ${fxRateUSDPerTRY ? numberUSD(c.v * fxRateUSDPerTRY) : 'â€“ USD'}`;
      ul.appendChild(li);
    });
  }

  const shareTbl = document.getElementById('kpiShareTbl');
  if (shareTbl) {
    shareTbl.innerHTML = channels
      .map(c => {
        const pct = (c.v / totalCh) * 100;
        return `<tr><td>${c.k}</td><td class="text-right">${pct.toFixed(1)}%</td></tr>`;
      })
      .join('');
  }

  // === MoM (bu yÄ±l iÃ§indeki son iki ay) ===
  const rowsSorted = rowsThisYear.slice().sort((a, b) => a.month.localeCompare(b.month));
  let last = null, prev = null;
  if (rowsSorted.length >= 2) {
    last = rowsSorted.at(-1).Total;
    prev = rowsSorted.at(-2).Total;
  } else if (rowsSorted.length === 1) {
    last = rowsSorted[0].Total;
    prev = 0;
  }

  const mom = prev ? (last - prev) / prev : 0;
  const elMoM = document.getElementById('kpiMoM');
  if (elMoM) {
    elMoM.textContent = `${(mom * 100).toFixed(1)}%`;
    elMoM.classList.remove('kpi-up', 'kpi-down');
    elMoM.classList.add(mom >= 0 ? 'kpi-up' : 'kpi-down');
  }

  const mLabels = rowsSorted.map(m => m.month);
  const momNote = document.getElementById('momNote');
  if (momNote) momNote.textContent = mLabels.length >= 2 ? `(${mLabels.at(-2)} â†’ ${mLabels.at(-1)})` : '';
}

/* ================== Alerts ================== */
function buildAlerts(monthly){
  const alerts = [];
  if(monthly.length>=2){
    const mLast = monthly.at(-1), mPrev = monthly.at(-2);
    const mom = mPrev.Total ? (mLast.Total - mPrev.Total) / mPrev.Total : 0;
    if(mom < -0.15){ alerts.push({type:'risk', text:`MoM toplam ciro dÃ¼ÅŸÃ¼ÅŸÃ¼ ${ (mom*100).toFixed(1) }%`}); }
    ["Toptan","Online","CKM","Trendyol","Hepsiburada"].forEach(k=>{
      const r = mPrev[k] ? (mLast[k]-mPrev[k]) / mPrev[k] : 0;
      if(r < -0.20){ alerts.push({type:'warn', text:`${k} aylÄ±k -${(Math.abs(r)*100).toFixed(0)}%`}); }
    });
  }
  const ul = document.getElementById('alertsList'); ul.innerHTML='';
  if(alerts.length===0){ ul.innerHTML = `<li class="hint">UyarÄ± yok.</li>`; return; }
  alerts.forEach(a=>{
    const li = document.createElement('li');
    const color = a.type==='risk'?'#ef4444':(a.type==='warn'?'#f59e0b':'#6366f1');
    li.innerHTML = `<span class="dot" style="background:${color}"></span>${a.text}`;
    ul.appendChild(li);
  });
}

/* ================== Targets ================== */
function computeAutoTargets(monthly){
  const byYear = {};
  monthly.forEach(m => { (byYear[m.year] = byYear[m.year] || []).push(m); });
  const targets = {};
  for(const y of Object.keys(byYear)){
    const arr = byYear[y].sort((a,b)=> a.month.localeCompare(b.month));
    let running = [];
    arr.forEach((m, idx) => {
      if(idx === 0){ targets[m.month] = m.Total; running.push(m.Total); }
      else { const avg = running.reduce((a,b)=>a+b,0) / running.length; targets[m.month] = avg; running.push(m.Total); }
    });
  }
  return targets;
}
function renderTargets(monthly){
  const autoTargets = computeAutoTargets(monthly);
  const wrap = document.getElementById('targetsWrap'); 
  wrap.innerHTML='';
  monthly.forEach(m=>{
    const target = autoTargets[m.month] || 0;
    const p = target ? Math.min(100, Math.round(m.Total/target*100)) : 0;
    const box = document.createElement('div');
    box.className = 'glass target-card border border-white/70';
    box.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="ttl text-slate-700 dark:text-slate-200">${m.month}</div>
        <div class="val text-slate-800 dark:text-slate-100">${numberTL(m.Total)}</div>
      </div>
      <div class="progress-wrap mt-1.5"><div class="progress-bar" style="width:${p}%"></div></div>
      <div class="sub hint mt-1">Hedef: ${numberTL(target)} â€¢ ${p}%</div>
    `;
    wrap.appendChild(box);
  });
}

/* ================== Charts ================== */
// === iOS-like frosted glass effect for the pie chart ===
const glassPie = {
  id: 'glassPie',
  beforeDatasetDraw(chart, args, pluginOptions) {
    if (chart.config.type !== 'pie') return;
    const { ctx } = chart;
    ctx.save();
    // soft drop shadow for segments
    ctx.shadowColor = 'rgba(15,23,42,0.25)'; // slate-ish
    ctx.shadowBlur = 12;
    ctx.shadowOffsetY = 6;
    ctx.shadowOffsetX = 0;
  },
  afterDatasetDraw(chart, args, pluginOptions) {
    if (chart.config.type !== 'pie') return;
    const { ctx, chartArea } = chart;
    // subtle radial highlight over the chart for glass sheen
    const {left, right, top, bottom} = chartArea;
    const cx = (left + right) / 2;
    const cy = (top + bottom) / 2;
    const r = Math.min(right - left, bottom - top) / 2;
    const grad = ctx.createRadialGradient(cx - r*0.3, cy - r*0.6, r*0.05, cx, cy, r);
    grad.addColorStop(0, 'rgba(255,255,255,0.22)');
    grad.addColorStop(0.6, 'rgba(255,255,255,0.08)');
    grad.addColorStop(1, 'rgba(255,255,255,0.00)');
    ctx.save();
    ctx.globalCompositeOperation = 'lighter';
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    // restore to clear the shadow for other charts
    ctx.restore();
  }
};
// === iOS-like frosted glass effect for stacked bar chart ===
const glassBars = {
  id: 'glassBars',
  beforeDatasetDraw(chart, args, pluginOptions) {
    if (chart.config.type !== 'bar') return;
    const { ctx } = chart;
    ctx.save();
    ctx.shadowColor = 'rgba(15,23,42,0.25)'; // slate shadow
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 6;
    ctx.shadowOffsetX = 0;
  },
  afterDatasetDraw(chart, args, pluginOptions) {
    if (chart.config.type !== 'bar') return;
    const { ctx, chartArea } = chart;
    const { left, top, right, bottom } = chartArea;
    // subtle diagonal sheen across the plot area
    const grad = ctx.createLinearGradient(left, top, right, bottom);
    grad.addColorStop(0.0, 'rgba(255,255,255,0.12)');
    grad.addColorStop(0.3, 'rgba(255,255,255,0.06)');
    grad.addColorStop(1.0, 'rgba(255,255,255,0.00)');
    ctx.save();
    ctx.globalCompositeOperation = 'lighter';
    ctx.fillStyle = grad;
    ctx.fillRect(left, top, right - left, bottom - top);
    ctx.restore();
    // clear shadow for next charts
    ctx.restore();
  }
};
Chart.register(glassPie);
Chart.register(glassBars);
Chart.register(ChartDataLabels);
let lineChart, pieChart, barChart;
let monthlyCache = [];
let yoyEnabled = true;
function drawCharts(monthly){
  // Cache incoming monthly for later re-draws (toggle)
  monthlyCache = Array.isArray(monthly) ? monthly : [];

  // ==== Build label set for the current year & an aligned prev-year series ====
  const now = new Date();
  const currentYear = monthlyCache.length ? monthlyCache[monthlyCache.length - 1].year : now.getFullYear();
  const prevYear = currentYear - 1;

  const curArr = monthlyCache.filter(r => r.year === currentYear);
  const labels = curArr.map(r => r.month); // e.g. "2025-01", "2025-02", ...

  // Map prev-year by MM for alignment to current labels
  const prevMap = {};
  monthlyCache.forEach(r => {
    if (r.year === prevYear) {
      const mm = r.month.slice(5, 7); // "MM"
      prevMap[mm] = (prevMap[mm] || 0) + (r.Total || 0);
    }
  });
  const dataCur = curArr.map(r => r.Total || 0);
  const dataPrev = labels.map(m => {
    const mm = m.slice(5, 7);
    return prevMap[mm] || 0;
  });

  // ========== Line: AylÄ±k Toplam Ciro ==========
  if(lineChart) lineChart.destroy();
  const lctx = document.getElementById('lineTotal').getContext('2d');
  function grad(ctx, c1, c2){ const g = ctx.createLinearGradient(0,0,0,220); g.addColorStop(0,c1); g.addColorStop(1,c2); return g; }

  const datasets = [{
    label:'Bu YÄ±l',
    data: dataCur,
    tension:0.35, borderWidth:3, borderColor:'#6366f1', fill:true,
    backgroundColor: grad(lctx, 'rgba(99,102,241,0.25)','rgba(34,211,238,0.05)'),
    pointRadius:3, pointHoverRadius:5
  }];

  // add prev year overlay if toggled on and we have any values
  const hasPrevAny = dataPrev.some(v => v > 0);
  if (yoyEnabled && hasPrevAny) {
    datasets.push({
      label:'GeÃ§en YÄ±l',
      data: dataPrev,
      tension:0.35,
      borderWidth:2,
      borderDash:[6,4],
      borderColor:'#94a3b8',     // slate-400
      pointRadius:0,
      fill:false
    });
  }

  lineChart = new Chart(lctx, {
    type:'line',
    data:{ labels: labels.map(m => m), datasets },
    options:{
      plugins:{
        legend:{display:true, position:'bottom'},
        datalabels:{ align:'top', anchor:'end', formatter:(v)=> numberTL(v), color:'#64748b', clip:true }
      },
      scales:{
        x:{ ticks:{ maxRotation:0 } },
        y:{ ticks:{ callback:(v)=> numberTL(v) } }
      }
    }
  });

  // ========== Pie: Kanal PaylarÄ± (YTD) ==========
  const sum = k => monthlyCache.reduce((a,r)=>a+(r[k]||0),0);
  if(pieChart) pieChart.destroy();
  const pctx = document.getElementById('pieShare').getContext('2d');

  const pieColors = [
    'rgba(129,140,248,0.65)',
    'rgba(52,211,153,0.65)',
    'rgba(96,165,250,0.65)',
    'rgba(251,191,36,0.65)',
    'rgba(244,114,182,0.65)'
  ];
  const pieHover = [
    'rgba(129,140,248,0.85)',
    'rgba(52,211,153,0.85)',
    'rgba(96,165,250,0.85)',
    'rgba(251,191,36,0.85)',
    'rgba(244,114,182,0.85)'
  ];

  pieChart = new Chart(pctx, {
    type:'pie',
    data:{
      labels:['Toptan','Online','CKM','Trendyol','Hepsiburada'],
      datasets:[{
        data:[sum('Toptan'),sum('Online'),sum('CKM'),sum('Trendyol'),sum('Hepsiburada')],
        backgroundColor: pieColors,
        hoverBackgroundColor: pieHover,
        borderWidth: 1.5,
        borderColor: 'rgba(255,255,255,0.55)'
      }]
    },
    options:{
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1,
      layout: { padding: 0 },
      radius: '65%',
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 10, padding: 12 } },
        datalabels: {
          color:'#0f172a',
          formatter:(v,ctx)=>{
            const total = ctx.dataset.data.reduce((a,b)=>a+b,0)||1;
            const pct = v/total*100; return `${pct.toFixed(1)}%`;
          },
          backgroundColor:'rgba(255,255,255,0.40)',
          borderColor:'rgba(255,255,255,0.85)',
          borderWidth:1,
          borderRadius:12,
          padding:5,
          clip: true
        }
      }
    }
  });

  // ========== Stacked Bar: Kanal BazlÄ± AylÄ±k Ciro (bu yÄ±l aylar) ==========
  if (barChart) barChart.destroy();
  const bctx = document.getElementById('barStack').getContext('2d');
  const barColors = [
    'rgba(165,180,252,0.70)',
    'rgba(52,211,153,0.70)',
    'rgba(96,165,250,0.70)',
    'rgba(251,191,36,0.70)',
    'rgba(244,114,182,0.70)'
  ];
  const barBorder = 'rgba(255,255,255,0.55)';

  barChart = new Chart(bctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Toptan',      data: curArr.map(r=>r.Toptan),      backgroundColor: barColors[0], borderColor: barBorder, borderWidth: 1, borderRadius: 6 },
        { label: 'Online',      data: curArr.map(r=>r.Online),      backgroundColor: barColors[1], borderColor: barBorder, borderWidth: 1, borderRadius: 6 },
        { label: 'CKM',         data: curArr.map(r=>r.CKM),         backgroundColor: barColors[2], borderColor: barBorder, borderWidth: 1, borderRadius: 6 },
        { label: 'Trendyol',    data: curArr.map(r=>r.Trendyol),    backgroundColor: barColors[3], borderColor: barBorder, borderWidth: 1, borderRadius: 6 },
        { label: 'Hepsiburada', data: curArr.map(r=>r.Hepsiburada), backgroundColor: barColors[4], borderColor: barBorder, borderWidth: 1, borderRadius: 6 },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1.6,
      layout: { padding: 0 },
      scales: {
        x: { stacked:true, ticks:{ maxRotation:0 }, grid:{ display:false } },
        y: { stacked:true, ticks:{ callback:(v)=> numberTL(v) }, grid:{ color:'rgba(148,163,184,0.15)' } }
      },
      plugins: {
        legend: { position:'bottom', labels: { boxWidth: 10, padding: 12 } },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${numberTL(ctx.raw)}` } },
        datalabels: {
          display: ctx => ctx.raw > 0,
          anchor: 'center',
          align: 'center',
          formatter: v => numberTL(v),
          color: '#fff',
          font: { weight: '600', size: 10 },
          clamp: true
        }
      },
      categoryPercentage: 0.7,
      barPercentage: 0.8
    }
  });
}

/* ================== Expenses (CFO) ================== */
let expensesRowsCache = [];
let expensesMonthlyCache = [];
let expYoyEnabled = true;

function normalizeExpenseCategory(cat){
  const s0 = (cat || '').toString();
  if (!s0) return '';

  // 1) BaÅŸta "DiÄŸer -" gibi sÃ¼sleri temizle
  const s1 = s0.replace(/^diÄŸer\s*[-:â€“â€”]\s*/i, '').replace(/^diger\s*[-:â€“â€”]\s*/i, '').trim();

  // 2) KÃ¼Ã§Ã¼k harfe indir, diakritikleri normalize et
  const toAscii = (str) => str
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // maÄŸaza -> magaza

  const s = toAscii(s1);

  // 3) AyÄ±rÄ±cÄ±larla bÃ¶l: " | " , "/" , " - "
  const tokens = s.split(/[|/]+/).flatMap(t => t.split(/\s+-\s+/)).map(t => t.trim()).filter(Boolean);

  // 4) "other/diÄŸer/misc" sayÄ±lacak kelimeler
  const isOther = (t) => /^(other|others|misc|miscellaneous|cesitli|various|diverse|diger|digerleri)$/i.test(t);

  // 5) Ä°lk "diÄŸer" olmayan etiket
  const primary = tokens.find(t => !isOther(t)) || (tokens[0] || '');

  // 6) SÄ±k gÃ¶rÃ¼len ad dÃ¼zeltmeleri
  if (/^meta\s*ads?$/.test(primary) || /^facebook(\s*ads?)?$/.test(primary) || /^instagram(\s*ads?)?$/.test(primary)) return 'Facebook';
  if (/^google(\s*ads?|adwords)$/.test(primary)) return 'Google Ads';
  if (/^tik(tok| tok)(\s*ads?)?$/.test(primary)) return 'TikTok Ads';
  if (/(yurtici|aras|mng|surat|ptt|ups|dhl|fedex|trendyol\s*express|hepsijet)/.test(primary)) return 'Kargo';
  if (/(garanti|isbank|is\s*bankasi|qnb|enpara|akbank|ziraat|yapi\s*kredi|iyzico|iyzi|iyzi-co|payu|iyzico|iyzi\s*co|stripe|iyzico)/.test(primary)) return 'Banka/Ã–deme';

  // 7) Ã–zel Ã¼rÃ¼n/marka Ã¶rnekleri
  if (/(zee)[\s\.-]*(dog)/.test(primary)) return 'Zee.Dog';

  // 8) BoÅŸsa DiÄŸer
  if (!primary || isOther(primary)) return 'DiÄŸer';

  // 9) Standart boÅŸluk temizliÄŸi
  return primary.replace(/\s+/g, ' ').trim();
}

function mapMainExpenseCategory(cat){
  // `cat` = normalizeExpenseCategory Ã§Ä±ktÄ±sÄ± veya Ã¶zgÃ¼n metin
  const s = (cat || '').toString().toLowerCase();

  // 1) Dijital Reklam
  if (/(facebook|google\s*ads?|adwords|instagram|tiktok|youtube|meta\s*ads?)/.test(s))
    return 'Dijital Reklam';

  // 2) Lojistik
  if (/(kargo|lojistik|shipping|nakliye|kurye|yurtici|aras|mng|surat|ptt|ups|dhl|fedex|trendyol\s*express|hepsijet)/.test(s))
    return 'Lojistik';

  // 3) Banka / Komisyon / Ã–deme KuruluÅŸlarÄ±
  if (/(banka|komisyon|pos\s*kesintisi|pos\s*ucreti|havale|eft|chargeback|kart\s*ucreti|iban\s*ucreti|iyzico|payu|stripe|paytr|papara|wise|paycell)/.test(s))
    return 'Banka / Komisyon';

  // 4) Vergiler
  if (/(vergi|kdv|stopaj|damga|gecikme|ceza|beyanname|muhasebe\s*damga)/.test(s))
    return 'Vergiler';

  // 5) YazÄ±lÄ±m / Abonelik
  if (/(shopify|yazilim|abonelik|subscription|google\s*workspace|office\s*365|microsoft\s*365|slack|notion|figma|zoom|canva|trello|asana|jira|aws|gcp|azure|cloudflare)/.test(s))
    return 'YazÄ±lÄ±m / Abonelik';

  // 6) DanÄ±ÅŸmanlÄ±k / Hizmet
  if (/(danisman|consult|freelance|ajans|agency|hukuk|legal|avukat|muhasebe\s*hizmet|ymm|denetim|tasarim|design|fotograf|video|prodÃ¼ksiyon|prodÃ¼ksiyon)/.test(s))
    return 'DanÄ±ÅŸmanlÄ±k Giderleri';

  // 7) Stok / Mal AlÄ±mÄ±
  if (/(mal\s*al(imi|Ä±mÄ±)|stok|tedarik|sat(in|Ä±n)\s*alma|purchase|supplier|tedarikci)/.test(s))
    return 'Stok / Mal AlÄ±mÄ±';

  // 8) MaÄŸaza Giderleri (yalnÄ±z maÄŸaza/ÅŸube anahtarlarÄ±yla eÅŸle)
  if (/(magaza|maÄŸaza|saha|sube|ckm|caddebostan|cadde|depo|thrones)/.test(s) &&
      /(kira|elektrik|su|dogalgaz|doÄŸalgaz|aidat|guvenlik|gÃ¼venlik|temizlik|personel|maas|maaÅŸ|yemek|ssk|sgk|pos)/.test(s))
    return 'MaÄŸaza Giderleri';

  // 9) Ev Giderleri (ev/konut anahtarÄ± ÅŸart)
  if (/(ev|konut|daire|home|house)/.test(s) &&
      /(kira|elektrik|su|dogalgaz|doÄŸalgaz|aidat|internet)/.test(s))
    return 'Ev Giderleri';

  // 10) VarsayÄ±lan
  return 'DiÄŸer';
}

function parseExpenseRow(r){
  // 1) Tarih: ISO ya da TR formatÄ±nÄ± destekle
  const rawDate = (r.Date || r.date || r.DATE || '').toString().trim();
  let iso = rawDate.slice(0,10);
  if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)){
    if(/\d{1,2}[./-]\d{1,2}[./-]\d{2,4}/.test(rawDate)){
      iso = parseTRDateString(rawDate) || '';
    } else {
      iso = '';
    }
  }

  // 2) Tutar (mutlak deÄŸer)
  const amt = Math.abs(
    parseTL(
      r.Amount || r.TRY || r.Tutar || r['Tutar (TRY)'] || r['Amount (TRY)'] || 0
    )
  );

  // 2.b) USD tutar: varsa ayrÄ± al
  const amtUSD = Math.abs(
    parseTL(
      r.USD || r['Amount USD'] || r['AmountUSD'] || r['US$'] || r['USD Amount'] || 0
    )
  );

  // 2.c) EÄŸer USD tutar varsa, TRY'ye Ã§evir (gÃ¼ncel kur: fxRateUSDPerTRY kullanÄ±lÄ±yor â€” 1 TRY kaÃ§ USD?)
  // Not: fxRateUSDPerTRY = USD/TRY. USD â†’ TRY dÃ¶nÃ¼ÅŸÃ¼mÃ¼ iÃ§in TRY = USD / (USD/TRY)
  let finalTRY = amt;
  if (amtUSD > 0) {
    if (fxRateUSDPerTRY && fxRateUSDPerTRY > 0) {
      finalTRY = amtUSD / fxRateUSDPerTRY;
    } else {
      // kur bilinmiyorsa, TRY alanÄ± boÅŸsa USD'yi doÄŸrudan kullan (yaklaÅŸÄ±k olarak)
      finalTRY = amt > 0 ? amt : amtUSD;
    }
  }

  // 3) CSV'den Final* alanlarÄ±nÄ± aÃ§Ä±kÃ§a Ã§ek ve sakla (kullanÄ±cÄ± override)
  const finalSub = (r.FinalSubcategory || '').toString().trim();
  const finalCat = (r.FinalCategory     || '').toString().trim();

  // 4) Kategori sinyalleri â€” geniÅŸ alan seti (varsa ekle)
  const parts = [
    r.FinalSubcategory, r.FinalCategory,
    r.Subcategory, r.Category, r.Kategori,
    r.Source, r.Aciklama, r.AÃ§Ä±klama, r.Description, r.Details, r.Note, r.Notes, r.Memo,
    r.Merchant, r.Payee, r.Supplier, r.Vendor, r.Bank, r.Banka, r.Account
  ].filter(Boolean).map(x => x.toString().trim());

  const combined = parts.join(' | ');

  // 5) Normalize edilmiÅŸ alt kategori adÄ±
  //    EÄŸer FinalSubcategory varsa onu Ã¶ncelikle normalize et, yoksa combined'dan Ã¼ret
  const cat = finalSub ? normalizeExpenseCategory(finalSub) : (normalizeExpenseCategory(combined) || 'DiÄŸer');

  // 6) Ana kategori â€” FinalCategory > mapper(cat) > mapper(combined)
  let main = finalCat || mapMainExpenseCategory(cat);
  if (!finalCat && (!main || main === 'DiÄŸer')) {
    main = mapMainExpenseCategory(combined);
  }

  return {
    Date: iso,
    Amount: finalTRY,         // TRY bazlÄ± (USD varsa Ã§evrilmiÅŸ)
    AmountUSD: amtUSD || 0,   // USD kaynaklÄ± ise burada
    Category: cat,            // normalize edilmiÅŸ alt kategori
    MainCategory: main,       // ana kategori (FinalCategory Ã¶ncelikli)
    FinalSubcategory: finalSub || null,
    FinalCategory: finalCat || null
  };
}

function buildExpensesMonthly(rows){
  const map = new Map();
  (rows||[]).forEach(r=>{
    if(!r.Date) return;
    const d = new Date(r.Date+'T00:00:00Z'); if(isNaN(+d)) return;
    const key = monthKey(d);
    const prev = map.get(key) || { month:key, year:d.getFullYear(), Total:0, byCat:{}, byMain:{} };

    const a = +r.Amount || 0;
    prev.Total += a;

    // Kategoriler: Final* varsa onu kullan, yoksa eski alanlara dÃ¼ÅŸ
    const catFine  = (r.FinalSubcategory && r.FinalSubcategory.trim()) || (r.Category || 'DiÄŸer');
    const mainFine = (r.FinalCategory     && r.FinalCategory.trim())     || (r.MainCategory || mapMainExpenseCategory(r.Category||'DiÄŸer'));

    prev.byCat[catFine]   = (prev.byCat[catFine]   || 0) + a;
    prev.byMain[mainFine] = (prev.byMain[mainFine] || 0) + a;

    map.set(key, prev);
  });
  return Array.from(map.values()).sort((a,b)=> a.month.localeCompare(b.month));
}

function setExpensesKPIs(expMonthly){
  const now = new Date();
  const curYear = now.getFullYear();
  // YÄ±l seÃ§imi: Bu yÄ±l veriniz yoksa, eldeki son yÄ±lÄ± kullan
  const yearsExp = Array.from(new Set((expMonthly||[]).map(m=>m.year))).sort((a,b)=>a-b);
  const expYear = yearsExp.includes(curYear) ? curYear : (yearsExp.length ? yearsExp[yearsExp.length-1] : curYear);
  const rowsThisYear = (expMonthly||[]).filter(m=> m.year===expYear);
  const expYTD = rowsThisYear.reduce((a, r) => a + (r.Total || 0), 0);

  // YTD gider
  const elExp = document.getElementById('kpiExpYTD'); if (elExp) elExp.textContent = numberTL(expYTD);
  const elExpUSD = document.getElementById('kpiExpYTD_USD'); if (elExpUSD) elExpUSD.textContent = fxRateUSDPerTRY ? `â‰ˆ ${numberUSD(expYTD*fxRateUSDPerTRY)} USD` : 'â‰ˆ â€“ USD';

  // YoY (aynÄ± ay sayÄ±sÄ± hizalÄ±)
  try{
    const monthsThis = rowsThisYear.map(r=> r.month.slice(5,7));
const prevSum = (expMonthly||[]).reduce((acc,r)=> (r.year===expYear-1 && monthsThis.includes(r.month.slice(5,7))) ? acc+(r.Total||0) : acc, 0);    const yoy = prevSum ? (expYTD - prevSum) / prevSum : 0;
    const elYoY = document.getElementById('kpiExpYoY'); if (elYoY) elYoY.textContent = `YTD YoY: ${(yoy*100).toFixed(1)}%`;
  }catch(e){}

  // MoM
  const sorted = rowsThisYear.slice().sort((a,b)=> a.month.localeCompare(b.month));
  const last = sorted.at(-1)?.Total || 0; const prev = sorted.at(-2)?.Total || 0;
  const mom = prev ? (last - prev) / prev : 0;
  const elMoM = document.getElementById('kpiExpMoM'); if (elMoM){ elMoM.textContent = `${(mom*100).toFixed(1)}%`; elMoM.classList.remove('kpi-up','kpi-down'); elMoM.classList.add(mom<=0?'kpi-up':'kpi-down'); }
  const elMoMNote = document.getElementById('kpiExpMoMNote'); if (elMoMNote){ const labs = sorted.map(m=>m.month); elMoMNote.textContent = labs.length>=2 ? `(${labs.at(-2)} â†’ ${labs.at(-1)})` : ''; }

  // Net (Gelir YTD - Gider YTD)
  try{
    const revThisYear = (monthlyCache||[]).filter(m=> m.year===expYear).reduce((a,r)=> a+(r.Total||0), 0);
    const net = revThisYear - expYTD;
    const elNet = document.getElementById('kpiNetYTD'); if (elNet) elNet.textContent = numberTL(net);
    const elNetUSD = document.getElementById('kpiNetYTD_USD'); if (elNetUSD) elNetUSD.textContent = fxRateUSDPerTRY ? `â‰ˆ ${numberUSD(net*fxRateUSDPerTRY)} USD` : 'â‰ˆ â€“ USD';
    const elNetNote = document.getElementById('kpiNetNote'); if (elNetNote) elNetNote.textContent = `Gelir (YTD): ${numberTL(revThisYear)} â€¢ Gider (YTD): ${numberTL(expYTD)}`;
  }catch(e){}
}

function renderMainExpenseTable(){
  try{
    const now = new Date();
    const curYear = now.getFullYear();
    const years = Array.from(new Set((expensesMonthlyCache||[]).map(m=>m.year))).sort((a,b)=>a-b);
    const expYear = years.includes(curYear) ? curYear : (years.length ? years[years.length-1] : curYear);

    const rows = (expensesRowsCache || []).filter(r => {
      const d = r.Date ? new Date(r.Date + 'T00:00:00Z') : null;
      return d && !isNaN(+d) && d.getFullYear() === expYear;
    });

    const sumByMain = {};
    const sumByMainUSD = {};
    let total = 0;
    for(const r of rows){
      // FinalCategory ve FinalSubcategory Ã¶ncelikli; yoksa tÃ¼retilmiÅŸ MainCategory / fallback
      const main =
        (r.FinalCategory && r.FinalCategory.trim()) ||
        (r.FinalSubcategory && r.FinalSubcategory.trim()) ||
        r.MainCategory ||
        mapMainExpenseCategory(r.Category || 'DiÄŸer');

      const a = +r.Amount || 0;
      const aUSD = +r.AmountUSD || 0;
      sumByMain[main] = (sumByMain[main] || 0) + a;
      sumByMainUSD[main] = (sumByMainUSD[main] || 0) + aUSD;
      total += a;
    }

    const arr = Object.entries(sumByMain)
      .map(([k,v]) => ({ k, v, usd: (sumByMainUSD[k] || 0), p: total ? (v/total*100) : 0 }))
      .sort((a,b) => b.v - a.v);

    const tbody = document.getElementById('tblMainExpenses');
    if(!tbody) return;
    tbody.innerHTML = arr.length
      ? arr.map(x => `
          <tr>
            <td class="py-1 pr-3">${x.k}</td>
            <td class="py-1 pr-3 text-right">${numberTL(x.v)}</td>
            <td class="py-1 pr-3 text-right">${x.usd > 0 ? numberUSD(x.usd) : 'â€“'}</td>
            <td class="py-1 pr-0 text-right">${x.p.toFixed(1)}%</td>
          </tr>
        `).join('')
      : '<tr><td colspan="4" class="hint py-1">Veri yok.</td></tr>';
  }catch(e){
    console.warn('renderMainExpenseTable error', e);
  }
}
let expLineChart, expPieChart;
function drawExpensesCharts(expMonthly){
  const now = new Date();
  const curYear = now.getFullYear();
  // Bu yÄ±l veri yoksa, eldeki son yÄ±lÄ± kullan
  const yearsWithData = Array.from(new Set((expMonthly||[]).map(r=> r.year))).sort((a,b)=>a-b);
  const expYear = yearsWithData.includes(curYear) ? curYear : (yearsWithData.length ? yearsWithData[yearsWithData.length-1] : curYear);
  const arr = (expMonthly||[]).filter(r=> r.year===expYear);
  const labels = arr.map(r=> r.month);
  const dataCur = arr.map(r=> r.Total||0);

  // === Expenses Pie Chart: Main Categories (TRY, YTD) ===
  if (expPieChart) expPieChart.destroy();
  (function(){
    // YÄ±l seÃ§imi (renderMainExpenseTable ile aynÄ± mantÄ±k)
    const years = Array.from(new Set((expMonthly||[]).map(r=> r.year))).sort((a,b)=>a-b);
    const targetYear = years.includes(curYear) ? curYear : (years.length ? years[years.length-1] : curYear);

    // YalnÄ±zca hedef yÄ±l satÄ±rlarÄ±nÄ± ham satÄ±rlardan al; MainCategory bazÄ±nda TRY toplamla.
    const rowsY = (expensesRowsCache || []).filter(r=>{
      const d = r.Date ? new Date(r.Date + 'T00:00:00Z') : null;
      return d && !isNaN(+d) && d.getFullYear() === targetYear;
    });

    const byMainTRY = {};
    rowsY.forEach(r=>{
      // Ana kategori: FinalCategory > FinalSubcategory > MainCategory mapper
      const main =
        (r.FinalCategory && r.FinalCategory.trim()) ||
        (r.FinalSubcategory && r.FinalSubcategory.trim()) ||
        r.MainCategory || mapMainExpenseCategory(r.Category || 'DiÄŸer');

      const aTRY = +r.Amount || 0;      // TRY (USD varsa dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ)
      byMainTRY[main] = (byMainTRY[main] || 0) + aTRY;
    });

    // Chart datasÄ±nÄ± hazÄ±rla (en bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    const pairs = Object.entries(byMainTRY).sort((a,b)=> b[1]-a[1]);
    const labelsPie = pairs.map(([k])=>k);
    const dataPie   = pairs.map(([,v])=>v);

    const ctxPie = document.getElementById('pieExpenses').getContext('2d');
    const bg = [
      'rgba(129,140,248,0.75)',
      'rgba(52,211,153,0.75)',
      'rgba(96,165,250,0.75)',
      'rgba(251,191,36,0.75)',
      'rgba(244,114,182,0.75)',
      'rgba(248,113,113,0.75)',
      'rgba(94,234,212,0.75)',
      'rgba(190,242,100,0.75)'
    ];
    const hover = bg.map(c => c.replace('0.75','0.95'));

    expPieChart = new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: labelsPie,
        datasets: [{
          data: dataPie,
          backgroundColor: bg,
          hoverBackgroundColor: hover,
          borderWidth: 1.5,
          borderColor: 'rgba(255,255,255,0.55)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 0 },
        radius: '78%',
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 10, padding: 12 } },
          datalabels: {
            color: '#0f172a',
            formatter: (v,ctx) => {
              const sum = ctx.dataset.data.reduce((a,b)=>a+b,0) || 1;
              const pct = v/sum*100;
              return `${pct.toFixed(1)}%`;
            },
            backgroundColor: 'rgba(255,255,255,0.50)',
            borderColor: 'rgba(255,255,255,0.90)',
            borderWidth: 1,
            borderRadius: 12,
            padding: 5,
            clip: true
          }
        }
      },
      plugins: [glassPie]
    });

    // === Line: AylÄ±k Giderler (TRY) ===
    if (expLineChart) expLineChart.destroy();
    const ctxLine = document.getElementById('lineExpenses').getContext('2d');

    // Mevcut yÄ±l dizisi
    const arrY = (expMonthly||[]).filter(r=> r.year===targetYear);
    const labelsExp = arrY.map(r=>r.month);
    const dataExp   = arrY.map(r=>r.Total||0);

    expLineChart = new Chart(ctxLine, {
      type: 'line',
      data: { labels: labelsExp, datasets: [{
        label: 'Giderler (TRY)',
        data: dataExp,
        tension: 0.35,
        borderWidth: 3,
        borderColor: '#f59e0b',
        fill: true,
        backgroundColor: (function(){
          const g = ctxLine.createLinearGradient(0,0,0,220);
          g.addColorStop(0, 'rgba(245,158,11,0.25)');
          g.addColorStop(1, 'rgba(245,158,11,0.04)');
          return g;
        })(),
        pointRadius: 3,
        pointHoverRadius: 5
      }]},
      options: {
        plugins: {
          legend: { display: true, position: 'bottom' },
          datalabels: { align: 'top', anchor: 'end', formatter: (v) => numberTL(v), color: '#64748b', clip: true }
        },
        scales: {
          x: { ticks: { maxRotation: 0 } },
          y: { ticks: { callback: (v) => numberTL(v) } }
        }
      }
    });
  })();