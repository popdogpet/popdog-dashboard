<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Pop Dog | 2025 CFO Dashboard (Sheet + WhatsApp + Weekly)</title>
  <!-- === Versioned cache reset (iOS/Safari safe) ===
       Bump APP_VERSION to force clearing old caches/localStorage and one-time reload -->
  <script>
  (function(){
    var APP_VERSION = '2026.01.18-01'; // ‚¨ÖÔ∏è bump this to invalidate client caches
    var VERSION_KEY = 'popdog_app_version';
    var RELOAD_FLAG = 'popdog_version_reloaded';
    // Keep these keys across resets (user prefs / endpoints)
    var PRESERVE_KEYS = [
      'popdog_sheet_webapp_url',
      'popdog_theme'
    ];
    try{
      var prev = localStorage.getItem(VERSION_KEY);
      if (prev !== APP_VERSION){
        // Preserve a few important values before we clean
        var preserve = {};
        try{
          PRESERVE_KEYS.forEach(function(k){ preserve[k] = localStorage.getItem(k); });
        }catch(_){}

        // Wipe app-local keys (namespaced with popdog_) but keep PRESERVE_KEYS
        try{
          var toRemove = [];
          for (var i=0; i<localStorage.length; i++){
            var k = localStorage.key(i);
            if (/^popdog_/i.test(k) && PRESERVE_KEYS.indexOf(k) === -1){
              toRemove.push(k);
            }
          }
          toRemove.forEach(function(k){ localStorage.removeItem(k); });
        }catch(_){}

        // Restore preserved values
        try{
          Object.keys(preserve).forEach(function(k){
            if (preserve[k] !== null && preserve[k] !== undefined){
              localStorage.setItem(k, preserve[k]);
            }
          });
        }catch(_){}

        // Nuke CacheStorage (if available)
        try{
          if ('caches' in window){
            caches.keys().then(function(keys){ keys.forEach(function(k){ caches.delete(k); }); });
          }
        }catch(_){}

        // Unregister any service workers (if any)
        try{
          if ('serviceWorker' in navigator){
            navigator.serviceWorker.getRegistrations().then(function(list){
              list.forEach(function(reg){ reg.unregister(); });
            });
          }
        }catch(_){}

        // Save new version
        try{ localStorage.setItem(VERSION_KEY, APP_VERSION); }catch(_){}

        // One-time hard reload to ensure fresh assets
        try{
          if (!sessionStorage.getItem(RELOAD_FLAG)){
            sessionStorage.setItem(RELOAD_FLAG, '1');
            // Avoid hash preserving to prevent SW/SPA quirks; strip query except debug flags
            location.replace(location.href.split('#')[0]);
          }else{
            sessionStorage.removeItem(RELOAD_FLAG);
          }
        }catch(_){}
      }
    }catch(_){}
  })();
  </script>
  <!-- Tailwind CDN removed - using pre-compiled CSS for faster loading -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* === Pre-compiled Tailwind CSS (only used classes) === */
    *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
    html { line-height: 1.5; -webkit-text-size-adjust: 100%; font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; line-height: inherit; }
    h1, h2, h3, h4, h5, h6 { font-size: inherit; font-weight: inherit; }
    p { margin: 0; }
    button, input, select, textarea { font-family: inherit; font-size: 100%; font-weight: inherit; line-height: inherit; color: inherit; margin: 0; padding: 0; }
    button { cursor: pointer; background-color: transparent; background-image: none; }
    table { text-indent: 0; border-color: inherit; border-collapse: collapse; }
    img, svg { display: block; }
    *, ::before, ::after { --tw-border-spacing-x: 0; --tw-border-spacing-y: 0; --tw-ring-offset-width: 0px; --tw-ring-offset-color: #fff; --tw-ring-color: rgb(59 130 246 / 0.5); }

    /* Layout */
    .block { display: block; }
    .flex { display: flex; }
    .grid { display: grid; }
    .hidden { display: none; }
    .inline-flex { display: inline-flex; }

    /* Flexbox */
    .flex-wrap { flex-wrap: wrap; }
    .items-center { align-items: center; }
    .items-start { align-items: flex-start; }
    .items-end { align-items: flex-end; }
    .items-stretch { align-items: stretch; }
    .justify-between { justify-content: space-between; }

    /* Grid */
    .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    /* Gap */
    .gap-1 { gap: 0.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .gap-6 { gap: 1.5rem; }

    /* Spacing */
    .space-y-1 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.25rem; }
    .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; }
    .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }

    /* Sizing */
    .w-full { width: 100%; }
    .w-28 { width: 7rem; }
    .min-w-full { min-width: 100%; }
    .max-w-7xl { max-width: 80rem; }
    .min-h-screen { min-height: 100vh; }
    .max-h-48 { max-height: 12rem; }
    .max-h-64 { max-height: 16rem; }

    /* Margin */
    .mx-auto { margin-left: auto; margin-right: auto; }
    .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
    .mt-0\.5 { margin-top: 0.125rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-1\.5 { margin-top: 0.375rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .mt-5 { margin-top: 1.25rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .ml-1 { margin-left: 0.25rem; }
    .ml-4 { margin-left: 1rem; }

    /* Padding */
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-0\.5 { padding-top: 0.125rem; padding-bottom: 0.125rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .pt-2 { padding-top: 0.5rem; }
    .pr-0 { padding-right: 0; }
    .pr-2 { padding-right: 0.5rem; }
    .pr-3 { padding-right: 0.75rem; }
    .pr-4 { padding-right: 1rem; }
    .pl-4 { padding-left: 1rem; }

    /* Typography */
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .text-\[10px\] { font-size: 10px; }
    .text-\[11px\] { font-size: 11px; }
    .text-xs { font-size: 0.75rem; line-height: 1rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-base { font-size: 1rem; line-height: 1.5rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .tracking-tight { letter-spacing: -0.025em; }
    .list-disc { list-style-type: disc; }

    /* Colors */
    .text-slate-600 { color: rgb(71 85 105); }
    .text-slate-700 { color: rgb(51 65 85); }
    .text-slate-800 { color: rgb(30 41 59); }
    .bg-white\/70 { background-color: rgb(255 255 255 / 0.7); }

    /* Borders */
    .border { border-width: 1px; }
    .border-t { border-top-width: 1px; }
    .border-dashed { border-style: dashed; }
    .border-slate-300\/60 { border-color: rgb(203 213 225 / 0.6); }
    .border-white\/30 { border-color: rgb(255 255 255 / 0.3); }
    .border-white\/40 { border-color: rgb(255 255 255 / 0.4); }
    .border-white\/50 { border-color: rgb(255 255 255 / 0.5); }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-2xl { border-radius: 1rem; }
    .rounded-3xl { border-radius: 1.5rem; }

    /* Effects */
    .opacity-70 { opacity: 0.7; }
    .overflow-auto { overflow: auto; }
    .cursor-pointer { cursor: pointer; }
    .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }

    /* Dark mode */
    .dark .dark\:text-slate-100 { color: rgb(241 245 249); }
    .dark .dark\:text-slate-200 { color: rgb(226 232 240); }
    .dark .dark\:text-slate-300 { color: rgb(203 213 225); }
    .dark .dark\:bg-slate-800 { background-color: rgb(30 41 59); }
    .dark .dark\:border-slate-600\/50 { border-color: rgb(71 85 105 / 0.5); }
    .dark .dark\:border-slate-700\/40 { border-color: rgb(51 65 85 / 0.4); }

    /* Responsive - SM (640px+) */
    @media (min-width: 640px) {
      .sm\:inline-flex { display: inline-flex; }
      .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .sm\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .sm\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .sm\:col-span-2 { grid-column: span 2 / span 2; }
      .sm\:col-span-3 { grid-column: span 3 / span 3; }
      .sm\:gap-3 { gap: 0.75rem; }
      .sm\:gap-4 { gap: 1rem; }
      .sm\:p-4 { padding: 1rem; }
      .sm\:p-5 { padding: 1.25rem; }
      .sm\:p-6 { padding: 1.5rem; }
      .sm\:mt-4 { margin-top: 1rem; }
      .sm\:space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
      .sm\:space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
      .sm\:text-sm { font-size: 0.875rem; line-height: 1.25rem; }
      .sm\:text-lg { font-size: 1.125rem; line-height: 1.75rem; }
      .sm\:text-xl { font-size: 1.25rem; line-height: 1.75rem; }
      .sm\:text-2xl { font-size: 1.5rem; line-height: 2rem; }
    }

    /* Responsive - MD (768px+) */
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .md\:text-2xl { font-size: 1.5rem; line-height: 2rem; }
      .md\:text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
    }

    /* Responsive - LG (1024px+) */
    @media (min-width: 1024px) {
      .lg\:block { display: block; }
      .lg\:grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
      .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .lg\:grid-cols-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
      .lg\:grid-cols-7 { grid-template-columns: repeat(7, minmax(0, 1fr)); }
    }

    /* Responsive - XL (1280px+) */
    @media (min-width: 1280px) {
      .xl\:grid-cols-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
    }
  </style>
  <style>
    .badge-paid{
      background: #16a34a1a;
      color:#16a34a;
      border:1px solid #16a34a33;
      padding:.15rem .45rem; border-radius:999px; font-size:10px;
    }
    .badge-partial{
      background: #f9731633;
      color:#f97316;
      border:1px solid #f9731666;
      padding:.15rem .45rem; border-radius:999px; font-size:10px;
    }
    .badge-wait{
      background:#64748b1a; color:#64748b; border:1px solid #64748b33;
      padding:.15rem .45rem; border-radius:999px; font-size:10px;
    }
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 600px at 10% -10%, #ecf2ff, transparent), radial-gradient(1200px 600px at 110% 110%, #f8fafc, transparent); }
    .dark body, .dark .pagebg { background: radial-gradient(1200px 600px at 10% -10%, #0b1220, transparent), radial-gradient(1200px 600px at 110% 110%, #0f172a, transparent) !important; }
    .glass { background: rgba(255,255,255,0.65); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.4); }
    .dark .glass { background: rgba(2,6,23,0.5); border-color: rgba(255,255,255,0.08) !important; }
    .hint { color:#64748b }

    /* PIN Lock Overlay */
    #pinOverlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
    }
    #pinOverlay.hidden { display: none; }
    .pin-box {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 24px;
      padding: 2.5rem;
      text-align: center;
      max-width: 320px;
      width: 90%;
    }
    .pin-box h2 {
      color: #fff;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .pin-box p {
      color: rgba(255,255,255,0.6);
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }
    .pin-input {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .pin-input input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      outline: none;
      transition: border-color 0.2s, background 0.2s;
    }
    .pin-input input:focus {
      border-color: #60a5fa;
      background: rgba(255,255,255,0.15);
    }
    .pin-input input.error {
      border-color: #f87171;
      animation: shake 0.3s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .pin-error {
      color: #f87171;
      font-size: 0.875rem;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
      min-height: 1.25rem;
    }
    .pin-logo {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .dark .hint { color:#93a4bd }
    .badge { font-size:10px; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; color:#334155; }
    .dark .badge { background:#0b1220; color:#cbd5e1; border:1px solid rgba(255,255,255,.08); }
    .progress-wrap{height:4px;background:rgba(0,0,0,.06);border-radius:999px;overflow:hidden}
    .target-card{
      padding:.35rem .5rem;
      border-radius:.75rem;
    }
    .target-card .ttl{
      font-size:.7rem;
      line-height:1.1;
    }
    .target-card .val{
      font-weight:600;
      font-size:.75rem;
      line-height:1.1;
    }
    .target-card .sub{
      font-size:.65rem;
      opacity:.75;
      line-height:1.1;
    }
    .progress-bar{height:100%;background:linear-gradient(90deg,#6366f1,#22d3ee)}
    .kpi-up{color:#10b981}.kpi-down{color:#ef4444}
    .dot{width:.5rem;height:.5rem;border-radius:999px;display:inline-block;margin-right:.4rem}
    .card-3d{ box-shadow: 0 10px 30px rgba(2,6,23,.15), inset 0 1px 0 rgba(255,255,255,.3); transform: translateZ(0); }
    canvas{image-rendering: auto}
    /* === iOS-like glass chips (frosted) === */
    .chip-ios{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.3rem .6rem; border-radius:999px;
      background: rgba(255,255,255,0.35);
      border:1px solid rgba(255,255,255,0.55);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.45),
        0 8px 20px rgba(15,23,42,0.08);
    }
    .dark .chip-ios{
      background: rgba(2,6,23,0.45);
      border-color: rgba(255,255,255,0.10);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.06),
        0 10px 26px rgba(0,0,0,0.35);
    }
    .chip-ios .dot{
      width:.45rem; height:.45rem; border-radius:999px;
      background: currentColor;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.5) inset;
    }
    .chip-ios .label{ font-size:.75rem; color:#0f172a; }
    .dark .chip-ios .label{ color:#e2e8f0; }
.chip-ios .val{ font-weight:600; font-size:.75rem; color:#334155; }
.dark .chip-ios .val{ color:#cbd5e1; }
th, td { white-space: nowrap; }

/* === MOBILE OPTIMIZATIONS === */
/* Touch-friendly minimum sizes */
@media (max-width: 768px) {
  /* Buttons and interactive elements */
  button, .btn, input[type="submit"], input[type="button"] {
    min-height: 44px !important;
    min-width: 44px !important;
    font-size: 16px !important; /* Prevents iOS zoom on focus */
  }

  /* Input fields */
  input[type="text"],
  input[type="date"],
  input[type="number"],
  select,
  textarea {
    min-height: 44px !important;
    font-size: 16px !important; /* Prevents iOS zoom */
    padding: 0.75rem !important;
  }

  /* Reduce padding on cards */
  .glass, .card-glass-pro {
    padding: 0.75rem !important;
  }

  /* Smaller font for compact tables on mobile */
  .sales-turnover table th,
  .sales-turnover table td,
  #stockBlock table th,
  #stockBlock table td {
    font-size: 9px !important;
  }

  /* Badge sizes */
  .badge, .badge-paid, .badge-wait, .badge-partial {
    font-size: 11px !important;
    padding: 0.25rem 0.5rem !important;
  }

  /* KPI cards stack better on mobile */
  .target-card .ttl {
    font-size: 0.75rem !important;
  }
  .target-card .val {
    font-size: 0.85rem !important;
  }

  /* Chips more readable on mobile */
  .chip-ios .label,
  .chip-ios .val {
    font-size: 0.85rem !important;
  }

  /* Table headers more visible */
  thead th {
    font-size: 0.8rem !important;
    font-weight: 600 !important;
  }

  /* Better spacing for mobile */
  .mt-5 { margin-top: 1.5rem !important; }
  .mt-4 { margin-top: 1rem !important; }
  .gap-4 { gap: 0.75rem !important; }
}

/* === Compact tables (stock + sales/turnover) ‚Äî ultra compact === */
.sales-turnover table th,
.sales-turnover table td,
#stockBlock table th,
#stockBlock table td{
  font-size: 7px;            /* ~6px'e yakƒ±n, her ekranda √ßok kompakt */
  padding: .15rem .25rem;    /* dar h√ºcre i√ßi bo≈üluk */
}
@media (min-width: 1280px){
  .sales-turnover table th,
  .sales-turnover table td,
  #stockBlock table th,
  #stockBlock table td{ font-size: 10px; }
}

    /* === En B√ºy√ºk Kanal ‚Äî sade liste + k√º√ß√ºk y√ºzde tablosu === */
#kpiOthers{ margin-top:.25rem; max-height:none; overflow:visible; }
#kpiOthers li{ font-size: 12px; line-height:1.2; }
#kpiShareTbl{ width:100%; margin-top:.35rem; border-collapse:collapse; }
#kpiShareTbl td{ font-size:11px; padding:.15rem .25rem; }
#kpiShareTbl td:first-child{ opacity:.85; }
  /* === Pro glass cards, inputs and buttons === */
  .card-glass-pro{
    position: relative;
    border-radius: 1rem;
    background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.28));
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    border: 1px solid rgba(255,255,255,0.65);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.55),
      0 10px 28px rgba(15,23,42,0.12);
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .dark .card-glass-pro{
    background: linear-gradient(180deg, rgba(2,6,23,0.55), rgba(2,6,23,0.35));
    border-color: rgba(255,255,255,0.10);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.06),
      0 12px 28px rgba(0,0,0,0.35);
  }
  .card-glass-pro:hover{
    transform: translateY(-2px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.6),
      0 16px 36px rgba(15,23,42,0.16);
  }

  .input-pro{
    width: 100%;
    border-radius: .75rem;
    padding: .5rem .75rem;
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(255,255,255,0.8);
    backdrop-filter: blur(10px) saturate(160%);
    -webkit-backdrop-filter: blur(10px) saturate(160%);
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .dark .input-pro{
    background: rgba(2,6,23,0.45);
    border-color: rgba(255,255,255,0.10);
  }
  .input-pro:focus{
    outline: none;
    box-shadow: 0 0 0 3px rgba(99,102,241,.35), 0 10px 24px rgba(15,23,42,.12);
    border-color: rgba(99,102,241,.55);
  }

  .btn-primary{
    display: inline-flex; align-items:center; justify-content:center; gap:.5rem;
    border-radius: 1rem;
    padding: .55rem 1rem;
    font-weight: 600;
    background: linear-gradient(90deg, #6366f1, #a855f7);
    color: white;
    box-shadow: 0 10px 22px rgba(99,102,241,.28);
    transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    border: 1px solid rgba(255,255,255,0.35);
  }
  .btn-primary:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(99,102,241,.32); }
  .btn-primary:active{ transform: translateY(0); filter: brightness(.98); }

  .soft-badge{
    font-size: 11px;
    padding: .2rem .5rem;
    border-radius: 999px;
    background: rgba(99,102,241,0.10);
    color: #334155;
    border: 1px solid rgba(99,102,241,0.18);
  }
  .dark .soft-badge{
    background: rgba(99,102,241,0.14);
    color: #cbd5e1;
    border-color: rgba(255,255,255,0.08);
  }
  </style>
</head>
<body class="min-h-screen pagebg">
  <!-- PIN Lock Overlay -->
  <div id="pinOverlay">
    <div class="pin-box">
      <div class="pin-logo">üêï</div>
      <h2>Pop Dog CFO</h2>
      <p>Devam etmek i√ßin PIN kodunu girin</p>
      <div class="pin-input">
        <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-pin="0">
        <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-pin="1">
        <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-pin="2">
        <input type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-pin="3">
      </div>
      <div class="pin-error" id="pinError"></div>
    </div>
  </div>

  <div id="mainContent" class="max-w-7xl mx-auto p-3 sm:p-6 space-y-4 sm:space-y-6" style="display:none;">

    <!-- Header -->
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h1 class="text-xl sm:text-2xl md:text-3xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">
          Pop Dog | 2025 CFO Dashboard
        </h1>
      </div>
      <!-- Top Nav: Pages -->
      <div class="w-full mt-2 flex items-center gap-2 flex-wrap">
        <button id="navSummary" class="glass card-3d px-3 py-2 rounded-xl text-sm font-medium">√ñzet</button>
        <button id="navRevenue" class="glass card-3d px-3 py-2 rounded-xl text-sm font-medium">Ciro</button>
        <button id="navExpenses" class="glass card-3d px-3 py-2 rounded-xl text-sm font-medium">Giderler</button>
        <button id="navStock" class="glass card-3d px-3 py-2 rounded-xl text-sm font-medium">Stok</button>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
  <button id="themeBtn" class="glass card-3d px-3 py-2 rounded-2xl text-sm text-slate-700 dark:text-slate-200">üåó Tema</button>
  <button id="refreshBtn" class="glass card-3d px-3 py-2 rounded-2xl text-sm">Yenile</button>
  <input id="fileInput" type="file" accept=".csv" class="hidden">
  <button id="uploadBtn" class="glass card-3d px-3 py-2 rounded-2xl text-sm hidden sm:inline-flex">CSV Y√ºkle</button>
  <button id="downloadBtn" class="glass card-3d px-3 py-2 rounded-2xl text-sm hidden sm:inline-flex">CSV ƒ∞ndir</button>
  <button id="writeSheetBtn" class="glass card-3d px-3 py-2 rounded-2xl text-sm hidden sm:inline-flex">Sheet'e Kaydet</button>
</div>
    </header>



    <!-- KPIs + Alerts -->
    <div class="grid md:grid-cols-2 gap-3 sm:gap-4 items-start" data-page="summary">
      <div class="grid gap-3 sm:gap-4">
        <div class="glass card-3d rounded-3xl p-4 sm:p-5">
          <div class="hint text-xs sm:text-sm">Toplam Ciro (YTD)</div>
          <div id="kpiYTD" class="text-lg sm:text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">‚Äì</div>
          <div id="kpiYTD_USD" class="text-xs sm:text-sm hint">‚âà ‚Äì USD</div>
          <div id="kpiYTD_YoY" class="text-xs hint mt-1"></div>
          <div id="fxNote" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass card-3d rounded-3xl p-4 sm:p-5">
          <div class="hint text-xs sm:text-sm">En B√ºy√ºk Kanal</div>
          <div id="kpiTop" class="text-lg sm:text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">‚Äì</div>
          <ul id="kpiOthers" class="text-xs sm:text-sm hint mt-2 space-y-1"></ul>
          <table id="kpiShareTbl"></table>
        </div>
      </div>
      <div class="glass card-3d rounded-3xl p-4 sm:p-5 space-y-3 sm:space-y-4">
        <div class="grid sm:grid-cols-2 gap-3 sm:gap-4">
          <div class="glass rounded-2xl p-3 sm:p-4">
            <div class="hint text-xs sm:text-sm">Stok Deƒüeri (Maliyet)</div>
            <div id="kpiInvCost" class="text-lg sm:text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">‚Äì</div>
            <div id="kpiInvCost_USD" class="text-xs hint mt-0.5">‚âà ‚Äì USD</div>
            <div class="hint text-xs mt-2">Vergi + Navlun dahil (+%65)</div>
            <div id="kpiInvCost_65" class="text-sm font-medium text-slate-800 dark:text-slate-100">‚Äì</div>
            <div id="kpiInvCost_65_USD" class="text-xs hint mt-0.5">‚âà ‚Äì USD</div>
          </div>
          <div class="glass rounded-2xl p-3 sm:p-4">
            <div class="hint text-sm">Stok Deƒüeri (Satƒ±≈ü)</div>
            <div id="kpiInvPrice" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">‚Äì</div>
            <div id="kpiInvPrice_USD" class="text-xs hint mt-0.5">‚âà ‚Äì USD</div>
            <div class="hint text-xs mt-2">KDV Hari√ß (‚àí%20)</div>
            <div id="kpiInvPrice_exVAT" class="text-sm font-medium text-slate-800 dark:text-slate-100">‚Äì</div>
            <div id="kpiInvPrice_exVAT_USD" class="text-xs hint mt-0.5">‚âà ‚Äì USD</div>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">MoM Deƒüi≈üim <span id="momNote" class="text-xs"></span></div>
          <div id="kpiMoM" class="text-xl md:text-2xl font-semibold">‚Äì</div>
        </div>

        <div>
          <div class="hint text-sm mb-1">Uyarƒ±lar</div>
          <ul id="alertsList" class="text-sm text-slate-700 dark:text-slate-200 space-y-1">
            <li class="hint">Hen√ºz veri yok.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Haftalƒ±k Mini Kartlar -->
    <section class="glass card-3d rounded-3xl p-4 sm:p-5" data-page="summary">
      <div class="flex items-center justify-between gap-2 sm:gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-base sm:text-lg font-medium flex items-center gap-2 sm:gap-3">
          Haftalƒ±k G√∂r√ºn√ºm
          <span id="weekLabel" class="badge text-xs"></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="weekPrev" class="glass card-3d px-3 py-2 rounded-xl text-sm">‚óÄÔ∏é</button>
          <button id="weekNext" class="glass card-3d px-3 py-2 rounded-xl text-sm">‚ñ∂Ô∏é</button>
        </div>
      </div>
      <div id="weekCards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 sm:gap-3 mt-3"></div>
      <div id="weekWoW" class="hint text-xs mt-2"></div>
      <div class="mt-3 sm:mt-4">
        <div class="text-slate-700 dark:text-slate-200 text-sm font-medium">Son 7 G√ºn √ñzeti</div>
        <div id="last7Wrap" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 sm:gap-3 mt-2"></div>
        <div id="last7Note" class="hint text-xs mt-1"></div>
      </div>
    </section>

    <!-- Aylƒ±k G√∂r√ºn√ºm -->
    <section class="glass card-3d rounded-3xl p-4 sm:p-5 mt-4" data-page="summary">
      <details open>
        <summary class="cursor-pointer text-slate-700 dark:text-slate-200 text-base sm:text-lg font-medium flex items-center gap-2 sm:gap-3">
          Aylƒ±k G√∂r√ºn√ºm
          <span id="monthYearLabel" class="badge text-xs"></span>
        </summary>
        <div id="monthCards" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 sm:gap-3 mt-3"></div>
        <div id="monthMoM" class="hint text-xs mt-2"></div>
      </details>
    </section>

    <!-- === Krediler & Bekleyen √ñdemeler === -->
    <section id="loansBlock" class="glass card-3d rounded-3xl p-5 mt-6" data-page="expenses">
      <div class="flex items-center justify-between mb-3">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium flex items-center gap-2">
          üí≥ Krediler & Bekleyen √ñdemeler
        </div>
        <div class="flex items-center gap-3">
          <span class="hint text-xs">Kaynak: localStorage (popdog_loans_state)</span>
        </div>
      </div>
    
      <!-- √º√ß kredi -->
      <div class="grid md:grid-cols-3 gap-4">
        <!-- Taksitli Ticari Kredi -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Taksitli Ticari Kredi</div>
            <span id="loanBizPaidBadge" class="badge">5/24</span>
          </div>
          <div class="mt-1 text-sm hint">√ñdenecek Taksitler Toplamƒ±: <span id="loanBizRemain" class="font-medium">‚Äì</span></div>
          <div class="mt-1 text-sm">Taksit Tutarƒ±: <span id="loanBizInst" class="font-semibold">‚Äì</span></div>
          <div class="mt-1 text-xs hint">Kredi Tutarƒ±: <span id="loanBizPrincipal">‚Äì</span> ‚Ä¢ Aylƒ±k Faiz: <span id="loanBizRate">‚Äì</span></div>
          <div class="progress-wrap mt-2"><div id="loanBizBar" class="progress-bar" style="width:0%"></div></div>
        </div>
    
        <!-- Taksitli Ara√ß Kredisi -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Taksitli Ara√ß Kredisi</div>
            <span id="loanCarPaidBadge" class="badge">9/24</span>
          </div>
          <div class="mt-1 text-sm hint">√ñdenecek Taksitler Toplamƒ±: <span id="loanCarRemain" class="font-medium">‚Äì</span></div>
          <div class="mt-1 text-sm">Taksit Tutarƒ±: <span id="loanCarInst" class="font-semibold">‚Äì</span></div>
          <div class="mt-1 text-xs hint">Kredi Tutarƒ±: <span id="loanCarPrincipal">‚Äì</span> ‚Ä¢ Aylƒ±k Faiz: <span id="loanCarRate">‚Äì</span></div>
          <div class="progress-wrap mt-2"><div id="loanCarBar" class="progress-bar" style="width:0%"></div></div>
        </div>

          <!-- Taksitli Ticari Kredi 2 -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Taksitli Ticari Kredi 2</div>
            <span id="loanBiz2PaidBadge" class="badge">0/24</span>
          </div>
          <div class="mt-1 text-sm hint">
            √ñdenecek Taksitler Toplamƒ±:
            <span id="loanBiz2Remain" class="font-medium">1714868,61‚Ç∫</span>
          </div>
          <div class="mt-1 text-sm">
            Taksit Tutarƒ±:
            <span id="loanBiz2Inst" class="font-semibold">71452,86‚Ç∫</span>
          </div>
          <div class="mt-1 text-xs hint">
            Kredi Tutarƒ±:
            <span id="loanBiz2Principal">1714868,61‚Ç∫</span>
            ‚Ä¢ Aylƒ±k Faiz: <span id="loanBiz2Rate">‚Äì</span>
          </div>
          <div class="progress-wrap mt-2">
            <div id="loanBiz2Bar" class="progress-bar" style="width:0%"></div>
          </div>
        </div>
      </div>

            
    
      <!-- Zee.Dog Bekleyen √ñdemeler -->
      <div class="mt-5 rounded-2xl p-4 card-glass-pro">
        <div class="flex items-center justify-between">
          <div class="font-medium">Zee.Dog Bekleyen √ñdemeler</div>
          <div class="hint text-xs">USD ‚Üí TRY √ßeviri i√ßin KPI'dan t√ºretilen kur kullanƒ±lƒ±r</div>
        </div>
        <div class="overflow-auto mt-2">
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left py-1 pr-3">ID</th>
                <th class="text-right py-1 pr-3">Toplam (USD)</th>
                <th class="text-right py-1 pr-3">√ñdenen (USD)</th>
                <th class="text-right py-1 pr-3">Kalan (USD)</th>
                <th class="text-left py-1 pr-0">Durum</th>
              </tr>
            </thead>
            <tbody id="tblZeeAwait" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    
      <!-- Demo≈ü Bank -->
      <div class="mt-5 grid md:grid-cols-2 gap-4">
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Demo≈ü Bank ‚Äî Altƒ±n Bor√ß</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Gram Fiyatƒ± (TRY)</span>
              <input id="goldGramInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="√∂rn. 2900">
            </div>
          </div>
          <div class="mt-1 text-sm">Miktar: <strong>169 gr</strong></div>
          <div class="mt-1 text-sm">Toplam (‚âà): <span id="goldTotal" class="font-semibold">‚Äì</span></div>
          <div class="hint text-xs mt-1" id="goldNote"></div>
        </div>
    
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">QNB Portf√∂y Para Piyasasƒ± (FI5)</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Birim Fiyatƒ± (TRY)</span>
              <input id="fi5UnitInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="√∂rn. 1,0198">
            </div>
          </div>
          <div class="mt-1 text-sm">Adet: <strong>565</strong></div>
          <div class="mt-1 text-sm">Toplam (‚âà): <span id="fi5Total" class="font-semibold">‚Äì</span></div>
          <div class="hint text-xs mt-1" id="fi5Note"></div>
        </div>

        <!-- Ak Portf√∂y SAS -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Ak Portf√∂y Sabancƒ± Topluluƒüu ≈ûirketleri (SAS)</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Birim Fiyatƒ± (TRY)</span>
              <input id="sasUnitInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="√∂rn. 1,0321">
            </div>
          </div>
          <div class="mt-1 text-sm">Adet: <strong>114236</strong></div>
          <div class="mt-1 text-sm">Toplam (‚âà): <span id="sasTotal" class="font-semibold">‚Äì</span></div>
          <div class="hint text-xs mt-1" id="sasNote"></div>
        </div>

        <!-- ƒ∞≈ü Portf√∂y ƒ∞≈ütirakler -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">ƒ∞≈ü Portf√∂y ƒ∞≈ü Bankasƒ± ƒ∞≈ütirakleri (ƒ∞≈ûY)</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Birim Fiyatƒ± (TRY)</span>
              <input id="isyUnitInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="√∂rn. 1,5267">
            </div>
          </div>
          <div class="mt-1 text-sm">Adet: <strong>2530000</strong></div>
          <div class="mt-1 text-sm">Toplam (‚âà): <span id="isyTotal" class="font-semibold">‚Äì</span></div>
          <div class="hint text-xs mt-1" id="isyNote"></div>
        </div>
      </div>
    </section>

    <!-- Charts -->
<!-- Ciro (Grafiksiz) -->
<div class="grid grid-cols-1 gap-6" data-page="revenue">
  <div class="glass card-3d rounded-3xl p-5">
    <div class="flex items-center justify-between mb-2 gap-3 flex-wrap">
      <div class="text-slate-700 dark:text-slate-200">Aylƒ±k Toplam Ciro</div>
      <div class="flex items-center gap-2">
        <span class="hint text-xs">Yƒ±l:</span>
        <select id="revYearSel" class="glass rounded-xl px-2 py-1 text-sm">
          <option value="all">T√ºm√º</option>
        </select>
      </div>
    </div>
    <div id="lineTotalTblWrap"></div>
  </div>

  <div class="glass card-3d rounded-3xl p-5">
    <div class="flex items-center justify-between mb-2">
      <div class="text-slate-700 dark:text-slate-200">Kanal Bazlƒ± Aylƒ±k Ciro</div>
    </div>
    <div id="barStackTblWrap"></div>
  </div>

  <div class="glass card-3d rounded-3xl p-5">
    <div class="flex items-center justify-between mb-2 gap-3 flex-wrap">
      <div class="text-slate-700 dark:text-slate-200">Kuaf√∂r Aylƒ±k Toplam</div>
      <div class="hint text-xs">(Ciro sheet‚Äôteki ‚ÄúKuaf√∂r‚Äù s√ºtunundan)</div>
    </div>
    <div id="groomMonthlyTblWrap"></div>
  </div>
</div>

    <!-- === Expenses (CFO) === -->
    <section class="glass card-3d rounded-3xl p-5 mt-6" data-page="expenses">
      <div class="flex items-center justify-between mb-3">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">Giderler (YTD) & Net K√¢r</div>
        <div class="flex items-center gap-3">
          <span class="chip-ios text-xs" title="Giderler YoY ge√ßi≈üi" id="expYoyToggle">
            <span class="label">YoY</span>
            <span id="expYoyState" class="val">A√ßƒ±k</span>
          </span>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4 items-stretch">
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Toplam Gider (YTD)</div>
          <div id="kpiExpYTD" class="text-xl md:text-2xl font-semibold">‚Äì</div>
          <div id="kpiExpYTD_USD" class="text-xs hint mt-0.5">‚âà ‚Äì USD</div>
          <div id="kpiExpYoY" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Net K√¢r (YTD)</div>
          <div id="kpiNetYTD" class="text-xl md:text-2xl font-semibold">‚Äì</div>
          <div id="kpiNetYTD_USD" class="text-xs hint mt-0.5">‚âà ‚Äì USD</div>
          <div id="kpiNetNote" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Gider MoM</div>
          <div id="kpiExpMoM" class="text-xl md:text-2xl font-semibold">‚Äì</div>
          <div id="kpiExpMoMNote" class="text-xs hint mt-1"></div>
        </div>
      </div>

      <div class="grid lg:grid-cols-1 gap-4 mt-4">
        <div class="glass card-3d rounded-2xl p-3">
          <details class="expenses-compact">
            <summary class="cursor-pointer flex items-center justify-between mb-2">
              <div class="text-slate-700 dark:text-slate-200 text-sm font-medium">Aylƒ±k Giderler <span class="hint text-xs">(tƒ±kla: a√ß/kapat)</span></div>
            </summary>
            <div id="expensesMonthlyTblWrap" class="max-h-64 overflow-auto"></div>
          </details>
        </div>
      </div>
      <!-- Gider Ekle ‚Äî Hƒ±zlƒ± Form -->
      <div class="glass card-3d card-glass-pro rounded-2xl p-3 sm:p-4 mt-4" data-page="expenses">
        <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
          <div class="text-slate-700 dark:text-slate-200 text-base sm:text-lg font-medium flex items-center gap-2">
            <span aria-hidden="true">üßæ</span>
            Aylƒ±k Gider Ekle
          </div>
          <span class="soft-badge text-xs">Veri: expenses_master</span>
        </div>

        <div class="grid sm:grid-cols-4 gap-2 sm:gap-3 items-end">
          <div>
            <label class="hint text-xs block mb-1">Tarih</label>
            <input id="expDate" type="date"
                   class="input-pro"
                   title="Tarih se√ßin">
          </div>
          <div class="sm:col-span-2">
            <label class="hint text-xs block mb-1">Alt Kategori</label>
            <select id="expSubSel" class="input-pro">
              <option value="">Y√ºkleniyor‚Ä¶</option>
            </select>
          </div>
          <div>
            <label class="hint text-xs block mb-1">Tutar (‚Ç∫)</label>
            <input id="expAmount" type="text" inputmode="decimal" placeholder="√∂r. 12.345,67"
                   class="input-pro">
          </div>
        </div>

        <hr class="hidden lg:block my-4 border-t border-dashed border-slate-300/60 dark:border-slate-600/50">

        <div class="grid sm:grid-cols-4 gap-3 items-end mt-3">
          <div class="sm:col-span-3">
            <label class="hint text-xs block mb-1">Not (opsiyonel)</label>
            <input id="expNote" type="text" class="input-pro" placeholder="a√ßƒ±klama‚Ä¶">
          </div>
          <div>
            <button id="expAddBtn" class="btn-primary w-full rounded-2xl">Gideri Ekle</button>
          </div>
        </div>

        <div id="expAddInfo" class="hint text-xs mt-2 pt-2 border-t border-white/50 dark:border-slate-700/40">Alt kategoriler CSV‚Äôden √ßekiliyor‚Ä¶</div>
      </div>
      <div class="grid lg:grid-cols-2 gap-4 mt-4">
        <div class="glass card-3d rounded-2xl p-4">
          <div class="text-slate-700 dark:text-slate-200 mb-2">Ana Kategoriler (YTD) ‚Äî Detay</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left py-1 pr-3">Kategori</th>
                  <th class="text-right py-1 pr-3">Tutar</th>
                  <th class="text-right py-1 pr-0">Pay</th>
                </tr>
              </thead>
              <tbody id="tblMainExpensesDetail" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
        <div class="glass card-3d rounded-2xl p-4">
          <div class="text-slate-700 dark:text-slate-200 mb-2">Ana Kategoriler (YTD) ‚Äî Gruplanmƒ±≈ü</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left py-1 pr-3">Kategori</th>
                  <th class="text-right py-1 pr-3">Tutar</th>
                  <th class="text-right py-1 pr-0">Pay</th>
                </tr>
              </thead>
              <tbody id="tblMainExpensesGrouped" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Bu Ayƒ±n Giderleri (Kategori + Alt Kategori) - Kompakt -->
      <div class="glass card-3d rounded-2xl p-3 mt-4">
        <details class="expenses-compact">
          <summary class="cursor-pointer flex items-center justify-between mb-2">
            <div class="text-slate-700 dark:text-slate-200 text-sm font-medium">Bu Ayƒ±n Giderleri <span class="hint text-xs">(tƒ±kla: a√ß/kapat)</span></div>
            <div class="text-right">
              <div id="expThisMonthTotal" class="text-xs font-medium text-slate-700 dark:text-slate-200">‚Äì</div>
              <div id="expThisMonthMoM" class="hint text-[10px]">MoM: ‚Äì</div>
            </div>
          </summary>
          <div class="overflow-auto max-h-48">
            <table class="min-w-full text-xs">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left py-1 pr-2">Tarih</th>
                  <th class="text-left py-1 pr-2">Kategori</th>
                  <th class="text-left py-1 pr-2">Alt Kat.</th>
                  <th class="text-right py-1 pr-0">Tutar</th>
                </tr>
              </thead>
              <tbody id="tblExpThisMonth" class="text-slate-800 dark:text-slate-100">
                <tr><td class="hint py-2" colspan="4">Y√ºkleniyor‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </details>
      </div>
      <!-- Bu Ay ‚Äî Kategori Altƒ±nda √ñdemeler - Kompakt -->
      <div class="glass card-3d rounded-2xl p-3 mt-4">
        <details class="expenses-compact">
          <summary class="cursor-pointer flex items-center justify-between mb-2">
            <div class="text-slate-700 dark:text-slate-200 text-sm font-medium">Bu Ay ‚Äî Kategori Kƒ±rƒ±lƒ±mƒ± <span class="hint text-xs">(tƒ±kla: a√ß/kapat)</span></div>
            <div id="expByCatTotal" class="text-xs font-medium text-slate-700 dark:text-slate-200">‚Äì</div>
          </summary>
          <div id="expThisMonthByCat" class="text-xs max-h-48 overflow-auto"></div>
        </details>
      </div>
    </section>

    <!-- Satƒ±≈ü / Devir Listeleri -->
    <div class="mt-6 sales-turnover" data-page="stock">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-base font-medium">Satƒ±≈ü &amp; Devir Listeleri</div>
        <div class="flex items-center gap-3">
          <label for="salesWindowSelect" class="hint text-xs">Pencere:</label>
          <select id="salesWindowSelect" class="glass rounded-xl px-2 py-1 text-sm">
            <option value="30">30 g√ºn</option>
            <option value="90">90 g√ºn</option>
            <option value="120">120 g√ºn</option>
            <option value="180">180 g√ºn</option>
          </select>
          <div id="stockExtraNote" class="hint text-xs"></div>
        </div>
      </div>
      <div class="mt-3 grid md:grid-cols-2 gap-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">En √ßok satan 5 √ºr√ºn</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">Satƒ±lan (adet)</th></tr>
            </thead>
            <tbody id="tblTopSellers" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">En az satan 5 √ºr√ºn</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">Satƒ±lan (adet)</th></tr>
            </thead>
            <tbody id="tblLeastSellers" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">Stoƒüu en hƒ±zlƒ± giden 5 √ºr√ºn</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">Adet/g√ºn</th><th class="text-right py-1 pr-3">On-hand</th></tr>
            </thead>
            <tbody id="tblFastestMoving" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">Stokta en uzun s√ºredir kalan 5 √ºr√ºn</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">Ya≈ü (g√ºn)</th><th class="text-right py-1 pr-3">On-hand</th></tr>
            </thead>
            <tbody id="tblMostStale" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- === Stock Block: KPI + Tablolar === -->
    <section id="stockBlock" class="glass card-3d rounded-3xl p-5" data-page="stock">
      <!-- Header with search and export -->
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="flex items-center gap-3">
          <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">Stok √ñzeti</div>
          <div class="hint text-xs" id="stockLastUpdate">Son g√ºncelleme: ‚Äì</div>
        </div>
        <div class="flex items-center gap-2">
          <input type="text" id="stockSearchInput" placeholder="SKU veya √ºr√ºn ara..." class="glass rounded-xl px-3 py-1 text-sm w-40 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <button id="stockExportBtn" class="glass card-3d px-3 py-1 rounded-xl text-xs hover:bg-slate-200 dark:hover:bg-slate-700" title="CSV olarak indir">üì• Export</button>
        </div>
      </div>

      <!-- Stok Deƒüeri √ñzet Kartlarƒ± (Ana) -->
      <div class="grid md:grid-cols-4 gap-4 mt-4">
        <div class="glass rounded-2xl p-4 border-l-4 border-blue-500">
          <div class="hint text-xs">Toplam Stok Deƒüeri (Maliyet)</div>
          <div class="text-slate-800 dark:text-slate-100 text-xl font-bold" id="kpiInvCost">‚Äì</div>
          <div class="hint text-xs" id="kpiInvCost_USD">‚âà ‚Äì USD</div>
        </div>
        <div class="glass rounded-2xl p-4 border-l-4 border-green-500">
          <div class="hint text-xs">Toplam Stok Deƒüeri (Satƒ±≈ü)</div>
          <div class="text-slate-800 dark:text-slate-100 text-xl font-bold" id="kpiInvPrice">‚Äì</div>
          <div class="hint text-xs" id="kpiInvPrice_USD">‚âà ‚Äì USD</div>
        </div>
        <div class="glass rounded-2xl p-4 border-l-4 border-purple-500">
          <div class="hint text-xs">Maliyet +%65 (Vergi+Navlun)</div>
          <div class="text-slate-800 dark:text-slate-100 text-xl font-bold" id="kpiInvCost_65">‚Äì</div>
          <div class="hint text-xs" id="kpiInvCost_65_USD">‚âà ‚Äì USD</div>
        </div>
        <div class="glass rounded-2xl p-4 border-l-4 border-orange-500">
          <div class="hint text-xs">Satƒ±≈ü KDV Hari√ß (‚àí%20)</div>
          <div class="text-slate-800 dark:text-slate-100 text-xl font-bold" id="kpiInvPrice_exVAT">‚Äì</div>
          <div class="hint text-xs" id="kpiInvPrice_exVAT_USD">‚âà ‚Äì USD</div>
        </div>
      </div>

      <!-- Kategori Bazlƒ± √ñzet -->
      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">üêï Zee Dog</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiCatZee">‚Äì adet</div>
          <div class="hint text-xs" id="kpiCatZeeVal">‚Ç∫‚Äì</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">üê∂ Pop Dog</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiCatPop">‚Äì adet</div>
          <div class="hint text-xs" id="kpiCatPopVal">‚Ç∫‚Äì</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">üì¶ Diƒüer</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiCatOther">‚Äì adet</div>
          <div class="hint text-xs" id="kpiCatOtherVal">‚Ç∫‚Äì</div>
        </div>
      </div>

      <!-- Ek KPI'lar -->
      <div class="grid md:grid-cols-5 gap-4 mt-4">
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Stok Devir Hƒ±zƒ±</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiTurnover">‚Äì</div>
          <div class="hint text-[10px]">Yƒ±llƒ±k satƒ±≈ü / ort. stok</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">90+ g√ºn elde</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiAged90Value">‚Äì</div>
          <div class="hint text-xs" id="kpiAged90Qty">‚Äì adet</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Dead Stock (180+)</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold text-red-600 dark:text-red-400" id="kpiDeadStock">‚Äì</div>
          <div class="hint text-xs" id="kpiDeadStockQty">‚Äì adet</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Median Stok Ya≈üƒ±</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiMedianAge">‚Äì g√ºn</div>
        </div>
        <div class="glass rounded-2xl p-3" title="DIO: Days of Inventory">
          <div class="hint text-xs">DIO (60g)</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiDIO60">‚Äì g√ºn</div>
          <div class="hint text-[11px]" id="kpiDIOx">30g: ‚Äì ‚Ä¢ 90g: ‚Äì</div>
        </div>
      </div>

      <!-- Toplam √úr√ºn Adedi -->
      <div class="grid md:grid-cols-1 gap-4 mt-4">
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Toplam √úr√ºn Adedi (depo bazƒ±nda)</div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiTotalUnits">‚Äì adet</div>
          <div class="hint text-xs" id="kpiTotalUnitsNote">Thrones: ‚Äì ‚Ä¢ Caddebostan: ‚Äì</div>
        </div>
      </div>

      <!-- Stok Ya≈ülandƒ±rma Bar Chart -->
      <div class="mt-4 glass rounded-2xl p-4">
        <div class="hint text-sm mb-3">Stok Ya≈ülandƒ±rma Daƒüƒ±lƒ±mƒ± (adet bazƒ±nda)</div>
        <div class="flex items-end gap-2 h-32" id="agingChartBars">
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full bg-green-500 rounded-t transition-all" id="agingBar0_30" style="height:0%"></div>
            <div class="hint text-[10px] mt-1">0-30g</div>
            <div class="text-xs font-medium" id="agingLbl0_30">‚Äì</div>
          </div>
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full bg-yellow-500 rounded-t transition-all" id="agingBar31_60" style="height:0%"></div>
            <div class="hint text-[10px] mt-1">31-60g</div>
            <div class="text-xs font-medium" id="agingLbl31_60">‚Äì</div>
          </div>
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full bg-orange-500 rounded-t transition-all" id="agingBar61_90" style="height:0%"></div>
            <div class="hint text-[10px] mt-1">61-90g</div>
            <div class="text-xs font-medium" id="agingLbl61_90">‚Äì</div>
          </div>
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full bg-red-500 rounded-t transition-all" id="agingBar90plus" style="height:0%"></div>
            <div class="hint text-[10px] mt-1">90+g</div>
            <div class="text-xs font-medium" id="agingLbl90plus">‚Äì</div>
          </div>
        </div>
        <div class="hint text-[10px] mt-2 text-center" id="agingChartNote">Toplam: ‚Äì adet</div>
      </div>

      <!-- ABC Analizi -->
      <div class="mt-4 glass rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="hint text-sm">ABC Analizi (Satƒ±≈ü Deƒüerine G√∂re)</div>
          <div class="hint text-[10px]">A: %80 satƒ±≈ü, B: %15, C: %5</div>
        </div>
        <div class="grid md:grid-cols-3 gap-3">
          <div class="bg-green-100 dark:bg-green-900/30 rounded-xl p-3">
            <div class="flex items-center justify-between">
              <span class="text-green-700 dark:text-green-400 font-bold text-lg">A</span>
              <span class="hint text-xs">Y√ºksek √∂ncelik</span>
            </div>
            <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiAbcA">‚Äì SKU</div>
            <div class="hint text-xs" id="kpiAbcAVal">‚Ç∫‚Äì (%‚Äì)</div>
          </div>
          <div class="bg-yellow-100 dark:bg-yellow-900/30 rounded-xl p-3">
            <div class="flex items-center justify-between">
              <span class="text-yellow-700 dark:text-yellow-400 font-bold text-lg">B</span>
              <span class="hint text-xs">Orta √∂ncelik</span>
            </div>
            <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiAbcB">‚Äì SKU</div>
            <div class="hint text-xs" id="kpiAbcBVal">‚Ç∫‚Äì (%‚Äì)</div>
          </div>
          <div class="bg-red-100 dark:bg-red-900/30 rounded-xl p-3">
            <div class="flex items-center justify-between">
              <span class="text-red-700 dark:text-red-400 font-bold text-lg">C</span>
              <span class="hint text-xs">D√º≈ü√ºk √∂ncelik</span>
            </div>
            <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiAbcC">‚Äì SKU</div>
            <div class="hint text-xs" id="kpiAbcCVal">‚Ç∫‚Äì (%‚Äì)</div>
          </div>
        </div>
      </div>

      <!-- Reorder Point Uyarƒ±larƒ± -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto border-l-4 border-yellow-500">
          <div class="flex items-center justify-between mb-2">
            <div class="hint text-sm">‚ö†Ô∏è Sipari≈ü Verilmesi Gereken √úr√ºnler</div>
            <div class="hint text-[10px]">Lead time: 45 g√ºn + Safety stock: 7 g√ºn</div>
          </div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left py-2 pr-4">SKU</th>
                <th class="text-left py-2 pr-4">Title</th>
                <th class="text-right py-2 pr-4">On-hand</th>
                <th class="text-right py-2 pr-4">G√ºnl√ºk hƒ±z</th>
                <th class="text-right py-2 pr-4">Reorder Point</th>
                <th class="text-right py-2 pr-4">√ñnerilen Sipari≈ü</th>
              </tr>
            </thead>
            <tbody id="tblReorderPoint" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>

      <!-- Tablolar -->
      <div class="mt-4 grid lg:grid-cols-2 gap-4">
        <div>
          <div class="hint text-sm mb-1">‚Ç∫ maliyet bazƒ±nda en y√ºksek 10 SKU</div>
          <div class="overflow-auto max-h-80">
            <table class="min-w-full text-sm" id="tblTopStockTable">
              <thead class="text-slate-600 dark:text-slate-300 sticky top-0 bg-white/80 dark:bg-slate-800/80">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">Value @Cost</th>
                  <th class="text-right py-2 pr-4">Son Satƒ±≈ü</th>
                  <th class="text-right py-2 pr-4">Ya≈ü (g√ºn)</th>
                </tr>
              </thead>
              <tbody id="tblTopStock" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="hint text-sm mb-1">90+ g√ºn elde (‚Ç∫ bazƒ±nda ilk 10)</div>
          <div class="overflow-auto max-h-80">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300 sticky top-0 bg-white/80 dark:bg-slate-800/80">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">Value @Cost</th>
                  <th class="text-right py-2 pr-4">Son Satƒ±≈ü</th>
                  <th class="text-right py-2 pr-4">Ya≈ü (g√ºn)</th>
                </tr>
              </thead>
              <tbody id="tblAged90" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Dead Stock Tablosu (180+ g√ºn) -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto border-l-4 border-red-500">
          <div class="hint text-sm mb-1">üíÄ Dead Stock (180+ g√ºn satƒ±≈ü yok)</div>
          <div class="overflow-auto max-h-60">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300 sticky top-0 bg-white/80 dark:bg-slate-800/80">
                <tr>
                  <th class="text-left py-2 pr-4">SKU</th>
                  <th class="text-left py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">Value @Cost</th>
                  <th class="text-right py-2 pr-4">Son Satƒ±≈ü</th>
                  <th class="text-right py-2 pr-4">Ya≈ü (g√ºn)</th>
                </tr>
              </thead>
              <tbody id="tblDeadStock" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Stokout Risk (‚â§14 g√ºn) -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto border-l-4 border-orange-500">
          <div class="hint text-sm mb-1">üî• Stokout Riski (‚â§14 g√ºn) ‚Äî Pencere: <span id="riskWindowLbl" class="badge"></span></div>
          <div class="overflow-auto max-h-60">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300 sticky top-0 bg-white/80 dark:bg-slate-800/80">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">G√ºnl√ºk hƒ±z</th>
                  <th class="text-right py-2 pr-4">Kalan g√ºn</th>
                </tr>
              </thead>
              <tbody id="tblStockoutRisk" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Largest Stock (Top 25) -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">üì¶ Stoƒüu En Fazla Olan (Top 25)</div>
          <div class="overflow-auto max-h-60">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300 sticky top-0 bg-white/80 dark:bg-slate-800/80">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                </tr>
              </thead>
              <tbody id="tblLargestStock" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- G√ºnl√ºk Rapor Yapƒ±≈ütƒ±r -->
    <section class="glass card-3d rounded-3xl p-5" data-page="revenue">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">G√ºnl√ºk Rapor Yapƒ±≈ütƒ±r ‚Üí Satƒ±r Ekle</div>
        <div class="hint text-sm">Format: Tarih, Kredi Kartƒ±, QNB/ƒ∞≈ü/Garanti, Nakit, Toplam, Kasa Nakit, Pop Dog Online, Pop Dog Toptan, Trendyol, Hepsiburada</div>
      </div>
      <textarea id="dailyText" class="w-full mt-3 rounded-2xl border p-3 focus:outline-none bg-white/70 dark:bg-slate-800 dark:text-slate-100" rows="6" placeholder="WhatsApp raporunu yapƒ±≈ütƒ±r..."></textarea>
      <div class="mt-3 flex items-center gap-3">
        <button id="parseAddBtn" class="glass card-3d px-4 py-2 rounded-2xl">Satƒ±ra √ßevir ve ekle</button>
        <button id="pushRowsBtn" class="glass card-3d px-4 py-2 rounded-2xl">Sheet‚Äôe Yaz</button>
        <span id="parseInfo" class="hint text-sm"></span>
      </div>

      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-600 dark:text-slate-300">
            <tr>
              <th class="text-left py-2 pr-4">Date</th>
              <th class="text-right py-2 pr-4">Toptan</th>
              <th class="text-right py-2 pr-4">Online</th>
              <th class="text-right py-2 pr-4">CKM</th>
              <th class="text-right py-2 pr-4">Kuaf√∂r</th>
              <th class="text-right py-2 pr-4">CKM Nakit</th>
              <th class="text-right py-2 pr-4">Kasa Nakit (EoD)</th>
              <th class="text-right py-2 pr-4">Trendyol</th>
              <th class="text-right py-2 pr-4">Hepsiburada</th>
              <th class="text-right py-2 pr-4">Total</th>
            </tr>
          </thead>
          <tbody id="stagedTbody" class="text-slate-800 dark:text-slate-100"></tbody>
        </table>
      </div>
    </section>

    <!-- Targets -->
    <section class="glass card-3d rounded-3xl p-4" data-page="revenue">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-base font-medium">Aylƒ±k Hedefler (YTD ortalama)</div>
        <div class="hint text-xs">Her ay: aynƒ± yƒ±l o aya kadar ortalama</div>
      </div>
      <div class="grid sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-1 mt-2" id="targetsWrap"></div>
    </section>

  </div><!-- /mainContent -->

  <!-- PIN Lock Script -->
  <script>
  (function(){
    const CORRECT_PIN = '1958';
    const PIN_SESSION_KEY = 'popdog_pin_verified';

    // Check if already verified in this session
    if (sessionStorage.getItem(PIN_SESSION_KEY) === 'true') {
      document.getElementById('pinOverlay').classList.add('hidden');
      document.getElementById('mainContent').style.display = '';
      return;
    }

    const inputs = document.querySelectorAll('.pin-input input');
    const errorEl = document.getElementById('pinError');

    // Focus first input on load
    inputs[0].focus();

    // Handle input
    inputs.forEach((input, idx) => {
      input.addEventListener('input', (e) => {
        const val = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = val;

        // Clear error state
        inputs.forEach(i => i.classList.remove('error'));
        errorEl.textContent = '';

        // Move to next input
        if (val && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        }

        // Check if all filled
        const pin = Array.from(inputs).map(i => i.value).join('');
        if (pin.length === 4) {
          if (pin === CORRECT_PIN) {
            // Success
            sessionStorage.setItem(PIN_SESSION_KEY, 'true');
            document.getElementById('pinOverlay').style.opacity = '0';
            document.getElementById('pinOverlay').style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
              document.getElementById('pinOverlay').classList.add('hidden');
              document.getElementById('mainContent').style.display = '';
            }, 300);
          } else {
            // Error
            inputs.forEach(i => {
              i.classList.add('error');
              i.value = '';
            });
            errorEl.textContent = 'Yanlƒ±≈ü PIN kodu';
            inputs[0].focus();
          }
        }
      });

      // Handle backspace
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) {
          inputs[idx - 1].focus();
        }
      });

      // Handle paste
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g, '').slice(0, 4);
        paste.split('').forEach((char, i) => {
          if (inputs[i]) inputs[i].value = char;
        });
        if (paste.length === 4) {
          inputs[3].dispatchEvent(new Event('input'));
        } else if (paste.length > 0) {
          inputs[Math.min(paste.length, 3)].focus();
        }
      });
    });
  })();
  </script>

  <script>
    // Simple page router (hide/show data-page sections)
    (function(){
      const KEY = 'popdog_active_page';
      const $all = () => Array.from(document.querySelectorAll('[data-page]'));
      function showPage(key){
        $all().forEach(el => {
          if (el.dataset.page === key) el.classList.remove('hidden');
          else el.classList.add('hidden');
        });
        try{ localStorage.setItem(KEY, key); }catch(e){}
        // set active button look (optional subtle bold)
        ['navSummary','navRevenue','navExpenses','navStock'].forEach(id=>{
          const b = document.getElementById(id);
          if(!b) return;
          const k = id.replace('nav','').toLowerCase();
          if((k==='summary' && key==='summary') || (k==='revenue' && key==='revenue') || (k==='expenses' && key==='expenses') || (k==='stock' && key==='stock')){
            b.classList.add('ring-1','ring-indigo-400');
          } else {
            b.classList.remove('ring-1','ring-indigo-400');
          }
        });
      }
      window.showPage = showPage;
      // Bind buttons
      const btnMap = [
        ['navSummary','summary'],
        ['navRevenue','revenue'],
        ['navExpenses','expenses'],
        ['navStock','stock']
      ];
      btnMap.forEach(([id,key])=>{
        const b = document.getElementById(id);
        if(b) b.onclick = ()=> showPage(key);
      });
      // Initial
      const start = (function(){ try{ return localStorage.getItem(KEY) || 'summary'; }catch(e){ return 'summary'; } })();
      showPage(start);
    })();
  </script>
  </div>

<script>

/* ================== CONFIG ================== */
/* Apps Script Web App URL‚Äôin (write-to-sheet i√ßin) */
const SHEET_WEBAPP_URL = (()=>{
  try{
    const u = localStorage.getItem('popdog_sheet_webapp_url');
    if (u && /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(u)) return u;
  }catch(_){}
  // Safe fallback (no editor markup)
  try { localStorage.setItem('popdog_sheet_webapp_url', 'https://script.google.com/macros/s/AKfycbzvuXYbQuYMp3E-NGYjjea3RFhR9_NuwVK8hKu0iVO40gEK_qJtZ-BSyyr17PjdBEuP/exec'); } catch(_){}
  return 'https://script.google.com/macros/s/AKfycbzvuXYbQuYMp3E-NGYjjea3RFhR9_NuwVK8hKu0iVO40gEK_qJtZ-BSyyr17PjdBEuP/exec';
})();

// Always read the latest URL from localStorage at call time
function getSheetWebAppURL(){
  try{
    const u = localStorage.getItem('popdog_sheet_webapp_url');
    if (u && /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(u)) return u;
  }catch(_){ }
  return SHEET_WEBAPP_URL; // boot-time fallback
}

async function fetchFundQuote(code){
  const base = getSheetWebAppURL();
  if (!base || typeof base !== 'string' || !/^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(base)){
    throw new Error('INVALID_WEBAPP_URL');
  }

  const upper = String(code||'').toUpperCase();
  const shortcut = { FI5:'fi5Quote', SAS:'sasQuote', TI3:'isyQuote' }[upper] || '';

  // Small helper: fetch and try to parse JSON safely (don‚Äôt throw on 200/HTML bodies)
  async function request(url, opts){
    const ctrl = new AbortController();
    const id = setTimeout(()=> ctrl.abort(), 12000); // a bit more lenient
    try{
      const res = await fetch(url, { cache:'no-store', ...opts, signal: ctrl.signal });
      const text = await res.text().catch(()=> '');
      let json = null;
      // Try JSON only if it looks like JSON
      try{ json = JSON.parse(text); }catch(_){ json = null; }
      return { status: res.status, ok: res.ok, json, raw: text };
    }catch(err){
      return { status: 0, ok:false, json:null, raw: (err && err.name==='AbortError') ? 'TIMEOUT' : 'LOAD_FAILED' };
    }finally{ clearTimeout(id); }
  }

  // Normalize a potential quote-shaped object
  function normalizeQuote(j){
    if (!j || typeof j !== 'object') return null;
    const unit = (j.unitTRY!=null) ? Number(j.unitTRY) : NaN;
    if (j.ok && unit>0) return { ok:true, code: (j.code||upper), unitTRY: unit, source: j.source||'' };
    return null;
  }

  // Try a sequence of GET endpoints first (some deploys only allow GET)
  const getURLs = [
    `${base}?action=fundQuote&code=${encodeURIComponent(upper)}&t=${Date.now()}`,
    `${base}?code=${encodeURIComponent(upper)}&action=fundQuote&t=${Date.now()}`,
  ];
  if (shortcut){
    getURLs.push(`${base}?action=${encodeURIComponent(shortcut)}&t=${Date.now()}`);
  }

  for (const u of getURLs){
    const r = await request(u, { method:'GET' });
    const q = normalizeQuote(r.json);
    if (q) return q;             // success
    // If server answered 200 but not a quote (e.g., ping JSON), just continue without throwing
    if (r.raw === 'TIMEOUT' || r.raw === 'LOAD_FAILED'){
      // soft fail; continue trying other strategies ‚Äî don‚Äôt surface as an error yet
      continue;
    }
  }

  // Try POST (JSON)
  {
    const r = await request(base, {
      method:'POST',
      headers: { 'Content-Type':'application/json;charset=utf-8' },
      body: JSON.stringify({ action:'fundQuote', code: upper })
    });
    const q = normalizeQuote(r.json);
    if (q) return q;
  }

  // Try POST (form-urlencoded)
  {
    const form = new URLSearchParams();
    form.set('action','fundQuote');
    form.set('code', upper);
    const r = await request(base, {
      method:'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=utf-8' },
      body: form.toString()
    });
    const q = normalizeQuote(r.json);
    if (q) return q;
  }

  // Nothing worked ‚Üí signal upper layer to use cache without logging scary errors
  throw new Error('NO_QUOTE');
}

function cacheless(url){
  const u = new URL(url, location.href);
  // Add a cache-busting param to avoid any intermediary caches
  u.searchParams.set('_', Date.now());
  // IMPORTANT: Do NOT set any custom headers here ‚Äî Apps Script Web Apps
  // will preflight on non-simple headers and return 405 to the CORS OPTIONS request.
  // Keep this a simple GET so the request does not trigger a preflight.
  return fetch(u.toString(), {
    method: 'GET',
    cache: 'no-store',
    redirect: 'follow'
  });
}

// === TEFAS fon fiyatlarƒ±nƒ± Apps Script'ten √ßek (FI5, SAS, TI3) ===
async function refreshFundQuotes(){
  try{
    const funds = [
      { code:'FI5', input:'fi5UnitInput', lsUnit:'popdog_fi5_unit_try', lsAt:'popdog_fi5_updated_at' },
      { code:'SAS', input:'sasUnitInput', lsUnit:'popdog_sas_unit_try', lsAt:'popdog_sas_updated_at' },
      { code:'TI3', input:'isyUnitInput', lsUnit:'popdog_isy_unit_try', lsAt:'popdog_isy_updated_at' }, // ƒ∞≈ûY = TI3
    ];
    const base = getSheetWebAppURL();
    for (const f of funds){
      try{
        // Build GET URL (prefer action=fundQuote&code=...)
        const r = await cacheless(`${base}?action=fundQuote&code=${encodeURIComponent(f.code)}`);
        let j = null;
        try {
          const txt = await r.text();
          j = JSON.parse(txt);
        } catch(_){}
        // Normalize: expect shape { ok:true, unitTRY: number }
        const unitRaw = (j && typeof j.unitTRY !== 'undefined') ? j.unitTRY : null;
        const unit = Number(unitRaw);
        if (!j || !j.ok || !(unit > 0)) {
          throw new Error('Invalid payload');
        }
        // SANE PRICE GUARD
        const codeUp = String(f.code || '').toUpperCase();
        const cap = (codeUp === 'FI5') ? 2000 : 10000;
        if (!(unit > 0 && unit < cap)) {
          throw new Error('Insane price rejected');
        }

        // Ba≈üarƒ±lƒ± ‚Üí kaydet + UI
        localStorage.setItem(f.lsUnit, String(unit));
        localStorage.setItem(f.lsAt, String(Date.now()));
        const inp = document.getElementById(f.input);
        if (inp) inp.value = String(unit);

        // Kaynak yaz
        const noteEl = document.getElementById((f.input||'').replace('UnitInput','Note'));
        if (noteEl) noteEl.textContent = (j.source ? `Kaynak: ${j.source}` : '');
      }catch(e){
        // Baƒülantƒ±/timeout/yanƒ±t bozuksa ‚Üí √∂nbellek fallback
        const cached = Number(localStorage.getItem(f.lsUnit)||'0');
        const inp = document.getElementById(f.input);
        if (cached>0 && inp){
          inp.value = String(cached);
          const noteEl = document.getElementById((f.input||'').replace('UnitInput','Note'));
          const at = Number(localStorage.getItem(f.lsAt)||'0');
          const ageMin = at? Math.round((Date.now()-at)/60000) : null;
          if (noteEl) noteEl.textContent = `√ñnbellekten kullanƒ±ldƒ±${ageMin!=null ? ` ‚Ä¢ ${ageMin} dk √∂nce` : ''}`;
        }
        // Sessiz hata - API sorunlarƒ± kullanƒ±cƒ±yƒ± ilgilendirmez, cache kullanƒ±lƒ±r
        // console.debug('fundQuote fetch failed:', String(f.code).toLowerCase(), e && e.message ? e.message : e);
      }
    }
    // Kartlardaki toplamlarƒ±/hesap notlarƒ±nƒ± tazele
    try{ renderLoansBlock(); }catch(_){}
  }catch(e){
    console.warn('refreshFundQuotes() top-level error', e);
  }
}

// === Altƒ±n gram fiyatƒ±nƒ± Apps Script √ºzerinden √ßek (CORS'suz) ===
async function refreshGoldFromScript(){
  try{
    const base = getSheetWebAppURL();
    if (!/^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(base)){
      throw new Error('INVALID_WEBAPP_URL');
    }

    const url = `${base}?action=goldQuote&t=${Date.now()}`;
    const res = await fetch(url, { method:'GET', cache:'no-store' });
    const txt = await res.text().catch(()=> '');
    let j = null;
    try{ j = JSON.parse(txt); }catch(_){ j = null; }

    if (!j || !j.ok || typeof j.gramTRY === 'undefined'){
      throw new Error('Invalid payload');
    }

    const gram = Number(j.gramTRY);
    if (!(gram > 0)){
      throw new Error('Invalid price');
    }

    // Cache to localStorage
    try{
      localStorage.setItem('popdog_gold_gram_try', String(gram));
      localStorage.setItem('popdog_gold_updated_at', String(Date.now()));
    }catch(_){}

    const input = document.getElementById('goldGramInput');
    const note  = document.getElementById('goldNote');

    if (input){
      // T√ºrk√ße formatla veya d√ºz sayƒ± bƒ±rak; mevcut logic input'u parse ediyor
      input.value = String(gram);
      // Mevcut hesaplama mantƒ±ƒüƒ±nƒ± tetiklemek i√ßin input event'i g√∂nder
      try{
        const evt = new Event('input', { bubbles:true });
        input.dispatchEvent(evt);
      }catch(_){}
    }

    if (note){
      note.textContent = j.source
        ? `Kaynak: ${j.source}`
        : 'Altƒ±n gram fiyatƒ± Apps Script √ºzerinden g√ºncellendi.';
    }
  }catch(e){
    // Hata durumunda, varsa √∂nbelleƒüi kullan
    const input = document.getElementById('goldGramInput');
    const note  = document.getElementById('goldNote');
    try{
      const cached = Number(localStorage.getItem('popdog_gold_gram_try') || '0');
      const at     = Number(localStorage.getItem('popdog_gold_updated_at') || '0');
      if (cached > 0 && input){
        input.value = String(cached);
        try{
          const evt = new Event('input', { bubbles:true });
          input.dispatchEvent(evt);
        }catch(_){}
        if (note){
          const ageMin = at ? Math.round((Date.now() - at)/60000) : null;
          note.textContent = ageMin != null
            ? `Gram fiyatƒ± √∂nbellekten kullanƒ±ldƒ± ‚Ä¢ ${ageMin} dk √∂nce`
            : 'Gram fiyatƒ± √∂nbellekten kullanƒ±ldƒ±.';
        }
        return;
      }
    }catch(_){}
    if (note){
      note.textContent = 'Altƒ±n fiyatƒ± otomatik alƒ±namadƒ±, l√ºtfen gram fiyatƒ±nƒ± elle girin.';
    }
    // Sessiz hata - API sorunlarƒ± kullanƒ±cƒ±yƒ± ilgilendirmez
    // console.debug('refreshGoldFromScript() error:', e && e.message ? e.message : e);
  }
}

// Simple interactive setter for the Web App URL
async function setupSheetWebAppURL(infoEl){
  try{
    const cur = getSheetWebAppURL() || '';
    const hint = '(√ñrn: https://script.google.com/macros/s/AKfyc.../exec)';
    const pasted = prompt('Apps Script Web App URL‚Äônizi yapƒ±≈ütƒ±rƒ±n\n' + hint, cur);
    if(!pasted){ if(infoEl) infoEl.textContent = 'ƒ∞ptal edildi.'; return; }
    const ok = /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(pasted.trim());
    if(!ok){ if(infoEl) infoEl.textContent = '‚ö†Ô∏è Ge√ßerli bir /exec URL girin.'; return; }
    localStorage.setItem('popdog_sheet_webapp_url', pasted.trim());
    if(infoEl) infoEl.textContent = '‚úì URL kaydedildi. Sayfa tazelenecek‚Ä¶';
    setTimeout(()=> location.reload(), 400);
  }catch(e){
    if(infoEl) infoEl.textContent = '‚ö†Ô∏è URL kaydedilemedi: ' + (e?.message || e);
  }
}
/* === Apps Script WebApp Compatibility (action/rows keys) === */
const WEBAPP_COMPAT_KEY = 'popdog_webapp_compat';

function getWebAppCompat(){
  try{
    const j = JSON.parse(localStorage.getItem(WEBAPP_COMPAT_KEY) || '{}');
    return (j && typeof j === 'object') ? j : {};
  }catch(_){ return {}; }
}

/* Quick interactive compat setup:
   - rowsKey (default: 'rows')
   - actionKey (default: 'action')
   - dailyAction (default: 'appendDaily')
   - expenseAction (default: 'appendExpense')
*/
async function setupWebAppCompat(infoEl){
  try{
    const cur = getWebAppCompat();
    const rowsKey = prompt('Web App: satƒ±r listesinin parametre adƒ± nedir?\n(√∂rn. rows, data, values, payload)', cur.rowsKey || 'rows') || '';
    const actionKey = prompt('Web App: aksiyon parametresi adƒ±?\n(√∂rn. action, mode, type ‚Äî bo≈ü bƒ±rakabilirsiniz)', cur.actionKey || 'action') || '';
    const dailyAction = prompt('G√ºnl√ºk rapor yazma aksiyon deƒüeri?', cur.dailyAction || 'appendDaily') || '';
    const expenseAction = prompt('Gider ekleme aksiyon deƒüeri?', cur.expenseAction || 'appendExpense') || '';
    const cfg = { rowsKey: rowsKey.trim(), actionKey: actionKey.trim(), dailyAction: dailyAction.trim(), expenseAction: expenseAction.trim() };
    localStorage.setItem(WEBAPP_COMPAT_KEY, JSON.stringify(cfg));
    if(infoEl) infoEl.textContent = '‚úì Uyumluluk kaydedildi. Tekrar deneyebilirsiniz.';
    return cfg;
  }catch(e){
    if(infoEl) infoEl.textContent = '‚ö†Ô∏è Uyumluluk ayarƒ± kaydedilemedi: ' + (e?.message || e);
    return null;
  }
}
// === Hardcoded default CSV URLs (fallbacks if nothing set) ===
const DEFAULT_SHEET_CSV  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=1778107676&single=true&output=csv';
const DEFAULT_INV_CSV    = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=1049936864&single=true&output=csv';
const DEFAULT_ORDERS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=72488526&single=true&output=csv';

const DEFAULT_EXPENSES_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=798821160&single=true&output=csv';

/* ================== TABLE RENDERERS (NO CHARTS) ================== */

function safeText(s){
  return String(s==null?'':s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function loadCsv(url, timeoutMs = 30000){
  return new Promise((resolve, reject)=>{
    if (!window.Papa){ reject(new Error('PAPA_MISSING')); return; }

    let completed = false;
    const timer = setTimeout(() => {
      if (!completed) {
        completed = true;
        reject(new Error('CSV_LOAD_TIMEOUT'));
      }
    }, timeoutMs);

    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res)=> {
        if (!completed) {
          completed = true;
          clearTimeout(timer);
          resolve(res.data || []);
        }
      },
      error: (err)=> {
        if (!completed) {
          completed = true;
          clearTimeout(timer);
          reject(err);
        }
      }
    });
  });
}

function monthKeyFromDateStr(ds){
  try{
    const d = new Date(String(ds||'').slice(0,10));
    if (isNaN(+d)) return '';
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
  }catch(_){ return ''; }
}

function fmtPct(n){
  if (!isFinite(n)) return '‚Äì';
  const s = (n>0?'+':'') + n.toFixed(1) + '%';
  return s;
}

async function renderRevenueTables(){
  const wrapTotal = document.getElementById('lineTotalTblWrap');
  const wrapCh    = document.getElementById('barStackTblWrap');
  const yearSel   = document.getElementById('revYearSel');
  const YEAR_KEY  = 'popdog_revenue_year';
  const selectedYear = (()=>{
    try{
      const v = yearSel ? String(yearSel.value || '') : '';
      if (v) return v;
      return String(localStorage.getItem(YEAR_KEY) || 'all');
    }catch(_){
      return 'all';
    }
  })();
  if (!wrapTotal && !wrapCh) return;

  // Default placeholder
  if (wrapTotal) wrapTotal.innerHTML = '<div class="hint text-sm">Y√ºkleniyor‚Ä¶</div>';
  if (wrapCh)    wrapCh.innerHTML    = '<div class="hint text-sm">Y√ºkleniyor‚Ä¶</div>';
  const wrapGroom0 = document.getElementById('groomMonthlyTblWrap');
  if (wrapGroom0) wrapGroom0.innerHTML = '<div class="hint text-sm">Y√ºkleniyor‚Ä¶</div>';

  let rows = [];
  try{
    rows = await loadCsv(DEFAULT_SHEET_CSV);
  }catch(e){
    if (wrapTotal) wrapTotal.innerHTML = '<div class="hint text-sm">Ciro tablosu y√ºklenemedi.</div>';
    if (wrapCh)    wrapCh.innerHTML    = '<div class="hint text-sm">Kanal tablosu y√ºklenemedi.</div>';
    const wrapGroomE = document.getElementById('groomMonthlyTblWrap');
    if (wrapGroomE) wrapGroomE.innerHTML = '<div class="hint text-sm">Kuaf√∂r tablosu y√ºklenemedi.</div>';
    console.warn('renderRevenueTables load error', e);
    return;
  }

  // Column mapping (case-insensitive)
  const getDate = (r)=> getFieldCI(r, ['Date','Tarih','date','TARƒ∞H']);
  const getTotal = (r)=> parseTL(getFieldCI(r, ['Total','Toplam','TOTAL','Sum'])) || 0;

  const CHANNELS = [
    { key:'toptan', label:'Toptan', cols:['Toptan','Wholesale','Pop Dog Toptan'] },
    { key:'online', label:'Online', cols:['Online','Pop Dog Online','E-Commerce','Ecom'] },
    { key:'ckm', label:'CKM', cols:['CKM','Caddebostan','Maƒüaza','Store'] },
    { key:'kuafor', label:'Kuaf√∂r', cols:['Kuaf√∂r','Kuafor','Grooming'] },
    { key:'trendyol', label:'Trendyol', cols:['Trendyol'] },
    { key:'hepsiburada', label:'Hepsiburada', cols:['Hepsiburada','HB'] },
  ];

  // Aggregate by YEAR -> MONTH
  const byYear = new Map(); // y -> Map(monthKey -> { total, channels })

  function ensureYearMonth(y, mk){
    if (!byYear.has(y)) byYear.set(y, new Map());
    const mMap = byYear.get(y);
    if (!mMap.has(mk)){
      const ch = {};
      CHANNELS.forEach(c=> ch[c.key]=0);
      mMap.set(mk, { total:0, channels: ch });
    }
    return mMap.get(mk);
  }

  for (const r of (rows||[])){
    const ds = getDate(r);
    const mk = monthKeyFromDateStr(ds);
    if (!mk) continue;
    const y = Number(String(mk).slice(0,4)) || 0;
    if (!y) continue;
    const o = ensureYearMonth(y, mk);

    const t = getTotal(r);
    o.total += t;

    CHANNELS.forEach(c=>{
      const v = parseTL(getFieldCI(r, c.cols)) || 0;
      o.channels[c.key] += v;
    });
  }

  const years = Array.from(byYear.keys()).sort((a,b)=> a-b);
  if (!years.length){
    if (wrapTotal) wrapTotal.innerHTML = '<div class="hint text-sm">Ciro verisi bulunamadƒ±.</div>';
    if (wrapCh)    wrapCh.innerHTML    = '<div class="hint text-sm">Kanal verisi bulunamadƒ±.</div>';
    const wrapGroomN = document.getElementById('groomMonthlyTblWrap');
    if (wrapGroomN) wrapGroomN.innerHTML = '<div class="hint text-sm">Kuaf√∂r verisi bulunamadƒ±.</div>';
    return;
  }

  // Populate year selector (once) + persist selection
  if (yearSel){
    const curVal = String(localStorage.getItem(YEAR_KEY) || 'all');
    // Build options
    const opts = ['all', ...years.map(y=>String(y))];
    // If options differ, rebuild
    const existing = Array.from(yearSel.options).map(o=>o.value);
    const same = existing.length === opts.length && existing.every((v,i)=>v===opts[i]);
    if (!same){
      yearSel.innerHTML = opts.map(v=>{
        const lbl = (v==='all') ? 'T√ºm√º' : v;
        return `<option value="${v}">${lbl}</option>`;
      }).join('');
    }
    // Set selected
    yearSel.value = (opts.includes(curVal) ? curVal : 'all');
    // Bind change (only once)
    if (!yearSel.__bound){
      yearSel.__bound = true;
      yearSel.addEventListener('change', ()=>{
        try{ localStorage.setItem(YEAR_KEY, String(yearSel.value||'all')); }catch(_){ }
        // Re-render tables
        renderRevenueTables();
      });
    }
  }

  // Apply year filter
  const yearsToRender = (()=>{
    const v = (yearSel ? String(yearSel.value||'') : selectedYear) || 'all';
    if (v === 'all') return years;
    const yNum = Number(v);
    return (years.includes(yNum)) ? [yNum] : years;
  })();

  // === Monthly total table (grouped by year) ===
  if (wrapTotal){
    let html = '<div class="overflow-auto"><table class="min-w-full text-sm">'
      + '<thead class="text-slate-600 dark:text-slate-300"><tr>'
      + '<th class="text-left py-2 pr-4">Ay</th>'
      + '<th class="text-right py-2 pr-4">Toplam Ciro</th>'
      + '<th class="text-right py-2 pr-0">MoM</th>'
      + '</tr></thead><tbody class="text-slate-800 dark:text-slate-100">';

    yearsToRender.forEach((y, yi)=>{
      const mMap = byYear.get(y);
      const months = Array.from(mMap.keys()).sort();

      // Year separator row
      html += `<tr class="border-t border-white/30 dark:border-slate-700/40">`
        + `<td class="py-2 pr-4 font-semibold" colspan="3">${safeText(String(y))}</td>`
        + `</tr>`;

      let prev = 0;
      let yearSum = 0;

      months.forEach(mk=>{
        const tot = Number(mMap.get(mk).total||0);
        yearSum += tot;

        let mom = '‚Äì';
        let cls = '';
        if (prev > 0){
          const pct = ((tot - prev) / prev) * 100;
          mom = fmtPct(pct);
          cls = pct >= 0 ? 'kpi-up' : 'kpi-down';
        }

        html += `<tr>`
          + `<td class="py-1 pr-4">${safeText(mk)}</td>`
          + `<td class="py-1 pr-4 text-right">${numberTL(tot)}</td>`
          + `<td class="py-1 pr-0 text-right ${cls}">${safeText(mom)}</td>`
          + `</tr>`;
        prev = tot;
      });

      // Year total row
      html += `<tr class="border-t border-white/40 dark:border-slate-700/40">`
        + `<td class="py-2 pr-4 font-medium">${safeText(String(y))} Toplam</td>`
        + `<td class="py-2 pr-4 text-right font-semibold">${numberTL(yearSum)}</td>`
        + `<td class="py-2 pr-0"></td>`
        + `</tr>`;
    });

    html += '</tbody></table></div>';
    wrapTotal.innerHTML = html;
  }

  // === Channel-by-month table (grouped by year, with yearly totals) ===
  if (wrapCh){
    let html = '<div class="overflow-auto"><table class="min-w-full text-sm">'
      + '<thead class="text-slate-600 dark:text-slate-300"><tr>'
      + '<th class="text-left py-2 pr-4">Ay</th>';
    CHANNELS.forEach(c=>{ html += `<th class="text-right py-2 pr-4">${safeText(c.label)}</th>`; });
    html += '<th class="text-right py-2 pr-0">Toplam</th>';
    html += '</tr></thead><tbody class="text-slate-800 dark:text-slate-100">';

    yearsToRender.forEach(y=>{
      const mMap = byYear.get(y);
      const months = Array.from(mMap.keys()).sort();

      // Year separator row
      html += `<tr class="border-t border-white/30 dark:border-slate-700/40">`
        + `<td class="py-2 pr-4 font-semibold" colspan="${CHANNELS.length + 2}">${safeText(String(y))}</td>`
        + `</tr>`;

      const colTotals = {}; CHANNELS.forEach(c=> colTotals[c.key]=0);
      let yearGrand = 0;

      months.forEach(mk=>{
        const o = mMap.get(mk);
        html += `<tr><td class="py-1 pr-4">${safeText(mk)}</td>`;
        let rowSum = 0;
        CHANNELS.forEach(c=>{
          const v = Number((o.channels && o.channels[c.key]) || 0);
          rowSum += v;
          colTotals[c.key] += v;
          html += `<td class="py-1 pr-4 text-right">${numberTL(v)}</td>`;
        });
        // Prefer sheet total if provided; otherwise sum channels
        const tot = Number(o.total||0) || rowSum;
        yearGrand += tot;
        html += `<td class="py-1 pr-0 text-right font-medium">${numberTL(tot)}</td></tr>`;
      });

      // Year totals row
      html += `<tr class="border-t border-white/40 dark:border-slate-700/40">`;
      html += `<td class="py-2 pr-4 font-medium">${safeText(String(y))} Toplam</td>`;
      CHANNELS.forEach(c=>{ html += `<td class="py-2 pr-4 text-right font-semibold">${numberTL(colTotals[c.key])}</td>`; });
      html += `<td class="py-2 pr-0 text-right font-semibold">${numberTL(yearGrand)}</td>`;
      html += `</tr>`;
    });

    html += '</tbody></table></div>';
    wrapCh.innerHTML = html;
  }

  // === Grooming (Kuaf√∂r) monthly totals + MoM ===
  const wrapGroom = document.getElementById('groomMonthlyTblWrap');
  if (wrapGroom){
    let html = '<div class="overflow-auto"><table class="min-w-full text-sm">'
      + '<thead class="text-slate-600 dark:text-slate-300"><tr>'
      + '<th class="text-left py-2 pr-4">Ay</th>'
      + '<th class="text-right py-2 pr-4">Kuaf√∂r</th>'
      + '<th class="text-right py-2 pr-0">MoM</th>'
      + '</tr></thead><tbody class="text-slate-800 dark:text-slate-100">';

    yearsToRender.forEach((y)=>{
      const mMap = byYear.get(y);
      const months = Array.from(mMap.keys()).sort();

      html += `<tr class="border-t border-white/30 dark:border-slate-700/40">`
        + `<td class="py-2 pr-4 font-semibold" colspan="3">${safeText(String(y))}</td>`
        + `</tr>`;

      let prev = 0;
      let yearSum = 0;

      months.forEach(mk=>{
        const o = mMap.get(mk);
        const v = Number((o && o.channels && o.channels.kuafor) || 0);
        yearSum += v;

        let mom = '‚Äì';
        let cls = '';
        if (prev > 0){
          const pct = ((v - prev) / prev) * 100;
          mom = fmtPct(pct);
          cls = pct >= 0 ? 'kpi-up' : 'kpi-down';
        }

        html += `<tr>`
          + `<td class="py-1 pr-4">${safeText(mk)}</td>`
          + `<td class="py-1 pr-4 text-right">${numberTL(v)}</td>`
          + `<td class="py-1 pr-0 text-right ${cls}">${safeText(mom)}</td>`
          + `</tr>`;

        prev = v;
      });

      html += `<tr class="border-t border-white/40 dark:border-slate-700/40">`
        + `<td class="py-2 pr-4 font-medium">${safeText(String(y))} Kuaf√∂r Toplam</td>`
        + `<td class="py-2 pr-4 text-right font-semibold">${numberTL(yearSum)}</td>`
        + `<td class="py-2 pr-0"></td>`
        + `</tr>`;
    });

    html += '</tbody></table></div>';
    wrapGroom.innerHTML = html;
  }
}

async function renderExpensesMonthlyTable(){
  const wrap = document.getElementById('expensesMonthlyTblWrap');
  if (!wrap) return;
  wrap.innerHTML = '<div class="hint text-sm">Y√ºkleniyor‚Ä¶</div>';

  let rows = [];
  try{
    rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);
  }catch(e){
    wrap.innerHTML = '<div class="hint text-sm">Gider tablosu y√ºklenemedi.</div>';
    console.warn('renderExpensesMonthlyTable load error', e);
    return;
  }

  const byMonth = new Map();
  for (const r of (rows||[])){
    const mk = monthKeyFromDateStr(getFieldCI(r, ['Date','Tarih','date']));
    if (!mk) continue;
    const amt = readExpenseAmountTRY(r);
    if (!(amt>0)) continue;
    byMonth.set(mk, (byMonth.get(mk)||0) + amt);
  }

  const months = Array.from(byMonth.keys()).sort();
  if (!months.length){
    wrap.innerHTML = '<div class="hint text-sm">Gider verisi bulunamadƒ±.</div>';
    return;
  }

  let html = '<div class="overflow-auto"><table class="min-w-full text-sm">'
    + '<thead class="text-slate-600 dark:text-slate-300"><tr>'
    + '<th class="text-left py-2 pr-4">Ay</th>'
    + '<th class="text-right py-2 pr-4">Toplam Gider</th>'
    + '<th class="text-right py-2 pr-0">MoM</th>'
    + '</tr></thead><tbody class="text-slate-800 dark:text-slate-100">';

  let prev = 0;
  months.forEach(mk=>{
    const tot = byMonth.get(mk)||0;
    let mom = '‚Äì';
    let cls = '';
    if (prev > 0){
      const pct = ((tot - prev)/prev)*100;
      mom = fmtPct(pct);
      cls = pct >= 0 ? 'kpi-up' : 'kpi-down';
    }
    html += `<tr>`
      + `<td class="py-1 pr-4">${safeText(mk)}</td>`
      + `<td class="py-1 pr-4 text-right">${numberTL(tot)}</td>`
      + `<td class="py-1 pr-0 text-right ${cls}">${safeText(mom)}</td>`
      + `</tr>`;
    prev = tot;
  });

  const grand = months.reduce((a,m)=> a + (byMonth.get(m)||0), 0);
  html += `<tr class="border-t border-white/40 dark:border-slate-700/40">`
    + `<td class="py-2 pr-4 font-medium">Toplam</td>`
    + `<td class="py-2 pr-4 text-right font-semibold">${numberTL(grand)}</td>`
    + `<td class="py-2 pr-0"></td>`
    + `</tr>`;

  html += '</tbody></table></div>';
  wrap.innerHTML = html;
}

function hookNoChartRenderers(){
  // Run on load
  window.addEventListener('load', ()=>{
    try{ renderRevenueTables(); }catch(_){ }
    try{ renderExpensesMonthlyTable(); }catch(_){ }
  });

  // If refreshAll exists, chain it
  const tryHook = (name)=>{
    const fn = window[name];
    if (typeof fn !== 'function' || fn.__noChartHooked) return;
    const wrapped = async function(){
      const r = fn.apply(this, arguments);
      try{ await Promise.resolve(r); }catch(_){ }
      try{ renderRevenueTables(); }catch(_){ }
      try{ renderExpensesMonthlyTable(); }catch(_){ }
      return r;
    };
    wrapped.__noChartHooked = true;
    window[name] = wrapped;
  };
  ['refreshAll','refreshAllData','loadAll','loadAllData'].forEach(tryHook);
}
hookNoChartRenderers();

/* ================== /TABLE RENDERERS (NO CHARTS) ================== */

/* ================== THEME ================== */
const root = document.documentElement;
function setTheme(mode){
  if(mode === 'dark'){
    root.classList.add('dark');
  } else {
    root.classList.remove('dark');
  }
  localStorage.setItem('popdog_theme', mode);
}
document.getElementById('themeBtn').onclick = ()=> setTheme(root.classList.contains('dark') ? 'light' : 'dark');
(function(){
  const initial = localStorage.getItem('popdog_theme') || 'light';
  setTheme(initial);
})();

// Yenile: varsa veri yenileme fonksiyonunu √ßaƒüƒ±r, yoksa sayfayƒ± tazele
(function(){
  const rb = document.getElementById('refreshBtn');
  if (!rb) return;
  rb.onclick = async () => {
    try{
      if (typeof refreshAll === 'function') await refreshAll();
      else if (typeof refreshAllData === 'function') await refreshAllData();
      else if (typeof loadAll === 'function') await loadAll();
      else if (typeof loadAllData === 'function') await loadAllData();
      else {
        location.reload();
        return;
      }
    }catch(_){
      location.reload();
      return;
    }
    try{ await renderRevenueTables(); }catch(_){ }
  };
})();

/* ================== HELPERS ================== */
const nfTL  = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 });
const nfUSD = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
const numberTL  = n => {
  const val = Number(n);
  return nfTL.format(isNaN(val) ? 0 : Math.round(val));
};
const numberUSD = n => nfUSD.format(Math.round(n||0));


/* ================== DAILY REPORT PARSER (CKM + Kuaf√∂r split) ================== */
// Parse WhatsApp/daily report text, extract Kuaf√∂r (Grooming) and avoid double counting in CKM.
function parseDailyReportText_v2(text) {
  // Normalize newlines and remove invisible chars (WhatsApp copy/paste)
  text = String(text || '')
    .replace(/\r\n/g, '\n')
    .replace(/\r/g, '\n')
    .replace(/[\u2028\u2029]/g, '\n')
    .replace(/\u00A0/g,' ')                 // NBSP
    .replace(/[\u200B-\u200D\uFEFF]/g,'') // zero-width
    .trim();

  // Diacritics-stripped text for stable matching (Kuaf√∂r/Kuafor)
  const textNoDia = text.normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  // Helper: extract amount from a line using a regex with one capture group for the number.
  // Returns null if no match, 0 if the label exists but number is empty.
  function extractAmount_(line, re){
    const m = String(line||'').trim().match(re);
    if (!m) return null;
    if (!m[1]) return 0;
    return parseTL(m[1]);
  }

  // Build normalized lines (both original + no-diacritics) keeping position
  const rawLines = text.split('\n').map(s => String(s||'').trim()).filter(Boolean);
  const lines    = textNoDia.split('\n').map(s => String(s||'').trim()).filter(Boolean);

  // Date: use original text (to preserve separators)
  let date = '';
  const dateMatch = text.match(/(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/);
  if (dateMatch) date = parseTRDateString(dateMatch[1]);

  // Extract amounts line-by-line (no false matches like "Kasa Nakit" vs "Nakit")
  let groomingTRY = 0;
  let cashSalesTRY = 0;     // Nakit satƒ±≈ü
  let kasaNakitTRY = 0;     // EoD cash
  let trendyolTRY = 0;
  let hbTRY = 0;
  let onlineTRY = 0;
  let toptanTRY = 0;
  let storeTotalTRY = 0;
  let kkTRY = 0;
  let cashSalesHasNumber = false; // true only if the Nakit line contains a number

  for (let i=0; i<lines.length; i++){
    const L = lines[i];

    // Kuaf√∂r (prefer explicit Kuaf√∂r/Kuafor line; do not overwrite once captured)
    {
      if (!(groomingTRY > 0)) {
        const rawL = (rawLines && rawLines[i]) ? String(rawLines[i]) : '';

        // Try on raw line (keeps Turkish chars) then on diacritics-stripped line.
        // Do NOT require end-of-line; WhatsApp often has trailing notes/hidden chars.
        let v = extractAmount_(rawL, /\bKuaf[√∂o]r\b[^0-9]{0,60}[:Ôºö=]\s*([0-9][0-9\.,\s]*)/i);
        if (v == null) {
          v = extractAmount_(L, /\bKuafor\b[^0-9]{0,60}[:Ôºö=]\s*([0-9][0-9\.,\s]*)/i);
        }

        // Ultra-fallback for weird spacing: "Kuaf√∂r 2550" (no colon)
        if (v == null) {
          v = extractAmount_(rawL, /\bKuaf[√∂o]r\b[^0-9]{0,60}([0-9][0-9\.,\s]*)/i);
        }
        if (v == null) {
          v = extractAmount_(L, /\bKuafor\b[^0-9]{0,60}([0-9][0-9\.,\s]*)/i);
        }

        if (v != null && v > 0) groomingTRY = v;
      }
    }

    // Nakit (cash sales) ‚Äî DO NOT match "Kasa Nakit".
    // IMPORTANT: Only treat as cash sales if the Nakit line actually contains digits.
    {
      const m = String(L||'').trim().match(/^\s*(?!Kasa\s+Nakit\b)Nakit\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)\s*(?:TL|‚Ç∫)?\s*$/i);
      if (m && m[1]){
        cashSalesTRY = parseTL(m[1]) || 0;
        cashSalesHasNumber = true;
      }
    }

    // Kasa Nakit (EoD), strict label+colon
    {
      const v = extractAmount_(L, /^\s*Kasa\s+Nakit\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v != null) kasaNakitTRY = v;
    }

    // Trendyol, strict label+colon
    {
      const v = extractAmount_(L, /^\s*Trendyol\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v != null) trendyolTRY = v;
    }

    // Hepsiburada, strict label+colon, number optional
    {
      const v = extractAmount_(L, /^\s*Hepsiburada\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)?\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v != null) hbTRY = v;
    }

    // Pop Dog Online / Online, strict label+colon, number optional
    {
      const v1 = extractAmount_(L, /^\s*Pop\s*Dog\s*Online\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)?\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v1 != null) onlineTRY = v1;
      const v2 = extractAmount_(L, /^\s*Online\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)?\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v2 != null) onlineTRY = v2;
    }

    // Pop Dog Toptan / Toptan, strict label+colon, number optional
    {
      const v1 = extractAmount_(L, /^\s*Pop\s*Dog\s*Toptan\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)?\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v1 != null) toptanTRY = v1;
      const v2 = extractAmount_(L, /^\s*Toptan\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)?\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v2 != null) toptanTRY = v2;
    }

    // Toplam ciro, strict label+colon, number optional
    {
      const v = extractAmount_(L, /^\s*Toplam\s*ciro\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)?\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v != null) storeTotalTRY = v;
    }

    // Kredi Kartƒ±, strict label+colon, number optional
    {
      const v = extractAmount_(L, /^\s*Kredi\s*Kart[ƒ±i]\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)?\s*(?:TL|‚Ç∫)?\s*$/i);
      if (v != null) kkTRY = v;
    }
  }

  // Fallback: if Kuaf√∂r wasn't found line-by-line, do robust global scans.
  // Prefer explicit "Kuaf√∂r/Kuafor" label near a number; tolerate trailing text.
  if (!(groomingTRY > 0)){
    let m = text.match(/\bKuaf[√∂o]r\b[^0-9]{0,80}[:Ôºö=]?\s*([0-9][0-9\.,\s]*)/i);
    if (m && m[1]) groomingTRY = parseTL(m[1]) || 0;
  }
  if (!(groomingTRY > 0)){
    let m = textNoDia.match(/\bKuafor\b[^0-9]{0,80}[:Ôºö=]?\s*([0-9][0-9\.,\s]*)/i);
    if (m && m[1]) groomingTRY = parseTL(m[1]) || 0;
  }

  // Safety: if grooming accidentally equals cash sales and we did not see an explicit Kuaf√∂r label, force grooming=0.
  // (Prevents rare mis-parses where another line's number is picked up.)
  try{
    if ((groomingTRY > 0) && (cashSalesTRY > 0) && groomingTRY === cashSalesTRY){
      const hasExplicitKuafor = /\bKuaf[√∂o]r\b\s*[:Ôºö=]/i.test(text) || /\bKuafor\b\s*[:Ôºö=]/i.test(textNoDia);
      if (!hasExplicitKuafor) groomingTRY = 0;
    }
  }catch(_){ }

  // If total not provided, compute from credit card + cash sales
  if (!(storeTotalTRY > 0)){
    storeTotalTRY = (kkTRY || 0) + (cashSalesTRY || 0);
  }

  // CKM (retail) = storeTotal - grooming (avoid double count)
  const ckmRetailTRY = Math.max(0, (storeTotalTRY || 0) - (groomingTRY || 0));

  // CKM Nakit: prefer explicit "CKM Nakit" if present; otherwise use Nakit ONLY if it had a number.
  let ckmNakitTRY = cashSalesHasNumber ? cashSalesTRY : 0;
  for (let i=0; i<lines.length; i++){
    const m = String(lines[i]||'').trim().match(/^\s*CKM\s+Nakit\s*[:Ôºö=]\s*([0-9][0-9\.,\s]*)\s*(?:TL|‚Ç∫)?\s*$/i);
    if (m && m[1]){ ckmNakitTRY = parseTL(m[1]) || 0; break; }
  }

  // Total (channels sum) ‚Äî CKM retail + Kuaf√∂r counted once
  const totalTRY = (toptanTRY || 0) + (onlineTRY || 0) + (ckmRetailTRY || 0) + (groomingTRY || 0) + (trendyolTRY || 0) + (hbTRY || 0);


  return {
    'Date': date,
    'Toptan': toptanTRY,
    'Online': onlineTRY,
    'CKM': ckmRetailTRY,
    'Kuaf√∂r': (groomingTRY || 0),
    'CKM Nakit': ckmNakitTRY,
    'Kasa Nakit (EoD)': kasaNakitTRY,
    'Trendyol': trendyolTRY,
    'Hepsiburada': hbTRY,
    'Total': totalTRY
  };
}

// Force global reference to the new parser (prevents legacy overrides)
try{ window.parseDailyReportText = parseDailyReportText_v2; }catch(_){ }

function renderStagedRows(stagedRows) {
  const tbody = document.getElementById('stagedTbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  for (const row of stagedRows) {
    const html =
      `<tr>
        <td class="py-2 pr-4">${safeText(row.Date || '')}</td>
        <td class="text-right py-2 pr-4">${numberTL(row.Toptan || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row.Online || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row.CKM || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row['Kuaf√∂r'] || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row['CKM Nakit'] || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row['Kasa Nakit (EoD)'] || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row.Trendyol || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row.Hepsiburada || 0)}</td>
        <td class="text-right py-2 pr-4">${numberTL(row.Total || 0)}</td>
      </tr>`;
    tbody.insertAdjacentHTML('beforeend', html);
  }
}

(function(){
  const btn = document.getElementById('parseAddBtn');
  if (!btn) return;

  // ‚úÖ TEK KAYNAK: g√ºnl√ºk satƒ±rlar tek bir global array‚Äôde tutulur
  if (!Array.isArray(window.stagedRows)) window.stagedRows = [];


  btn.onclick = function() {
    const ta = document.getElementById('dailyText');
    const info = document.getElementById('parseInfo');
    if (!ta) return;

    const text = ta.value || '';
    let row;
    try {
      row = parseDailyReportText_v2(text);
      // Guarantee Kuaf√∂r key exists
      if (row && typeof row['Kuaf√∂r'] === 'undefined') row['Kuaf√∂r'] = 0;
      if (info && row) {
        info.textContent = `√ñnizleme: CKM=${numberTL(row.CKM||0)} ‚Ä¢ Kuaf√∂r=${numberTL(row['Kuaf√∂r']||0)} ‚Ä¢ Trendyol=${numberTL(row.Trendyol||0)} ‚Ä¢ HB=${numberTL(row.Hepsiburada||0)} ‚Ä¢ Total=${numberTL(row.Total||0)}`;
      }
    } catch (e) {
      if (info) info.textContent = 'Satƒ±r ayrƒ±≈ütƒ±rƒ±lamadƒ±: ' + (e && e.message ? e.message : e);
      return;
    }

    if (!row || !row.Date) {
      if (info) info.textContent = 'Tarih bulunamadƒ± veya format hatalƒ±.';
      return;
    }

    window.stagedRows.push(row);
    renderStagedRows(window.stagedRows);
    if (info) {
      info.textContent = `Satƒ±r eklendi. (${window.stagedRows.length}) ‚Ä¢ √ñnizleme: CKM=${numberTL(row.CKM||0)} ‚Ä¢ Kuaf√∂r=${numberTL(row['Kuaf√∂r']||0)} ‚Ä¢ Trendyol=${numberTL(row.Trendyol||0)} ‚Ä¢ HB=${numberTL(row.Hepsiburada||0)} ‚Ä¢ Total=${numberTL(row.Total||0)}`;
    }
    ta.value = '';
  };

window.getStagedDailyRows = () => (Array.isArray(window.stagedRows) ? window.stagedRows.slice() : []);
})();
/* ================== /DAILY REPORT PARSER ================== */


/* ================== LOANS STATE HELPERS ================== */
// Zee.Dog varsayƒ±lan bekleyen √∂demeler (USD)
const DEFAULT_ZEE_AWAIT = [
  { id:'YK#033',   usd:4626.02, paidUsd:0, remainingUsd:4626.02, status:'waiting' },
  { id:'YK#034',   usd:39425.33, paidUsd:0, remainingUsd:39425.33, status:'waiting' },
  { id:'YK#034.1', usd:11827.00, paidUsd:0, remainingUsd:11827.00, status:'waiting' },
  { id:'YK#034.2', usd:27597.00, paidUsd:0, remainingUsd:27597.00, status:'waiting' },
  { id:'YK#035',   usd:37589.19, paidUsd:0, remainingUsd:37589.19, status:'waiting' },
  { id:'YK#035.1', usd:11276.76, paidUsd:0, remainingUsd:11276.76, status:'waiting' },
  { id:'YK#035.2', usd:26312.43, paidUsd:0, remainingUsd:26312.43, status:'waiting' },
];
(function(){
  if (typeof window.defaultLoansState === 'undefined') {
    window.defaultLoansState = {
            loans: {
        biz:  { total: 24, paid: 0, instTRY: 0,        remainTRY: 0,         principalTRY: 0,         monthlyRate: 0 },
        car:  { total: 24, paid: 0, instTRY: 0,        remainTRY: 0,         principalTRY: 0,         monthlyRate: 0 },
        biz2: { total: 24, paid: 0, instTRY: 71452.86, remainTRY: 1714868.61, principalTRY: 1714868.61, monthlyRate: 0 }
      },
    zeeAwaitUSD: DEFAULT_ZEE_AWAIT.slice(),  // Fixed: changed from zeeAwait to zeeAwaitUSD for consistency
    demoBank: {
      goldGram: 169,
      gramTRY: 0,
      fi5Units: 565,
      fi5UnitTRY: 0,
      sasUnits: 114236,
      sasUnitTRY: 0,
      isyUnits: 2530000,
      isyUnitTRY: 0
    }
    };
  }
  if (typeof window.getLoansState !== 'function'){
    window.getLoansState = function(){
      try{
        const raw = localStorage.getItem('popdog_loans_state');
        if (!raw) return JSON.parse(JSON.stringify(window.defaultLoansState));
        const obj = JSON.parse(raw);
        const d = JSON.parse(JSON.stringify(window.defaultLoansState));
        const out = Object.assign({}, d, obj || {});
        out.loans = Object.assign({}, d.loans, out.loans || {});
        out.zeeAwaitUSD = Array.isArray(out.zeeAwaitUSD) && out.zeeAwaitUSD.length ? out.zeeAwaitUSD : DEFAULT_ZEE_AWAIT.slice();
        // Migrate old data structure to new: add paidUsd and remainingUsd if missing
        out.zeeAwaitUSD = out.zeeAwaitUSD.map(z => {
          const total = Number(z.usd || 0);
          const paid = Number(z.paidUsd ?? 0);
          const remaining = Number(z.remainingUsd ?? total);
          return {
            ...z,
            paidUsd: paid,
            remainingUsd: remaining
          };
        });
        out.loans.biz  = Object.assign({}, d.loans.biz,  out.loans.biz  || {});
        out.loans.car  = Object.assign({}, d.loans.car,  out.loans.car  || {});
        out.loans.biz2 = Object.assign({}, d.loans.biz2, out.loans.biz2 || {});
        return out;
      }catch(_){ return JSON.parse(JSON.stringify(window.defaultLoansState)); }
    };
  }
  if (typeof window.setLoansState !== 'function'){
    window.setLoansState = function(st){
      try{ localStorage.setItem('popdog_loans_state', JSON.stringify(st || {})); }catch(_){}
    };
  }
  if (typeof window.bumpLoansPaidIfMatches !== 'function'){
    window.bumpLoansPaidIfMatches = function(subcat, amountTRY){
      try{
        const s = String(subcat || '').toLowerCase();
        if (!s) return;
        const amt = Number(amountTRY || 0);
        const st = getLoansState();

        // Check for "Kredi 2" first (most specific)
        const isBiz2 = /kredi\s*2|kredi\s*ii|ticari\s*2|ticari\s*ii|i≈ületme\s*2/.test(s);
        // Then check for regular "ticari" (but not if it's Kredi 2)
        const isBiz = !isBiz2 && /ticari|i≈ületme|taksitli.*ticari|kredi(?!\s*2)/.test(s);
        const isCar = /ara√ß|oto|otomobil|ta≈üƒ±t/.test(s);

        if (isBiz2){
          // Handle Taksitli Ticari Kredi 2
          if (!st.loans.biz2) st.loans.biz2 = { total: 24, paid: 0, instTRY: 71452.86, remainTRY: 1714868.61, principalTRY: 1714868.61, monthlyRate: 0 };
          st.loans.biz2.paid = Math.max(0, Number(st.loans.biz2.paid || 0)) + 1;
          if (amt > 0) st.loans.biz2.remainTRY = Math.max(0, Number(st.loans.biz2.remainTRY || 0) - amt);
          setLoansState(st);
        } else if (isBiz){
          st.loans.biz.paid = Math.max(0, Number(st.loans.biz.paid || 0)) + 1;
          if (amt > 0) st.loans.biz.remainTRY = Math.max(0, Number(st.loans.biz.remainTRY || 0) - amt);
          setLoansState(st);
        } else if (isCar){
          st.loans.car.paid = Math.max(0, Number(st.loans.car.paid || 0)) + 1;
          if (amt > 0) st.loans.car.remainTRY = Math.max(0, Number(st.loans.car.remainTRY || 0) - amt);
          setLoansState(st);
        }
      }catch(_){}
    };
  }
})();

function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function yyyymmddUTC(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

/* TRY sayƒ±larƒ± i√ßin saƒülam parser */
function parseTL(v){
  if(v==null || v==='') return 0;
  if(typeof v === 'number') return v;
  let s = String(v).trim().replace(/\s|‚Ç∫|TRY|TL/gi,'').replace(/\u00A0/g,'');
  if(s === '-' || s === '‚Äì' || s === '‚Äî') return 0;
  if(/^-?\d+$/.test(s)) return Number(s);
  if(s.includes('.') && s.includes(',')){
    const lastDot = s.lastIndexOf('.'), lastComma = s.lastIndexOf(',');
    if(lastComma > lastDot){ s = s.replace(/\./g,'').replace(',', '.'); } else { s = s.replace(/,/g,''); }
    const n = Number(s); return isNaN(n)?0:n;
  }
  if(s.includes(',') && !s.includes('.')){
    s = s.replace(/\./g,''); s = s.replace(',', '.');
    const n = Number(s); return isNaN(n)?0:n;
  }
  const n = Number(s.replace(/,/g,'')); return isNaN(n)?0:n;
}

function parseTRDateString(s){
  const m = s.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
  if(!m) return '';
  let dd=+m[1], mm=+m[2], yy=+m[3]; if(yy<100) yy += 2000;
  return yyyymmddUTC(yy, mm, dd);
}
function parseUSD(v){
  if(v==null || v==='') return 0;
  if(typeof v === 'number') return v;
  let s = String(v).trim();
  s = s.replace(/USD/gi,'').replace(/\$/g,'').replace(/\s/g,'').replace(/\u00A0/g,'');
  if(s === '-' || s === '‚Äì' || s === '‚Äî') return 0;
  if(/^-?\d+$/.test(s)) return Number(s);
  if(s.includes('.') && s.includes(',')){
    s = s.replace(/,/g,'');
    const n = Number(s);
    return isNaN(n)?0:n;
  }
  const n = Number(s.replace(/,/g,''));
  return isNaN(n)?0:n;
}
 
function getTryPerUsd(){
  try{
    const s = localStorage.getItem('popdog_fx_try_per_usd');
    const n = s ? Number(s) : 0;
    if (n && !isNaN(n)) return n;

    // if a session-level USD/TRY exists, invert it
    if (typeof fxRateUSDPerTRY === 'number' && fxRateUSDPerTRY > 0){
      return 1 / fxRateUSDPerTRY;
    }
    return 0;
  }catch(e){ return 0; }
}

// === Case-insensitive field getter (first non-empty) ===
function getFieldCI(row, candidates){
  if(!row) return '';
  const keys = Object.keys(row);
  // quick map of lower->actual
  const map = {};
  keys.forEach(k => { map[String(k).toLowerCase()] = k; });
  for (const want of candidates){
    const real = map[String(want).toLowerCase()];
    if (real && row[real] != null && String(row[real]).trim() !== ''){
      return row[real];
    }
  }
  return '';
}

// === REMOVED: Duplicate function definition (kept the most comprehensive version at line ~4634) ===

// === Satƒ±rdan subcategory metnini okuma (case-insensitive) ===
function readExpenseSubcat(row){
  const keys = (typeof SUBCAT_KEYS !== 'undefined' && Array.isArray(SUBCAT_KEYS) && SUBCAT_KEYS.length)
    ? SUBCAT_KEYS
    : ['Subcategory','Sub-Category','Subcat','Alt Kategori','AltKategori','Detail','Kalem'];
  const v = getFieldCI(row, keys);
  return v !== '' ? String(v).trim() : '';
}

/* === Bu Ayƒ±n Giderleri: Kategori + Alt Kategori listesi === */
async function renderThisMonthExpenses(){
  try{
    const tbody = document.getElementById('tblExpThisMonth');
    if (!tbody) return;

    // CSV'yi y√ºkle
    const rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);

    // Bu ayƒ±n ba≈ülangƒ±√ß/biti≈üi
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth(); // 0-index

    // Bu aya ait satƒ±rlarƒ± filtrele
    const inMonth = (rows||[]).filter(r=>{
      const ds = String(r.Date || r.date || '').slice(0,10);
      const d  = new Date(ds);
      return !isNaN(+d) && d.getFullYear() === y && d.getMonth() === m;
    });

    // === Totals & MoM ===
    const curTotal = inMonth.reduce((acc, r) => acc + readExpenseAmountTRY(r), 0);

    // Previous month (handles year wrap automatically)
    const prevStart = new Date(y, m - 1, 1);
    const prevY = prevStart.getFullYear();
    const prevM = prevStart.getMonth();
    const prevMonthRows = (rows || []).filter(r => {
      const ds = String(r.Date || r.date || '').slice(0,10);
      const d  = new Date(ds);
      return !isNaN(+d) && d.getFullYear() === prevY && d.getMonth() === prevM;
    });
    const prevTotal = prevMonthRows.reduce((acc, r) => acc + readExpenseAmountTRY(r), 0);

    // Write header totals
    const totalEl = document.getElementById('expThisMonthTotal');
    if (totalEl) totalEl.textContent = numberTL(curTotal);

    const momEl = document.getElementById('expThisMonthMoM');
    if (momEl){
      let text = 'MoM: ‚Äì';
      momEl.classList.remove('kpi-up','kpi-down');
      if (prevTotal > 0){
        const pct = ((curTotal - prevTotal) / prevTotal) * 100;
        const sign = pct > 0 ? '+' : '';
        text = `MoM: ${sign}${pct.toFixed(1)}%`;
        momEl.classList.add(pct >= 0 ? 'kpi-up' : 'kpi-down');
      } else if (curTotal > 0){
        text = 'MoM: +‚àû% (ilk ay)';
        momEl.classList.add('kpi-up');
      }
      momEl.textContent = text;
    }

    if (!inMonth.length){
      tbody.innerHTML = '<tr><td class="hint py-2" colspan="4">Bu ay i√ßin gider bulunamadƒ±.</td></tr>';
      return;
    }

    // Satƒ±rlarƒ± tarihe g√∂re artan sƒ±rada g√∂ster
    inMonth.sort((a,b)=>{
      const ad = new Date(String(a.Date||a.date||'').slice(0,10));
      const bd = new Date(String(b.Date||b.date||'').slice(0,10));
      return ad - bd;
    });

    // Yardƒ±mcƒ±lar
    const fmtTL = (n)=> nfTL.format(Math.round(n||0));
    const getCat = (r)=> getFieldCI(r, ['Category','Kategori','Main Category','Ana Kategori','Cat']) || '';
    // Nihai alt kategori (varsa FinalSubcategory √∂ncelikli)
    const getFinalSub = (r)=> getFieldCI(r, ['FinalSubcategory','Final Subcategory','Final','Nihai Alt Kategori']) ||
                              getFieldCI(r, ['Subcategory','Sub-Category','Alt Kategori','AltKategori','Detail','Kalem']) || '';

    // Render (kompakt - 4 s√ºtun)
    const html = inMonth.map(r=>{
      const date = String(r.Date || r.date || '').slice(5,10); // MM-DD formatƒ± (kompakt)
      const cat  = getCat(r);
      const fsub = getFinalSub(r);
      const amt  = readExpenseAmountTRY(r); // TRY tutarƒ± g√ºvenli okuma
      return `<tr>
        <td class="py-0.5 pr-2">${date}</td>
        <td class="py-0.5 pr-2">${cat}</td>
        <td class="py-0.5 pr-2">${fsub}</td>
        <td class="py-0.5 pr-0 text-right">${fmtTL(amt)}</td>
      </tr>`;
    }).join('');
    tbody.innerHTML = html;
  }catch(e){
    console.warn('renderThisMonthExpenses() error:', e);
    const tbody = document.getElementById('tblExpThisMonth');
    if (tbody) tbody.innerHTML = '<tr><td class="hint py-2" colspan="4">Liste y√ºklenemedi.</td></tr>';
  }
}

/* === Bu Ayƒ±n Giderleri: Kategori altƒ±nda (FinalSubcategory ‚Äì Subcategory) kƒ±rƒ±lƒ±mƒ± === */
async function renderThisMonthExpensesByCategory(){
  try{
    const wrap = document.getElementById('expThisMonthByCat');
    if (!wrap) return;

    // CSV'yi y√ºkle
    const rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);

    // Bu ayƒ±n ba≈ülangƒ±√ß/biti≈üi
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth(); // 0-index

    // Bu aya ait satƒ±rlarƒ± filtrele
    const inMonth = (rows||[]).filter(r=>{
      const ds = String(r.Date || r.date || '').slice(0,10);
      const d  = new Date(ds);
      return !isNaN(+d) && d.getFullYear() === y && d.getMonth() === m;
    });

    // Hi√ß veri yoksa
    if (!inMonth.length){
      wrap.innerHTML = '<div class="hint">Bu ay i√ßin gider bulunamadƒ±.</div>';
      const totEl = document.getElementById('expByCatTotal');
      if (totEl) totEl.textContent = '‚Äì';
      return;
    }

    // Kategori -> { sum, items: Map(label -> sum) }
    const totals = new Map();
    let grand = 0;

    inMonth.forEach(r=>{
      const cat = getFieldCI(r, ['Category','Kategori','Main Category','Ana Kategori','Cat']) || 'Diƒüer';
      const fsubRaw = getFieldCI(r, ['FinalSubcategory','Final Subcategory','Final','Nihai Alt Kategori']) || '';
      const subRaw  = getFieldCI(r, ['Subcategory','Sub-Category','Alt Kategori','AltKategori','Detail','Kalem']) || '';
      const label = (function(){
        if (fsubRaw && subRaw && String(fsubRaw) !== String(subRaw)) return `${fsubRaw} ‚Äì ${subRaw}`;
        if (fsubRaw) return String(fsubRaw);
        if (subRaw)  return String(subRaw);
        return 'Diƒüer';
      })();
      const amt = readExpenseAmountTRY(r);
      if (!(amt > 0)) return;
      grand += amt;

      if (!totals.has(cat)) totals.set(cat, { sum:0, items:new Map() });
      const entry = totals.get(cat);
      entry.sum += amt;
      entry.items.set(label, (entry.items.get(label)||0) + amt);
    });

    // Render: Kategorileri toplam tutara g√∂re b√ºy√ºkten k√º√ß√ºƒüe sƒ±rala
    const cats = Array.from(totals.entries()).sort((a,b)=> b[1].sum - a[1].sum);

    let html = '';
    cats.forEach(([cat, obj])=>{
      const items = Array.from(obj.items.entries()).sort((a,b)=> b[1] - a[1]);
      const listHTML = items.map(([label, val])=> `<li>${label} ‚Äî <strong>${numberTL(val)}</strong></li>`).join('');
      html += `
        <div class="mt-2">
          <div class="font-medium">${cat} ‚Äî Toplam Tutar: ${numberTL(obj.sum)}</div>
          <ul class="ml-4 list-disc">
            ${listHTML}
          </ul>
        </div>
      `;
    });

    const totEl = document.getElementById('expByCatTotal');
    if (totEl) totEl.textContent = numberTL(grand);
    wrap.innerHTML = html || '<div class="hint">Bu ay i√ßin gider bulunamadƒ±.</div>';
  }catch(e){
    console.warn('renderThisMonthExpensesByCategory() error:', e);
    const wrap = document.getElementById('expThisMonthByCat');
    if (wrap) wrap.innerHTML = '<div class="hint">Liste y√ºklenemedi.</div>';
    const totEl = document.getElementById('expByCatTotal');
    if (totEl) totEl.textContent = '‚Äì';
  }
}

/* === Expenses CSV'den kredi taksitlerini say ve Loans UI'ƒ± g√ºncelle === */
async function refreshLoansFromExpenses(){
  try{
    // CSV'yi oku (mevcut loader'ƒ±nƒ± kullanƒ±yoruz)
    const rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);

    // Mevcut loans config/state'i al
    const st = (typeof getLoansState === 'function') ? getLoansState() : (window.defaultLoansState || {
      loans:{
        biz:{ total:24, paid:0, instTRY:0, remainTRY:0, principalTRY:0, monthlyRate:0 },
        car:{ total:24, paid:0, instTRY:0, remainTRY:0, principalTRY:0, monthlyRate:0 },
        biz2: { total:24, paid:0, instTRY:71452.86, remainTRY:1714868.61, principalTRY:1714868.61, monthlyRate:0 }
      },
      zeeAwaitUSD:[]
    });

    // === Filtre ko≈üullarƒ± (daha sƒ±kƒ± ve AY bazƒ±nda tekil sayƒ±m) ===
    // "Taksitli Ticari Kredi" sayƒ±mƒ±:
    //  - Subcategory = "Kredi" (case-insensitive, tam e≈üle≈üme)
    //  - Tutar ‚âà 143.155 TL (instTRY varsa ona ¬±500 TL tolerans; yoksa hedefe ¬±500 TL)
    //  - Aynƒ± ay i√ßinde birden fazla satƒ±r varsa 1 taksit say (month-dedup)
    //
    // "Ara√ß Kredisi":
    //  - Subcategory "Kredi" ve satƒ±rda ara√ß/ta≈üƒ±t ipucu (subcategory veya final sub)
    //  - Tutar mantƒ±klƒ± bandda; AY bazƒ±nda tekil.
    const NORM = s => String(s||'').toLowerCase().trim();

    const BIZ_TARGET = Number(st?.loans?.biz?.instTRY) > 0 ? Number(st.loans.biz.instTRY) : 143_155;
    const BIZ_EPS    = 500; // ¬±500 TL tolerans

    // Kredi 2 (Taksitli Ticari Kredi 2)
    const BIZ2_TARGET = Number(st?.loans?.biz2?.instTRY) > 0 ? Number(st.loans.biz2.instTRY) : 71_453;
    const BIZ2_EPS    = 500; // ¬±500 TL tolerans

    // Ara√ß ipu√ßlarƒ±
    const CAR_HINT_RE = /(ara√ß|ta≈üƒ±t|oto|otomobil)/i;
    const CAR_TARGET  = Number(st?.loans?.car?.instTRY) > 0 ? Number(st.loans.car.instTRY) : 30_000;
    const CAR_EPS     = 1_500; // ¬±1.5K TL varsayƒ±lan tolerans

    // Distinct month sets (YYYY-MM)
    const bizMonths = new Set();
    const biz2Months = new Set();
    const carMonths = new Set();

    // Yardƒ±mcƒ±: YYYY-MM anahtarƒ±
    const monthKeyFromRow = (r) => {
      try{
        const dstr = String(r.Date || r.date || '').slice(0,10);
        if(!dstr) return '';
        const dt = new Date(dstr);
        if (isNaN(+dt)) return '';
        return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
      }catch(_){ return ''; }
    };

    (rows||[]).forEach(r=>{
      const subRaw = readExpenseSubcat(r);
      const sub = NORM(subRaw);
      if (!sub) return;

      const amt = readExpenseAmountTRY(r);
      if (!(amt > 0)) return;

      const monthK = monthKeyFromRow(r);
      if (!monthK) return;

      // FinalSubcategory‚Äôyi de ipucu olarak okuyalƒ±m
      const finSub = NORM(r.FinalSubcategory || r['Final Subcategory'] || r.Final || '');

      // --- Ara√ß kredisi ayƒ±klama ---
      const isCarHint = CAR_HINT_RE.test(sub) || CAR_HINT_RE.test(finSub);

      // --- Kredi 2 ayƒ±klama ---
      const isKredi2Hint = /kredi\s*2|kredi\s*ii|ticari\s*2/.test(sub) || /kredi\s*2|kredi\s*ii|ticari\s*2/.test(finSub);

      // Yalnƒ±zca "Kredi" alt kategorisini say (tam e≈üle≈üme)
      const isSubKredi = sub === 'kredi' || finSub === 'kredi';

      // === Kredi 2 (check first, most specific) ===
      if (isKredi2Hint){
        const near = Math.abs(amt - BIZ2_TARGET) <= BIZ2_EPS;
        if (near) biz2Months.add(monthK);
      }
      // === ƒ∞≈ületme/Ticari kredi (regular) ===
      else if (isSubKredi && !isCarHint){
        const near = Math.abs(amt - BIZ_TARGET) <= BIZ_EPS;
        if (near) bizMonths.add(monthK);
      }
      // === Ara√ß kredisi ===
      else if (isSubKredi && isCarHint){
        const nearCar = Math.abs(amt - CAR_TARGET) <= CAR_EPS;
        if (nearCar) carMonths.add(monthK);
      }
    });

    // AY bazƒ±nda tekil sayƒ±m
    const bizPaid = bizMonths.size;
    const biz2Paid = biz2Months.size;
    const carPaid = carMonths.size;

    // State'i g√ºncelle
    st.loans = st.loans || {};
    st.loans.biz = Object.assign({ total:24, instTRY:143000, remainTRY:0 }, st.loans.biz||{});
    st.loans.car = Object.assign({ total:24, instTRY:30000,  remainTRY:0 }, st.loans.car||{});
    st.loans.biz2 = Object.assign(
      { total:24, instTRY:71452.86, remainTRY:1714868.61, principalTRY:1714868.61, monthlyRate:0, paid:0 },
      st.loans.biz2 || {}
    );
    st.loans.biz.paid = bizPaid;
    st.loans.biz2.paid = biz2Paid;
    st.loans.car.paid = carPaid;

    // Kalan toplamƒ± kabaca taksit* (kalan adet) olarak g√ºncelle (opsiyonel)
    const bizRemainCnt = Math.max(0, (st.loans.biz.total||0) - bizPaid);
    const biz2RemainCnt = Math.max(0, (st.loans.biz2.total||0) - biz2Paid);
    const carRemainCnt = Math.max(0, (st.loans.car.total||0) - carPaid);
    if (st.loans.biz.instTRY>0) st.loans.biz.remainTRY = bizRemainCnt * Number(st.loans.biz.instTRY||0);
    if (st.loans.biz2.instTRY>0) st.loans.biz2.remainTRY = biz2RemainCnt * Number(st.loans.biz2.instTRY||0);
    if (st.loans.car.instTRY>0) st.loans.car.remainTRY = carRemainCnt * Number(st.loans.car.instTRY||0);

    // Kaydet + UI
    if (typeof setLoansState === 'function') setLoansState(st);
    try{
      localStorage.removeItem('popdog_expenses_cache');
    }catch(_){}
    if (typeof renderLoansBlock === 'function') renderLoansBlock();

  }catch(e){
    console.warn('refreshLoansFromExpenses() error:', e);
  }
}

// === Zee.Dog: Expenses'tan paid olanlarƒ± i≈üaretle + TRY hesapla ===
async function refreshZeeAwaitFromExpenses(){
  try{
    // Always bust the cached expenses before scanning (ensures we see latest Notes)
    try{ localStorage.removeItem('popdog_expenses_cache'); }catch(_){}
    // 1) Expenses'ƒ± y√ºkle
    const rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);

    // 2) Note/Not/A√ßƒ±klama i√ßinden YK#... yakala (case-insensitive header names)
    const NOTE_KEYS = ['Note','Notes','Not','A√ßƒ±klama','A√ßƒ±klama 2','Description','DetailNote','Source','Kaynak','Detay'];
    const getNote = (r) => {
      const v = getFieldCI(r, NOTE_KEYS);
      return v !== '' ? String(v).trim() : '';
    };
    const idFromNote = (s) => {
      const m = String(s||'').match(/YK#\d+(?:\.\d+)?/i);
      return m ? m[0].toUpperCase() : '';
    };
    // Fallback: scan all string fields on the row for an ID like YK#033 or YK#033.1
    const idFromAnyField = (row) => {
      try{
        for (const k in row){
          const v = row[k];
          if (v == null) continue;
          const m = String(v).match(/YK#\d+(?:\.\d+)?/i);
          if (m) return m[0].toUpperCase();
        }
      }catch(_){}
      return '';
    };
    // Zee.Dog satƒ±rƒ± olup olmadƒ±ƒüƒ±nƒ± Subcategory/FinalSubcategory √ºzerinden, case-insensitive bak
    const isZeeRow = (r) => {
      const sub = String(getFieldCI(r, ['Subcategory','FinalSubcategory','Final Subcategory']) || '').toLowerCase();
      return /zee\.?dog/.test(sub);
    };

    // √ñdeme tutarlarƒ±nƒ± ID bazƒ±nda topla
    const paymentsByID = new Map(); // Map<ID, totalUSD>
    const AMT_KEYS = ['AmountTRY','Amount','Tutar','Tutar (TRY)','TRY'];
    const CURR_KEYS = ['Currency','Para Birimi'];

    for (const r of rows) {
      if (!isZeeRow(r)) continue;
      let id = idFromNote(getNote(r));
      if (!id) id = idFromAnyField(r);
      if (!id) continue;

      // Tutar ve para birimini al
      const amtTRY = Number(getFieldCI(r, AMT_KEYS) || 0);
      if (amtTRY <= 0) continue;

      // Zee.Dog √∂demeleri i√ßin varsayƒ±lan para birimi USD (Currency s√ºtunu yoksa veya bo≈üsa)
      const currencyField = getFieldCI(r, CURR_KEYS);
      const currency = currencyField ? String(currencyField).toUpperCase() : 'USD';

      // USD'ye √ßevir
      let amtUSD = 0;
      if (currency === 'USD') {
        amtUSD = amtTRY; // AmountTRY aslƒ±nda USD ise (s√ºtun adƒ± AmountTRY ama deƒüer USD)
      } else {
        // TRY ise USD'ye √ßevir (getTryPerUsd = ka√ß TRY = 1 USD, mesela 43.3)
        // TRY ‚Üí USD d√∂n√º≈ü√ºm√º: TRY tutarƒ± / (TRY/USD oranƒ±)
        const fx = (typeof getTryPerUsd === 'function') ? getTryPerUsd() : 0;
        amtUSD = fx > 0 ? (amtTRY / fx) : 0;
      }

      // Sanity check: USD tutarƒ± √ßok b√ºy√ºkse (>$500k), muhtemelen TRY yanlƒ±≈ülƒ±kla USD olarak algƒ±lanmƒ±≈ü
      if (amtUSD > 500000) {
        console.warn(`[Zee.Dog] ≈û√ºpheli y√ºksek √∂deme tutarƒ±: ${id} i√ßin $${amtUSD.toFixed(2)} (kaynak: ‚Ç∫${amtTRY}, currency: ${currency}). Bu √∂deme atlandƒ±.`);
        continue;
      }

      // Bu ID i√ßin toplama ekle
      const current = paymentsByID.get(id) || 0;
      paymentsByID.set(id, current + amtUSD);
    }

    // 3) State'i al + yoksa default listeyi kullan
    const st = (typeof getLoansState === 'function') ? getLoansState() : (window.defaultLoansState || { zeeAwaitUSD: [] });
    if (!Array.isArray(st.zeeAwaitUSD) || st.zeeAwaitUSD.length===0) {
      st.zeeAwaitUSD = DEFAULT_ZEE_AWAIT.slice();
    }

    // 4) Kur (USD‚ÜíTRY)
    const fx = (typeof getTryPerUsd === 'function') ? getTryPerUsd() : 0;

    // 5) Her bir Zee.Dog √∂deme kaydƒ±nƒ± g√ºncelle
    st.zeeAwaitUSD = st.zeeAwaitUSD.map(it => {
      const id = String(it.id || '').toUpperCase();
      const totalUsd = Number(it.usd || 0);
      const paidUsd = paymentsByID.get(id) || 0;
      const remainingUsd = Math.max(0, totalUsd - paidUsd);

      // Durum belirle
      let status = 'waiting';
      if (remainingUsd <= 0.01) { // Tam √∂dendi (1 cent tolerans)
        status = 'paid';
      } else if (paidUsd > 0) { // Kƒ±smi √∂dendi
        status = 'partially_paid';
      }

      const prevTRY = (typeof it.try === 'number') ? it.try : null;
      const nextTRY = (fx > 0 && totalUsd > 0) ? (totalUsd * fx) : prevTRY;

      return {
        ...it,
        paidUsd: paidUsd,
        remainingUsd: remainingUsd,
        status: status,
        try: nextTRY
      };
    });

    // 5.5) Ana ID'leri alt ID'lerden hesapla (YK#034 = YK#034.1 + YK#034.2 gibi)
    // Ana ID'leri bul (nokta i√ßermeyen, √∂rn: YK#034, YK#035)
    const parentIds = st.zeeAwaitUSD.filter(z => !String(z.id).includes('.')).map(z => z.id.toUpperCase());

    parentIds.forEach(parentId => {
      // Bu ana ID'nin alt ID'lerini bul (YK#034.1, YK#034.2 gibi)
      const children = st.zeeAwaitUSD.filter(z => {
        const id = String(z.id).toUpperCase();
        return id.startsWith(parentId + '.'); // YK#034. ile ba≈ülayanlar
      });

      if (children.length === 0) return; // Alt ID yoksa atla

      // Alt ID'lerin toplam √∂denen ve kalanƒ±nƒ± hesapla
      const childrenPaidTotal = children.reduce((sum, c) => sum + Number(c.paidUsd || 0), 0);
      const childrenRemainingTotal = children.reduce((sum, c) => sum + Number(c.remainingUsd || 0), 0);

      // Ana ID'yi g√ºncelle
      const parent = st.zeeAwaitUSD.find(z => z.id.toUpperCase() === parentId);
      if (parent) {
        parent.paidUsd = childrenPaidTotal;
        parent.remainingUsd = childrenRemainingTotal;

        // Durum g√ºncelle
        if (childrenRemainingTotal <= 0.01) {
          parent.status = 'paid';
        } else if (childrenPaidTotal > 0) {
          parent.status = 'partially_paid';
        } else {
          parent.status = 'waiting';
        }
      }
    });

    // 6) Kaydet + UI
    if (typeof setLoansState === 'function') setLoansState(st);
    if (typeof renderLoansBlock === 'function') renderLoansBlock();
  }catch(e){
    console.warn('refreshZeeAwaitFromExpenses() error:', e);
  }
}

document.addEventListener('DOMContentLoaded', async function(){
  // Ensure fresh expenses before both passes
  try{ localStorage.removeItem('popdog_expenses_cache'); }catch(_){}

  // Run sequential operations that depend on cache clear
  try{ await refreshLoansFromExpenses(); }catch(e){ console.warn('refreshLoansFromExpenses error:', e); }
  try{ localStorage.removeItem('popdog_expenses_cache'); }catch(_){}
  try{ await refreshZeeAwaitFromExpenses(); }catch(e){ console.warn('refreshZeeAwaitFromExpenses error:', e); }

  // Run independent operations in parallel
  await Promise.allSettled([
    (async () => { try{ await renderThisMonthExpenses(); }catch(e){ console.warn('renderThisMonthExpenses error:', e); } })(),
    (async () => { try{ await renderThisMonthExpensesByCategory(); }catch(e){ console.warn('renderThisMonthExpensesByCategory error:', e); } })(),
    (async () => { try{ await refreshGoldFromScript(); }catch(e){ console.warn('refreshGoldFromScript error:', e); } })()
  ]);
}, { once:true });

/* Re-run Zee + Loans refresh after "Gider Ekle" form submits (best-effort) */
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('expAddBtn');
  if (!btn) return;
  // We don't intercept the existing click handler; we just schedule a refresh shortly after.
  btn.addEventListener('click', function(){
    // Give the existing submit/write flow a moment to complete before refreshing.
    setTimeout(async function(){
      try{ localStorage.removeItem('popdog_expenses_cache'); }catch(_){}
      try{ await refreshLoansFromExpenses(); }catch(_){}
      try{ await refreshZeeAwaitFromExpenses(); }catch(_){}
      try{ await renderThisMonthExpenses(); }catch(_){}
      try{ await renderThisMonthExpensesByCategory(); }catch(_){}
    }, 1800);
  });
}, { once:true });
function toMonday(d){
  const dt = new Date(d); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt;
}
function addDays(d, n){ const dt = new Date(d); dt.setDate(dt.getDate()+n); return dt; }
function weekRangeLabel(monday){
  const sun = addDays(monday, 6);
  const f = (x)=> `${x.getDate().toString().padStart(2,'0')}.${(x.getMonth()+1).toString().padStart(2,'0')}`;
  return `${f(monday)} ‚Äì ${f(sun)}`;
}

/* Cache-bust */
function withCacheBust(url){
  if(!url) return '';
  const sep = url.includes('?') ? '&' : '?';
  return `${url}${sep}t=${Date.now()}`;
}

// === Missing helpers (used by CSV loaders) ===
// assetURL: currently just applies cache-bust; can be extended later for local assets
function assetURL(url){
  try{
    return withCacheBust(url);
  }catch(e){
    return url || '';
  }
}

// isFreshMode: controls fetch cache mode; can be toggled via ?fresh=1 or localStorage flag
function isFreshMode(){
  try{
    const p = getParam('fresh');
    if (p === '1') return true;
    if (p === '0') return false;
    const s = localStorage.getItem('popdog_fresh_mode');
    if (s === '1') return true;
    if (s === '0') return false;
  } catch(e){}
  return true; // default: fresh mode on (force reload)
}

/* ================== QUERY PARAM HELPERS ================== */
function getParam(name){
  try { return new URLSearchParams(location.search).get(name) || ''; } catch(e){ return ''; }
}

/* Clean-on-load flag: URL ?clean=1/0 overrides; falls back to localStorage; default = true */
function isCleanOnLoad(){
  try{
    const p = getParam('clean');
    if (p === '1') return true;
    if (p === '0') return false;
    const s = localStorage.getItem('popdog_clean_on_load');
    if (s === '1') return true;
    if (s === '0') return false;
  }catch(e){}
  return true; // default: clean enabled
}

/* ================== STATE ================== */
/* === Ensure daily rows are deduped by Date (keep richer row) === */
let loadedRows = [];     // revenue rows (sheet csv)
// IMPORTANT: use a single shared stagedRows array everywhere.
// Some code paths used a local `stagedRows` while others used `window.stagedRows`.
// If those diverge, the "Sheet‚Äôe Yaz" button thinks there are 0 rows.
if (!Array.isArray(window.stagedRows)) window.stagedRows = [];
let stagedRows = window.stagedRows; // legacy compat: keep name but point to the shared array
let fxRateUSDPerTRY = null;
let fxDate = null;
let mergedRowsCache = [];

// === REMOVED: Duplicate function definition (kept the version at line ~5231) ===

/* ================== CSV LOADERS ================== */
async function loadFromSheet(url){
  const resp = await fetch(assetURL(url), { cache: isFreshMode()? 'reload' : 'default' });
  if(!resp.ok) throw new Error(`CSV fetch failed: ${resp.status}`);
  const csvText = await resp.text();
  return new Promise((resolve,reject)=>{
    Papa.parse(csvText, {
      header:true, skipEmptyLines:true,
      worker:true, fastMode:true,
      complete: (res)=>{
        try{
          const data = (res.data||[]).map(r=>{
            const iso = r.Date ? String(r.Date).trim().slice(0,10) : '';
            // Kuaf√∂r s√ºtunu: Kuaf√∂r, Kuafor veya Grooming olabilir
            const kuaforVal = parseTL(r['Kuaf√∂r'] ?? r['Kuafor'] ?? r['Grooming'] ?? 0);
            const row = {
              Date: iso,
              Toptan: parseTL(r.Toptan),
              Online: parseTL(r.Online),
              CKM: parseTL(r.CKM),
              "CKM Nakit": parseTL(r["CKM Nakit"]),
              Kuaf√∂r: kuaforVal,
              Trendyol: parseTL(r.Trendyol),
              Hepsiburada: parseTL(r.Hepsiburada),
            };
            row.Total = row.Toptan + row.Online + row.CKM + row.Kuaf√∂r + row.Trendyol + row.Hepsiburada;
            return row;
          }).filter(r=>r.Date);
          // Optional cleaning while loading from Sheet:
          // - dedupe same-day rows (keeps the row with higher Total or more non-zero fields)
          // - sort by Date ascending
          const cleaned = isCleanOnLoad() ? dedupeDailyRows(data) : data;
          resolve(cleaned);
        }catch(e){ reject(e); }
      },
      error: reject
    });
  });
}

function loadCSV(url){
  return new Promise((resolve,reject)=>{
    if(!url) return resolve([]);
    Papa.parse(assetURL(url), {
      download:true, header:true, skipEmptyLines:true,
      worker:true, fastMode:true,
      complete: (res)=> resolve(res.data||[]),
      error: reject
    });
  });
}

// Robust normalizer so Papa.parse output always has Date normalized.
function parseExpenseRow(r){
  try{
    const iso = getExpenseISODate(r) || '';
    // IMPORTANT:
    // Do NOT modify or overwrite r.Amount here.
    // Keep raw CSV fields intact so readExpenseAmountTRY(r) can apply FX exactly once later.
    return { ...r, Date: (iso || r.Date || r.date || '') };
  }catch(e){
    return r || {};
  }
}

// Correct CSV loader for Expenses (fetch text, then Papa.parse on string)
async function loadExpensesCsv(url){
  if (!url) return [];
  try{
    const resp = await fetch(withCacheBust(url), { cache: 'no-store' });
    if (!resp.ok) return [];
    const text = await resp.text();

    return await new Promise((resolve) => {
      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
const rows = (res.data || [])
  .map(parseExpenseRow)
  .filter(r => r.Date);          resolve(rows);
        },
        error: () => resolve([])
      });
    });
  }catch(e){
    return [];
  }
}

/* ========= Gider Ekle (UI + Sheet yazma) ========= */
// Ek kolon alias'larƒ±
const CATEGORY_KEYS = ['Category','Kategori','Main Category','Ana Kategori','Cat'];
const FINALSUB_KEYS = ['FinalSubcategory','Final Subcategory','FinalSubcat','Final Sub-Category','Nihai Alt Kategori','Final','FinalSub'];
// Subcategory ‚Üí { category, final } e≈ülemesi (CSV'den t√ºretilir)
let EXP_SUBMAP = {};  // √∂r: { "Kargo": { category:"Lojistik", final:"Kargo" } }
// Alt kategori kolon isimleri i√ßin olasƒ± ba≈ülƒ±klar
const SUBCAT_KEYS = ['Subcategory', 'Sub-Category', 'Subcat', 'Alt Kategori', 'AltKategori', 'Detail', 'Kalem'];

// Mevcut expenses CSV‚Äôden benzersiz alt kategorileri topla + kategori/final e≈ülemesi
async function loadExpenseSubcategories(){
  try{
    // 1) √ñnce localStorage cache varsa kullan
    let rows = [];
    try{ rows = JSON.parse(localStorage.getItem('popdog_expenses_cache') || '[]'); }catch(_){}
    // 2) Yoksa CSV‚Äôden y√ºkle
    if(!Array.isArray(rows) || rows.length===0){
      rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);
      try{ localStorage.setItem('popdog_expenses_cache', JSON.stringify(rows||[])); }catch(_){}
    }

    // 3) Set + e≈üleme (subcategory ‚Üí {category, final})
    const set = new Set();
    const map = {};

    (rows||[]).forEach(r=>{
      if(!r) return;

      // Subcategory value
      let sub = '';
      for(const k of SUBCAT_KEYS){
        if(r[k]!=null && String(r[k]).trim()!==''){ sub = String(r[k]).trim(); break; }
      }
      if(!sub) return;

      // Category value
      let cat = '';
      for(const k of CATEGORY_KEYS){
        if(r[k]!=null && String(r[k]).trim()!==''){ cat = String(r[k]).trim(); break; }
      }

      // FinalSubcategory value
      let fin = '';
      for(const k of FINALSUB_KEYS){
        if(r[k]!=null && String(r[k]).trim()!==''){ fin = String(r[k]).trim(); break; }
      }

      set.add(sub);
      // ƒ∞lk geleni koru, bo≈üsa doldur
      if(!map[sub]) map[sub] = { category: cat || '', final: fin || sub };
    });

    // Bo≈üsa en azƒ±ndan bir ka√ß √∂neri bƒ±rak
    if(set.size===0){
      ['Kira','Elektrik','Personel','Kargo','Reklam','Sarf','Diƒüer'].forEach(x=>{
        set.add(x);
        if(!map[x]) map[x] = { category:'', final:x };
      });
    }

    // Global ve localStorage'a yaz
    EXP_SUBMAP = map;
    try{ localStorage.setItem('popdog_expenses_submap', JSON.stringify(map)); }catch(_){}

    return Array.from(set).sort((a,b)=> a.localeCompare(b,'tr'));
  }catch(e){
    // Map fallback
    EXP_SUBMAP = {};
    return ['Diƒüer'];
  }
}

// Tarih: <input type="date"> ‚Üí YYYY-MM-DD
function dateToISO(d){
  if(!d) return '';
  const s = String(d).trim();
  if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return '';
  return s; // already ISO-like from <input type="date">
}

// Sheet‚Äôe gider satƒ±rƒ± yaz (daha saƒülam hata yakalama + JSON kontrol)
  async function appendExpenseRow({ dateISO, subcat, amountTRY, note }){
  // Subcategory e≈üle≈ümesinden kategori/final √ßek
  let cat = '', fin = '';
  try{
    const m = EXP_SUBMAP && EXP_SUBMAP[subcat] ? EXP_SUBMAP[subcat] : JSON.parse(localStorage.getItem('popdog_expenses_submap')||'{}')[subcat];
    if(m){ cat = m.category || ''; fin = m.final || subcat; } else { fin = subcat; }
  }catch(_){ fin = subcat; }

  const payload = {
    action: 'appendExpense',
    row: {
      Date: dateISO,                       // YYYY-MM-DD (01)
      Subcategory: subcat,                 // alt kategori
      Category: cat,                       // ana kategori (varsa)
      FinalSubcategory: fin,               // nihai alt kategori (varsa)
      AmountTRY: Math.round(amountTRY || 0), // tamsayƒ±ya yuvarla
      Note: note || ''
    }
  };
  const WEBAPP_URL = getSheetWebAppURL();
  async function postOnceFlexible(body){
    const url = WEBAPP_URL;

    // Strategy A: JSON POST
    try{
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;charset=utf-8' },
        body: JSON.stringify(body)
      });
      if (r.ok){
        const raw = await r.text().catch(()=> '');
        let json = null; try{ json = JSON.parse(raw); }catch(_){ /* ignore */ }
        return { json, raw };
      }
      // If 400/unknown action text is present, bubble for fallback
      const raw = await r.text().catch(()=> '');
      throw new Error(`HTTP ${r.status}${raw? ' ‚Ä¢ '+raw : ''}`);
    }catch(e){ /* fall through to Strategy B */ }

    // Strategy B: x-www-form-urlencoded POST (Apps Script classic doPost(e.parameter))
    try{
      const form = new URLSearchParams();
      Object.keys(body||{}).forEach(k=>{
        const v = body[k];
        form.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
      });
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8' },
        body: form.toString()
      });
      if (r.ok){
        const raw = await r.text().catch(()=> '');
        let json = null; try{ json = JSON.parse(raw); }catch(_){ /* ignore */ }
        return { json, raw };
      }
      const raw = await r.text().catch(()=> '');
      throw new Error(`HTTP ${r.status}${raw? ' ‚Ä¢ '+raw : ''}`);
    }catch(e){ /* fall through to Strategy C */ }

    // Strategy C: GET with query params (very legacy handlers; beware URL length)
    const params = new URLSearchParams();
    Object.keys(body||{}).forEach(k=>{
      const v = body[k];
      params.append(k, typeof v === 'object' ? encodeURIComponent(JSON.stringify(v)) : String(v));
    });
    const r = await fetch(`${url}?${params.toString()}`, { method: 'GET' });
    const raw = await r.text().catch(()=> '');
    let json = null; try{ json = JSON.parse(raw); }catch(_){ /* ignore */ }
    if (!r.ok) throw new Error(`HTTP ${r.status}${raw? ' ‚Ä¢ '+raw : ''}`);
    return { json, raw };
  }

  const attempts = [];
  {
    const compat = getWebAppCompat();
    if (compat && (compat.rowsKey || compat.actionKey || compat.expenseAction)){
      const ak = compat.actionKey || 'action';
      const av = compat.expenseAction || 'appendExpense';
      // prefer 'row' for single; fallback to compat.rowsKey if provided
      const rk = compat.rowsKey || 'row';
      const b1 = {}; b1[rk] = payload.row; if (ak) b1[ak] = av; attempts.push(b1);
      const b2 = {}; b2[rk] = JSON.stringify(payload.row); if (ak) b2[ak] = av; attempts.push(b2);
    }
  }
  attempts.push(
    { action: 'appendExpense', row: payload.row },
    { action: 'append_expense', row: payload.row },
    { action: 'expenseAppend',  row: payload.row },
    { action: 'appendRow',      row: payload.row },
    { action: 'append',         row: payload.row },
    // legacy: rowJson / data
    { action: 'appendExpense', rowJson: JSON.stringify(payload.row) },
    { action: 'appendExpense', data: payload.row },
    { data: JSON.stringify(payload.row) },
    // very old handlers: flat payload
    payload.row
  );

  for (const body of attempts){
    try{
      const { json, raw } = await postOnceFlexible(body);
      if (json && json.ok === false && /UNKNOWN_ACTION|unknown\s*action|no\s*such\s*action/i.test(String(json.error||json.message||''))){
        continue; // try next
      }
      if (json && json.ok === false){
        throw new Error(`Server ‚Ä¢ ${json.error || json.message || 'unknown error'}`);
      }
      if (json && (json.error || json.message)){
        try{
          localStorage.removeItem('popdog_expenses_cache');
          if (subcat) bumpLoansPaidIfMatches(subcat, amountTRY);
          if (typeof renderLoansBlock === 'function') renderLoansBlock();
        }catch(_){}
        return String(json.message || json.error);
      }
      // Success case - update cache and return
      try{
        localStorage.removeItem('popdog_expenses_cache');
        if (subcat) bumpLoansPaidIfMatches(subcat, amountTRY);
        if (typeof renderLoansBlock === 'function') renderLoansBlock();
      } catch(_){}
      return 'Sheet g√ºncellendi';
    }catch(e){
      const s = String(e && e.message || '');
      if (/UNKNOWN_ACTION|unknown\s*action|no\s*such\s*action/i.test(s)) continue;
      // network or other errors ‚Üí bubble up
      throw e;
    }
  }
  throw new Error('UNKNOWN_ACTION: Sunucu appendExpense i≈ülemini tanƒ±mƒ±yor. (appendExpense/appendRow/append)');
}

// Web App baƒülantƒ± testi (opsiyonel)
async function pingSheetWebApp(){
  try{
    // Try POST __ping__ (preferred)
    const r = await fetch(getSheetWebAppURL(), {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: '__ping__' })
    });
    if (r && r.ok) return true;
  }catch(_){}
  try{
    // Fallback: simple GET
    const g = await fetch(getSheetWebAppURL(), { method: 'GET' });
    return !!(g && g.ok);
  }catch(_){
    return false;
  }
}

// UI init
async function initExpenseEntryUI(){
  const sel = document.getElementById('expSubSel');
  const info = document.getElementById('expAddInfo');
  const btn = document.getElementById('expAddBtn');

  // Baƒülantƒ± uyarƒ±sƒ± (erken)
  try{
    if(info) info.textContent = 'Baƒülantƒ± kontrol ediliyor‚Ä¶';
    const ok = await pingSheetWebApp();
    if(!ok && info){
      info.textContent = '‚ö†Ô∏è Sheet baƒülantƒ±sƒ± yok. Apps Script Web App: Deploy‚ÜíWeb app ‚Üí Execute as: Me ¬∑ Access: Anyone (link). Ardƒ±ndan kendi /exec URL\'nizi localStorage\'a kaydedin: localStorage.setItem("popdog_sheet_webapp_url","https://script.google.com/macros/s/XXX/exec")';
    }
    try{
      const b = document.getElementById('writeSheetBtn');
      if(!ok && b){ b.onclick = ()=> setupSheetWebAppURL(info); }
    }catch(_){}
  }catch(_){ /* sessiz */ }
  try{
    const w = document.getElementById('writeSheetBtn');
    if (w) w.addEventListener('contextmenu', (e)=>{ e.preventDefault(); setupWebAppCompat(info); });
  }catch(_){}

  // Alt kategorileri doldur
  try{
    const subs = await loadExpenseSubcategories();
    if(sel){
      sel.innerHTML = `<option value="">Se√ßiniz‚Ä¶</option>` + subs.map(s=>`<option>${s}</option>`).join('');
    }
    if(info) info.textContent = `Alt kategori sayƒ±sƒ±: ${subs.length}`;
  }catch(e){
    if(sel) sel.innerHTML = `<option value="">(y√ºklenemedi)</option>`;
    if(info) info.textContent = `‚ö†Ô∏è Alt kategoriler y√ºklenemedi: ${e.message||e}`;
  }

  // Varsayƒ±lan: bug√ºn se√ßili gelsin
  try{
    const dateInput = document.getElementById('expDate');
    if(dateInput && !dateInput.value){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      dateInput.value = `${y}-${m}-${d}`;
    }
  }catch(_){/* sessiz */}

  // Ekle butonu
  if(btn){
    btn.onclick = async ()=>{
      const dateVal = document.getElementById('expDate')?.value || '';
      const subVal  = document.getElementById('expSubSel')?.value || '';
      const amtVal  = document.getElementById('expAmount')?.value || '';
      const noteVal = document.getElementById('expNote')?.value || '';

      const infoEl = document.getElementById('expAddInfo');
      function setInfo(t){ if(infoEl) infoEl.textContent = t; }

      // Validasyon
      const dateISO = dateToISO(dateVal);
      if(!dateISO){ setInfo('L√ºtfen bir tarih se√ßin (YYYY-AA-GG).'); return; }
      if(!subVal){ setInfo('Alt kategori se√ßin.'); return; }
      const amountTRY = parseTL(amtVal);
      if(!amountTRY || amountTRY<=0){ setInfo('Tutar (‚Ç∫) girin.'); return; }

      try{
        setInfo('G√∂nderiliyor‚Ä¶');
        // Optional UX: kategori e≈üle≈ümesi yoksa bilgi ver
        if(!EXP_SUBMAP[subVal]){
          setInfo('G√∂nderiliyor‚Ä¶ (kategori e≈üle≈ümesi bulunamadƒ±, FinalSubcategory=subcat yazƒ±lacak)');
        }
        const msg = await appendExpenseRow({ dateISO, subcat: subVal, amountTRY, note: noteVal });
        setInfo(`‚úì Eklendi ‚Ä¢ ${msg||'Sheet g√ºncellendi'}`);
        applyExpenseToLoans({ amountTRY, subcat: subVal, note: noteVal });
        // Gerekirse cache‚Äôi kirletme & ekrana tazeleme
        try{ localStorage.removeItem('popdog_expenses_cache'); }catch(_){}
        try{ if(typeof refreshAll === 'function') refreshAll(); }catch(_){}
      }catch(err){
        setInfo(`‚ö†Ô∏è Hata: ${err && err.message ? err.message : err}\n‚Äî Olasƒ± nedenler: Web App URL hatalƒ±, yayƒ±n yapƒ±lmadƒ±/yeni versiyon se√ßilmedi veya eri≈üim izni (Anyone) kapalƒ±.`);
      }
    };
  }
}

// Sayfa y√ºklenince hazƒ±rla (router √ßalƒ±≈ütƒ±ktan sonra da √ßaƒürƒ±lƒ±rsa sorun yok)
document.addEventListener('DOMContentLoaded', ()=> {
  try{ initExpenseEntryUI(); }catch(_){}
});

document.addEventListener('DOMContentLoaded', ()=>{
  // 300ms sonra bir kere √ßek (UI render‚Äôdan sonra gelsin)
  setTimeout(refreshFundQuotes, 300);

  // Ekstra: √áift tƒ±kla anlƒ±k g√ºncelle
  ['fi5UnitInput','sasUnitInput','isyUnitInput'].forEach(id=>{
    const el = document.getElementById(id);
    if (el){
      el.title = '√áift tƒ±kla: sunucudan en son birim fiyatƒ± √ßek';
      el.addEventListener('dblclick', refreshFundQuotes);
    }
  });
});

/* ================== LOANS & PENDING (STATE + UI) ================== */
/* Kalƒ±cƒ± durum (localStorage) ≈üemasƒ± */
const LOANS_KEY = 'popdog_loans_state';
const defaultLoansState = {
  loans: {
    biz: {                    // Taksitli Ticari
      remainTRY: 2719938.78,
      paid: 5, total: 24,
      instTRY: 143154.67,
      principalTRY: 2000000,
      monthlyRate: 0.04640833
    },
    car: {                    // Taksitli Ara√ß
      remainTRY: 1453127.86,
      paid: 9, total: 24,
      instTRY: 96875.20,
      principalTRY: 1500000,
      monthlyRate: 0.03666666
    }
  },
  zeeAwaitUSD: [
    { id:'YK#033',   usd: 4626.02,  paid:true },
    { id:'YK#034',   usd: 39425.33, paid:false },
    { id:'YK#034.1', usd: 11827.00, paid:false },
    { id:'YK#034.2', usd: 27597.00, paid:false },
    { id:'YK#035',   usd: 37589.19, paid:false },
    { id:'YK#035.1', usd: 11276.76, paid:false },
    { id:'YK#035.2', usd: 26312.43, paid:false },
  ],
  demoBank: {
  goldGram: 169,
  gramTRY: Number(localStorage.getItem('popdog_gold_gram_try')||0) || 0, // kullanƒ±cƒ± girecek
  fi5Units: 565,
  fi5UnitTRY: Number(localStorage.getItem('popdog_fi5_unit_try')||0) || 0,  // kullanƒ±cƒ± girecek (birim fiyat)
  sasUnits: 114236,
  sasUnitTRY: Number(localStorage.getItem('popdog_sas_unit_try')||0) || 0,
  isyUnits: 2530000,
  isyUnitTRY: Number(localStorage.getItem('popdog_isy_unit_try')||0) || 0
}
};

function getLoansState(){
  try{
    const s = JSON.parse(localStorage.getItem(LOANS_KEY) || 'null');
    if (s && typeof s==='object') return s;
  }catch(_){}
  return structuredClone(defaultLoansState);
}
function setLoansState(st){
  try{ localStorage.setItem(LOANS_KEY, JSON.stringify(st)); }catch(_){}
}

/* Yardƒ±mcƒ±: yakla≈üƒ±k e≈üle≈üme (taksit sayƒ±sƒ± tahmini) */
function approxInstallments(paidAmount, instAmount){
  if (!instAmount) return 1;
  const k = Math.round(paidAmount / instAmount);
  return Math.max(1, k);
}

/* Zee ID yakalama: not metninde YK#... varsa */
function extractZeeIdFromNote(note){
  if(!note) return '';
  const m = String(note).match(/YK#\d+(?:\.\d+)?/i);
  return m ? m[0].toUpperCase() : '';
}

/* USD tutarƒ± nottan yakalama: $ 12,345.67 gibi */
function extractUSDFromNote(note){
  if(!note) return 0;
  const m = String(note).match(/\$?\s*([\d,]+(?:\.\d+)?)/);
  if (!m) return 0;
  const s = m[1].replace(/,/g,'');
  const v = Number(s);
  return isNaN(v) ? 0 : v;
}

/* TRY‚ÜîUSD yardƒ±mcƒ±larƒ± (mevcut koddaki oranlarƒ± kullanƒ±r) */
function tryPerUsd(){
  // varsa localStorage tpu, yoksa KPI‚Äôdan t√ºretilen
  const tpu = Number(localStorage.getItem('popdog_fx_try_per_usd') || '0');
  if (tpu>0) return tpu;
  const derived = deriveTryPerUsdFromKPI();
  return derived || 0;
}
function renderLoansBlock(){
  try{
    const st = (typeof getLoansState === 'function') ? getLoansState() : (window.defaultLoansState || {});
    const loans = st.loans || {};

    function applyLoan(prefix, loan){
      if (!loan) return;
      const total = Number(loan.total || 0);
      const paid  = Number(loan.paid  || 0);
      const inst  = Number(loan.instTRY || 0);
      const remain= Number(loan.remainTRY || 0);
      const princ = Number(loan.principalTRY || 0);
      const rate  = loan.monthlyRate;

      const id = (s)=> document.getElementById(prefix + s);

      const badge = id('PaidBadge');
      if (badge) badge.textContent = `${paid}/${total}`;

      const remainEl = id('Remain');
      if (remainEl) {
        const calcRemain = remain > 0 ? remain : Math.max(0, (total - paid) * inst);
        remainEl.textContent = numberTL(calcRemain);
      }

      const instEl = id('Inst');
      if (instEl) instEl.textContent = numberTL(inst);

      const princEl = id('Principal');
      if (princEl) {
        const calcPrinc = princ > 0 ? princ : inst * total;
        princEl.textContent = numberTL(calcPrinc);
      }

      const rateEl = id('Rate');
      if (rateEl) {
        if (rate != null && rate !== '' && !isNaN(Number(rate))) {
          rateEl.textContent = `${Number(rate).toFixed(2)}%`;
        } else {
          rateEl.textContent = '‚Äì';
        }
      }

      const bar = id('Bar');
      if (bar){
        const pct = total > 0 ? Math.max(0, Math.min(100, (paid / total) * 100)) : 0;
        bar.style.width = `${pct.toFixed(1)}%`;
      }
    }

    // 3 kredi: biz, car, biz2
    applyLoan('loanBiz',  loans.biz);
    applyLoan('loanCar',  loans.car);
    applyLoan('loanBiz2', loans.biz2);

    // Zee.Dog Bekleyen √ñdemeler tablosu
    const tbody = document.getElementById('tblZeeAwait');
    if (tbody){
      const fx = (typeof getTryPerUsd === 'function') ? getTryPerUsd() : 0;
      const list = Array.isArray(st.zeeAwaitUSD) && st.zeeAwaitUSD.length ? st.zeeAwaitUSD : (DEFAULT_ZEE_AWAIT || []);

      if (!list.length){
        tbody.innerHTML = '<tr><td class="hint py-2" colspan="5">Kayƒ±t bulunamadƒ±.</td></tr>';
      } else {
        const rows = list.map(it => {
          const totalUsd = Number(it.usd || 0);
          const paidUsd = Number(it.paidUsd || 0);
          const remainingUsd = Number(it.remainingUsd ?? totalUsd);
          const status = (it.status || '').toLowerCase();

          // Badge stil ve metni
          let badgeCls = 'badge-wait';
          let badgeText = 'Bekliyor';
          if (status === 'paid') {
            badgeCls = 'badge-paid';
            badgeText = '√ñdendi';
          } else if (status === 'partially_paid') {
            badgeCls = 'badge-partial';
            badgeText = 'Kƒ±smi √ñdendi';
          }

          return `
            <tr>
              <td class="py-1 pr-3">${it.id || ''}</td>
              <td class="py-1 pr-3 text-right">${totalUsd > 0 ? numberUSD(totalUsd) : '‚Äì'}</td>
              <td class="py-1 pr-3 text-right">${paidUsd > 0 ? numberUSD(paidUsd) : '‚Äì'}</td>
              <td class="py-1 pr-3 text-right">${remainingUsd > 0 ? numberUSD(remainingUsd) : '‚Äì'}</td>
              <td class="py-1 pr-0">
                <span class="${badgeCls}">${badgeText}</span>
              </td>
            </tr>`;
        }).join('');
        tbody.innerHTML = rows;
      }
    }
  }catch(e){
    console.warn('renderLoansBlock() error:', e);
  }
}

 

  window.renderLoansBlock = renderLoansBlock;

  // Zee listesi
  const tbody = document.getElementById('tblZeeAwait');
  const st = (typeof getLoansState === 'function') ? getLoansState() : defaultLoansState;

  const k = tryPerUsd();
  tbody.innerHTML = st.zeeAwaitUSD.map(z=>{
    const tryEq = k ? numberTL(z.usd * k) : '‚Äì';
    const badge = z.paid ? '<span class="badge-paid">paid</span>' : '<span class="badge-wait">waiting</span>';
    return `
      <tr>
        <td class="py-1 pr-3">${z.id}</td>
        <td class="py-1 pr-3 text-right">$ ${z.usd.toLocaleString('en-US',{maximumFractionDigits:2})}</td>
        <td class="py-1 pr-3 text-right">${tryEq}</td>
        <td class="py-1 pr-0">${badge}</td>
      </tr>
    `;
  }).join('');

  // Altƒ±n
  const gInput = document.getElementById('goldGramInput');
  if (gInput){
    if (!gInput.value && st.demoBank.gramTRY){ gInput.value = String(st.demoBank.gramTRY); }

    const applyGoldInput = ()=>{
      const v = parseTL(gInput.value);
      const s = getLoansState();
      s.demoBank.gramTRY = v;
      setLoansState(s);
      try{
        localStorage.setItem('popdog_gold_gram_try', String(v));
        localStorage.setItem('popdog_gold_updated_at', String(Date.now()));
      }catch(_){}
      renderLoansBlock();
    };

    // Deƒüer deƒüi≈üip input'tan √ßƒ±kƒ±ldƒ±ƒüƒ±nda √ßalƒ±≈üsƒ±n
    gInput.addEventListener('change', applyGoldInput);

    // Enter'a basƒ±nca da aynƒ± i≈ülemi yap
    gInput.addEventListener('keydown', (ev)=>{
      if (ev.key === 'Enter'){
        ev.preventDefault();
        applyGoldInput();
        try{ gInput.blur(); }catch(_){}
      }
    });
  }
  const gramPrice = st.demoBank.gramTRY || Number(localStorage.getItem('popdog_gold_gram_try')||0) || 0;
  const goldTotal = gramPrice ? gramPrice * st.demoBank.goldGram : 0;
  document.getElementById('goldTotal').textContent = goldTotal ? numberTL(goldTotal) : '‚Äì';
  {
    const GOLD_UPDATED_AT_KEY = 'popdog_gold_updated_at';
    const ts = Number(localStorage.getItem(GOLD_UPDATED_AT_KEY) || 0);
    const when = ts ? new Date(ts).toLocaleString('tr-TR') : '';
    const suffix = when ? ` ‚Ä¢ G√ºncellendi: ${when}` : '';
    document.getElementById('goldNote').textContent = gramPrice
      ? `Hesap: ${st.demoBank.goldGram} gr √ó ${numberTL(gramPrice)}${suffix}`
      : 'Gram fiyatƒ± girin';
  }
// FI5 (QNB Portf√∂y Para Piyasasƒ±) ‚Äî birim fiyat √ó adet
const fInput = document.getElementById('fi5UnitInput');
if (fInput){
  if (!fInput.value && st.demoBank.fi5UnitTRY){ fInput.value = String(st.demoBank.fi5UnitTRY); }

  const applyFi5Input = ()=>{
    const v = parseTL(fInput.value);
    const s = getLoansState();
    s.demoBank.fi5UnitTRY = v;
    setLoansState(s);
    localStorage.setItem('popdog_fi5_unit_try', String(v));
    localStorage.setItem('popdog_fi5_updated_at', String(Date.now()));
    renderLoansBlock();
  };

  fInput.addEventListener('change', applyFi5Input);
  fInput.addEventListener('keydown', (ev)=>{
    if (ev.key === 'Enter'){
      ev.preventDefault();
      applyFi5Input();
      try{ fInput.blur(); }catch(_){}
    }
  });
}

// === FI5 total (robust parse + sanity cap) ===
const fi5Inp = document.getElementById('fi5UnitInput');
let fi5Unit = fi5Inp ? parseTL(fi5Inp.value) : 0;
if (!(fi5Unit > 0 && fi5Unit < 2000)) {
  fi5Unit = 0; // kirli/zehirli deƒüeri yok say
}
// adet g√ºvenli: state‚Äôten al, yoksa 565
const fi5Qty = (st && st.demoBank && Number(st.demoBank.fi5Units)) || 565;

const fi5TotalVal = fi5Unit * fi5Qty;
const fi5TotalEl = document.getElementById('fi5Total');
if (fi5TotalEl) fi5TotalEl.textContent = fi5TotalVal ? numberTL(fi5TotalVal) : '‚Äì';

{
  const ts = Number(localStorage.getItem('popdog_fi5_updated_at') || 0);
  const when = ts ? new Date(ts).toLocaleString('tr-TR') : '';
  const suffix = when ? ` ‚Ä¢ G√ºncellendi: ${when}` : '';
  const noteEl = document.getElementById('fi5Note');
  if (noteEl) noteEl.textContent = fi5Unit
    ? `Hesap: ${fi5Qty} adet √ó ${numberTL(fi5Unit)}${suffix}`
    : 'Birim fiyat girin';
}
// Remove old FI5 total block if present
// (no action needed if not present)
  // SAS Fonu
const sasInput = document.getElementById('sasUnitInput');
if (sasInput){
  if (!sasInput.value && st.demoBank.sasUnitTRY){ sasInput.value = String(st.demoBank.sasUnitTRY); }
  sasInput.onchange = ()=>{
    const v = parseTL(sasInput.value);
    const s = getLoansState();
    s.demoBank.sasUnitTRY = v;
    setLoansState(s);
    localStorage.setItem('popdog_sas_unit_try', String(v));
    localStorage.setItem('popdog_sas_updated_at', String(Date.now()));
    renderLoansBlock();
  };
}
const sasUnit = st.demoBank.sasUnitTRY || Number(localStorage.getItem('popdog_sas_unit_try')||0) || 0;
const sasQty  = st.demoBank.sasUnits || 114236;
const sasSum  = sasUnit ? (sasUnit * sasQty) : 0;
const sasTotalEl = document.getElementById('sasTotal');
if (sasTotalEl) sasTotalEl.textContent = sasSum ? numberTL(sasSum) : '‚Äì';
{
  const ts = Number(localStorage.getItem('popdog_sas_updated_at') || 0);
  const when = ts ? new Date(ts).toLocaleString('tr-TR') : '';
  const suffix = when ? ` ‚Ä¢ G√ºncellendi: ${when}` : '';
  const noteEl = document.getElementById('sasNote');
  if (noteEl) noteEl.textContent = sasUnit
    ? `Hesap: ${sasQty} adet √ó ${numberTL(sasUnit)}${suffix}`
    : 'Birim fiyat girin';
}

// ƒ∞≈ûY Fonu
const isyInput = document.getElementById('isyUnitInput');
if (isyInput){
  if (!isyInput.value && st.demoBank.isyUnitTRY){ isyInput.value = String(st.demoBank.isyUnitTRY); }
  isyInput.onchange = ()=>{
    const v = parseTL(isyInput.value);
    const s = getLoansState();
    s.demoBank.isyUnitTRY = v;
    setLoansState(s);
    localStorage.setItem('popdog_isy_unit_try', String(v));
    localStorage.setItem('popdog_isy_updated_at', String(Date.now()));
    renderLoansBlock();
  };
}
const isyUnit = st.demoBank.isyUnitTRY || Number(localStorage.getItem('popdog_isy_unit_try')||0) || 0;
const isyQty  = st.demoBank.isyUnits || 2530000;
const isySum  = isyUnit ? (isyUnit * isyQty) : 0;
const isyTotalEl = document.getElementById('isyTotal');
if (isyTotalEl) isyTotalEl.textContent = isySum ? numberTL(isySum) : '‚Äì';
{
  const ts = Number(localStorage.getItem('popdog_isy_updated_at') || 0);
  const when = ts ? new Date(ts).toLocaleString('tr-TR') : '';
  const suffix = when ? ` ‚Ä¢ G√ºncellendi: ${when}` : '';
  const noteEl = document.getElementById('isyNote');
  if (noteEl) noteEl.textContent = isyUnit
    ? `Hesap: ${isyQty} adet √ó ${numberTL(isyUnit)}${suffix}`
    : 'Birim fiyat girin';
}


/* === Otomatik g√ºncelleme: gider eklendiƒüinde √ßaƒüƒ±rƒ±lacak ===
   - subcat "Taksitli Ticari Kredi" ‚Üí loans.biz
   - subcat "Taksitli Ara√ß Kredisi" ‚Üí loans.car
   - Zee.Dog √∂demesi (not veya kategori) ‚Üí e≈üle≈üen YK# id ‚Äúpaid‚Äù
*/
function applyExpenseToLoans({ amountTRY, subcat, note }){
  const st = getLoansState();
  const s = (subcat||'').toLowerCase();

  // 1) Kredi taksitleri
  if (s.includes('ara√ß kredi') || s.includes('arac kredi')) {
    // Ara√ß Kredisi
    const inst = st.loans.car.instTRY || 0;
    const n = approxInstallments(amountTRY, inst);
    st.loans.car.remainTRY = Math.max(0, (st.loans.car.remainTRY || 0) - amountTRY);
    st.loans.car.paid = Math.min(st.loans.car.total, (st.loans.car.paid || 0) + n);

  } else if (s.includes('kredi 2') || s.includes('ticari kredi 2')) {
    // 2. Ticari Kredi (loanBiz2)
    const inst = st.loans.biz2.instTRY || 0;
    const n = approxInstallments(amountTRY, inst);
    st.loans.biz2.remainTRY = Math.max(0, (st.loans.biz2.remainTRY || 0) - amountTRY);
    st.loans.biz2.paid = Math.min(st.loans.biz2.total, (st.loans.biz2.paid || 0) + n);

  } else if (s.includes('kredi')) {
    // 1. Ticari Kredi (loanBiz)
    const inst = st.loans.biz.instTRY || 0;
    const n = approxInstallments(amountTRY, inst);
    st.loans.biz.remainTRY = Math.max(0, (st.loans.biz.remainTRY || 0) - amountTRY);
    st.loans.biz.paid = Math.min(st.loans.biz.total, (st.loans.biz.paid || 0) + n);
  }

  // 2) Zee.Dog √∂demesi: not i√ßinde YK#xxx varsa kƒ±smi/tam √∂deme olarak i≈üaretle
  let marked = false;
  const idFromNote = extractZeeIdFromNote(note);

  if (idFromNote){
    // ID bulundu - bu √∂demeyi ekle
    st.zeeAwaitUSD.forEach(z => {
      if (z.id.toUpperCase() === idFromNote) {
        // Zee.Dog √∂demeleri (YK# ID'li) varsayƒ±lan olarak USD cinsindendir
        // amountTRY parametresi yanƒ±ltƒ±cƒ± isimde ama Zee.Dog i√ßin USD deƒüeridir
        const paymentUsd = amountTRY;

        // √ñdenen miktarƒ± g√ºncelle
        z.paidUsd = Number(z.paidUsd || 0) + paymentUsd;
        z.remainingUsd = Math.max(0, Number(z.usd || 0) - z.paidUsd);

        // Durum g√ºncelle
        if (z.remainingUsd <= 0.01) { // Tam √∂dendi (1 cent tolerans)
          z.status = 'paid';
          z.remainingUsd = 0;
        } else if (z.paidUsd > 0) { // Kƒ±smi √∂dendi
          z.status = 'partially_paid';
        } else {
          z.status = 'waiting';
        }
        marked = true;
      }
    });
  } else {
    // ID yok - tutar e≈üle≈ümesi dene (tam √∂deme varsayƒ±mƒ±)
    // Not: Zee.Dog fonksiyonuna girildiƒüine g√∂re, amountTRY aslƒ±nda USD'dir
    const usdNote = extractUSDFromNote(note);
    const usdAmount = amountTRY; // Zee.Dog i√ßin varsayƒ±lan USD
    const candidates = st.zeeAwaitUSD.filter(z => z.status !== 'paid');
    const matchBy = (val)=> candidates.find(z => Math.abs(z.usd - val) <= Math.max(5, z.usd*0.02)); // ¬±2% veya min $5
    let hit = null;
    if (usdNote) hit = matchBy(usdNote);
    if (!hit && usdAmount) hit = matchBy(usdAmount);
    if (hit){
      hit.paidUsd = Number(hit.usd || 0);
      hit.remainingUsd = 0;
      hit.status = 'paid';
      marked = true;
    }
  }

  setLoansState(st);
  renderLoansBlock();
  return true;
}

/* === Ba≈ülat === */
(function initLoans(){
  // ƒ∞lk render
  try{ if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', renderLoansBlock, { once:true }); } else { renderLoansBlock(); } }catch(_){}
})();

/* === GOLD AUTO PRICE (daily refresh) =============================== */
(function(){
  const GOLD_FETCH_URL_KEY   = 'popdog_gold_fetch_url';       // optional override URL set by you
  const GOLD_UPDATED_AT_KEY  = 'popdog_gold_updated_at';
  const GOLD_GRAM_STORAGEKEY = 'popdog_gold_gram_try';        // already used elsewhere

  // Consider price stale after 22 hours
  function isStale(ts){
    if(!ts) return true;
    const ageMs = Date.now() - Number(ts);
    return !(ageMs > 0) || ageMs > 22*60*60*1000;
  }


  // Source #0: Optional custom endpoint you can define in localStorage
  async function fetchFromCustom(){
    const u = localStorage.getItem(GOLD_FETCH_URL_KEY) || '';
    if(!u) throw new Error('no custom');
    const r = await fetch(u, { cache:'no-store' });
    if(!r.ok) throw new Error('custom http '+r.status);
    const j = await r.json();
    // Accept a few shapes: {priceTRY}, {gramTRY}, {sell}, {Satƒ±≈ü}
    const s = (j.priceTRY ?? j.gramTRY ?? j.sell ?? j.selling ?? j['Satƒ±≈ü'] ?? j.price ?? '').toString().replace('.', '').replace(',', '.');
    const v = Number(s);
    if(!v || isNaN(v)) throw new Error('custom parse');
    return v;
  }

  async function tryFetch(){
    try{
      // If a custom endpoint is defined in localStorage, use it as the only automated source.
      const v = await fetchFromCustom();
      if (v && !isNaN(v)) return v;
      throw new Error('custom source invalid');
    }catch(e){
      // No automatic external fallbacks anymore: user can always type the gram price manually.
      throw new Error('Gold auto source failed (custom endpoint only).');
    }
  }

  async function updateGold(force=false){
    try{
      // If user just typed a price, do not override immediately unless force=true.
      const ts = Number(localStorage.getItem(GOLD_UPDATED_AT_KEY) || 0);
      if(!force && !isStale(ts)) return; // still fresh

      const price = await tryFetch();
      if(!price || isNaN(price)) return;

      // Persist
      localStorage.setItem(GOLD_GRAM_STORAGEKEY, String(price));
      localStorage.setItem(GOLD_UPDATED_AT_KEY, String(Date.now()));

      // Also sync Loans state if it exists
      try{
        const s = getLoansState();
        if(s && s.demoBank){ s.demoBank.gramTRY = price; setLoansState(s); }
      }catch(_){ /* ignore */ }

      // Reflect in input instantly
      const gInput = document.getElementById('goldGramInput');
      if(gInput){ gInput.value = String(price); }
      // Re-render card
      try{ renderLoansBlock(); }catch(_){}
    }catch(err){
      // Silent failure is okay; user can still type manually.
      // console.debug('Gold auto price update skipped:', err && err.message ? err.message : err);
    }
  }

  // Kick on load and then every 6 hours
  try{
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', ()=>{ updateGold(false); setInterval(updateGold, 6*60*60*1000); }, { once:true });
    } else {
      updateGold(false);
      setInterval(updateGold, 6*60*60*1000);
    }
  }catch(_){ /* ignore */ }

  // Expose a small manual refresh for debugging
  window.refreshGoldNow = ()=> updateGold(true);
})();

/* ================== INVENTORY & ORDERS HELPERS ================== */
const SALES_WINDOW_OPTIONS = [30,90,120,180];
let salesWindowDays = Number(localStorage.getItem('popdog_sales_window_days') || '90');
if (!SALES_WINDOW_OPTIONS.includes(salesWindowDays)) salesWindowDays = 90;
function initSalesWindowSelector(){
  const sel = document.getElementById('salesWindowSelect');
  if(!sel) return;
  // Set current value
  sel.value = String(salesWindowDays);
  sel.onchange = () => {
    const v = Number(sel.value);
    if(!SALES_WINDOW_OPTIONS.includes(v)) return;
    salesWindowDays = v;
    localStorage.setItem('popdog_sales_window_days', String(v));
    renderStockBlock();
  };
}
/* inventory_value toplam √∂zet */
function summarizeInventoryValue(rows){
  // ba≈ülƒ±k varyasyonlarƒ±nƒ± tolere et
  let valCost = 0, valPrice = 0;
  for(const r of rows || []){
    const costRaw  = r['Value@Cost']  ?? r['Value @Cost']  ?? r['CostValue']   ?? r['Value_Cost']  ?? 0;
    const priceRaw = r['Value@Price'] ?? r['Value @Price'] ?? r['SalesValue']  ?? r['Value_Price'] ?? 0;
    valCost  += parseTL(costRaw);
    valPrice += parseTL(priceRaw);
  }
  return { valCost, valPrice };
}

// Shopify "Created at" tarihlerini saƒülam parse et
function parseShopifyDate(s){
  if(!s) return null;
  let t = String(s).trim();

  // "2025-09-07 12:34:56 +0300" ‚Üí "+03:00" bi√ßimine √ßevir
  if(/\s\+\d{4}$/.test(t)){
    t = t.replace(/\s\+(\d{2})(\d{2})$/, (m,h,mn)=> `+${h}:${mn}`);
  }
  // "... UTC" ‚Üí Z
  if(/\sUTC$/i.test(t)){ t = t.replace(/\sUTC$/i,'Z'); }

  // "YYYY-MM-DD HH:mm:ss" ‚Üí "YYYY-MM-DDTHH:mm:ss"
  if(/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}/.test(t)){
    t = t.replace(' ', 'T');
  }

  // dd/mm/yyyy veya dd.mm.yyyy gibi olursa
  const m = t.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
  if(m){
    let dd=+m[1], mm=+m[2], yy=+m[3]; if(yy<100) yy+=2000;
    t = `${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}T00:00:00Z`;
  }

  const d = new Date(t);
  return isNaN(+d) ? null : d;
}

// localStorage‚Üíorders okurken tarihleri Date'e yeniden √ßevir
function getOrdersCache(){
  const raw = JSON.parse(localStorage.getItem('popdog_orders_cache') || '[]');
  return raw.map(o => ({
    sku: (o.sku||'').trim(),
    qty: Number(o.qty)||0,
    price: parseTL(o.price||0),
    date: o.date ? new Date(o.date) : null  // <- rehydrate
  })).filter(o => o.sku && o.qty>0 && o.date && !isNaN(+o.date));
}

/* stok listesi i√ßinden (‚Ç∫ satƒ±≈ü deƒüeri bazlƒ±) top N */
function topStockSKUs(rows, n=10){
  const arr = (rows||[]).map(r=>({
    sku: String(r['SKU']||'').trim(),
    title: r['Title'] || '',
    units: parseTL(r['TotalUnits'] || r['On hand total'] || 0),
    unitCost: parseTL(r['UnitCost'] || 0),
    unitPrice: parseTL(r['UnitPrice'] || 0),
    valueCost: parseTL(r['Value@Cost'] || r['Value @Cost'] || 0),
    valuePrice: parseTL(r['Value@Price']|| r['Value @Price']|| 0),
  }));
  return arr.filter(x=>x.sku && x.units>0)
            .sort((a,b)=> b.valuePrice - a.valuePrice)
            .slice(0,n);
}

/* Shopify orders + orders_clean (buildAll) uyumlu mapper */
function mapOrderRow(r){
  // SKU alias‚Äôlarƒ±: Shopify (Lineitem sku / SKU / Variant SKU) + orders_clean (sku)
  const sku = (r['Lineitem sku'] || r['SKU'] || r['Variant SKU'] || r['sku'] || '').toString().trim();

  // Qty alias‚Äôlarƒ±: Shopify (Lineitem quantity / Quantity / Qty) + orders_clean (qty)
  const qty = parseInt(r['Lineitem quantity'] || r['Quantity'] || r['Qty'] || r['qty'] || 0, 10) || 0;

  // Price (opsiyonel) ‚Äì gerekirse; orders_clean‚Äôde 'price'
  const price = parseTL(r['Lineitem price'] || r['Price'] || r['price'] || 0);

  // Tarih: Shopify (Created at / ‚Ä¶) + orders_clean (date)
  const rawDate = r['Created at'] || r['Created At'] || r['Created at (UTC)'] || r['Processed at'] || r['Paid at'] || r['Fulfilled at'] || r['date'] || '';
  const date = parseShopifyDate(rawDate);

  return { sku, qty, price, date };
}

/* stok ya≈ülandƒ±rma (son satƒ±≈üa g√∂re g√ºn farkƒ±) */
function stockAging(inventoryRows, orderRows){
  const today = new Date();
  const lastSaleMap = {};
  (orderRows||[]).forEach(o=>{
    if(!o || !o.sku || !o.date) return;
    if(!lastSaleMap[o.sku] || o.date > lastSaleMap[o.sku]) lastSaleMap[o.sku] = o.date;
  });

  const buckets = { '0-30':0, '31-60':0, '61-90':0, '90+':0 };
  const bucketsVal = { '0-30':0, '31-60':0, '61-90':0, '90+':0 };
  const ages = [];

  (inventoryRows||[]).forEach(r=>{
    const sku = String(r['SKU']||'').trim();
    const units = parseTL(r['TotalUnits']||0);
    const valCost = parseTL(r['Value@Cost']||r['Value @Cost']||0);
    if(!sku || units<=0) return;
    const last = lastSaleMap[sku];
    const diff = last ? Math.floor((today-last)/(1000*60*60*24)) : 9999; // hi√ß satmamƒ±≈üsa 9999
    ages.push(diff);

    let bucket = '90+';
    if(diff<=30) bucket='0-30';
    else if(diff<=60) bucket='31-60';
    else if(diff<=90) bucket='61-90';
    buckets[bucket]+=units;
    bucketsVal[bucket]+=valCost;
  });

  const sorted = ages.sort((a,b)=>a-b);
  const medianAge = sorted.length ? sorted[Math.floor(sorted.length/2)] : 0;
  return { buckets, bucketsVal, medianAge };
}

/* DIO: Days of Inventory = On-hand / (g√ºnl√ºk satƒ±≈ü ort.) */
function daysOfInventory(inventoryRows, orderRows, days=60){
  const today = new Date();
  const cutoff = new Date(today.getTime() - days*24*60*60*1000);
  let totalUnitsSold=0;
  (orderRows||[]).forEach(o=>{
    if(!o.date || isNaN(+o.date) || o.date<cutoff) return;
    totalUnitsSold += (o.qty||0);
  });
  const dailyAvg = totalUnitsSold / (days||1);
  const totalOnHand = (inventoryRows||[]).reduce((a,r)=> a + parseTL(r['TotalUnits']||0), 0);
  return dailyAvg>0 ? (totalOnHand/dailyAvg) : null;
}

/* Stok tablolarƒ±nƒ± ve KPI‚Äôlarƒ± render et */
function renderStockBlock(){
  // cache‚Äôlerden oku
  const invRows   = JSON.parse(localStorage.getItem('popdog_inv_cache')   || '[]');
  const ordersMap = getOrdersCache();

  // 1) Stok deƒüeri KPI‚Äôlarƒ±
  const inv = summarizeInventoryValue(invRows);
  document.getElementById('kpiInvCost').textContent  = numberTL(inv.valCost);
  document.getElementById('kpiInvPrice').textContent = numberTL(inv.valPrice);

  // USD equivalents (using latest fetched fxRateUSDPerTRY)
  try {
    const costUsdEl  = document.getElementById('kpiInvCost_USD');
    const priceUsdEl = document.getElementById('kpiInvPrice_USD');
    if (costUsdEl) {
      if (fxRateUSDPerTRY) {
        costUsdEl.textContent  = `‚âà ${numberUSD(inv.valCost * fxRateUSDPerTRY)} USD`;
      } else {
        costUsdEl.textContent  = '‚âà ‚Äì USD';
      }
    }
    if (priceUsdEl) {
      if (fxRateUSDPerTRY) {
        priceUsdEl.textContent = `‚âà ${numberUSD(inv.valPrice * fxRateUSDPerTRY)} USD`;
      } else {
        priceUsdEl.textContent = '‚âà ‚Äì USD';
      }
    }
  } catch (e) {
    // silent
  }

  // 1.c) T√ºretilmi≈ü tutarlar: Maliyet +%65 (Vergi+Navlun) ve Satƒ±≈ü KDV Hari√ß (‚àí%20)
  try {
    const costPlus = inv.valCost * 1.65;           // +%65 eklendi
    const priceEx  = inv.valPrice / 1.20;          // %20 KDV √ßƒ±kartƒ±ldƒ±

    const c65El      = document.getElementById('kpiInvCost_65');
    const c65UsdEl   = document.getElementById('kpiInvCost_65_USD');
    const exVatEl    = document.getElementById('kpiInvPrice_exVAT');
    const exVatUsdEl = document.getElementById('kpiInvPrice_exVAT_USD');

    if (c65El)    c65El.textContent    = numberTL(costPlus);
    if (exVatEl)  exVatEl.textContent  = numberTL(priceEx);

    if (c65UsdEl) {
      c65UsdEl.textContent = fxRateUSDPerTRY ? `‚âà ${numberUSD(costPlus * fxRateUSDPerTRY)} USD` : '‚âà ‚Äì USD';
    }
    if (exVatUsdEl) {
      exVatUsdEl.textContent = fxRateUSDPerTRY ? `‚âà ${numberUSD(priceEx * fxRateUSDPerTRY)} USD` : '‚âà ‚Äì USD';
    }
  } catch (e) { /* silent */ }

  // 1.b) Toplam √úr√ºn Adedi + depo bazƒ±nda daƒüƒ±lƒ±m (Thrones / Caddebostan)
  try {
    // toplam on-hand (SKU bazƒ±nda TotalUnits)
    const totalUnitsAll = (invRows || []).reduce((acc, r) => acc + parseTL(r['TotalUnits'] || 0), 0);

    // location s√ºtunlarƒ±nƒ± tahmin et: Title ile TotalUnits arasƒ±ndaki ba≈ülƒ±klar
    let thronesUnits = 0, caddeUnits = 0;
    if (Array.isArray(invRows) && invRows.length) {
      const hdrs = Object.keys(invRows[0] || {});
      const iTitle = hdrs.indexOf('Title');
      const iTotal = hdrs.indexOf('TotalUnits');
      const locCols = (iTitle >= 0 && iTotal > iTitle) ? hdrs.slice(iTitle + 1, iTotal) : [];

      invRows.forEach(row => {
        locCols.forEach(col => {
          const v = parseTL(row[col] || 0);
          const key = (col || '').toLowerCase();
          if (key.includes('thrones')) thronesUnits += v;
          if (key.includes('caddebostan') || key.includes('ckm') || key.includes('cadde')) caddeUnits += v;
        });
      });
    }

    const totalEl = document.getElementById('kpiTotalUnits');
    const noteEl  = document.getElementById('kpiTotalUnitsNote');
    if (totalEl) totalEl.textContent = `${totalUnitsAll} adet`;
    if (noteEl)  noteEl.textContent  = `Thrones: ${thronesUnits} ‚Ä¢ Caddebostan: ${caddeUnits}`;
  } catch (e) {
    console.warn('Total units KPI calc error', e);
  }

  // 2) Top 10 ‚Ç∫ stok tablosu
  const top10 = topStockSKUs(invRows, 10);
  const topTbody = document.getElementById('tblTopStock');
  topTbody.innerHTML = '';
  top10.forEach(row=>{
    // son satƒ±≈ü tarihi & ya≈ü (g√ºn)
    const lastDate = lastSaleDateForSKU(row.sku, ordersMap);
    const age = lastDate ? Math.floor((Date.now() - lastDate.getTime())/(1000*60*60*24)) : '‚Äî';
    const lastStr = lastDate ? lastDate.toISOString().slice(0,10) : '‚Äî';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4">${row.sku}</td>
      <td class="py-2 pr-4">${row.title||''}</td>
      <td class="py-2 pr-4 text-right">${row.units}</td>
      <td class="py-2 pr-4 text-right">${numberTL(row.valueCost)}</td>
      <td class="py-2 pr-4 text-right">${lastStr}</td>
      <td class="py-2 pr-4 text-right">${age}</td>
    `;
    topTbody.appendChild(tr);
  });

  // 3) 90+ g√ºn elde olanlar (‚Ç∫ maliyet bazƒ±nda en b√ºy√ºk 10)
  const agedList = (invRows||[]).filter(r => r != null).map(r=>{
    const sku = String(r['SKU']||'').trim();
    const units = parseTL(r['TotalUnits']||0);
    const valCost = parseTL(r['Value@Cost']||r['Value @Cost']||0);
    const last = lastSaleDateForSKU(sku, ordersMap);
    const age = last ? Math.floor((Date.now()-last.getTime())/(1000*60*60*24)) : 9999;
    return { sku, title:r['Title']||'', units, valCost, last, age };
  }).filter(x=>x.units>0 && x.age>=90)
    .sort((a,b)=> b.valCost - a.valCost)
    .slice(0,10);

  const agedTbody = document.getElementById('tblAged90');
  agedTbody.innerHTML='';
  agedList.forEach(x=>{
    const lastStr = x.last ? x.last.toISOString().slice(0,10) : '‚Äî';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4">${x.sku}</td>
      <td class="py-2 pr-4">${x.title}</td>
      <td class="py-2 pr-4 text-right">${x.units}</td>
      <td class="py-2 pr-4 text-right">${numberTL(x.valCost)}</td>
      <td class="py-2 pr-4 text-right">${lastStr}</td>
      <td class="py-2 pr-4 text-right">${x.age}</td>
    `;
    agedTbody.appendChild(tr);
  });

  // 4) Ya≈ülandƒ±rma KPI‚Äôlarƒ± (toplam)
  const aging = stockAging(invRows, ordersMap);
  const agedQty = aging.buckets['90+'] || 0;
  const agedVal = aging.bucketsVal['90+'] || 0;
  document.getElementById('kpiAged90Qty').textContent   = `${agedQty} adet`;
  document.getElementById('kpiAged90Value').textContent = numberTL(agedVal);
  document.getElementById('kpiMedianAge').textContent   = `${aging.medianAge} g√ºn`;

  // 5) DIO KPI (60 g√ºn) + notlar
  const dio60 = daysOfInventory(invRows, ordersMap, 60);
  const dio30 = daysOfInventory(invRows, ordersMap, 30);
  const dio90 = daysOfInventory(invRows, ordersMap, 90);
  document.getElementById('kpiDIO60').textContent = dio60 ? `${dio60.toFixed(0)} g√ºn` : '‚Äì g√ºn';

  // Patch: update kpiDIOx with 30g and 90g values
  const dioxEl = document.getElementById('kpiDIOx');
  if (dioxEl) dioxEl.textContent = `30g: ${dio30?dio30.toFixed(0):'‚Äì'} ‚Ä¢ 90g: ${dio90?dio90.toFixed(0):'‚Äì'}`;

  // k√º√ß√ºk a√ßƒ±klama (title attribute)
  document.getElementById('kpiDIO60').title =
    `DIO ~ On-hand / g√ºnl√ºk satƒ±≈ü ort.\n30g: ${dio30?dio30.toFixed(0):'‚Äì'} ‚Ä¢ 60g: ${dio60?dio60.toFixed(0):'‚Äì'} ‚Ä¢ 90g: ${dio90?dio90.toFixed(0):'‚Äì'}`;

  // 6) Satƒ±≈ü & Devir listeleri (son SALES_WINDOW_DAYS g√ºn)
  try {
    const cutoff = new Date(Date.now() - salesWindowDays*24*60*60*1000);
    const soldMap = new Map();   // sku -> sold qty (window)
    const lastMap = new Map();   // sku -> last sale date
    (ordersMap||[]).forEach(o=>{
      if(!o || !o.sku || !o.date) return;
      if(o.date >= cutoff){
        soldMap.set(o.sku, (soldMap.get(o.sku)||0) + (o.qty||0));
      }
      if(!lastMap.get(o.sku) || o.date > lastMap.get(o.sku)){
        lastMap.set(o.sku, o.date);
      }
    });

    // On-hand ve title map‚Äôleri
    const onHandMap = new Map();   // sku -> units
    const titleMap  = new Map();   // sku -> title
    (invRows||[]).forEach(r=>{
      const sku = String(r['SKU']||'').trim();
      if(!sku) return;
      const units = parseTL(r['TotalUnits']||r['On hand total']||r['On hand (current)']||0);
      onHandMap.set(sku, (onHandMap.get(sku)||0) + (units||0));
      const title = r['Title'] || '';
      if(title && !titleMap.has(sku)) titleMap.set(sku, title);
    });

    // Helper: Zee filter
    const isZee = (sku)=>{
      const t = (titleMap.get(sku) || '').toLowerCase();
      return t.includes('zee');
    };
    // Helper (already defined above for other lists) kept here for clarity:

    // 6.a En √ßok satan 5 (satƒ±≈ü miktarƒ±na g√∂re, sadece Zee)
    const topSellers = Array.from(soldMap.entries())
      .map(([sku,qty])=>({sku, qty, title:titleMap.get(sku)||''}))
      .filter(x => isZee(x.sku))
      .sort((a,b)=> b.qty - a.qty)
      .slice(0,5);

    const topSellersTbody = document.getElementById('tblTopSellers');
    if(topSellersTbody){
      topSellersTbody.innerHTML = topSellers.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.qty}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="3">Veri yok.</td></tr>';
    }

    // 6.b En az satan 5 (pencerede satƒ±≈ü yapanlar arasƒ±ndan en az qty, sadece Zee ve stok>0)
    const leastSellers = Array.from(soldMap.entries())
      .map(([sku,qty])=>({sku, qty, title:titleMap.get(sku)||'', on:onHandMap.get(sku)||0}))
      .filter(x => x.on>0 && isZee(x.sku))
      .sort((a,b)=> a.qty - b.qty)
      .slice(0,5);

    const leastSellersTbody = document.getElementById('tblLeastSellers');
    if(leastSellersTbody){
      leastSellersTbody.innerHTML = leastSellers.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.qty}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="3">Veri yok.</td></tr>';
    }

    // 6.c Stoƒüu en hƒ±zlƒ± giden 5 (satƒ±≈ü hƒ±zƒ±: adet/g√ºn, sadece Zee)
    const winDays = salesWindowDays || 1;
    const speedArr = Array.from(new Set([...Array.from(soldMap.keys()), ...Array.from(onHandMap.keys())]))
      .map(sku=>{
        const sold = soldMap.get(sku)||0;
        const on   = onHandMap.get(sku)||0;
        const spd  = sold / winDays; // adet/g√ºn
        return { sku, title:titleMap.get(sku)||'', speed: spd, onHand:on };
      })
      .filter(x=> x.speed>0 && isZee(x.sku))
      .sort((a,b)=> b.speed - a.speed)
      .slice(0,5);

    const fastestTbody = document.getElementById('tblFastestMoving');
    if(fastestTbody){
      fastestTbody.innerHTML = speedArr.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.speed.toFixed(2)}</td><td class="py-1 pr-3 text-right">${x.onHand}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="4">Veri yok.</td></tr>';
    }

    // 6.d Stokta en uzun s√ºredir kalan 5 (en ya≈ülƒ±, on-hand > 0, sadece Zee)
    const staleArr = Array.from(onHandMap.entries()).map(([sku,on])=>{
      const last = lastMap.get(sku);
      const age = last ? Math.floor((Date.now()-last.getTime())/(1000*60*60*24)) : 9999;
      return { sku, title:titleMap.get(sku)||'', age, onHand:on };
    }).filter(x=> x.onHand>0 && isZee(x.sku))
      .sort((a,b)=> b.age - a.age)
      .slice(0,5);

    const staleTbody = document.getElementById('tblMostStale');
    if(staleTbody){
      staleTbody.innerHTML = staleArr.map(x=>`
        <tr><td class="py-1 pr-3">${x.sku}</td><td class="py-1 pr-3">${x.title}</td><td class="py-1 pr-3 text-right">${x.age}</td><td class="py-1 pr-3 text-right">${x.onHand}</td></tr>
      `).join('') || '<tr><td class="hint py-1" colspan="4">Veri yok.</td></tr>';
    }

    const noteEl = document.getElementById('stockExtraNote');
    if(noteEl){
      const today = new Date(); const start = new Date(today.getTime() - salesWindowDays*24*60*60*1000);
      const fmt = d => `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      noteEl.textContent = `Pencere: ${fmt(start)} ‚Äì ${fmt(today)} ¬∑ Kaynak: orders_raw`;
    }
    // 6.e Stokout Riski (‚â§14 g√ºn): pencere = salesWindowDays
    try {
      const riskDays = 14;
      const days = salesWindowDays || 90;
      // sold qty per SKU in the selected window
      const soldMapWin = new Map();
      const cutoffWin = new Date(Date.now() - days*24*60*60*1000);
      (ordersMap||[]).forEach(o=>{
        if(!o || !o.sku || !o.date) return;
        if(o.date >= cutoffWin){
          soldMapWin.set(o.sku, (soldMapWin.get(o.sku)||0) + (o.qty||0));
        }
      });
      // on-hand and titles already computed above: onHandMap, titleMap
      // Only include SKUs where title includes "zee" (case-insensitive)
      const riskArr = [];
      onHandMap.forEach((on, sku)=>{
        const title = titleMap.get(sku) || '';
        if (!title.toLowerCase().includes('zee')) return;
        if (on <= 0) return;
        const sold = soldMapWin.get(sku)||0;
        const daily = sold / (days||1);
        if (daily > 0){
          const remain = on / daily;
          if (remain <= riskDays){
            riskArr.push({
              sku,
              title: title,
              onHand: on,
              daily: daily,
              remain: remain
            });
          }
        }
      });
      // Sort and slice to max 25 entries
      riskArr.sort((a,b)=> a.remain - b.remain);
      const riskArrSliced = riskArr.slice(0, 25);
      const riskTbody = document.getElementById('tblStockoutRisk');
      if (riskTbody){
        riskTbody.innerHTML = riskArrSliced.length
          ? riskArrSliced.map(x => `
              <tr>
                <td class="py-2 pr-4">${x.sku}</td>
                <td class="py-2 pr-4">${x.title}</td>
                <td class="py-2 pr-4 text-right">${x.onHand}</td>
                <td class="py-2 pr-4 text-right">${x.daily.toFixed(2)}</td>
                <td class="py-2 pr-4 text-right">${x.remain.toFixed(1)}</td>
              </tr>
            `).join('')
          : '<tr><td class="hint py-2 pr-4" colspan="5">Riskli √ºr√ºn bulunmadƒ±.</td></tr>';
      }
      const riskLbl = document.getElementById('riskWindowLbl');
      if (riskLbl) riskLbl.textContent = `${days} g√ºn`;
    } catch (e) {
      console.warn('Stockout risk render error', e);
    }

    // 6.f Stoƒüu En Fazla Olan (Top 25)
    try {
      const largest = (invRows || []).map(r => ({
        sku: String(r['SKU'] || '').trim(),
        title: r['Title'] || '',
        on: parseTL(r['TotalUnits'] || r['On hand total'] || r['On hand (current)'] || 0)
      }))
      .filter(x => x.sku && x.on > 0)
      .sort((a,b) => b.on - a.on)
      .slice(0, 25);

      const largestTbody = document.getElementById('tblLargestStock');
      if (largestTbody) {
        largestTbody.innerHTML = largest.length
          ? largest.map(x => `
              <tr>
                <td class="py-2 pr-4">${x.sku}</td>
                <td class="py-2 pr-4">${x.title}</td>
                <td class="py-2 pr-4 text-right">${x.on}</td>
              </tr>
            `).join('')
          : '<tr><td class="hint py-2 pr-4" colspan="3">Veri yok.</td></tr>';
      }
    } catch (e) {
      console.warn('Largest stock render error', e);
    }

    // 6.g Kategori bazlƒ± √∂zet (Zee Dog / Pop Dog / Diƒüer)
    try {
      let zeeQty=0, zeeVal=0, popQty=0, popVal=0, otherQty=0, otherVal=0;
      (invRows||[]).forEach(r=>{
        const title = (r['Title']||'').toLowerCase();
        const units = parseTL(r['TotalUnits']||0);
        const val = parseTL(r['Value@Cost']||r['Value @Cost']||0);
        if(title.includes('zee')){
          zeeQty += units; zeeVal += val;
        } else if(title.includes('pop dog') || title.includes('popdog')){
          popQty += units; popVal += val;
        } else {
          otherQty += units; otherVal += val;
        }
      });
      const catZeeEl = document.getElementById('kpiCatZee');
      const catZeeValEl = document.getElementById('kpiCatZeeVal');
      const catPopEl = document.getElementById('kpiCatPop');
      const catPopValEl = document.getElementById('kpiCatPopVal');
      const catOtherEl = document.getElementById('kpiCatOther');
      const catOtherValEl = document.getElementById('kpiCatOtherVal');
      if(catZeeEl) catZeeEl.textContent = `${zeeQty} adet`;
      if(catZeeValEl) catZeeValEl.textContent = numberTL(zeeVal);
      if(catPopEl) catPopEl.textContent = `${popQty} adet`;
      if(catPopValEl) catPopValEl.textContent = numberTL(popVal);
      if(catOtherEl) catOtherEl.textContent = `${otherQty} adet`;
      if(catOtherValEl) catOtherValEl.textContent = numberTL(otherVal);
    } catch(e){}

    // 6.h Stok Devir Hƒ±zƒ± (Turnover) = Yƒ±llƒ±k satƒ±≈ü / ortalama stok deƒüeri
    try {
      const oneYearAgo = new Date(Date.now() - 365*24*60*60*1000);
      let yearSalesVal = 0;
      (ordersMap||[]).forEach(o=>{
        if(o.date && o.date >= oneYearAgo){
          yearSalesVal += (o.qty||0) * (o.price||0);
        }
      });
      const avgStockVal = inv.valCost || 1;
      const turnover = yearSalesVal / avgStockVal;
      const turnoverEl = document.getElementById('kpiTurnover');
      if(turnoverEl) turnoverEl.textContent = turnover > 0 ? turnover.toFixed(2) + 'x' : '‚Äì';
    } catch(e){}

    // 6.i Dead Stock (180+ g√ºn)
    try {
      const deadList = (invRows||[]).map(r=>{
        const sku = String(r['SKU']||'').trim();
        const units = parseTL(r['TotalUnits']||0);
        const valCost = parseTL(r['Value@Cost']||r['Value @Cost']||0);
        const last = lastSaleDateForSKU(sku, ordersMap);
        const age = last ? Math.floor((Date.now()-last.getTime())/(1000*60*60*24)) : 9999;
        return { sku, title:r['Title']||'', units, valCost, last, age };
      }).filter(x=>x.units>0 && x.age>=180)
        .sort((a,b)=> b.valCost - a.valCost);

      const deadQty = deadList.reduce((a,x)=>a+x.units, 0);
      const deadVal = deadList.reduce((a,x)=>a+x.valCost, 0);

      const deadStockEl = document.getElementById('kpiDeadStock');
      const deadStockQtyEl = document.getElementById('kpiDeadStockQty');
      if(deadStockEl) deadStockEl.textContent = numberTL(deadVal);
      if(deadStockQtyEl) deadStockQtyEl.textContent = `${deadQty} adet`;

      const deadTbody = document.getElementById('tblDeadStock');
      if(deadTbody){
        deadTbody.innerHTML = deadList.slice(0,15).map(x=>{
          const lastStr = x.last ? x.last.toISOString().slice(0,10) : '‚Äî';
          return `<tr class="text-red-600 dark:text-red-400">
            <td class="py-2 pr-4">${x.sku}</td>
            <td class="py-2 pr-4">${x.title}</td>
            <td class="py-2 pr-4 text-right">${x.units}</td>
            <td class="py-2 pr-4 text-right">${numberTL(x.valCost)}</td>
            <td class="py-2 pr-4 text-right">${lastStr}</td>
            <td class="py-2 pr-4 text-right">${x.age}</td>
          </tr>`;
        }).join('') || '<tr><td class="hint py-2" colspan="6">Dead stock yok.</td></tr>';
      }
    } catch(e){}

    // 6.j Stok Ya≈ülandƒ±rma Bar Chart
    try {
      const buckets = aging.buckets;
      const total = Object.values(buckets).reduce((a,b)=>a+b, 0) || 1;
      const maxVal = Math.max(...Object.values(buckets)) || 1;

      const bar0_30 = document.getElementById('agingBar0_30');
      const bar31_60 = document.getElementById('agingBar31_60');
      const bar61_90 = document.getElementById('agingBar61_90');
      const bar90plus = document.getElementById('agingBar90plus');

      if(bar0_30) bar0_30.style.height = ((buckets['0-30']||0)/maxVal*100) + '%';
      if(bar31_60) bar31_60.style.height = ((buckets['31-60']||0)/maxVal*100) + '%';
      if(bar61_90) bar61_90.style.height = ((buckets['61-90']||0)/maxVal*100) + '%';
      if(bar90plus) bar90plus.style.height = ((buckets['90+']||0)/maxVal*100) + '%';

      const lbl0_30 = document.getElementById('agingLbl0_30');
      const lbl31_60 = document.getElementById('agingLbl31_60');
      const lbl61_90 = document.getElementById('agingLbl61_90');
      const lbl90plus = document.getElementById('agingLbl90plus');

      if(lbl0_30) lbl0_30.textContent = buckets['0-30']||0;
      if(lbl31_60) lbl31_60.textContent = buckets['31-60']||0;
      if(lbl61_90) lbl61_90.textContent = buckets['61-90']||0;
      if(lbl90plus) lbl90plus.textContent = buckets['90+']||0;

      const chartNote = document.getElementById('agingChartNote');
      if(chartNote) chartNote.textContent = `Toplam: ${total} adet`;
    } catch(e){}

    // 6.k ABC Analizi
    try {
      // SKU bazƒ±nda satƒ±≈ü deƒüeri (pencere i√ßinde)
      const skuSales = new Map();
      (ordersMap||[]).forEach(o=>{
        if(o.date && o.date >= cutoff){
          const val = (o.qty||0) * (o.price||0);
          skuSales.set(o.sku, (skuSales.get(o.sku)||0) + val);
        }
      });

      const sorted = Array.from(skuSales.entries())
        .map(([sku,val])=>({sku, val}))
        .sort((a,b)=>b.val-a.val);

      const totalSalesVal = sorted.reduce((a,x)=>a+x.val, 0) || 1;
      let cumulative = 0;
      let aCount=0, aVal=0, bCount=0, bVal=0, cCount=0, cVal=0;

      sorted.forEach(x=>{
        cumulative += x.val;
        const pct = cumulative / totalSalesVal;
        if(pct <= 0.80){
          aCount++; aVal += x.val;
        } else if(pct <= 0.95){
          bCount++; bVal += x.val;
        } else {
          cCount++; cVal += x.val;
        }
      });

      const abcAEl = document.getElementById('kpiAbcA');
      const abcAValEl = document.getElementById('kpiAbcAVal');
      const abcBEl = document.getElementById('kpiAbcB');
      const abcBValEl = document.getElementById('kpiAbcBVal');
      const abcCEl = document.getElementById('kpiAbcC');
      const abcCValEl = document.getElementById('kpiAbcCVal');

      if(abcAEl) abcAEl.textContent = `${aCount} SKU`;
      if(abcAValEl) abcAValEl.textContent = `${numberTL(aVal)} (${(aVal/totalSalesVal*100).toFixed(0)}%)`;
      if(abcBEl) abcBEl.textContent = `${bCount} SKU`;
      if(abcBValEl) abcBValEl.textContent = `${numberTL(bVal)} (${(bVal/totalSalesVal*100).toFixed(0)}%)`;
      if(abcCEl) abcCEl.textContent = `${cCount} SKU`;
      if(abcCValEl) abcCValEl.textContent = `${numberTL(cVal)} (${(cVal/totalSalesVal*100).toFixed(0)}%)`;
    } catch(e){}

    // 6.l Reorder Point Uyarƒ±larƒ± (Lead time: 45 g√ºn, Safety stock: 7 g√ºn)
    try {
      const leadTime = 45;
      const safetyDays = 7;
      const reorderList = [];

      onHandMap.forEach((on, sku)=>{
        const title = titleMap.get(sku) || '';
        if(!title.toLowerCase().includes('zee')) return; // Sadece Zee Dog
        if(on <= 0) return;

        const sold = soldMap.get(sku) || 0;
        const daily = sold / (salesWindowDays || 1);
        if(daily <= 0) return;

        const reorderPoint = daily * (leadTime + safetyDays);
        if(on <= reorderPoint){
          const suggestedOrder = Math.ceil(daily * 90) - on; // 90 g√ºnl√ºk stok hedefi
          reorderList.push({
            sku,
            title,
            onHand: on,
            daily,
            reorderPoint,
            suggested: Math.max(0, suggestedOrder)
          });
        }
      });

      reorderList.sort((a,b)=> (a.onHand/a.daily) - (b.onHand/b.daily));

      const reorderTbody = document.getElementById('tblReorderPoint');
      if(reorderTbody){
        reorderTbody.innerHTML = reorderList.slice(0,15).map(x=>`
          <tr class="bg-yellow-50 dark:bg-yellow-900/20">
            <td class="py-2 pr-4">${x.sku}</td>
            <td class="py-2 pr-4">${x.title}</td>
            <td class="py-2 pr-4 text-right">${x.onHand}</td>
            <td class="py-2 pr-4 text-right">${x.daily.toFixed(2)}</td>
            <td class="py-2 pr-4 text-right">${Math.ceil(x.reorderPoint)}</td>
            <td class="py-2 pr-4 text-right font-semibold text-yellow-700 dark:text-yellow-400">${x.suggested}</td>
          </tr>
        `).join('') || '<tr><td class="hint py-2" colspan="6">Sipari≈ü gerektiren √ºr√ºn yok.</td></tr>';
      }
    } catch(e){}

    // 6.m Son g√ºncelleme tarihi
    try {
      const updateEl = document.getElementById('stockLastUpdate');
      if(updateEl){
        const now = new Date();
        updateEl.textContent = `Son g√ºncelleme: ${now.toLocaleString('tr-TR')}`;
      }
    } catch(e){}

    // 6.n Renk kodlarƒ±nƒ± uygula
    setTimeout(applyStockRowColors, 100);

  } catch(err) {
    console.warn('Sales/Turnover lists error', err);
  }
}

// Stok arama fonksiyonu
function initStockSearch(){
  const input = document.getElementById('stockSearchInput');
  if(!input) return;

  input.addEventListener('input', function(){
    const query = this.value.toLowerCase().trim();
    const tables = ['tblTopStock','tblAged90','tblDeadStock','tblStockoutRisk','tblLargestStock','tblReorderPoint'];

    tables.forEach(id=>{
      const tbody = document.getElementById(id);
      if(!tbody) return;
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(row=>{
        const text = row.textContent.toLowerCase();
        row.style.display = (!query || text.includes(query)) ? '' : 'none';
      });
    });
  });
}

// CSV Export fonksiyonu
function initStockExport(){
  const btn = document.getElementById('stockExportBtn');
  if(!btn) return;

  btn.addEventListener('click', function(){
    const invRows = JSON.parse(localStorage.getItem('popdog_inv_cache') || '[]');
    if(!invRows.length){
      alert('Export edilecek veri yok.');
      return;
    }

    // CSV olu≈ütur
    const headers = ['SKU','Title','TotalUnits','Value@Cost','Value@Price'];
    const csv = [
      headers.join(','),
      ...invRows.map(r => headers.map(h => {
        let val = r[h] || '';
        if(typeof val === 'string' && val.includes(',')) val = `"${val}"`;
        return val;
      }).join(','))
    ].join('\n');

    // Download
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stok_export_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });
}

// Tablolara renk kodlarƒ± ekle (kritik satƒ±rlara)
function applyStockRowColors(){
  // Stokout risk tablosunda kalan g√ºn < 7 ise kƒ±rmƒ±zƒ±
  const riskTbody = document.getElementById('tblStockoutRisk');
  if(riskTbody){
    riskTbody.querySelectorAll('tr').forEach(row=>{
      const cells = row.querySelectorAll('td');
      if(cells.length >= 5){
        const remain = parseFloat(cells[4].textContent) || 999;
        if(remain <= 7){
          row.classList.add('bg-red-100','dark:bg-red-900/30');
        } else if(remain <= 10){
          row.classList.add('bg-orange-100','dark:bg-orange-900/30');
        }
      }
    });
  }

  // Aged tablosunda ya≈ü > 120 ise koyu kƒ±rmƒ±zƒ±
  const agedTbody = document.getElementById('tblAged90');
  if(agedTbody){
    agedTbody.querySelectorAll('tr').forEach(row=>{
      const cells = row.querySelectorAll('td');
      if(cells.length >= 6){
        const age = parseInt(cells[5].textContent) || 0;
        if(age >= 180){
          row.classList.add('text-red-700','dark:text-red-400');
        } else if(age >= 120){
          row.classList.add('text-orange-600','dark:text-orange-400');
        }
      }
    });
  }
}

function lastSaleDateForSKU(sku, ordersMap){
  if(!sku || !Array.isArray(ordersMap)) return null;
  let last = null;
  for(const o of ordersMap){
    if(o.sku!==sku || !o.date) continue;
    if(!last || o.date>last) last = o.date;
  }
  return last;
}
function deriveTryPerUsdFromKPI(){
  try{
    const tlEl  = document.getElementById('kpiYTD');
    const usdEl = document.getElementById('kpiYTD_USD');
    if(!tlEl || !usdEl) return 0;

    const tl  = parseTL(tlEl.textContent || '');
    // "‚âà $12,345 USD" benzeri metinden USD‚Äôyi √ßek
    const usdText = (usdEl.textContent || '').replace(/‚âà/g,'').replace(/about/i,'');
    const usd = parseUSD(usdText);

    if(tl > 0 && usd > 0){
      const usdPerTry = usd / tl;      // 1 TRY ka√ß USD
      const tryPerUsd = 1 / usdPerTry; // 1 USD ka√ß TRY
      // cache‚Äôle
      try{
        localStorage.setItem('popdog_fx_try_per_usd', String(tryPerUsd));
        localStorage.setItem('popdog_fx_usd_per_try', String(usdPerTry));
      }catch(e){}
      return tryPerUsd;
    }
    return 0;
  }catch(e){ return 0; }
}
/* ================== REVENUE AGGREGATIONS & UI ================== */
function buildMonthly(rows){
  const map = new Map();
  rows.forEach(r=>{
    if(!r.Date) return;
    const d = new Date(r.Date + "T00:00:00Z");
    if(isNaN(+d)) return;
    const key = monthKey(d);
    const tpt=+r.Toptan||0, onl=+r.Online||0, ckm=+r.CKM||0, ckmN=+r["CKM Nakit"]||0, trn=+r.Trendyol||0, hb=+r.Hepsiburada||0, kua=+r.Kuaf√∂r||0;
    const computedTotal = tpt + onl + ckm + trn + hb + kua;
    const prev = map.get(key) || { month:key, year:d.getFullYear(), Toptan:0, Online:0, CKM:0, CKM_Nakit:0, Trendyol:0, Hepsiburada:0, Kuaf√∂r:0, Total:0 };
    prev.Toptan+=tpt; prev.Online+=onl; prev.CKM+=ckm; prev.CKM_Nakit+=ckmN; prev.Trendyol+=trn; prev.Hepsiburada+=hb; prev.Kuaf√∂r+=kua; prev.Total+=computedTotal;
    map.set(key, prev);
  });
  return Array.from(map.values()).filter(m=>m.Total>0).sort((a,b)=>a.month.localeCompare(b.month));
}

function buildWeekly(rows){
  const map = new Map();
  rows.forEach(r=>{
    if(!r.Date) return;
    const d = new Date(r.Date + "T00:00:00Z");
    if(isNaN(+d)) return;
    const mon = toMonday(d);
    const key = `${mon.getFullYear()}-${String(mon.getMonth()+1).padStart(2,'0')}-${String(mon.getDate()).padStart(2,'0')}`;
    const tpt=+r.Toptan||0, onl=+r.Online||0, ckm=+r.CKM||0, trn=+r.Trendyol||0, hb=+r.Hepsiburada||0, kua=+r.Kuaf√∂r||0;
    const total = tpt + onl + ckm + trn + hb + kua;
    const prev = map.get(key) || { monday:key, Toptan:0, Online:0, CKM:0, CKM_Nakit:0, Trendyol:0, Hepsiburada:0, Kuaf√∂r:0, Total:0 };
    prev.Toptan+=tpt; prev.Online+=onl; prev.CKM+=ckm; prev.Trendyol+=trn; prev.Hepsiburada+=hb; prev.Kuaf√∂r+=kua; prev.Total+=total;
    map.set(key, prev);
  });
  return Array.from(map.values()).sort((a,b)=>a.monday.localeCompare(b.monday));
}

/* ================== KPIs (Revenue) ================== */
function setKPIs(monthly){
  // === KPIs sadece bu yƒ±l (YTD) √ºzerinden hesaplansƒ±n ===
  const now = new Date();
  const currentYearReal = now.getFullYear();

  // Bu yƒ±lki aylar
  const ytdRowsReal = (monthly || []).filter(m => m.year === currentYearReal);

  // Eƒüer bu yƒ±l yoksa: eldeki son yƒ±l
  const fallbackYear = ytdRowsReal.length
    ? currentYearReal
    : ((monthly || []).length ? monthly[(monthly.length - 1)].year : currentYearReal);

  const thisYear = ytdRowsReal.length ? currentYearReal : fallbackYear;
  const rowsThisYear = (monthly || []).filter(m => m.year === thisYear);

  // Toplam yardƒ±mcƒ± sadece se√ßilen yƒ±l i√ßin
  const sumTY = k => rowsThisYear.reduce((a, r) => a + (r[k] || 0), 0);

  // === YTD Toplam (sadece bu yƒ±l) ===
  const ytdTotal = sumTY('Total');
  const elYTD = document.getElementById('kpiYTD');
  if (elYTD) elYTD.textContent = numberTL(ytdTotal);

  const elYTD_USD = document.getElementById('kpiYTD_USD');
  if (elYTD_USD) {
    if (fxRateUSDPerTRY) elYTD_USD.textContent = `‚âà ${numberUSD(ytdTotal * fxRateUSDPerTRY)} USD`;
    else elYTD_USD.textContent = '‚âà ‚Äì USD';
  }

  // === YTD YoY: ge√ßen yƒ±lƒ±n aynƒ± ay sayƒ±sƒ± ile hizalanmƒ±≈ü toplam ===
  try {
    const prevYear = thisYear - 1;
    // Bu yƒ±l var olan aylarƒ±n MM listesini √ßƒ±kar
    const monthsThisYear = rowsThisYear.map(r => r.month.slice(5, 7));
    const mmSet = new Set(monthsThisYear);

    // Ge√ßen yƒ±l aynƒ± aylarƒ±n toplamƒ±
    const prevYtd = (monthly || []).reduce((acc, r) => {
      if (r.year !== prevYear) return acc;
      const mm = r.month.slice(5, 7);
      if (mmSet.has(mm)) acc += (r.Total || 0);
      return acc;
    }, 0);

    const yoy = prevYtd ? ((ytdTotal - prevYtd) / prevYtd) : 0;
    const elYoY = document.getElementById('kpiYTD_YoY');
    if (elYoY) elYoY.textContent = `YTD YoY: ${(yoy * 100).toFixed(1)}%`;
  } catch (e) {
    // sessiz ge√ß
  }

  // === En b√ºy√ºk kanal + paylar (yalnƒ±zca bu yƒ±l) ===
  const channels = [
    { k: 'Toptan',      v: sumTY('Toptan') },
    { k: 'Online',      v: sumTY('Online') },
    { k: 'CKM',         v: sumTY('CKM') },
    { k: 'Trendyol',    v: sumTY('Trendyol') },
    { k: 'Hepsiburada', v: sumTY('Hepsiburada') },
    { k: 'Kuaf√∂r',      v: sumTY('Kuaf√∂r') },
  ].sort((a, b) => b.v - a.v);

  const totalCh = channels.reduce((a, b) => a + b.v, 0) || 1;
  const top = channels[0] || { k: '‚Äî', v: 0 };

  const kpiTopEl = document.getElementById('kpiTop');
  if (kpiTopEl) {
    kpiTopEl.textContent =
      `${top.k}: ${numberTL(top.v)}  ‚Ä¢  ${fxRateUSDPerTRY ? numberUSD(top.v * fxRateUSDPerTRY) : '‚Äì USD'}`;
  }

  const ul = document.getElementById('kpiOthers');
  if (ul) {
    ul.innerHTML = '';
    channels.slice(1).forEach(c => {
      const li = document.createElement('li');
      li.textContent = `${c.k}: ${numberTL(c.v)}  ‚Ä¢  ${fxRateUSDPerTRY ? numberUSD(c.v * fxRateUSDPerTRY) : '‚Äì USD'}`;
      ul.appendChild(li);
    });
  }

  const shareTbl = document.getElementById('kpiShareTbl');
  if (shareTbl) {
    shareTbl.innerHTML = channels
      .map(c => {
        const pct = (c.v / totalCh) * 100;
        return `<tr><td>${c.k}</td><td class="text-right">${pct.toFixed(1)}%</td></tr>`;
      })
      .join('');
  }

  // === MoM (bu yƒ±l i√ßindeki son iki ay) ===
  const rowsSorted = rowsThisYear.slice().sort((a, b) => a.month.localeCompare(b.month));
  let last = null, prev = null;
  if (rowsSorted.length >= 2) {
    last = rowsSorted.at(-1).Total;
    prev = rowsSorted.at(-2).Total;
  } else if (rowsSorted.length === 1) {
    last = rowsSorted[0].Total;
    prev = 0;
  }

  const mom = prev ? (last - prev) / prev : 0;
  const elMoM = document.getElementById('kpiMoM');
  if (elMoM) {
    elMoM.textContent = `${(mom * 100).toFixed(1)}%`;
    elMoM.classList.remove('kpi-up', 'kpi-down');
    elMoM.classList.add(mom >= 0 ? 'kpi-up' : 'kpi-down');
  }

  const mLabels = rowsSorted.map(m => m.month);
  const momNote = document.getElementById('momNote');
  if (momNote) momNote.textContent = mLabels.length >= 2 ? `(${mLabels.at(-2)} ‚Üí ${mLabels.at(-1)})` : '';
  // Ensure expenses table re-renders after KPIs (FX may now be derived)
  try { renderMainExpensesTable(); } catch (e) { /* silent */ }
}

/* ================== Alerts ================== */
function buildAlerts(monthly){
  const alerts = [];
  if(monthly.length>=2){
    const mLast = monthly.at(-1), mPrev = monthly.at(-2);
    const mom = mPrev.Total ? (mLast.Total - mPrev.Total) / mPrev.Total : 0;
    if(mom < -0.15){ alerts.push({type:'risk', text:`MoM toplam ciro d√º≈ü√º≈ü√º ${ (mom*100).toFixed(1) }%`}); }
    ["Toptan","Online","CKM","Trendyol","Hepsiburada"].forEach(k=>{
      const r = mPrev[k] ? (mLast[k]-mPrev[k]) / mPrev[k] : 0;
      if(r < -0.20){ alerts.push({type:'warn', text:`${k} aylƒ±k -${(Math.abs(r)*100).toFixed(0)}%`}); }
    });
  }
  const ul = document.getElementById('alertsList'); ul.innerHTML='';
  if(alerts.length===0){ ul.innerHTML = `<li class="hint">Uyarƒ± yok.</li>`; return; }
  alerts.forEach(a=>{
    const li = document.createElement('li');
    const color = a.type==='risk'?'#ef4444':(a.type==='warn'?'#f59e0b':'#6366f1');
    li.innerHTML = `<span class="dot" style="background:${color}"></span>${a.text}`;
    ul.appendChild(li);
  });
}

/* ================== Targets ================== */
function computeAutoTargets(monthly){
  const byYear = {};
  monthly.forEach(m => { (byYear[m.year] = byYear[m.year] || []).push(m); });
  const targets = {};
  for(const y of Object.keys(byYear)){
    const arr = byYear[y].sort((a,b)=> a.month.localeCompare(b.month));
    let running = [];
    arr.forEach((m, idx) => {
      if(idx === 0){ targets[m.month] = m.Total; running.push(m.Total); }
      else { const avg = running.reduce((a,b)=>a+b,0) / running.length; targets[m.month] = avg; running.push(m.Total); }
    });
  }
  return targets;
}
function renderTargets(monthly){
  const autoTargets = computeAutoTargets(monthly);
  const wrap = document.getElementById('targetsWrap'); 
  wrap.innerHTML='';
  monthly.forEach(m=>{
    const target = autoTargets[m.month] || 0;
    const p = target ? Math.min(100, Math.round(m.Total/target*100)) : 0;
    const box = document.createElement('div');
    box.className = 'glass target-card border border-white/70';
    box.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="ttl text-slate-700 dark:text-slate-200">${m.month}</div>
        <div class="val text-slate-800 dark:text-slate-100">${numberTL(m.Total)}</div>
      </div>
      <div class="progress-wrap mt-1.5"><div class="progress-bar" style="width:${p}%"></div></div>
      <div class="sub hint mt-1">Hedef: ${numberTL(target)} ‚Ä¢ ${p}%</div>
    `;
    wrap.appendChild(box);
  });
}

/* ================== Charts ================== */
// Charts removed (stability + simpler maintenance)
// Keep `monthlyCache` as the shared revenue monthly cache used by other blocks.
let monthlyCache = [];
function drawCharts(){
  if (!window.Chart) { return; }
 /* no-op */ }
/* ================== Expenses (CFO) ================== */

let expensesRowsCache = [];
let expensesMonthlyCache = [];
let expYoyEnabled = true;
try{ const s = document.getElementById('expYoyState'); if (s) s.textContent = expYoyEnabled ? 'A√ßƒ±k' : 'Kapalƒ±'; }catch(e){}
let expensesRowsAdjustedCache = [];




// Return the main category for a row; when grouped=true, collapse certain mains
function mainCategoryForRow(r, grouped=false){
  try{
    const cats = typeof expenseCats === 'function' ? expenseCats(r) : { main: (r.Category||r.Main||'') };
    let m = (cats && cats.main) ? String(cats.main) : String(r.Category||r.Main||'');
    if (!m) return '';
    if (grouped){
      const key = m.toLowerCase();
      // Collapse Caddebostan entries under a single bucket
      if (key.includes('caddebostan')) m = 'Caddebostan (Toplam)';
      // Add more grouping rules here if needed (e.g., advertising buckets)
    }
    return m;
  }catch(e){ return String(r.Category||r.Main||'')||''; }
}


// Alt kƒ±rƒ±lƒ±m anahtarƒ±: FinalSubcategory > Subcategory > "Diƒüer"
function subKeyForRow(r){
  const key =
    r.FinalSubcategory || r.FinalSubCategory || r['Final Subcategory'] ||
    r.Subcategory || r['Subcategory'] || r.SubCat || r['Sub Cat'] ||
    '';
  const s = String(key||'').trim();
  return s || 'Diƒüer';
}

// YTD Detay kƒ±rƒ±lƒ±mƒ±: Ana Kategori + (FinalSubcategory/Subcategory)
function buildMainExpenseBreakdownYTD(expRows){
  const year = new Date().getFullYear();
  const map = new Map(); // "main||sub" -> TRY toplam
  let sumAll = 0;

  for (const r of (expRows || [])){
    const iso = getExpenseISODate(r);
    if (!iso || !iso.startsWith(String(year))) continue;

    const main = mainCategoryForRow(r, false);
    if (!main) continue;

    const sub  = subKeyForRow(r);
    const amt  = Math.abs(readExpenseAmountTRY(r)) || 0;
    if (!amt) continue;

    const k = `${main}||${sub}`;
    map.set(k, (map.get(k)||0) + amt);
    sumAll += amt;
  }

  // Diziye √ßevir, ana kategori + (tutar desc), sonra ana kategori alfabetik
  const arr = Array.from(map.entries()).map(([k, v])=>{
    const [main, sub] = k.split('||');
    return { main, sub, total: v };
  });

  // √ñnce ana kategori, i√ßinde tutara g√∂re
  arr.sort((a,b)=>{
    if (a.main !== b.main) return a.main.localeCompare(b.main, 'tr');
    return b.total - a.total;
  });

  // pay hesaplarƒ±
  return { rows: arr, sumAll: sumAll || 1 };
}

// === YTD Ana Kategori Toplamƒ± (TRY) ‚Äî robust: category via expenseCats(), amount via readExpenseAmountTRY() ===
function buildMainExpenseTotalsYTD(expRows, grouped=false){
  const year = new Date().getFullYear();
  const map = new Map(); // main -> sum TRY
  for (const r of (expRows || [])) {
    const iso = getExpenseISODate(r);
    if (!iso || !iso.startsWith(String(year))) continue;
    const main = mainCategoryForRow(r, grouped);   // use grouped mapping when requested
    const amt = readExpenseAmountTRY(r);           // convert to TRY exactly once
    if (!main || !amt) continue;
    map.set(main, (map.get(main) || 0) + Math.abs(amt));
  }
  return Array.from(map.entries())
    .map(([k,v]) => ({ main:k, total:v }))
    .sort((a,b) => b.total - a.total);
}

// === "Ana Kategoriler (YTD)" tablosunu bu toplamlarla render et ===
function renderMainExpensesTable(){
  // Kaynak diziler
  const rowsDetail  = Array.isArray(expensesRowsCache) ? expensesRowsCache : [];
  const rowsGrouped = (Array.isArray(expensesRowsAdjustedCache) && expensesRowsAdjustedCache.length)
    ? expensesRowsAdjustedCache
    : rowsDetail;

  /* -------- Detay (FinalSubcategory/Subcategory kƒ±rƒ±lƒ±mƒ±) -------- */
  const { rows: detailRows, sumAll: sumDetail } = buildMainExpenseBreakdownYTD(rowsDetail);

  // ƒ∞steƒüe baƒülƒ±: ana kategori ba≈ülƒ±ƒüƒ± eklemek i√ßin gruplayalƒ±m
  const byMain = new Map();
  for (const r of detailRows){
    if(!byMain.has(r.main)) byMain.set(r.main, []);
    byMain.get(r.main).push(r);
  }

  const tbodyD = document.getElementById('tblMainExpensesDetail');
  if (tbodyD){
    const parts = [];
    byMain.forEach((list, main)=>{
      // Ana kategoriye ba≈ülƒ±k satƒ±rƒ±
      parts.push(`
        <tr>
          <td class="text-left py-1 pr-3 font-medium" colspan="3">${main}</td>
        </tr>
      `);
      // Alt kƒ±rƒ±lƒ±mlar (sub)
      list.forEach(item=>{
        parts.push(`
          <tr>
            <td class="text-left py-1 pr-3 pl-4">‚Ü≥ ${item.sub}</td>
            <td class="text-right py-1 pr-3">${numberTL(item.total)}</td>
            <td class="text-right py-1 pr-0">${(item.total/sumDetail*100).toFixed(1)}%</td>
          </tr>
        `);
      });
      // Ara ayra√ß
      parts.push(`<tr><td colspan="3" class="py-1"></td></tr>`);
    });
    tbodyD.innerHTML = parts.join('') || '<tr><td class="hint py-1" colspan="3">Veri yok.</td></tr>';
  }

  /* -------- Gruplanmƒ±≈ü (Ana Kategori toplamlarƒ±) -------- */
  const totalsGrouped = buildMainExpenseTotalsYTD(rowsGrouped, true);
  const sumGrouped = totalsGrouped.reduce((a,b)=>a+b.total,0) || 1;

  const tbodyG = document.getElementById('tblMainExpensesGrouped');
  if (tbodyG) {
    tbodyG.innerHTML = totalsGrouped.map(t => `
      <tr>
        <td class="text-left py-1 pr-3">${t.main}</td>
         <td class="text-right py-1 pr-3">${numberTL(t.total)}</td>
        <td class="text-right py-1 pr-0">${(t.total/sumGrouped*100).toFixed(1)}%</td>
      </tr>
    `).join('') || '<tr><td class="hint py-1" colspan="3">Veri yok.</td></tr>';
  }
}

// === Yumu≈üak baƒülama (expensesRowsCache dolunca 1 kez √ßiz) ===
(function setupMainExpensesAutoRender(){
  let tries = 0;
  const maxTries = 20; // ~16s
  const iv = setInterval(()=>{
    tries++;
    if (Array.isArray(expensesRowsCache) && expensesRowsCache.length){
      clearInterval(iv);
      renderMainExpensesTable();
    } else if (tries >= maxTries){
      clearInterval(iv);
    }
  }, 800);
  // G√ºvenlik i√ßin: sayfa g√∂r√ºn√ºr olduƒüunda tekrar dene
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden && Array.isArray(expensesRowsCache) && expensesRowsCache.length){
      renderMainExpensesTable();
    }
  });
})();

// ===== MAIN DATA LOAD (Revenue + Inventory + Orders) =====
(function initMainLoad(){
  if (window.__popdog_main_inited) return; // avoid double init
  window.__popdog_main_inited = true;

  async function boot(){
    // 1) SHEET (revenue daily)
    try{
      const sheetUrl = localStorage.getItem('popdog_sheet_csv') || DEFAULT_SHEET_CSV;
      if (sheetUrl){
        const rows = await loadFromSheet(sheetUrl);
        loadedRows = Array.isArray(rows) ? rows : [];
        try { localStorage.setItem('popdog_sheet_cache', JSON.stringify(loadedRows)); } catch(e){}
        const monthly = buildMonthly(loadedRows);
        try { setKPIs(monthly); } catch(e) { console.warn('setKPIs error', e); }
        try { drawCharts(monthly); } catch(e) { console.warn('drawCharts error', e); }
        try { buildAlerts(monthly); } catch(e) { console.warn('buildAlerts error', e); }
        try { renderTargets(monthly); } catch(e) { console.warn('renderTargets error', e); }
        // FX t√ºret: KPIs yazƒ±ldƒ±ktan sonra TRY/USD oranƒ±nƒ± √ßƒ±kar (opsiyonel)
        try {
          const tryPerUsd = deriveTryPerUsdFromKPI();
          if (tryPerUsd) { fxRateUSDPerTRY = 1 / tryPerUsd; }
        } catch(e){}
      }
    }catch(err){ console.warn('Revenue boot error', err); }

    // 2) INVENTORY
    try{
      const invUrl = localStorage.getItem('popdog_inv_csv') || DEFAULT_INV_CSV;
      if (invUrl){
        const invRows = await loadCSV(invUrl);
        try { localStorage.setItem('popdog_inv_cache', JSON.stringify(invRows||[])); } catch(e){}
      }
    }catch(err){ console.warn('Inventory load error', err); }

    // 3) ORDERS (raw ‚Üí mapped)
    try{
      const ordersUrl = localStorage.getItem('popdog_orders_csv') || DEFAULT_ORDERS_CSV;
      if (ordersUrl){
        const ordersRaw = await loadCSV(ordersUrl);
        const mapped = (ordersRaw||[]).map(mapOrderRow).filter(o=>o && o.sku && o.qty>0 && o.date);
        try { localStorage.setItem('popdog_orders_cache', JSON.stringify(mapped)); } catch(e){}
      }
    }catch(err){ console.warn('Orders load error', err); }

    // 4) STOCK BLOCK render (after caches are ready)
    try { renderStockBlock(); } catch(e) { console.warn('renderStockBlock error', e); }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  } else {
    boot();
  }
})();

// ===== Ensure Expenses CSV loads on page load (idempotent) =====
// ===== Ensure Expenses CSV loads on page load (idempotent) =====
(function initExpensesLoader(){
  if (window.__popdog_expenses_inited) return; // prevent double init
  window.__popdog_expenses_inited = true;
  async function loadExp(){
    try{
      const expUrl = localStorage.getItem('popdog_expenses_csv') || DEFAULT_EXPENSES_CSV;
      if (!expUrl) return;
      const expRows = await loadExpensesCsv(expUrl);
      expensesRowsCache = Array.isArray(expRows) ? expRows : [];
      if (!Array.isArray(expensesRowsAdjustedCache) || !expensesRowsAdjustedCache.length){
        expensesRowsAdjustedCache = expensesRowsCache.slice();
      }
      renderMainExpensesTable();
      refreshExpensesUI();
    }catch(e){ console.warn('Expenses init error', e); }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', loadExp, { once:true });
  } else {
    loadExp();
  }
})();


// === Helper: revenue YTD (same logic as setKPIs uses) ===
function revenueYTDForYear(year){
  try{
    if(!Array.isArray(monthlyCache)||!monthlyCache.length) return 0;
    return monthlyCache.filter(m=>m.year===year).reduce((a,b)=>a+(b.Total||0),0);
  }catch(e){ return 0; }
}

// Robustly parse expense amount in TRY, including USD->TRY conversion if needed
// === Expense helpers: robust date parse, category mapping (Zee.Dog override), TRY amount ===
function getExpenseISODate(r){
  try{
    const raw = (r && (r.Date || r.date)) ? String(r.Date || r.date).trim() : '';
    if (!raw) return '';
    const mIso = raw.match(/^(\d{4}-\d{2}-\d{2})/);
    if (mIso) return mIso[1];
    const mTr = raw.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
    if (mTr){
      let dd=+mTr[1], mm=+mTr[2], yy=+mTr[3]; if(yy<100) yy+=2000;
      return `${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    }
    const d = new Date(raw);
    return isNaN(+d) ? '' : d.toISOString().slice(0,10);
  }catch(e){ return ''; }
}

// === REMOVED: Duplicate function definition (kept the most comprehensive version at line ~4759) ===

// === REMOVED: Duplicate function definition (kept the most comprehensive version below) ===
function readExpenseAmountTRY(r){
  try{
    if(!r) return 0;

    // 0) Zee.Dog kontrol√º - Zee.Dog giderleri HER ZAMAN USD'dir
    const zeeRegex = /(zee[\s\.-]*dog|zeedog)/i;
    const zeeFields = String(r.Category || '') + ' ' + String(r.Subcategory || '') + ' ' +
                      String(r.FinalSubcategory || '') + ' ' + String(r.Description || '') + ' ' +
                      String(r.Merchant || '') + ' ' + String(r.Payee || '') + ' ' +
                      String(r.Source || '') + ' ' + String(r.Details || '') + ' ' +
                      String(r.Note || r.Notes || r.Memo || r.Aciklama || r['A√ßƒ±klama'] || '');
    const isZeeDog = zeeRegex.test(zeeFields) ||
                     (typeof isZeeExpense === 'function' && isZeeExpense(r));

    // 1) Currency hint from row (accept various header variants)
    let currency = String(
      r.Currency || r['Para Birimi'] || r['Currency Code'] || r['Currency'] || ''
    ).trim().toUpperCase();

    // Zee.Dog i√ßin currency belirtilmemi≈üse USD kabul et
    if (isZeeDog && !currency) {
      currency = 'USD';
    }

    // 2) Candidate amount fields (robust to header variants)
    let raw =
      r.Amount ??
      r.amount ??
      r['Amount (TRY)'] ??
      r['Amount (USD)'] ??
      r['Expense Amount'] ??
      r['Miktar'] ??
      r['Value'] ??
      r['Price'] ??
      r['Tutar'] ??
      r['Net Tutar'] ??
      r['Total'] ??
      r['Toplam'] ??
      0;

    const s = String(raw || '');

    // 3) Detect sign in accounting format "(1,234.00)"
    const isAccountingNegative = /^\s*\(.*\)\s*$/.test(s);

    // 4) Detect currency from field or inline symbols
    // Zee.Dog i√ßin √∂zel: currency zaten USD olarak ayarlandƒ±
    const looksUSD = currency === 'USD' || /\bUSD\b/i.test(s) || /^\s*\$/.test(s) || isZeeDog;
    const looksTRY = !isZeeDog && (currency === 'TRY' || /‚Ç∫|TL|TRY/i.test(s));

    // 5) Helper to resolve TRY per USD (‚Ç∫/USD)
    const resolveTryPerUsd = ()=>{
      // a) direct (stored) TRY per USD
      try{
        const tpu = Number(localStorage.getItem('popdog_fx_try_per_usd') || '0');
        if (tpu > 0) return tpu;
      }catch(e){}

      // b) we might only have USD per TRY in fxRateUSDPerTRY or storage ‚Üí invert
      let usdPerTry = 0;
      if (typeof fxRateUSDPerTRY === 'number' && fxRateUSDPerTRY > 0) usdPerTry = fxRateUSDPerTRY;
      try{
        const upt = Number(localStorage.getItem('popdog_fx_usd_per_try') || '0');
        if (upt > 0) usdPerTry = usdPerTry || upt;
      }catch(e){}
      if (usdPerTry > 0) return 1 / usdPerTry;

      // c) derive from KPI widgets on screen (kpiYTD vs kpiYTD_USD)
      const derived = deriveTryPerUsdFromKPI();
      if (derived > 0) return derived;

      return 0;
    };

    // 6) Convert based on detection
    if (looksUSD){
      // Parse as USD first
      const usd = parseUSD(s);
      const tryPerUsd = resolveTryPerUsd();
      if (!tryPerUsd) return 0;
      const valTRY = usd * tryPerUsd;
      return isAccountingNegative ? -Math.abs(valTRY) : valTRY;
    }

    // 7) Default branch: treat as TRY (also honoring accounting negatives)
    if (isAccountingNegative){
      const inner = s.replace(/^\(|\)$/g,'');
      return -Math.abs(parseTL(inner));
    }
    if (looksTRY){
      return parseTL(s);
    }
    // If currency is unknown, prefer TRY interpretation
    return parseTL(s);
  }catch(e){
    return 0;
  }
}





// === Recompute expenses monthly + KPIs + chart when cache changes ===
function refreshExpensesUI(){
  try{
    expensesMonthlyCache = buildExpensesMonthly(expensesRowsCache||[]);
    // try to derive FX if not ready (from revenue YTD box)
    if(!fxRateUSDPerTRY){
      const tryPerUsd = deriveTryPerUsdFromKPI();
      if(tryPerUsd>0){ fxRateUSDPerTRY = 1 / tryPerUsd; }
    }
    setExpensesKPIs(expensesMonthlyCache);
    drawExpensesCharts(expensesMonthlyCache);
  }catch(e){ console.warn('Expenses UI refresh error', e); }
}

// Run once on load (after expensesRowsCache is filled by initExpensesLoader)
(function(){
  let tries = 0; const maxTries = 25; // ~20s
  const iv = setInterval(()=>{
    tries++;
    if(Array.isArray(expensesRowsCache) && expensesRowsCache.length){
      clearInterval(iv); refreshExpensesUI();
    } else if (tries>=maxTries){ clearInterval(iv); }
  }, 800);
})();

// === Helpers specific to Expenses (robust Zee.Dog handling) ===
function isZeeExpense(r){
  const re = /(zee[\s\.-]*dog|zeedog)/i;
  const fields = [
    r && r.FinalSubcategory, r && r.FinalCategory, r && r.MainCategory, r && r.Category, r && r.Subcategory,
    r && r.Source, r && r.Description, r && r.Details, r && r.Note, r && r.Notes, r && r.Memo,
    r && r.Merchant, r && r.Payee, r && r.Supplier, r && r.Vendor, r && r.Bank, r && r.Banka, r && r.Account,
    r && r.Aciklama, r && r['A√ßƒ±klama']
  ];
  return fields.some(f => f && re.test(String(f)));
}

// Unified category extractor with HARD Zee.Dog override
function expenseCats(r){
  const finalSub = (r && r.FinalSubcategory ? String(r.FinalSubcategory).trim() : '');
  const finalCat = (r && r.FinalCategory    ? String(r.FinalCategory).trim()    : '');

  // Build a combined text for fallback normalization / Zee detection
  const parts = [
    r && r.FinalSubcategory, r && r.FinalCategory,
    r && r.Subcategory, r && r.Category, r && r.Kategori,
    r && r.Source, r && r.Aciklama, r && r['A√ßƒ±klama'], r && r.Description, r && r.Details, r && r.Note, r && r.Notes, r && r.Memo,
    r && r.Merchant, r && r.Payee, r && r.Supplier, r && r.Vendor, r && r.Bank, r && r.Banka, r && r.Account
  ].filter(Boolean).map(x => String(x).trim());
  const combined = parts.join(' | ');

  // Fallback subcategory candidate via normalization
  const sub0 = finalSub || normalizeExpenseCategory(combined) || 'Diƒüer';

  // --- HARD override for Zee.Dog anywhere ---
  const zeeRegex = /(zee[\s\.-]*dog|zeedog)/i;
  const zeeAny   = zeeRegex.test(combined) || zeeRegex.test(sub0) || zeeRegex.test(finalCat);

  // Prefer explicitly provided "main" category fields from the source row.
  // This preserves granular categories like "Kredi", "Kira", "Google", etc.
  const explicitMainCandidates = [
    r && r.FinalCategory,
    r && r.MainCategory,
    r && r.Category,
    r && r.Kategori
  ].filter(Boolean).map(s => String(s).trim()).filter(s => s.length > 0);

  let main = '';
  if (zeeAny) {
    main = 'Zee.Dog';
  } else if (explicitMainCandidates.length) {
    // Use the first explicit main-like field
    main = explicitMainCandidates[0];
    // If it is literally "Diƒüer" but we have a better sub, promote sub to main
    if (/^diƒüer$/i.test(main) && sub0 && !/^diƒüer$/i.test(sub0)) {
      main = sub0;
    }
  } else {
    // No explicit main given ‚Üí map based on normalized sub as a last resort
    main = mapMainExpenseCategory(sub0);
    // Avoid collapsing into "Diƒüer" if sub looks meaningful
    if (/^diƒüer$/i.test(main) && sub0 && !/^diƒüer$/i.test(sub0)) {
      main = sub0;
    }
  }

  const sub = zeeAny ? 'Zee.Dog' : (finalSub || sub0);
  return { sub, main };
}

function getExpenseISODate(r){
  const cands = [r && r.Date, r && r.date, r && r.DATE, r && r['Tarih'], r && r['Transaction Date'], r && r['Posting Date']];
  for(const c of cands){
    if(!c) continue;
    const s = String(c).trim();
    if(/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
    if(/\d{1,2}[./-]\d{1,2}[./-]\d{2,4}/.test(s)){
      const iso = parseTRDateString(s);
      if(iso) return iso;
    }
  }
  return '';
}


function normalizeExpenseCategory(cat){
  const s0 = (cat || '').toString();
  if (!s0) return '';

  // 1) Ba≈üta "Diƒüer -" gibi s√ºsleri temizle
  const s1 = s0.replace(/^diƒüer\s*[-:‚Äì‚Äî]\s*/i, '').replace(/^diger\s*[-:‚Äì‚Äî]\s*/i, '').trim();

  // 2) K√º√ß√ºk harfe indir, diakritikleri normalize et
  const toAscii = (str) => str
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // maƒüaza -> magaza

  const s = toAscii(s1);

  // 3) Ayƒ±rƒ±cƒ±larla b√∂l: " | " , "/" , " - "
  const tokens = s.split(/[|/]+/).flatMap(t => t.split(/\s+-\s+/)).map(t => t.trim()).filter(Boolean);

  // 4) "other/diƒüer/misc" sayƒ±lacak kelimeler
  const isOther = (t) => /^(other|others|misc|miscellaneous|cesitli|various|diverse|diger|digerleri)$/i.test(t);

  // 5) ƒ∞lk "diƒüer" olmayan etiket
  const primary = tokens.find(t => !isOther(t)) || (tokens[0] || '');

  // 6) Sƒ±k g√∂r√ºlen ad d√ºzeltmeleri
  if (/^meta\s*ads?$/.test(primary) || /^facebook(\s*ads?)?$/.test(primary) || /^instagram(\s*ads?)?$/.test(primary)) return 'Facebook';
  if (/^google(\s*ads?|adwords)$/.test(primary)) return 'Google Ads';
  if (/^tik(tok| tok)(\s*ads?)?$/.test(primary)) return 'TikTok Ads';
  if (/(yurtici|aras|mng|surat|ptt|ups|dhl|fedex|trendyol\s*express|hepsijet)/.test(primary)) return 'Kargo';
  if (/(garanti|isbank|is\s*bankasi|qnb|enpara|akbank|ziraat|yapi\s*kredi|iyzico|iyzi|iyzi-co|payu|iyzico|iyzi\s*co|stripe|iyzico)/.test(primary)) return 'Banka/√ñdeme';

  // 7) √ñzel √ºr√ºn/marka √∂rnekleri
  if (/(zee)[\s\.-]*(dog)|zeedog/.test(primary)) return 'Zee.Dog';

  // 8) Bo≈üsa Diƒüer
  if (!primary || isOther(primary)) return 'Diƒüer';

  // 9) Standart bo≈üluk temizliƒüi
  return primary.replace(/\s+/g, ' ').trim();
}

function mapMainExpenseCategory(cat){
  // `cat` = normalizeExpenseCategory √ßƒ±ktƒ±sƒ± veya √∂zg√ºn metin
  const s = (cat || '').toString().toLowerCase();

  // 1) Dijital Reklam
  if (/(facebook|google\s*ads?|adwords|instagram|tiktok|youtube|meta\s*ads?)/.test(s))
    return 'Dijital Reklam';

  // 2) Lojistik
  if (/(kargo|lojistik|shipping|nakliye|kurye|yurtici|aras|mng|surat|ptt|ups|dhl|fedex|trendyol\s*express|hepsijet)/.test(s))
    return 'Lojistik';

  // 3) Banka / Komisyon / √ñdeme Kurulu≈ülarƒ±
  if (/(banka|komisyon|pos\s*kesintisi|pos\s*ucreti|havale|eft|chargeback|kart\s*ucreti|iban\s*ucreti|iyzico|payu|stripe|paytr|papara|wise|paycell)/.test(s))
    return 'Banka / Komisyon';

  // 4) Vergiler
  if (/(vergi|kdv|stopaj|damga|gecikme|ceza|beyanname|muhasebe\s*damga)/.test(s))
    return 'Vergiler';

  // 5) Yazƒ±lƒ±m / Abonelik
  if (/(shopify|yazilim|abonelik|subscription|google\s*workspace|office\s*365|microsoft\s*365|slack|notion|figma|zoom|canva|trello|asana|jira|aws|gcp|azure|cloudflare)/.test(s))
    return 'Yazƒ±lƒ±m / Abonelik';

  // 6) Danƒ±≈ümanlƒ±k / Hizmet
  if (/(danisman|consult|freelance|ajans|agency|hukuk|legal|avukat|muhasebe\s*hizmet|ymm|denetim|tasarim|design|fotograf|video|prod√ºksiyon|prod√ºksiyon)/.test(s))
    return 'Danƒ±≈ümanlƒ±k Giderleri';

  // 7) Stok / Mal Alƒ±mƒ±
  if (/(mal\s*al(imi|ƒ±mƒ±)|stok|tedarik|sat(in|ƒ±n)\s*alma|purchase|supplier|tedarikci)/.test(s))
    return 'Stok / Mal Alƒ±mƒ±';

  // 8) Maƒüaza Giderleri (yalnƒ±z maƒüaza/≈üube anahtarlarƒ±yla e≈üle)
  if (/(magaza|maƒüaza|saha|sube|ckm|caddebostan|cadde|depo|thrones)/.test(s) &&
      /(kira|elektrik|su|dogalgaz|doƒüalgaz|aidat|guvenlik|g√ºvenlik|temizlik|personel|maas|maa≈ü|yemek|ssk|sgk|pos)/.test(s))
    return 'Maƒüaza Giderleri';

  // 9) Ev Giderleri (ev/konut anahtarƒ± ≈üart)
  if (/(ev|konut|daire|home|house)/.test(s) &&
      /(kira|elektrik|su|dogalgaz|doƒüalgaz|aidat|internet)/.test(s))
    return 'Ev Giderleri';

  // 9.b) Marka bazlƒ± √∂zel kasa: Zee.Dog ana kategori olarak ayrƒ± listelensin
  if (/(zee)[\s\.-]*dog|zeedog/.test(s)) return 'Zee.Dog';
  // 10) Varsayƒ±lan
  return 'Diƒüer';
}



function buildExpensesMonthly(rows){
  const map = new Map();

  (rows || []).forEach(r => {
    const iso = (r && r.Date && /^\d{4}-\d{2}-\d{2}$/.test(String(r.Date)))
      ? String(r.Date).slice(0,10)
      : getExpenseISODate(r);
    if (!iso) return;

    const d = new Date(iso + 'T00:00:00Z');
    if (isNaN(+d)) return;

    const key = monthKey(d);

   const amount = readExpenseAmountTRY(r);

    const cats = expenseCats(r);
    const subKey  = cats.sub || 'Diƒüer';
    const mainKey = cats.main || 'Diƒüer';

    const prev = map.get(key) || { month: key, year: d.getFullYear(), Total: 0, byCat: {}, byMain: {} };

    prev.Total += amount;
    prev.byCat[subKey]   = (prev.byCat[subKey]   || 0) + amount;
    prev.byMain[mainKey] = (prev.byMain[mainKey] || 0) + amount;

    map.set(key, prev);
  });

  return Array.from(map.values()).sort((a,b)=> a.month.localeCompare(b.month));
}

function setExpensesKPIs(expMonthly){
  const now = new Date();
  const curYear = now.getFullYear();
  // Yƒ±l se√ßimi: Bu yƒ±l veriniz yoksa, eldeki son yƒ±lƒ± kullan
  const yearsExp = Array.from(new Set((expMonthly||[]).map(m=>m.year))).sort((a,b)=>a-b);
  const expYear = yearsExp.includes(curYear) ? curYear : (yearsExp.length ? yearsExp[yearsExp.length-1] : curYear);
  const rowsThisYear = (expMonthly||[]).filter(m=> m.year===expYear);
  const expYTD = rowsThisYear.reduce((a, r) => a + (r.Total || 0), 0);

  // YTD gider
  const elExp = document.getElementById('kpiExpYTD'); if (elExp) elExp.textContent = numberTL(expYTD);
  const elExpUSD = document.getElementById('kpiExpYTD_USD'); if (elExpUSD) elExpUSD.textContent = fxRateUSDPerTRY ? `‚âà ${numberUSD(expYTD*fxRateUSDPerTRY)} USD` : '‚âà ‚Äì USD';

  // YoY (aynƒ± ay sayƒ±sƒ± hizalƒ±)
  try{
    const monthsThis = rowsThisYear.map(r=> r.month.slice(5,7));
const prevSum = (expMonthly||[]).reduce((acc,r)=> (r.year===expYear-1 && monthsThis.includes(r.month.slice(5,7))) ? acc+(r.Total||0) : acc, 0);    const yoy = prevSum ? (expYTD - prevSum) / prevSum : 0;
    const elYoY = document.getElementById('kpiExpYoY'); if (elYoY) elYoY.textContent = `YTD YoY: ${(yoy*100).toFixed(1)}%`;
  }catch(e){}

  // MoM
  const sorted = rowsThisYear.slice().sort((a,b)=> a.month.localeCompare(b.month));
  const last = sorted.at(-1)?.Total || 0; const prev = sorted.at(-2)?.Total || 0;
  const mom = prev ? (last - prev) / prev : 0;
  const elMoM = document.getElementById('kpiExpMoM'); if (elMoM){ elMoM.textContent = `${(mom*100).toFixed(1)}%`; elMoM.classList.remove('kpi-up','kpi-down'); elMoM.classList.add(mom<=0?'kpi-up':'kpi-down'); }
  const elMoMNote = document.getElementById('kpiExpMoMNote'); if (elMoMNote){ const labs = sorted.map(m=>m.month); elMoMNote.textContent = labs.length>=2 ? `(${labs.at(-2)} ‚Üí ${labs.at(-1)})` : ''; }

  // Net (Gelir YTD - Gider YTD)
  try{
    const revThisYear = (monthlyCache||[]).filter(m=> m.year===expYear).reduce((a,r)=> a+(r.Total||0), 0);
    const net = revThisYear - expYTD;
    const elNet = document.getElementById('kpiNetYTD'); if (elNet) elNet.textContent = numberTL(net);
    const elNetUSD = document.getElementById('kpiNetYTD_USD'); if (elNetUSD) elNetUSD.textContent = fxRateUSDPerTRY ? `‚âà ${numberUSD(net*fxRateUSDPerTRY)} USD` : '‚âà ‚Äì USD';
    const elNetNote = document.getElementById('kpiNetNote'); if (elNetNote) elNetNote.textContent = `Gelir (YTD): ${numberTL(revThisYear)} ‚Ä¢ Gider (YTD): ${numberTL(expYTD)}`;
  }catch(e){}
}

function renderMainExpenseTable(){
  try{
    const now = new Date();
    const curYear = now.getFullYear();
    const years = Array.from(new Set((expensesMonthlyCache||[]).map(m=>m.year))).sort((a,b)=>a-b);
    const expYear = years.includes(curYear) ? curYear : (years.length ? years[years.length-1] : curYear);

    const baseRows = (expensesRowsAdjustedCache && expensesRowsAdjustedCache.length) ? expensesRowsAdjustedCache : expensesRowsCache;
    const rows = (baseRows || []).filter(r => {
      const iso = (r && r.Date && /^\d{4}-\d{2}-\d{2}$/.test(r.Date)) ? r.Date : getExpenseISODate(r);
      if(!iso) return false;
      const d = new Date(iso + 'T00:00:00Z');
      return d && !isNaN(+d) && d.getFullYear() === expYear;
    });

    const sumByMain = {};
    let total = 0;
    for(const r of rows){
      const main = (r.FinalCategory && String(r.FinalCategory).trim()) || (r.FinalSubcategory && String(r.FinalSubcategory).trim()) || r.MainCategory || mapMainExpenseCategory(r.Category || 'Diƒüer');

      // Detect Zee across all fields
      const zee = isZeeExpense(r) || main === 'Zee.Dog' || (r.Category === 'Zee.Dog');
      const mainFixed = zee ? 'Zee.Dog' : main;

      // Amount in TRY with USD‚ÜíTRY fallback for Zee
      let a = ('Amount' in r && r.Amount !== null && r.Amount !== '') ? (Number(r.Amount)||0) : 0;
      if(!a){ a = readExpenseAmountTRY(r); }

      sumByMain[mainFixed] = (sumByMain[mainFixed] || 0) + (a || 0);
      total += (a || 0);
    }

    const arr = Object.entries(sumByMain)
      .map(([k,v]) => ({ k, v, p: total ? (v/total*100) : 0 }))
      .sort((a,b) => b.v - a.v);

    const tbody = document.getElementById('tblMainExpenses');
    if(!tbody) return;
    tbody.innerHTML = arr.length
      ? arr.map(x => `
          <tr>
            <td class="py-1 pr-3">${x.k}</td>
            <td class="py-1 pr-3 text-right">${numberTL(x.v)}</td>
            <td class="py-1 pr-0 text-right">${x.p.toFixed(1)}%</td>
          </tr>
        `).join('')
      : '<tr><td colspan="3" class="hint py-1">Veri yok.</td></tr>';
  }catch(e){
    console.warn('renderMainExpenseTable error', e);
  }
}
// Expenses charts removed (stability + simpler maintenance)
function drawExpensesCharts(){
  // Charts removed - placeholder function for compatibility
  if (!window.Chart) { return; }
  return;
}

/* ================== Expenses: Load & Refresh ================== */
function refreshExpenses(){
  try{
    // Amount alanlarƒ± zaten readExpenseAmountTRY() ile TRY‚Äôye normalize edilmi≈ü durumda.
    expensesRowsAdjustedCache = Array.isArray(expensesRowsCache) ? expensesRowsCache.slice() : [];

    // Aylƒ±k agregasyonlarƒ± doƒürudan bu cache'ten olu≈ütur
    expensesMonthlyCache = buildExpensesMonthly(expensesRowsAdjustedCache);

    // KPI + grafik + tablo
    setExpensesKPIs(expensesMonthlyCache);
    drawExpensesCharts(expensesMonthlyCache);
    renderMainExpensesTable();
  }catch(e){
    console.warn('refreshExpenses error', e);
  }
}

// URL / localStorage config for expenses CSV
const EXPENSES_CSV_URL =
  getParam('expenses') ||
  getParam('expenses_csv') ||
  localStorage.getItem('popdog_expenses_csv_url') ||
  DEFAULT_EXPENSES_CSV;

// YoY toggle for expenses chart
(function initExpYoyToggle(){
  const tgl = document.getElementById('expYoyToggle');
  const stateEl = document.getElementById('expYoyState');
  if (!tgl) return;
  tgl.addEventListener('click', ()=>{
    expYoyEnabled = !expYoyEnabled;
    if (stateEl) stateEl.textContent = expYoyEnabled ? 'A√ßƒ±k' : 'Kapalƒ±';
    if (expensesMonthlyCache && expensesMonthlyCache.length) {
      drawExpensesCharts(expensesMonthlyCache);
    }
  });
})();

/* ================== Hook expenses into global refreshAll ================== */
(function patchRefreshAll(){
  const prev = window.refreshAll;
  window.refreshAll = function(...args){
    if (typeof prev === 'function') {
      try { prev.apply(this, args); } catch(e){ console.warn('refreshAll (prev) error', e); }
    }
    try { refreshExpenses(); } catch(e){ console.warn('refreshAll‚ÜírefreshExpenses error', e); }
  };
})();



/* ================== Weekly UI ================== */
let weeklyAgg = [];
let selectedMondayISO = null;
function renderWeek(){
  if(!weeklyAgg.length){
    document.getElementById('weekCards').innerHTML = '<div class="hint text-sm">Haftalƒ±k veri yok.</div>';
    document.getElementById('weekWoW').textContent='';
    document.getElementById('weekLabel').textContent='';
    return;
  }
  if(!selectedMondayISO){ selectedMondayISO = weeklyAgg.at(-1).monday; }
  const idx = weeklyAgg.findIndex(w=>w.monday===selectedMondayISO);
  const cur = weeklyAgg[idx];
  const prev = weeklyAgg[idx-1] || null;

  document.getElementById('weekLabel').textContent = weekRangeLabel(new Date(cur.monday + "T00:00:00"));

  const keys = ['Total','Toptan','Online','CKM','Trendyol','Hepsiburada','Kuaf√∂r'];
  const labels = {Total:'Toplam', Toptan:'Toptan', Online:'Online', CKM:'CKM', Trendyol:'Trendyol', Hepsiburada:'Hepsiburada', Kuaf√∂r:'Kuaf√∂r'};
  const wrap = document.getElementById('weekCards'); wrap.innerHTML='';
  keys.forEach(k=>{
    const v = cur[k]||0;
    const p = prev ? prev[k]||0 : 0;
    const wow = p ? (v-p)/p : 0;
    const card = document.createElement('div');
    card.className='glass card-3d rounded-2xl p-3';
    card.innerHTML = `<div class="hint text-xs">${labels[k]}</div>
      <div class="text-slate-800 dark:text-slate-100 font-semibold">${numberTL(v)}</div>
      <div class="${wow>=0?'kpi-up':'kpi-down'} text-xs">${(wow*100).toFixed(1)}%</div>`;
    wrap.appendChild(card);
  });

  const wowTotal = prev ? (cur.Total - prev.Total) / prev.Total : 0;
  document.getElementById('weekWoW').textContent = `WoW (Toplam): ${(wowTotal*100).toFixed(1)}%`;
}
document.getElementById('weekPrev').onclick = ()=>{
  if(!weeklyAgg.length || !selectedMondayISO) return;
  const idx = weeklyAgg.findIndex(w=>w.monday===selectedMondayISO);
  if(idx>0){ selectedMondayISO = weeklyAgg[idx-1].monday; renderWeek(); }
};
document.getElementById('weekNext').onclick = ()=>{
  if(!weeklyAgg.length || !selectedMondayISO) return;
  const idx = weeklyAgg.findIndex(w=>w.monday===selectedMondayISO);
  if(idx<weeklyAgg.length-1){ selectedMondayISO = weeklyAgg[idx+1].monday; renderWeek(); }
};

/* ================== Monthly View UI ================== */
function renderMonthlyView(){
  const mc = monthlyCache || [];
  const wrap = document.getElementById('monthCards');
  const labelEl = document.getElementById('monthYearLabel');
  const momEl = document.getElementById('monthMoM');
  if(!wrap) return;

  if(!mc.length){
    wrap.innerHTML = '<div class="hint text-sm">Aylƒ±k veri yok.</div>';
    if(labelEl) labelEl.textContent = '';
    if(momEl) momEl.textContent = '';
    return;
  }

  // Son yƒ±lƒ±n aylarƒ±nƒ± g√∂ster
  const now = new Date();
  const currentYear = now.getFullYear();
  const thisYearMonths = mc.filter(m => m.year === currentYear);
  const dataMonths = thisYearMonths.length ? thisYearMonths : mc.slice(-12);

  if(labelEl) labelEl.textContent = dataMonths.length ? `${dataMonths[0].year}` : '';

  const keys = ['Toptan','Online','CKM','Trendyol','Hepsiburada','Kuaf√∂r','Total'];
  const labels = {Toptan:'Toptan', Online:'Online', CKM:'CKM', Trendyol:'Trendyol', Hepsiburada:'Hepsiburada', Kuaf√∂r:'Kuaf√∂r', Total:'Toplam'};

  // Her kanal i√ßin bu yƒ±lƒ±n toplamƒ±nƒ± ve ge√ßen aya g√∂re deƒüi≈üimi g√∂ster
  const sumThisYear = k => dataMonths.reduce((a, m) => a + (m[k] || 0), 0);
  const lastMonth = dataMonths.length ? dataMonths[dataMonths.length - 1] : null;
  const prevMonth = dataMonths.length >= 2 ? dataMonths[dataMonths.length - 2] : null;

  wrap.innerHTML = '';
  keys.forEach(k => {
    const ytdVal = sumThisYear(k);
    const curVal = lastMonth ? (lastMonth[k] || 0) : 0;
    const prvVal = prevMonth ? (prevMonth[k] || 0) : 0;
    const mom = prvVal ? (curVal - prvVal) / prvVal : 0;

    const card = document.createElement('div');
    card.className = 'glass card-3d rounded-2xl p-3';
    card.innerHTML = `
      <div class="hint text-xs">${labels[k]}</div>
      <div class="text-slate-800 dark:text-slate-100 font-semibold text-sm">${numberTL(ytdVal)}</div>
      <div class="hint text-xs mt-1">Son ay: ${numberTL(curVal)}</div>
      <div class="${mom >= 0 ? 'kpi-up' : 'kpi-down'} text-xs">MoM: ${(mom * 100).toFixed(1)}%</div>`;
    wrap.appendChild(card);
  });

  // Genel MoM
  if(momEl && lastMonth && prevMonth){
    const totalMom = prevMonth.Total ? (lastMonth.Total - prevMonth.Total) / prevMonth.Total : 0;
    const lastMonthName = lastMonth.month.slice(5);
    const prevMonthName = prevMonth.month.slice(5);
    momEl.textContent = `MoM (${prevMonthName} ‚Üí ${lastMonthName}): ${(totalMom * 100).toFixed(1)}%`;
  } else if(momEl){
    momEl.textContent = '';
  }
}

/* ================== WhatsApp Paste ‚Üí stage table ================== */
function grab(line, keys){ const s=line.toLowerCase(); return keys.some(k=>s.startsWith(k)); }
function extractValue(line){
  const m=line.match(/-?\d[\d\s.,]*/);
  if(!m) return 0;
  return parseTL(m[0]);
}
function parseDailyText(txt){
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let dateISO = '';
  let kk=0, qnb=0, nakit=0, toplam=0, kasaNakit=0, online=0, toptan=0, trendyol=0, hb=0, kuafor=0;

  for (const line of lines){
    const low = line.toLowerCase();

    if (low.includes('tarih')){ dateISO = parseTRDateString(line); continue; }

    // Kuaf√∂r / Grooming (must NOT be treated as CKM Nakit)
    if (low.startsWith('kuaf') || low.includes('kuaf√∂r') || low.includes('kuafor') || low.includes('grooming')){
      kuafor = extractValue(line);
      continue;
    }

    if (grab(low,['kredi kartƒ±','kredi karti'])){ kk = extractValue(line); continue; }
    if (grab(low,['qnb','i≈ü','is','garanti'])){ qnb = extractValue(line); continue; }

    // Nakit (exclude kasa nakit and kuaf√∂r)
    if ((low.includes('nakit') && !low.includes('kasa') && !low.includes('kuaf'))){
      nakit = extractValue(line);
      continue;
    }

    if (low.includes('toplam ciro')){ toplam = extractValue(line); continue; }
    if (low.includes('kasa nakit')){ kasaNakit = extractValue(line); continue; }
    if (low.includes('pop dog online')){ online = extractValue(line); continue; }
    if (low.includes('pop dog toptan')){ toptan = extractValue(line); continue; }
    if (low.startsWith('trendyol')){ trendyol = extractValue(line); continue; }
    if (low.startsWith('hepsiburada')){ hb = extractValue(line); continue; }
  }

  const ckm = (toplam > 0) ? toplam : (kk + qnb + nakit);
  return {
    Date: dateISO || '',
    Toptan: toptan || 0,
    Online: online || 0,
    CKM: ckm || 0,
    'Kuaf√∂r': kuafor || 0,
    'CKM Nakit': nakit || 0,
    'Kasa Nakit (EoD)': kasaNakit || 0,
    Trendyol: trendyol || 0,
    Hepsiburada: hb || 0,
    Total: (toptan + online + ckm + trendyol + hb)
  };
}
document.getElementById('parseAddBtn').onclick = ()=>{
  const txt=document.getElementById('dailyText').value;
  if(!txt.trim()){ document.getElementById('parseInfo').textContent='Metin bo≈ü.'; return; }
  const row=parseDailyText(txt);
  if(!row.Date){ document.getElementById('parseInfo').textContent='Tarih bulunamadƒ±. "Tarih 07/09/2025" gibi.'; return; }
  stagedRows.push(row);
  document.getElementById('parseInfo').textContent=`Eklendi: ${row.Date}`;
  document.getElementById('dailyText').value='';
  refreshAll();
};
function renderStaged(){
  const tbody = document.getElementById('stagedTbody'); tbody.innerHTML='';
  for(const r of stagedRows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4">${r.Date}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r.Toptan)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r.Online)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r.CKM)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r['Kuaf√∂r']||0)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r["CKM Nakit"]||0)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r["Kasa Nakit (EoD)"]||0)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r.Trendyol)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r.Hepsiburada)}</td>
      <td class="py-2 pr-4 text-right">${numberTL(r.Total)}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ================== CSV I/O (local import/export) ================== */
document.getElementById('uploadBtn').onclick = ()=> document.getElementById('fileInput').click();
document.getElementById('fileInput').addEventListener('change', e=>{
  const file = e.target.files && e.target.files[0]; if(!file) return;
  Papa.parse(file, { header:true, skipEmptyLines:true, complete:(res)=>{
    const data = (res.data||[]).map(r=>{
      const iso = r.Date ? String(r.Date).trim().slice(0,10) : '';
      const row = {
        Date: iso,
        Toptan: parseTL(r.Toptan), Online: parseTL(r.Online),
        CKM: parseTL(r.CKM), ["CKM Nakit"]: parseTL(r["CKM Nakit"]),
        Trendyol: parseTL(r.Trendyol), Hepsiburada: parseTL(r.Hepsiburada),
      };
      row.Total = row.Toptan + row.Online + row.CKM + row.Trendyol + row.Hepsiburada;
      return row;
    }).filter(r=>r.Date);
    loadedRows = data; localStorage.setItem('popdog_loaded_rows', JSON.stringify(loadedRows));
    refreshAll();
  }});
});
document.getElementById('downloadBtn').onclick = ()=>{
  // loaded + staged ‚Üí tekille≈ütir ve tarihe g√∂re sƒ±rala
  const mergedRaw = [...loadedRows, ...stagedRows];
  const merged = dedupeDailyRows(mergedRaw); // aynƒ± g√ºne ait en anlamlƒ± satƒ±rƒ± se√ßer

  const headers = ['Date','Toptan','Online','CKM','Kuaf√∂r','CKM Nakit','Kasa Nakit (EoD)','Trendyol','Hepsiburada','Total'];
  const lines = [headers.join(",")].concat(merged.map(r=>[
    r.Date,
    r.Toptan,
    r.Online,
    r.CKM,
    (r['Kuaf√∂r']||0),
    (r['CKM Nakit']||0),
    (r['Kasa Nakit (EoD)']||0),
    r.Trendyol,
    r.Hepsiburada,
    r.Total
  ].join(",")));

  const csv = lines.join("\n");
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'revenue_2025_YTD.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

/* ================== FX (TRY‚ÜíUSD) ================== */
async function fetchFX(){
  const fetchWithTimeout = async (url, timeout = 10000) => {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
      const response = await fetch(url, { signal: controller.signal });
      clearTimeout(id);
      return response;
    } catch (error) {
      clearTimeout(id);
      throw error;
    }
  };

  try{
    const r = await fetchWithTimeout('https://open.er-api.com/v6/latest/TRY');
    const j = await r.json();
    if(j && j.rates && j.rates.USD){
      fxRateUSDPerTRY = j.rates.USD;
      fxDate = j.time_last_update_utc ? new Date(j.time_last_update_utc) : new Date();
      const tryPerUsd = fxRateUSDPerTRY ? (1 / fxRateUSDPerTRY) : null;
      document.getElementById('fxNote').textContent =
  tryPerUsd ? `Kur: ${fxDate.toLocaleDateString('tr-TR')} ‚Ä¢ 1 $ = ${tryPerUsd.toFixed(4)} ‚Ç∫` : `Kur alƒ±namadƒ±`;
try { refreshExpenses(); } catch(e) {}
try { renderMainExpensesTable(); } catch(e) {}
return;
    }
  }catch(e){}
  try{
    const r2 = await fetchWithTimeout('https://api.exchangerate.host/latest?base=TRY&symbols=USD');
    const j2 = await r2.json();
    if(j2 && j2.rates && j2.rates.USD){
      fxRateUSDPerTRY = j2.rates.USD;
      fxDate = j2.date ? new Date(j2.date) : new Date();
      const tryPerUsd = fxRateUSDPerTRY ? (1 / fxRateUSDPerTRY) : null;
      document.getElementById('fxNote').textContent =
  tryPerUsd ? `Kur: ${fxDate.toLocaleDateString('tr-TR')} ‚Ä¢ 1 $ = ${tryPerUsd.toFixed(4)} ‚Ç∫` : `Kur alƒ±namadƒ±`;
try { refreshExpenses(); } catch(e) {}
try { renderMainExpensesTable(); } catch(e) {}
return;
    }
  }catch(e){}
  document.getElementById('fxNote').textContent = `Kur alƒ±namadƒ±`;
}

/* ================== DEDUPE HELPERS (daily revenue rows) ================== */
function dedupeDailyRows(rows){
  if (!Array.isArray(rows)) return [];
  const byDate = new Map();
  for (const r of rows){
    if (!r || !r.Date) continue;
    const key = String(r.Date).slice(0,10);
    const cur = byDate.get(key);
    // Daha b√ºy√ºk Total'ƒ± se√ß. E≈üitse dolu s√ºtunu fazla olanƒ± al.
    if (!cur) { byDate.set(key, r); continue; }
    const tNew = (+r.Total||0);
    const tOld = (+cur.Total||0);
    if (tNew > tOld) { byDate.set(key, r); continue; }
    if (tNew === tOld) {
      const nzNew = ((+r.Toptan||0)>0) + ((+r.Online||0)>0) + ((+r.CKM||0)>0) + ((+r.Trendyol||0)>0) + ((+r.Hepsiburada||0)>0);
      const nzOld = ((+cur.Toptan||0)>0) + ((+cur.Online||0)>0) + ((+cur.CKM||0)>0) + ((+cur.Trendyol||0)>0) + ((+cur.Hepsiburada||0)>0);
      if (nzNew > nzOld) byDate.set(key, r);
    }
  }
  // Tarihe g√∂re sƒ±rala
  return Array.from(byDate.values()).sort((a,b)=> (a.Date||'').localeCompare(b.Date||''));
}
/* ================== PIPELINE (Revenue) ================== */
function refreshAll(){
  // 1) loaded + staged ‚Üí tekille≈ütir (aynƒ± g√ºne ait satƒ±rlarda en anlamlƒ± olanƒ± se√ß)
  const mergedRaw = [...loadedRows, ...stagedRows];
  const merged = dedupeDailyRows(mergedRaw); // zaten tarihe g√∂re sƒ±ralƒ± d√∂ner

  // 2) cache
  mergedRowsCache = merged;

  // 3) agregasyonlar
  const monthly = buildMonthly(merged);
  monthlyCache = monthly;
  const weekly  = buildWeekly(merged); weeklyAgg = weekly;

  // 4) Haftalƒ±k se√ßimi g√ºncel son haftaya sabitle (varsa)
  const lastMonday = weeklyAgg.length ? weeklyAgg[weeklyAgg.length - 1].monday : null;
  if (
    !selectedMondayISO ||
    !weeklyAgg.some(w => w.monday === selectedMondayISO) ||
    (lastMonday && selectedMondayISO < lastMonday)
  ) {
    selectedMondayISO = lastMonday;
  }

  // 5) KPI + UI
  setKPIs(monthly);
  buildAlerts(monthly);
  drawCharts(monthly);
  renderTargets(monthly);
  renderStaged();
  renderWeek();
  renderMonthlyView();
  renderLast7();

  // 6) Stok bloƒüu
  renderStockBlock();
 // === Expenses (CFO) render ===
try {
  if (Array.isArray(expensesMonthlyCache) && expensesMonthlyCache.length) {
    drawExpensesCharts(expensesMonthlyCache);
  }
} catch (e) {
  console.warn('Expenses render error', e);
}
}
// ================== BOOTSTRAP (safe, idempotent) ==================
(function bootPopdog(){
  if (window.__popdog_bootstrapped) return; // idempotent
  window.__popdog_bootstrapped = true;

  // Quick placeholders to avoid blank UI perception
  try{
    const el1 = document.getElementById('kpiYTD');
    if (el1) el1.textContent = 'y√ºkleniyor‚Ä¶';
    const el2 = document.getElementById('kpiInvCost');
    if (el2) el2.textContent = 'y√ºkleniyor‚Ä¶';
    const el3 = document.getElementById('kpiInvPrice');
    if (el3) el3.textContent = 'y√ºkleniyor‚Ä¶';
    const t = document.getElementById('tblMainExpenses');
    if (t) t.innerHTML = '<tr><td class="hint py-1" colspan="3">Y√ºkleniyor‚Ä¶</td></tr>';
  }catch(e){}

  async function boot(){
    try {
      // START ALL LOADS IN PARALLEL (guard against missing defaults)
      const sheetUrl = localStorage.getItem('popdog_sheet_csv')    || (window.DEFAULT_SHEET_CSV    || '');
      const invUrl   = localStorage.getItem('popdog_inv_csv')      || (window.DEFAULT_INV_CSV      || '');
      const ordUrl   = localStorage.getItem('popdog_orders_csv')   || (window.DEFAULT_ORDERS_CSV   || '');
      const expUrl   = localStorage.getItem('popdog_expenses_csv') || (window.DEFAULT_EXPENSES_CSV || '');

      const pRev = (async()=>{
        try{
          if(!sheetUrl) return;
          const revRows = await loadFromSheet(sheetUrl);
          loadedRows = Array.isArray(revRows) ? revRows : [];
          const monthly = buildMonthly(loadedRows);
          setKPIs(monthly);
          try { renderMainExpensesTable(); } catch(e) {}
          drawCharts(monthly);
          buildAlerts(monthly);
          renderTargets(monthly);
        } catch(e){ console.warn('Revenue render error', e); }
      })();

      const pInv = (async()=>{
        try{
          if(!invUrl) return;
          const invRows = await loadCSV(invUrl);
          try { localStorage.setItem('popdog_inv_cache', JSON.stringify(invRows || [])); } catch(e){}
          renderStockBlock();
        } catch(e){ console.warn('Inventory load/render error', e); }
      })();

      const pOrd = (async()=>{
        try{
          if(!ordUrl) return;
          const ordRaw = await loadCSV(ordUrl);
          const mapped = (ordRaw || []).map(mapOrderRow).filter(o=>o && o.sku && o.qty>0 && o.date);
          const persist = mapped.map(o=>({ sku:o.sku, qty:o.qty, price:o.price, date:o.date.toISOString() }));
          try { localStorage.setItem('popdog_orders_cache', JSON.stringify(persist)); } catch(e){}
          renderStockBlock();
        } catch(e){ console.warn('Orders load/render error', e); }
      })();

      const pExp = (async()=>{
        try{
          if(!expUrl) return;
          const expRows = await loadCSV(expUrl);
          expensesRowsCache = Array.isArray(expRows) ? expRows : [];
          if (!Array.isArray(expensesRowsAdjustedCache) || !expensesRowsAdjustedCache.length){
            expensesRowsAdjustedCache = expensesRowsCache.slice();
          }
          // Build monthly + KPIs + charts
          try { refreshExpenses(); } catch(e) { console.warn('refreshExpenses error', e); }
          // Ensure main table visible ASAP
          try { renderMainExpensesTable(); } catch(e){}
        } catch(e){ console.warn('Expenses load/render error', e); }
      })();

      const results = await Promise.allSettled([pRev, pInv, pOrd, pExp]);
      // Log any failed promises for debugging
      results.forEach((result, index) => {
        if (result.status === 'rejected') {
          const names = ['Revenue', 'Inventory', 'Orders', 'Expenses'];
          console.warn(`${names[index]} load failed:`, result.reason);
        }
      });

      // Derive FX once (if needed) after first paints
      try {
        if (!fxRateUSDPerTRY){
          const tryPerUsd = deriveTryPerUsdFromKPI();
          if (tryPerUsd && isFinite(tryPerUsd)){
            fxRateUSDPerTRY = 1 / tryPerUsd;
          }
        }
      } catch(e){}
    } catch(err){
      console.error('BOOT error', err);
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  } else {
    // DOM is already ready
    boot();
  }
})();

/* ================== Last 7 Days Summary ================== */
function startOfDayLocal(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}

function renderLast7(){
  const wrap = document.getElementById('last7Wrap');
  if(!wrap) return;
  const note = document.getElementById('last7Note');

  const rows = Array.isArray(mergedRowsCache) ? mergedRowsCache : [];
  if(!rows.length){
    wrap.innerHTML = '<div class="hint text-sm">Veri yok.</div>';
    if (note) note.textContent = '';
    return;
  }

  // G√ºn g√ºn toplamlar (bug√ºn dahil son 7 g√ºn)
  const dayMs = 24*60*60*1000;
  const today = new Date(); today.setHours(0,0,0,0);
  const days = [];
  for(let i=6; i>=0; i--){
    const d = new Date(today.getTime() - i*dayMs);
    days.push(d);
  }

  const byDate = new Map(); // ISO-> {Total, Toptan, Online, CKM, Kuafor, Trendyol, Hepsiburada}
  rows.forEach(r=>{
    if(!r.Date) return;
    const d = new Date(r.Date + 'T00:00:00'); d.setHours(0,0,0,0);
    const iso = d.toISOString().slice(0,10);
    const acc = byDate.get(iso) || {Total:0,Toptan:0,Online:0,CKM:0,Kuafor:0,Trendyol:0,Hepsiburada:0};
    const tpt=+r.Toptan||0, onl=+r.Online||0, ckm=+r.CKM||0, kua=+(r['Kuaf√∂r']||r.Kuafor)||0, trn=+r.Trendyol||0, hb=+r.Hepsiburada||0;
    acc.Total += (tpt+onl+ckm+kua+trn+hb);
    acc.Toptan += tpt; acc.Online += onl; acc.CKM += ckm; acc.Kuafor += kua; acc.Trendyol += trn; acc.Hepsiburada += hb;
    byDate.set(iso, acc);
  });

  wrap.innerHTML = '';
  days.forEach(d=>{
    const iso = d.toISOString().slice(0,10);
    const acc = byDate.get(iso) || {Total:0,Toptan:0,Online:0,CKM:0,Kuafor:0,Trendyol:0,Hepsiburada:0};
    const card = document.createElement('div');
    card.className = 'glass card-3d rounded-2xl p-3';
    const lbl = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
    card.innerHTML = `
      <div class="hint text-xs">${lbl}</div>
      <div class="text-slate-800 dark:text-slate-100 font-semibold">${numberTL(acc.Total)}</div>
      <div class="hint text-[11px]">T:${numberTL(acc.Toptan)} ‚Ä¢ O:${numberTL(acc.Online)} ‚Ä¢ C:${numberTL(acc.CKM)} ‚Ä¢ K:${numberTL(acc.Kuafor)} ‚Ä¢ Tr:${numberTL(acc.Trendyol)} ‚Ä¢ H:${numberTL(acc.Hepsiburada)}</div>
    `;
    wrap.appendChild(card);
  });

  if (note) {
    const first = days[0], last = days[days.length-1];
    const fmt = x => `${String(x.getDate()).padStart(2,'0')}.${String(x.getMonth()+1).padStart(2,'0')}`;
    note.textContent = `G√ºn g√ºn: ${fmt(first)} ‚Äì ${fmt(last)} (bug√ºn dahil)`;
  }
}

/* ================== BOOT & SAVE ================== */
// No longer binding Data Source DOM elements

async function boot(){
  // 0) URL query param override (sheet, inv, orders) ‚Üí directly persist
  const qpSheet  = getParam('sheet');
  const qpInv    = getParam('inv');
  const qpOrders = getParam('orders');
  if (qpSheet)  localStorage.setItem('popdog_sheet_csv_url',  qpSheet);
  if (qpInv)    localStorage.setItem('popdog_inv_csv_url',    qpInv);
  if (qpOrders) localStorage.setItem('popdog_orders_csv_url', qpOrders);

  // Optional: persist clean flag from URL (?clean=1/0)
  (function(){
    const p = getParam('clean');
    if (p === '1' || p === '0') {
      try { localStorage.setItem('popdog_clean_on_load', p); } catch(e){}
    }
  })();

  // 1) config.json (same folder) fallback if nothing set yet
  const hasAnyStored = !!(localStorage.getItem('popdog_sheet_csv_url')   ||
                          localStorage.getItem('popdog_inv_csv_url')     ||
                          localStorage.getItem('popdog_orders_csv_url')  ||
                          localStorage.getItem('popdog_expenses_csv_url'));
  if (!hasAnyStored) {
    try {
      const r = await fetch('config.json', { cache: 'no-store' });
      if (r.ok) {
        const cfg = await r.json();
        if (cfg.sheetCsv)     localStorage.setItem('popdog_sheet_csv_url',     cfg.sheetCsv);
        if (cfg.inventoryCsv) localStorage.setItem('popdog_inv_csv_url',       cfg.inventoryCsv);
        if (cfg.ordersCsv)    localStorage.setItem('popdog_orders_csv_url',    cfg.ordersCsv);
        if (cfg.expensesCsv)  localStorage.setItem('popdog_expenses_csv_url',  cfg.expensesCsv);
      }
    } catch (e) { /* silent */ }
  }

  // 2) Resolve URLs: localStorage ‚Üí defaults
  const sheetUrl    = localStorage.getItem('popdog_sheet_csv_url')     || (typeof DEFAULT_SHEET_CSV     !== 'undefined' ? DEFAULT_SHEET_CSV     : '');
  const invUrl      = localStorage.getItem('popdog_inv_csv_url')       || (typeof DEFAULT_INV_CSV       !== 'undefined' ? DEFAULT_INV_CSV       : '');
  const ordersUrl   = localStorage.getItem('popdog_orders_csv_url')    || (typeof DEFAULT_ORDERS_CSV    !== 'undefined' ? DEFAULT_ORDERS_CSV    : '');
  const expensesUrl = localStorage.getItem('popdog_expenses_csv_url')  || (typeof DEFAULT_EXPENSES_CSV  !== 'undefined' ? DEFAULT_EXPENSES_CSV  : '');


// Expenses load (CSV)
try {
  expensesRowsCache = await loadExpensesCsv(expensesUrl);
  expensesMonthlyCache = []; // eskiden buildExpensesMonthly(...) idi
} catch(e) {
  expensesRowsCache = [];
  expensesMonthlyCache = [];
}
  // 3) FX
  try { await fetchFX(); } catch(e){}



  // 5) Load revenue (sheet)
  if (sheetUrl) {
    try {
      const data = await loadFromSheet(sheetUrl);
      if (!data.length) throw new Error('Sheet bo≈ü d√∂nd√º');
      loadedRows = data;
      localStorage.setItem('popdog_loaded_rows', JSON.stringify(loadedRows));
      const first = loadedRows[0]?.Date || '‚Äî';
      const last  = loadedRows.at(-1)?.Date || '‚Äî';
    } catch (e) {
      console.warn('Sheet y√ºklenemedi. URL ve yayƒ±nlama ayarlarƒ±nƒ± kontrol et.', e);
    }
  } else {
    console.warn('CSV URL yok: Sheet verisi y√ºklenemedi.');
  }

  // 6) inventory_value
  try {
    if (invUrl) {
      const invRows = await loadCSV(invUrl);
      localStorage.setItem('popdog_inv_cache', JSON.stringify(invRows));
    }
  } catch (e) { console.warn('INV CSV error', e); }

  // 7) orders_raw (Shopify)
  try {
    if (ordersUrl) {
      const rawRows = await loadCSV(ordersUrl);
      const mapped = rawRows.map(mapOrderRow)
                            .filter(o => o.sku && o.qty > 0 && o.date && !isNaN(+o.date));
      localStorage.setItem('popdog_orders_cache', JSON.stringify(mapped));
    }
  } catch (e) { console.warn('ORDERS CSV error', e); }

  initSalesWindowSelector();
  initStockSearch();
  initStockExport();
  refreshAll();
  (function(){
    const t = document.getElementById('yoyToggle');
    if (!t) return;
    const syncLabel = () => {
      const s = document.getElementById('yoyState');
      if (s) s.textContent = yoyEnabled ? 'A√ßƒ±k' : 'Kapalƒ±';
    };
    t.onclick = () => {
      yoyEnabled = !yoyEnabled;
      syncLabel();
      drawCharts(monthlyCache || []);
    };
    syncLabel();
  })();
}

/* ================== WRITE TO SHEET ================== */
async function writeStagedToSheet(){
  const infoEl = document.getElementById('parseInfo');
  const rows = Array.isArray(window.stagedRows)
    ? window.stagedRows.slice()
    : (Array.isArray(stagedRows) ? stagedRows.slice() : []);

  if (!rows.length) {
    if (infoEl) infoEl.textContent = '√ñnce satƒ±r ekleyin (Satƒ±ra √ßevir ve ekle).';
    return;
  }

  if (infoEl) infoEl.textContent = 'Sheet‚Äôe yazƒ±lƒ±yor...';

  // Normalize payload to guarantee Kuaf√∂r is sent
  const payloadRows = rows.map(r => {
    const kuafor = parseTL((r && (r['Kuaf√∂r'] ?? r['Kuafor'] ?? r['Grooming'] ?? r['grooming'])) ?? 0) || 0;
    return {
      Date: String((r && r.Date) || ''),
      Toptan: Number((r && r.Toptan) || 0) || 0,
      Online: Number((r && r.Online) || 0) || 0,
      CKM: Number((r && r.CKM) || 0) || 0,
      'Kuaf√∂r': kuafor,
      'CKM Nakit': Number((r && r['CKM Nakit']) || 0) || 0,
      'Kasa Nakit (EoD)': Number((r && r['Kasa Nakit (EoD)']) || 0) || 0,
      Trendyol: Number((r && r.Trendyol) || 0) || 0,
      Hepsiburada: Number((r && r.Hepsiburada) || 0) || 0,
      Total: Number((r && r.Total) || 0) || 0,
    };
  });

  const WEBAPP_URL = (typeof getSheetWebAppURL === 'function')
    ? getSheetWebAppURL()
    : (typeof SHEET_WEBAPP_URL !== 'undefined' ? SHEET_WEBAPP_URL : '');

  if (!/^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(String(WEBAPP_URL||''))) {
    if (infoEl) infoEl.textContent = '‚ö†Ô∏è Apps Script Web App URL tanƒ±mlƒ± deƒüil.';
    try{ await setupSheetWebAppURL(infoEl); }catch(_){ }
    return;
  }

  try {
    // IMPORTANT (Apps Script Web App + CORS):
    // Use "simple" requests (text/plain or x-www-form-urlencoded) to avoid an OPTIONS preflight,
    // which Apps Script Web Apps often reject (showing "Load failed" in Safari/Chrome).
    async function postOnce(opts){
      const res = await fetch(WEBAPP_URL, {
        method: 'POST',
        mode: 'cors',
        redirect: 'follow',
        cache: 'no-store',
        ...opts
      });
      const raw = await res.text().catch(()=> '');
      let json = null;
      try{ json = JSON.parse(raw); }catch(_){ json = null; }
      return { res, raw, json };
    }


    let out;
    try{
      out = await postOnce({
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'appenddaily', rows: payloadRows })
      });
    }catch(_e1){
      out = null;
    }

    // Retry with classic form-urlencoded if the first attempt failed (network/preflight quirks)
    if (!out || !out.res || !out.res.ok){
      const form = new URLSearchParams();
      form.set('action', 'appenddaily');
      form.set('rows', JSON.stringify(payloadRows));
      out = await postOnce({
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8' },
        body: form.toString()
      });
    }

    const res = out.res;
    const raw = out.raw;
    let j = out.json;


    if (!res.ok || (j && j.ok === false)) {
      const msg = (j && (j.error || j.message)) ? (j.error || j.message) : raw;
      throw new Error(msg || ('HTTP ' + res.status));
    }

    const added = (j && typeof j.added === 'number') ? j.added : payloadRows.length;

    if (infoEl) infoEl.textContent = `Sheet'e yazƒ±ldƒ± (${added} satƒ±r).`;

    // Clear staged rows
    if (Array.isArray(window.stagedRows)) window.stagedRows.length = 0;
    try{ if (typeof renderStagedRows === 'function') renderStagedRows([]); }catch(_){ }
    try{ if (typeof renderStaged === 'function') renderStaged(); }catch(_){ }

  } catch (err) {
    if (infoEl) infoEl.textContent = `Hata: ${String(err && err.message ? err.message : err)}`;
  }
}

// Bind daily sheet write buttons (single writer)
(function(){
  const a = document.getElementById('pushRowsBtn');
  const b = document.getElementById('writeSheetBtn');
  if (a) a.onclick = writeStagedToSheet;
  if (b) b.onclick = writeStagedToSheet;
})();












/* ================== BOOT! ================== */
boot();
// === FUND AUTO QUOTES (FI5 / SAS / ISY) ‚Äî frontend fetch to Apps Script ===
(function(){
  const HOUR = 60*60*1000;
  const STALE_MS = 22*HOUR;

  const FUND = {
    fi5: { inputId:'fi5UnitInput', unitKey:'popdog_fi5_unit_try', tsKey:'popdog_fi5_updated_at', stateKey:'fi5UnitTRY' },
    sas: { inputId:'sasUnitInput', unitKey:'popdog_sas_unit_try', tsKey:'popdog_sas_updated_at', stateKey:'sasUnitTRY' },
    isy: { inputId:'isyUnitInput', unitKey:'popdog_isy_unit_try', tsKey:'popdog_isy_updated_at', stateKey:'isyUnitTRY' },
  };

  function now(){ return Date.now(); }
  function isStale(ts){ if(!ts) return true; const age = now() - Number(ts||0); return !(age>0) || age > STALE_MS; }

  async function fetchFundQuote(type){
    const url = getSheetWebAppURL();
    if (!/^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(url)) throw new Error('Apps Script URL ge√ßersiz.');
    const req = `${url}?action=fundQuote&type=${encodeURIComponent(type)}`;
    const r = await fetch(req, { method:'GET', cache:'no-store' });
    let j = null; try{ j = await r.json(); }catch(_){}
    if (!r.ok || !j || j.ok === false) throw new Error(`HTTP ${r.status}`);
    const val = Number(j.unitTRY ?? j.price ?? j.value ?? 0);
    if (!val || isNaN(val)) throw new Error('Ge√ßersiz deƒüer');
    return { unit: val, source: j.source || 'server' };
  }

  function applyFundUnit(type, unit, source){
    const cfg = FUND[type]; if(!cfg) return;
    try{
      localStorage.setItem(cfg.unitKey, String(unit));
      localStorage.setItem(cfg.tsKey, String(now()));
    }catch(_){}
    try{
      const st = getLoansState();
      if (st && st.demoBank){ st.demoBank[cfg.stateKey] = unit; setLoansState(st); }
    }catch(_){}
    try{
      const inp = document.getElementById(cfg.inputId);
      if (inp && !inp.value) inp.value = String(unit);
      if (typeof renderLoansBlock === 'function') renderLoansBlock();
    }catch(_){}
  }

  async function maybeRefreshFund(type){
    const cfg = FUND[type]; if(!cfg) return;

    // If user has entered a value into the input, don't override
    const manual = (function(){
      try{
        const el = document.getElementById(cfg.inputId);
        return parseTL(el && el.value ? el.value : 0);
      }catch(_){ return 0; }
    })();
    if (manual > 0) return;

    const cached = Number(localStorage.getItem(cfg.unitKey) || 0);
    const ts     = Number(localStorage.getItem(cfg.tsKey)   || 0);
    if (cached > 0 && !isStale(ts)) return; // fresh enough

    try{
      const { unit, source } = await fetchFundQuote(type);
      if (unit && unit > 0) applyFundUnit(type, unit, source);
    }catch(e){
      console.warn('fundQuote fetch failed:', type, e && e.message ? e.message : e);
    }
  }

  // Run after DOM is ready so inputs exist
  document.addEventListener('DOMContentLoaded', ()=>{
    ['fi5','sas','isy'].forEach(maybeRefreshFund);
    // periodic gentle refresh
    setInterval(()=> ['fi5','sas','isy'].forEach(maybeRefreshFund), 6*HOUR);
  });
})();
// ===== Auto fund unit price fetchers (FI5 / SAS / ISY) =====
async function fetchFundQuote_(kind){
  const base = getSheetWebAppURL();
  const url = `${base}?action=${encodeURIComponent(kind + 'Quote')}`; // expects doPost/doGet handler fi5Quote/sasQuote/isyQuote
  try{
    const r = await fetch(url, { method:'GET', cache:'no-store' });
    if(!r.ok) return null;
    const j = await r.json().catch(()=>null);
    if (!j || j.ok === false) return null;
    const v = Number(j.unitTRY || j.unit || j.price || 0);
    return (v && v>0) ? { unitTRY: v, source: j.source || kind } : null;
  }catch(_){ return null; }
}

async function autoUpdateFI5(){
  try{
    const st = getLoansState();
    const cur = st.demoBank?.fi5UnitTRY || Number(localStorage.getItem('popdog_fi5_unit_try')||0) || 0;
    const input = document.getElementById('fi5UnitInput');
    const need = !(cur>0) && input && !String(input.value||'').trim();
    if(!need) return; // don't overwrite user-entered value
    const q = await fetchFundQuote_('fi5');
    if(q && q.unitTRY>0){
      if(input) input.value = String(q.unitTRY);
      st.demoBank.fi5UnitTRY = q.unitTRY;
      setLoansState(st);
      try{
        localStorage.setItem('popdog_fi5_unit_try', String(q.unitTRY));
        localStorage.setItem('popdog_fi5_updated_at', String(Date.now()));
      }catch(_){ }
      try{ renderLoansBlock(); }catch(_){}
    }
  }catch(_){ }
}

async function autoUpdateSAS(){
  try{
    const st = getLoansState();
    const cur = st.demoBank?.sasUnitTRY || Number(localStorage.getItem('popdog_sas_unit_try')||0) || 0;
    const input = document.getElementById('sasUnitInput');
    const need = !(cur>0) && input && !String(input.value||'').trim();
    if(!need) return;
    const q = await fetchFundQuote_('sas');
    if(q && q.unitTRY>0){
      if(input) input.value = String(q.unitTRY);
      st.demoBank.sasUnitTRY = q.unitTRY;
      setLoansState(st);
      try{
        localStorage.setItem('popdog_sas_unit_try', String(q.unitTRY));
        localStorage.setItem('popdog_sas_updated_at', String(Date.now()));
      }catch(_){ }
      try{ renderLoansBlock(); }catch(_){}
    }
  }catch(_){ }
}

async function autoUpdateISY(){
  try{
    const st = getLoansState();
    const cur = st.demoBank?.isyUnitTRY || Number(localStorage.getItem('popdog_isy_unit_try')||0) || 0;
    const input = document.getElementById('isyUnitInput');
    const need = !(cur>0) && input && !String(input.value||'').trim();
    if(!need) return;
    const q = await fetchFundQuote_('isy');
    if(q && q.unitTRY>0){
      if(input) input.value = String(q.unitTRY);
      st.demoBank.isyUnitTRY = q.unitTRY;
      setLoansState(st);
      try{
        localStorage.setItem('popdog_isy_unit_try', String(q.unitTRY));
        localStorage.setItem('popdog_isy_updated_at', String(Date.now()));
      }catch(_){ }
      try{ renderLoansBlock(); }catch(_){}
    }
  }catch(_){ }
}

async function autoUpdateFunds(){
  await Promise.all([ autoUpdateFI5(), autoUpdateSAS(), autoUpdateISY() ]);
}

// Run once on load; do not overwrite user input if present
try{ document.addEventListener('DOMContentLoaded', ()=>{ autoUpdateFunds(); }, { once:true }); }catch(_){ }

// Optional: refresh quotes every 6h if fields are still empty
try{ setInterval(()=>{ autoUpdateFunds(); }, 6*60*60*1000); }catch(_){ }
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Eski Service Worker‚Äôlarƒ± iptal et
  if ('serviceWorker' in navigator) {
    try {
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister()));
    } catch (e) { /* yoksay */ }
  }

  // Cache Storage‚Äôƒ± temizle
  if ('caches' in window) {
    try {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    } catch (e) { /* yoksay */ }
  }

  // ƒ∞stersen localStorage da sƒ±fƒ±rlanabilir (tamamen cachesiz istiyorsan):
  // localStorage.clear();

  // UI render‚Äôdan sonra canlƒ± veriyi √ßek
  setTimeout(refreshFundQuotes, 300);

  // √áift tƒ±klamada tazele (kullanƒ±≈ülƒ±)
  ['fi5UnitInput','sasUnitInput','isyUnitInput'].forEach(id=>{
    const el = document.getElementById(id);
    if (el){
      el.title = '√áift tƒ±kla: sunucudan en son birim fiyatƒ± √ßek';
      el.addEventListener('dblclick', refreshFundQuotes);
    }
  });
});
// === Krediler & Bekleyen √ñdemeler bloƒüunu ba≈ülangƒ±√ßta bir kez render et ===
document.addEventListener('DOMContentLoaded', function(){
  try{ renderLoansBlock(); }catch(_){}
  // Yeni: expenses_master'tan dinamik sayƒ±m yap
  try{ refreshLoansFromExpenses(); }catch(_){}
}, { once:true });
</script>
</body>
</html>