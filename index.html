<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pop Dog | 2025 CFO Dashboard (Sheet + WhatsApp + Weekly)</title>
  <!-- === Versioned cache reset (iOS/Safari safe) ===
       Bump APP_VERSION to force clearing old caches/localStorage and one-time reload -->
  <script>
  (function(){
    var APP_VERSION = '2025.10.09-01'; // â¬…ï¸ bump this to invalidate client caches
    var VERSION_KEY = 'popdog_app_version';
    var RELOAD_FLAG = 'popdog_version_reloaded';
    // Keep these keys across resets (user prefs / endpoints)
    var PRESERVE_KEYS = [
      'popdog_sheet_webapp_url',
      'popdog_theme'
    ];
    try{
      var prev = localStorage.getItem(VERSION_KEY);
      if (prev !== APP_VERSION){
        // Preserve a few important values before we clean
        var preserve = {};
        try{
          PRESERVE_KEYS.forEach(function(k){ preserve[k] = localStorage.getItem(k); });
        }catch(_){}

        // Wipe app-local keys (namespaced with popdog_) but keep PRESERVE_KEYS
        try{
          var toRemove = [];
          for (var i=0; i<localStorage.length; i++){
            var k = localStorage.key(i);
            if (/^popdog_/i.test(k) && PRESERVE_KEYS.indexOf(k) === -1){
              toRemove.push(k);
            }
          }
          toRemove.forEach(function(k){ localStorage.removeItem(k); });
        }catch(_){}

        // Restore preserved values
        try{
          Object.keys(preserve).forEach(function(k){
            if (preserve[k] !== null && preserve[k] !== undefined){
              localStorage.setItem(k, preserve[k]);
            }
          });
        }catch(_){}

        // Nuke CacheStorage (if available)
        try{
          if ('caches' in window){
            caches.keys().then(function(keys){ keys.forEach(function(k){ caches.delete(k); }); });
          }
        }catch(_){}

        // Unregister any service workers (if any)
        try{
          if ('serviceWorker' in navigator){
            navigator.serviceWorker.getRegistrations().then(function(list){
              list.forEach(function(reg){ reg.unregister(); });
            });
          }
        }catch(_){}

        // Save new version
        try{ localStorage.setItem(VERSION_KEY, APP_VERSION); }catch(_){}

        // One-time hard reload to ensure fresh assets
        try{
          if (!sessionStorage.getItem(RELOAD_FLAG)){
            sessionStorage.setItem(RELOAD_FLAG, '1');
            // Avoid hash preserving to prevent SW/SPA quirks; strip query except debug flags
            location.replace(location.href.split('#')[0]);
          }else{
            sessionStorage.removeItem(RELOAD_FLAG);
          }
        }catch(_){}
      }
    }catch(_){}
  })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .badge-paid{
      background: #16a34a1a;
      color:#16a34a;
      border:1px solid #16a34a33;
      padding:.15rem .45rem; border-radius:999px; font-size:10px;
    }
    .badge-wait{
      background:#64748b1a; color:#64748b; border:1px solid #64748b33;
      padding:.15rem .45rem; border-radius:999px; font-size:10px;
    }
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 600px at 10% -10%, #ecf2ff, transparent), radial-gradient(1200px 600px at 110% 110%, #f8fafc, transparent); }
    .dark body, .dark .pagebg { background: radial-gradient(1200px 600px at 10% -10%, #0b1220, transparent), radial-gradient(1200px 600px at 110% 110%, #0f172a, transparent) !important; }
    .glass { background: rgba(255,255,255,0.65); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.4); }
    .dark .glass { background: rgba(2,6,23,0.5); border-color: rgba(255,255,255,0.08) !important; }
    .hint { color:#64748b }
    .dark .hint { color:#93a4bd }
    .badge { font-size:10px; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; color:#334155; }
    .dark .badge { background:#0b1220; color:#cbd5e1; border:1px solid rgba(255,255,255,.08); }
    .progress-wrap{height:4px;background:rgba(0,0,0,.06);border-radius:999px;overflow:hidden}
    .target-card{padding:.65rem .75rem;border-radius:1rem}
    .target-card .ttl{font-size:.8rem}
    .target-card .val{font-weight:600; font-size:.8rem}
    .target-card .sub{font-size:.7rem; opacity:.75}
    .progress-bar{height:100%;background:linear-gradient(90deg,#6366f1,#22d3ee)}
    .kpi-up{color:#10b981}.kpi-down{color:#ef4444}
    .dot{width:.5rem;height:.5rem;border-radius:999px;display:inline-block;margin-right:.4rem}
    .card-3d{ box-shadow: 0 10px 30px rgba(2,6,23,.15), inset 0 1px 0 rgba(255,255,255,.3); transform: translateZ(0); }
    canvas{image-rendering: auto}
    /* === iOS-like glass chips (frosted) === */
    .chip-ios{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.3rem .6rem; border-radius:999px;
      background: rgba(255,255,255,0.35);
      border:1px solid rgba(255,255,255,0.55);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.45),
        0 8px 20px rgba(15,23,42,0.08);
    }
    .dark .chip-ios{
      background: rgba(2,6,23,0.45);
      border-color: rgba(255,255,255,0.10);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.06),
        0 10px 26px rgba(0,0,0,0.35);
    }
    .chip-ios .dot{
      width:.45rem; height:.45rem; border-radius:999px;
      background: currentColor;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.5) inset;
    }
    .chip-ios .label{ font-size:.75rem; color:#0f172a; }
    .dark .chip-ios .label{ color:#e2e8f0; }
.chip-ios .val{ font-weight:600; font-size:.75rem; color:#334155; }
.dark .chip-ios .val{ color:#cbd5e1; }
th, td { white-space: nowrap; }
/* === Unified chart glass cards: Prevent iPad/Safari resize loops === */
#lineTotal,
#barStack,
#pieShare,
#lineExpenses{
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  box-sizing: border-box;
  padding: 0 !important;
  /* FIX: avoid responsive resize feedback loops on iPad Safari */
  contain: layout size;
  display: block;
  width: 100% !important;
  /* Force a stable height controlled purely by CSS (not content size) */
  height: clamp(180px, 40vw, 260px) !important;
}

/* Desktop override for a bit more headroom */
@media (min-width:1024px){
  #lineTotal,
  #barStack,
  #lineExpenses{
    height: 220px !important;
  }
}

/* Keep table wrappers aligned below the canvases */
#lineTotalTblWrap,
#barStackTblWrap{
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  padding: 8px;
  margin: 8px 0 8px 0;   /* align with full-width canvas (margins moved off canvas) */
  max-height: 260px;
  overflow: auto;
}
@media (min-width: 1024px){
  #lineTotalTblWrap,
  #barStackTblWrap{ max-height: 320px; }
}
@media (min-width: 1536px){
  #lineTotalTblWrap,
  #barStackTblWrap{ max-height: 360px; }
}

  /* Shrink font size of Kanal BazlÄ± AylÄ±k Ciro table */
  #barStackTblWrap table {
    font-size: 60%;
  }
  /* Shrink font size of Ana Kategoriler (YTD) tables */
  #tblMainExpensesDetail,
  #tblMainExpensesGrouped {
    font-size: 60%;
  }
/* === Unified chart sizing for consistency (mobile-first) === */
.chart-can{ width:100%; display:block; height: clamp(180px, 40vw, 260px); }
@media (min-width:1024px){ .chart-can{ height: 220px; } }

/* Fallback for older Safari that doesnâ€™t support clamp() on height */
@supports not (height: clamp(10px, 10vw, 300px)){
  #lineTotal,
  #barStack,
  #pieShare,
  #lineExpenses{ height: 220px !important; }
}
/* === Compact tables (stock + sales/turnover) â€” ultra compact === */
.sales-turnover table th,
.sales-turnover table td,
#stockBlock table th,
#stockBlock table td{
  font-size: 7px;            /* ~6px'e yakÄ±n, her ekranda Ã§ok kompakt */
  padding: .15rem .25rem;    /* dar hÃ¼cre iÃ§i boÅŸluk */
}
@media (min-width: 1280px){
  .sales-turnover table th,
  .sales-turnover table td,
  #stockBlock table th,
  #stockBlock table td{ font-size: 10px; }
}

    /* === En BÃ¼yÃ¼k Kanal â€” sade liste + kÃ¼Ã§Ã¼k yÃ¼zde tablosu === */
#kpiOthers{ margin-top:.25rem; max-height:none; overflow:visible; }
#kpiOthers li{ font-size: 12px; line-height:1.2; }
#kpiShareTbl{ width:100%; margin-top:.35rem; border-collapse:collapse; }
#kpiShareTbl td{ font-size:11px; padding:.15rem .25rem; }
#kpiShareTbl td:first-child{ opacity:.85; }
  /* === Pro glass cards, inputs and buttons === */
  .card-glass-pro{
    position: relative;
    border-radius: 1rem;
    background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.28));
    backdrop-filter: blur(14px) saturate(160%);
    -webkit-backdrop-filter: blur(14px) saturate(160%);
    border: 1px solid rgba(255,255,255,0.65);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.55),
      0 10px 28px rgba(15,23,42,0.12);
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .dark .card-glass-pro{
    background: linear-gradient(180deg, rgba(2,6,23,0.55), rgba(2,6,23,0.35));
    border-color: rgba(255,255,255,0.10);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.06),
      0 12px 28px rgba(0,0,0,0.35);
  }
  .card-glass-pro:hover{
    transform: translateY(-2px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.6),
      0 16px 36px rgba(15,23,42,0.16);
  }

  .input-pro{
    width: 100%;
    border-radius: .75rem;
    padding: .5rem .75rem;
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(255,255,255,0.8);
    backdrop-filter: blur(10px) saturate(160%);
    -webkit-backdrop-filter: blur(10px) saturate(160%);
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .dark .input-pro{
    background: rgba(2,6,23,0.45);
    border-color: rgba(255,255,255,0.10);
  }
  .input-pro:focus{
    outline: none;
    box-shadow: 0 0 0 3px rgba(99,102,241,.35), 0 10px 24px rgba(15,23,42,.12);
    border-color: rgba(99,102,241,.55);
  }

  .btn-primary{
    display: inline-flex; align-items:center; justify-content:center; gap:.5rem;
    border-radius: 1rem;
    padding: .55rem 1rem;
    font-weight: 600;
    background: linear-gradient(90deg, #6366f1, #a855f7);
    color: white;
    box-shadow: 0 10px 22px rgba(99,102,241,.28);
    transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    border: 1px solid rgba(255,255,255,0.35);
  }
  .btn-primary:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(99,102,241,.32); }
  .btn-primary:active{ transform: translateY(0); filter: brightness(.98); }

  .soft-badge{
    font-size: 11px;
    padding: .2rem .5rem;
    border-radius: 999px;
    background: rgba(99,102,241,0.10);
    color: #334155;
    border: 1px solid rgba(99,102,241,0.18);
  }
  .dark .soft-badge{
    background: rgba(99,102,241,0.14);
    color: #cbd5e1;
    border-color: rgba(255,255,255,0.08);
  }
  </style>
</head>
<body class="min-h-screen pagebg">
  <div class="max-w-7xl mx-auto p-6 space-y-6">

    <!-- Header -->
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-800 dark:text-slate-100">
          Pop Dog | 2025 CFO Dashboard
        </h1>
        <p class="hint">Google Sheet + CSV + WhatsApp yapÄ±ÅŸtÄ±r Â· HaftalÄ±k mini kartlar Â· Hedefler (YTD ortalama)</p>
      </div>
      <!-- Top Nav: Pages -->
      <div class="w-full mt-2 flex items-center gap-2 flex-wrap">
        <button id="navSummary" class="glass card-3d px-3 py-1.5 rounded-xl text-sm">Ã–zet</button>
        <button id="navRevenue" class="glass card-3d px-3 py-1.5 rounded-xl text-sm">Ciro</button>
        <button id="navExpenses" class="glass card-3d px-3 py-1.5 rounded-xl text-sm">Giderler</button>
        <button id="navStock" class="glass card-3d px-3 py-1.5 rounded-xl text-sm">Stok</button>
      </div>
      <div class="flex items-center gap-3">
        <button id="themeBtn" class="glass card-3d px-3 py-2 rounded-2xl text-slate-700 dark:text-slate-200">ğŸŒ— Tema</button>
        <input id="fileInput" type="file" accept=".csv" class="hidden">
        <button id="uploadBtn" class="glass card-3d px-4 py-2 rounded-2xl">CSV YÃ¼kle</button>
        <button id="downloadBtn" class="glass card-3d px-4 py-2 rounded-2xl">CSV Ä°ndir</button>
        <button id="writeSheetBtn" class="glass card-3d px-4 py-2 rounded-2xl">Sheetâ€™e Kaydet</button>
      </div>
    </header>



    <!-- KPIs + Alerts -->
    <div class="grid md:grid-cols-2 gap-4 items-start" data-page="summary">
      <div class="grid gap-4">
        <div class="glass card-3d rounded-3xl p-5">
          <div class="hint text-sm">Toplam Ciro (YTD)</div>
          <div id="kpiYTD" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
          <div id="kpiYTD_USD" class="text-sm hint">â‰ˆ â€“ USD</div>
          <div id="kpiYTD_YoY" class="text-xs hint mt-1"></div>
          <div id="fxNote" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass card-3d rounded-3xl p-5">
          <div class="hint text-sm">En BÃ¼yÃ¼k Kanal</div>
          <div id="kpiTop" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
          <ul id="kpiOthers" class="text-sm hint mt-2 space-y-1"></ul>
          <table id="kpiShareTbl"></table>
        </div>
      </div>
      <div class="glass card-3d rounded-3xl p-5 space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4">
            <div class="hint text-sm">Stok DeÄŸeri (Maliyet)</div>
            <div id="kpiInvCost" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvCost_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
            <div class="hint text-xs mt-2">Vergi + Navlun dahil (+%65)</div>
            <div id="kpiInvCost_65" class="text-sm font-medium text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvCost_65_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="hint text-sm">Stok DeÄŸeri (SatÄ±ÅŸ)</div>
            <div id="kpiInvPrice" class="text-xl md:text-2xl font-semibold text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvPrice_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
            <div class="hint text-xs mt-2">KDV HariÃ§ (âˆ’%20)</div>
            <div id="kpiInvPrice_exVAT" class="text-sm font-medium text-slate-800 dark:text-slate-100">â€“</div>
            <div id="kpiInvPrice_exVAT_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">MoM DeÄŸiÅŸim <span id="momNote" class="text-xs"></span></div>
          <div id="kpiMoM" class="text-xl md:text-2xl font-semibold">â€“</div>
        </div>

        <div>
          <div class="hint text-sm mb-1">UyarÄ±lar</div>
          <ul id="alertsList" class="text-sm text-slate-700 dark:text-slate-200 space-y-1">
            <li class="hint">HenÃ¼z veri yok.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- HaftalÄ±k Mini Kartlar -->
    <section class="glass card-3d rounded-3xl p-5" data-page="summary">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium flex items-center gap-3">
          HaftalÄ±k GÃ¶rÃ¼nÃ¼m
          <span id="weekLabel" class="badge"></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="weekPrev" class="glass card-3d px-3 py-1 rounded-xl">â—€ï¸</button>
          <button id="weekNext" class="glass card-3d px-3 py-1 rounded-xl">â–¶ï¸</button>
        </div>
      </div>
      <div id="weekCards" class="grid sm:grid-cols-3 lg:grid-cols-6 gap-3 mt-3"></div>
      <div id="weekWoW" class="hint text-xs mt-2"></div>
      <div class="mt-4">
        <div class="text-slate-700 dark:text-slate-200 text-sm font-medium">Son 7 GÃ¼n Ã–zeti</div>
        <div id="last7Wrap" class="grid sm:grid-cols-3 lg:grid-cols-6 gap-3 mt-2"></div>
        <div id="last7Note" class="hint text-xs mt-1"></div>
      </div>
    </section>
    <!-- === Krediler & Bekleyen Ã–demeler === -->
    <section id="loansBlock" class="glass card-3d rounded-3xl p-5 mt-6" data-page="expenses">
      <div class="flex items-center justify-between mb-3">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium flex items-center gap-2">
          ğŸ’³ Krediler & Bekleyen Ã–demeler
        </div>
        <div class="flex items-center gap-3">
          <span class="hint text-xs">Kaynak: localStorage (popdog_loans_state)</span>
        </div>
      </div>
    
      <!-- Ã¼Ã§ kredi -->
      <div class="grid md:grid-cols-3 gap-4">
        <!-- Taksitli Ticari Kredi -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Taksitli Ticari Kredi</div>
            <span id="loanBizPaidBadge" class="badge">5/24</span>
          </div>
          <div class="mt-1 text-sm hint">Ã–denecek Taksitler ToplamÄ±: <span id="loanBizRemain" class="font-medium">â€“</span></div>
          <div class="mt-1 text-sm">Taksit TutarÄ±: <span id="loanBizInst" class="font-semibold">â€“</span></div>
          <div class="mt-1 text-xs hint">Kredi TutarÄ±: <span id="loanBizPrincipal">â€“</span> â€¢ AylÄ±k Faiz: <span id="loanBizRate">â€“</span></div>
          <div class="progress-wrap mt-2"><div id="loanBizBar" class="progress-bar" style="width:0%"></div></div>
        </div>
    
        <!-- Taksitli AraÃ§ Kredisi -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Taksitli AraÃ§ Kredisi</div>
            <span id="loanCarPaidBadge" class="badge">9/24</span>
          </div>
          <div class="mt-1 text-sm hint">Ã–denecek Taksitler ToplamÄ±: <span id="loanCarRemain" class="font-medium">â€“</span></div>
          <div class="mt-1 text-sm">Taksit TutarÄ±: <span id="loanCarInst" class="font-semibold">â€“</span></div>
          <div class="mt-1 text-xs hint">Kredi TutarÄ±: <span id="loanCarPrincipal">â€“</span> â€¢ AylÄ±k Faiz: <span id="loanCarRate">â€“</span></div>
          <div class="progress-wrap mt-2"><div id="loanCarBar" class="progress-bar" style="width:0%"></div></div>
        </div>

          <!-- Taksitli Ticari Kredi 2 -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Taksitli Ticari Kredi 2</div>
            <span id="loanBiz2PaidBadge" class="badge">0/24</span>
          </div>
          <div class="mt-1 text-sm hint">
            Ã–denecek Taksitler ToplamÄ±:
            <span id="loanBiz2Remain" class="font-medium">1714868,61â‚º</span>
          </div>
          <div class="mt-1 text-sm">
            Taksit TutarÄ±:
            <span id="loanBiz2Inst" class="font-semibold">71452,86â‚º</span>
          </div>
          <div class="mt-1 text-xs hint">
            Kredi TutarÄ±:
            <span id="loanBiz2Principal">1714868,61â‚º</span>
            â€¢ AylÄ±k Faiz: <span id="loanBiz2Rate">â€“</span>
          </div>
          <div class="progress-wrap mt-2">
            <div id="loanBiz2Bar" class="progress-bar" style="width:0%"></div>
          </div>
        </div>
      </div>

            
    
      <!-- Zee.Dog Bekleyen Ã–demeler -->
      <div class="mt-5 rounded-2xl p-4 card-glass-pro">
        <div class="flex items-center justify-between">
          <div class="font-medium">Zee.Dog Bekleyen Ã–demeler</div>
          <div class="hint text-xs">USD â†’ TRY Ã§eviri iÃ§in KPIâ€™dan tÃ¼retilen kur kullanÄ±lÄ±r</div>
        </div>
        <div class="overflow-auto mt-2">
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
  <tr>
    <th class="text-left py-1 pr-3">ID</th>
    <th class="text-right py-1 pr-3">Tutar (USD)</th>
    <th class="text-right py-1 pr-3">â‰ˆ TRY</th>
    <th class="text-right py-1 pr-3">Ã–denen (USD)</th>
    <th class="text-right py-1 pr-3">Kalan (USD)</th>
    <th class="text-left py-1 pr-0">Durum</th>
  </tr>
</thead>
            <tbody id="tblZeeAwait" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    
      <!-- DemoÅŸ Bank -->
      <div class="mt-5 grid md:grid-cols-2 gap-4">
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">DemoÅŸ Bank â€” AltÄ±n BorÃ§</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Gram FiyatÄ± (TRY)</span>
              <input id="goldGramInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="Ã¶rn. 2900">
            </div>
          </div>
          <div class="mt-1 text-sm">Miktar: <strong>169 gr</strong></div>
          <div class="mt-1 text-sm">Toplam (â‰ˆ): <span id="goldTotal" class="font-semibold">â€“</span></div>
          <div class="hint text-xs mt-1" id="goldNote"></div>
        </div>
    
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">QNB PortfÃ¶y Para PiyasasÄ± (FI5)</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Birim FiyatÄ± (TRY)</span>
              <input id="fi5UnitInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="Ã¶rn. 1,0198">
            </div>
          </div>
          <div class="mt-1 text-sm">Adet: <strong>565</strong></div>
          <div class="mt-1 text-sm">Toplam (â‰ˆ): <span id="fi5Total" class="font-semibold">â€“</span></div>
          <div class="hint text-xs mt-1" id="fi5Note"></div>
        </div>

        <!-- Ak PortfÃ¶y SAS -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Ak PortfÃ¶y SabancÄ± TopluluÄŸu Åirketleri (SAS)</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Birim FiyatÄ± (TRY)</span>
              <input id="sasUnitInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="Ã¶rn. 1,0321">
            </div>
          </div>
          <div class="mt-1 text-sm">Adet: <strong>114236</strong></div>
          <div class="mt-1 text-sm">Toplam (â‰ˆ): <span id="sasTotal" class="font-semibold">â€“</span></div>
          <div class="hint text-xs mt-1" id="sasNote"></div>
        </div>

        <!-- Ä°ÅŸ PortfÃ¶y Ä°ÅŸtirakler -->
        <div class="rounded-2xl p-4 card-glass-pro">
          <div class="flex items-center justify-between">
            <div class="font-medium">Ä°ÅŸ PortfÃ¶y Ä°ÅŸ BankasÄ± Ä°ÅŸtirakleri (Ä°ÅY)</div>
            <div class="flex items-center gap-2">
              <span class="hint text-xs">Birim FiyatÄ± (TRY)</span>
              <input id="isyUnitInput" type="text" inputmode="decimal" class="input-pro w-28 text-sm" placeholder="Ã¶rn. 1,5267">
            </div>
          </div>
          <div class="mt-1 text-sm">Adet: <strong>2530000</strong></div>
          <div class="mt-1 text-sm">Toplam (â‰ˆ): <span id="isyTotal" class="font-semibold">â€“</span></div>
          <div class="hint text-xs mt-1" id="isyNote"></div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <div class="grid lg:grid-cols-2 gap-6" data-page="revenue">
      <div class="glass card-3d rounded-3xl p-5">
        <div class="flex items-center justify-between mb-2">
          <div class="text-slate-700 dark:text-slate-200">AylÄ±k Toplam Ciro</div>
          <button id="yoyToggle" class="chip-ios text-xs" title="GeÃ§en yÄ±l serisini aÃ§/kapat">
            <span class="label">YoY</span>
            <span id="yoyState" class="val">AÃ§Ä±k</span>
          </button>
        </div>
        <canvas id="lineTotal" class="chart-can"></canvas>
        <div id="lineTotalTblWrap"></div>
      </div>

      <div class="glass card-3d rounded-3xl p-5">
        <div class="text-slate-700 dark:text-slate-200 mb-2">Kanal BazlÄ± AylÄ±k Ciro</div>
        <canvas id="barStack" class="chart-can"></canvas>
        <div id="barStackTblWrap"></div>
      </div>
    </div>

    <!-- === Expenses (CFO) === -->
    <section class="glass card-3d rounded-3xl p-5 mt-6" data-page="expenses">
      <div class="flex items-center justify-between mb-3">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">Giderler (YTD) & Net KÃ¢r</div>
        <div class="flex items-center gap-3">
          <span class="chip-ios text-xs" title="Giderler YoY geÃ§iÅŸi" id="expYoyToggle">
            <span class="label">YoY</span>
            <span id="expYoyState" class="val">AÃ§Ä±k</span>
          </span>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4 items-stretch">
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Toplam Gider (YTD)</div>
          <div id="kpiExpYTD" class="text-xl md:text-2xl font-semibold">â€“</div>
          <div id="kpiExpYTD_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          <div id="kpiExpYoY" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Net KÃ¢r (YTD)</div>
          <div id="kpiNetYTD" class="text-xl md:text-2xl font-semibold">â€“</div>
          <div id="kpiNetYTD_USD" class="text-xs hint mt-0.5">â‰ˆ â€“ USD</div>
          <div id="kpiNetNote" class="text-xs hint mt-1"></div>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="hint text-sm">Gider MoM</div>
          <div id="kpiExpMoM" class="text-xl md:text-2xl font-semibold">â€“</div>
          <div id="kpiExpMoMNote" class="text-xs hint mt-1"></div>
        </div>
      </div>

      <div class="grid lg:grid-cols-1 gap-6 mt-4">
        <div class="glass card-3d rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="text-slate-700 dark:text-slate-200">AylÄ±k Giderler</div>
          </div>
          <canvas id="lineExpenses" height="160"></canvas>
        </div>
      </div>
      <!-- Gider Ekle â€” HÄ±zlÄ± Form -->
      <div class="glass card-3d card-glass-pro rounded-2xl p-4 mt-4" data-page="expenses">
        <div class="flex items-center justify-between mb-3">
          <div class="text-slate-700 dark:text-slate-200 text-lg font-medium flex items-center gap-2">
            <span aria-hidden="true">ğŸ§¾</span>
            AylÄ±k Gider Ekle
          </div>
          <span class="soft-badge">Veri: expenses_master</span>
        </div>

        <div class="grid sm:grid-cols-4 gap-3 items-end">
          <div>
            <label class="hint text-xs block mb-1">Tarih</label>
            <input id="expDate" type="date"
                   class="input-pro"
                   title="Tarih seÃ§in">
          </div>
          <div class="sm:col-span-2">
            <label class="hint text-xs block mb-1">Alt Kategori</label>
            <select id="expSubSel" class="input-pro">
              <option value="">YÃ¼kleniyorâ€¦</option>
            </select>
          </div>
          <div>
            <label class="hint text-xs block mb-1">Tutar (â‚º)</label>
            <input id="expAmount" type="text" inputmode="decimal" placeholder="Ã¶r. 12.345,67"
                   class="input-pro">
          </div>
        </div>

        <hr class="hidden lg:block my-4 border-t border-dashed border-slate-300/60 dark:border-slate-600/50">

        <div class="grid sm:grid-cols-4 gap-3 items-end mt-3">
          <div class="sm:col-span-3">
            <label class="hint text-xs block mb-1">Not (opsiyonel)</label>
            <input id="expNote" type="text" class="input-pro" placeholder="aÃ§Ä±klamaâ€¦">
          </div>
          <div>
            <button id="expAddBtn" class="btn-primary w-full rounded-2xl">Gideri Ekle</button>
          </div>
        </div>

        <div id="expAddInfo" class="hint text-xs mt-2 pt-2 border-t border-white/50 dark:border-slate-700/40">Alt kategoriler CSVâ€™den Ã§ekiliyorâ€¦</div>
      </div>
      <div class="grid lg:grid-cols-2 gap-4 mt-4">
        <div class="glass card-3d rounded-2xl p-4">
          <div class="text-slate-700 dark:text-slate-200 mb-2">Ana Kategoriler (YTD) â€” Detay</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left py-1 pr-3">Kategori</th>
                  <th class="text-right py-1 pr-3">Tutar</th>
                  <th class="text-right py-1 pr-0">Pay</th>
                </tr>
              </thead>
              <tbody id="tblMainExpensesDetail" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
        <div class="glass card-3d rounded-2xl p-4">
          <div class="text-slate-700 dark:text-slate-200 mb-2">Ana Kategoriler (YTD) â€” GruplanmÄ±ÅŸ</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left py-1 pr-3">Kategori</th>
                  <th class="text-right py-1 pr-3">Tutar</th>
                  <th class="text-right py-1 pr-0">Pay</th>
                </tr>
              </thead>
              <tbody id="tblMainExpensesGrouped" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Bu AyÄ±n Giderleri (Kategori + Alt Kategori) -->
      <div class="glass card-3d rounded-2xl p-4 mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-slate-700 dark:text-slate-200">Bu AyÄ±n Giderleri</div>
          <div class="text-right">
            <div id="expThisMonthTotal" class="text-xs sm:text-sm font-medium text-slate-700 dark:text-slate-200">â€“</div>
            <div id="expThisMonthMoM" class="hint text-[11px]">MoM: â€“</div>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left py-1 pr-3">Tarih</th>
                <th class="text-left py-1 pr-3">Kategori</th>
                <th class="text-left py-1 pr-3">Nihai Alt Kategori</th>
                <th class="text-left py-1 pr-3">Alt Kategori</th>
                <th class="text-right py-1 pr-0">Tutar (â‚º)</th>
              </tr>
            </thead>
            <tbody id="tblExpThisMonth" class="text-slate-800 dark:text-slate-100">
              <tr><td class="hint py-2" colspan="5">YÃ¼kleniyorâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Bu Ay â€” Kategori AltÄ±nda Ã–demeler -->
      <div class="glass card-3d rounded-2xl p-4 mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-slate-700 dark:text-slate-200">Bu Ay â€” Kategori AltÄ±nda Ã–demeler</div>
          <div id="expByCatTotal" class="text-xs sm:text-sm font-medium text-slate-700 dark:text-slate-200">â€“</div>
        </div>
        <div id="expThisMonthByCat" class="text-sm"></div>
      </div>
    </section>

    <!-- SatÄ±ÅŸ / Devir Listeleri -->
    <div class="mt-6 sales-turnover" data-page="stock">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-base font-medium">SatÄ±ÅŸ &amp; Devir Listeleri</div>
        <div class="flex items-center gap-3">
          <label for="salesWindowSelect" class="hint text-xs">Pencere:</label>
          <select id="salesWindowSelect" class="glass rounded-xl px-2 py-1 text-sm">
            <option value="30">30 gÃ¼n</option>
            <option value="90">90 gÃ¼n</option>
            <option value="120">120 gÃ¼n</option>
            <option value="180">180 gÃ¼n</option>
          </select>
          <div id="stockExtraNote" class="hint text-xs"></div>
        </div>
      </div>
      <div class="mt-3 grid md:grid-cols-2 gap-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">En Ã§ok satan 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">SatÄ±lan (adet)</th></tr>
            </thead>
            <tbody id="tblTopSellers" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">En az satan 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">SatÄ±lan (adet)</th></tr>
            </thead>
            <tbody id="tblLeastSellers" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">StoÄŸu en hÄ±zlÄ± giden 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">Adet/gÃ¼n</th><th class="text-right py-1 pr-3">On-hand</th></tr>
            </thead>
            <tbody id="tblFastestMoving" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">Stokta en uzun sÃ¼redir kalan 5 Ã¼rÃ¼n</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr><th class="text-left py-1 pr-3">SKU</th><th class="text-left py-1 pr-3">Title</th><th class="text-right py-1 pr-3">YaÅŸ (gÃ¼n)</th><th class="text-right py-1 pr-3">On-hand</th></tr>
            </thead>
            <tbody id="tblMostStale" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- === Stock Block: KPI + Tablolar === -->
    <section id="stockBlock" class="glass card-3d rounded-3xl p-5" data-page="stock">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">Stok Ã–zeti</div>
        <div class="hint text-xs">Kaynak: inventory_value + orders_raw</div>
      </div>

      <!-- Ek KPI'lar -->
      <div class="grid md:grid-cols-4 gap-4 mt-3">
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">90+ gÃ¼n elde <span class="ml-1 opacity-70 text-[10px]">(son satÄ±ÅŸ â‰¥90g olan stok toplamÄ±)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiAged90Value">â€“</div>
          <div class="hint text-xs" id="kpiAged90Qty">â€“ adet</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Median stok yaÅŸÄ± <span class="ml-1 opacity-70 text-[10px]">(SKU'larÄ±n son satÄ±ÅŸtan bugÃ¼ne medyan gÃ¼n)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiMedianAge">â€“ gÃ¼n</div>
        </div>
        <div class="glass rounded-2xl p-3" title="DIO(30/60/90) Ã¼Ã§lÃ¼: kart Ã¼stÃ¼ 60g, tooltip 30/90">
          <div class="hint text-xs">DIO (60g) <span class="ml-1 opacity-70 text-[10px]">(son 60g ort. satÄ±ÅŸ hÄ±zÄ±na gÃ¶re stokun yeteceÄŸi gÃ¼n)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiDIO60">â€“ gÃ¼n</div>
          <div class="hint text-[11px]" id="kpiDIOx">30g: â€“ â€¢ 90g: â€“</div>
        </div>
        <div class="glass rounded-2xl p-3">
          <div class="hint text-xs">Toplam ÃœrÃ¼n Adedi <span class="ml-1 opacity-70 text-[10px]">(depo bazÄ±nda daÄŸÄ±lÄ±m)</span></div>
          <div class="text-slate-800 dark:text-slate-100 font-semibold" id="kpiTotalUnits">â€“ adet</div>
          <div class="hint text-xs" id="kpiTotalUnitsNote">Thrones: â€“ â€¢ Caddebostan: â€“</div>
        </div>
      </div>

      <!-- Tablolar -->
      <div class="mt-4 grid lg:grid-cols-2 gap-4">
        <div>
          <div class="hint text-sm mb-1">â‚º maliyet bazÄ±nda en yÃ¼ksek 10 SKU</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">Value @Cost</th>
                  <th class="text-right py-2 pr-4">Son SatÄ±ÅŸ</th>
                  <th class="text-right py-2 pr-4">YaÅŸ (gÃ¼n)</th>
                </tr>
              </thead>
              <tbody id="tblTopStock" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="hint text-sm mb-1">90+ gÃ¼n elde (â‚º bazÄ±nda ilk 10)</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="text-slate-600 dark:text-slate-300">
                <tr>
                  <th class="text-left  py-2 pr-4">SKU</th>
                  <th class="text-left  py-2 pr-4">Title</th>
                  <th class="text-right py-2 pr-4">On-hand</th>
                  <th class="text-right py-2 pr-4">Value @Cost</th>
                  <th class="text-right py-2 pr-4">Son SatÄ±ÅŸ</th>
                  <th class="text-right py-2 pr-4">YaÅŸ (gÃ¼n)</th>
                </tr>
              </thead>
              <tbody id="tblAged90" class="text-slate-800 dark:text-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Stokout Risk (â‰¤14 gÃ¼n) -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">Stokout Riski (â‰¤14 gÃ¼n) â€” Pencere: <span id="riskWindowLbl" class="badge"></span></div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left  py-2 pr-4">SKU</th>
                <th class="text-left  py-2 pr-4">Title</th>
                <th class="text-right py-2 pr-4">On-hand</th>
                <th class="text-right py-2 pr-4">GÃ¼nlÃ¼k hÄ±z</th>
                <th class="text-right py-2 pr-4">Kalan gÃ¼n</th>
              </tr>
            </thead>
            <tbody id="tblStockoutRisk" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>

      <!-- Largest Stock (Top 25) -->
      <div class="mt-4">
        <div class="glass rounded-2xl p-3 overflow-auto">
          <div class="hint text-sm mb-1">StoÄŸu En Fazla Olan (Top 25)</div>
          <table class="min-w-full text-sm">
            <thead class="text-slate-600 dark:text-slate-300">
              <tr>
                <th class="text-left  py-2 pr-4">SKU</th>
                <th class="text-left  py-2 pr-4">Title</th>
                <th class="text-right py-2 pr-4">On-hand</th>
              </tr>
            </thead>
            <tbody id="tblLargestStock" class="text-slate-800 dark:text-slate-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GÃ¼nlÃ¼k Rapor YapÄ±ÅŸtÄ±r -->
    <section class="glass card-3d rounded-3xl p-5" data-page="revenue">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-lg font-medium">GÃ¼nlÃ¼k Rapor YapÄ±ÅŸtÄ±r â†’ SatÄ±r Ekle</div>
        <div class="hint text-sm">Format: Tarih, Kredi KartÄ±, QNB/Ä°ÅŸ/Garanti, Nakit, Toplam, Kasa Nakit, Pop Dog Online, Pop Dog Toptan, Trendyol, Hepsiburada</div>
      </div>
      <textarea id="dailyText" class="w-full mt-3 rounded-2xl border p-3 focus:outline-none bg-white/70 dark:bg-slate-800 dark:text-slate-100" rows="6" placeholder="WhatsApp raporunu yapÄ±ÅŸtÄ±r..."></textarea>
      <div class="mt-3 flex items-center gap-3">
        <button id="parseAddBtn" class="glass card-3d px-4 py-2 rounded-2xl">SatÄ±ra Ã§evir ve ekle</button>
        <button id="pushRowsBtn" class="glass card-3d px-4 py-2 rounded-2xl">Sheetâ€™e Yaz</button>
        <span id="parseInfo" class="hint text-sm"></span>
      </div>

      <div class="mt-4 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-600 dark:text-slate-300">
            <tr>
              <th class="text-left py-2 pr-4">Date</th>
              <th class="text-right py-2 pr-4">Toptan</th>
              <th class="text-right py-2 pr-4">Online</th>
              <th class="text-right py-2 pr-4">CKM</th>
              <th class="text-right py-2 pr-4">CKM Nakit</th>
              <th class="text-right py-2 pr-4">Kasa Nakit (EoD)</th>
              <th class="text-right py-2 pr-4">Trendyol</th>
              <th class="text-right py-2 pr-4">Hepsiburada</th>
              <th class="text-right py-2 pr-4">Total</th>
            </tr>
          </thead>
          <tbody id="stagedTbody" class="text-slate-800 dark:text-slate-100"></tbody>
        </table>
      </div>
    </section>

    <!-- Targets -->
    <section class="glass card-3d rounded-3xl p-4" data-page="revenue">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="text-slate-700 dark:text-slate-200 text-base font-medium">AylÄ±k Hedefler (YTD ortalama)</div>
        <div class="hint text-xs">Her ay: aynÄ± yÄ±l o aya kadar ortalama</div>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 mt-3" id="targetsWrap"></div>
    </section>

    <footer class="text-xs hint text-right">
      Pop Dog CFO Dashboard Â· Sheet/CSV/WhatsApp baÄŸlÄ± Â· HaftalÄ±k kartlar Â· Hedef & UyarÄ±
      <br>
      <span style="color:#22c55e;">âœ… Test deplooooy - 18.09.2025</span>
    </footer>
  <script>
    // Simple page router (hide/show data-page sections)
    (function(){
      const KEY = 'popdog_active_page';
      const $all = () => Array.from(document.querySelectorAll('[data-page]'));
      function showPage(key){
        $all().forEach(el => {
          if (el.dataset.page === key) el.classList.remove('hidden');
          else el.classList.add('hidden');
        });
        try{ localStorage.setItem(KEY, key); }catch(e){}
        // set active button look (optional subtle bold)
        ['navSummary','navRevenue','navExpenses','navStock'].forEach(id=>{
          const b = document.getElementById(id);
          if(!b) return;
          const k = id.replace('nav','').toLowerCase();
          if((k==='summary' && key==='summary') || (k==='revenue' && key==='revenue') || (k==='expenses' && key==='expenses') || (k==='stock' && key==='stock')){
            b.classList.add('ring-1','ring-indigo-400');
          } else {
            b.classList.remove('ring-1','ring-indigo-400');
          }
        });
      }
      window.showPage = showPage;
      // Bind buttons
      const btnMap = [
        ['navSummary','summary'],
        ['navRevenue','revenue'],
        ['navExpenses','expenses'],
        ['navStock','stock']
      ];
      btnMap.forEach(([id,key])=>{
        const b = document.getElementById(id);
        if(b) b.onclick = ()=> showPage(key);
      });
      // Initial
      const start = (function(){ try{ return localStorage.getItem(KEY) || 'summary'; }catch(e){ return 'summary'; } })();
      showPage(start);
    })();
  </script>
  </div>

<script>
/* === Chart.js global safe defaults (iPad/Safari) === */
(function(){
  if (!window.Chart) return;
  // Prevent aspect-ratio oscillations; size is driven by CSS height
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = false;
  // Debounce layout-driven resizes
  Chart.defaults.resizeDelay = 180;
  // Tame DPR thrash on Safari zoom/orientation changes
  try { Chart.defaults.devicePixelRatio = () => Math.min(2, window.devicePixelRatio || 1); } catch(_) {}
  // Ensure enclosing cards donâ€™t balloon due to canvas reflow
  document.addEventListener('DOMContentLoaded', ()=>{
    ['lineTotal','barStack','pieShare','lineExpenses'].forEach(id=>{
      const c = document.getElementById(id);
      if (c && c.parentElement) c.parentElement.style.overflow = 'hidden';
    });
  }, { once:true });
})();
/* ================== CONFIG ================== */
/* Apps Script Web App URLâ€™in (write-to-sheet iÃ§in) */
const SHEET_WEBAPP_URL = (()=>{
  try{
    const u = localStorage.getItem('popdog_sheet_webapp_url');
    if (u && /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(u)) return u;
  }catch(_){}
  // Safe fallback (no editor markup)
  try { localStorage.setItem('popdog_sheet_webapp_url', 'https://script.google.com/macros/s/AKfycbxJKp_qC_tzFyiEGnfs9MEi2u2ovkC-QL_BgUUCgoA0oXCbEK6Fz9U1Ut1nkmzdesZ_/exec'); } catch(_){}
  return 'https://script.google.com/macros/s/AKfycbxJKp_qC_tzFyiEGnfs9MEi2u2ovkC-QL_BgUUCgoA0oXCbEK6Fz9U1Ut1nkmzdesZ_/exec';
})();

// Always read the latest URL from localStorage at call time
function getSheetWebAppURL(){
  try{
    const u = localStorage.getItem('popdog_sheet_webapp_url');
    if (u && /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(u)) return u;
  }catch(_){ }
  return SHEET_WEBAPP_URL; // boot-time fallback
}

async function fetchFundQuote(code){
  const base = getSheetWebAppURL();
  if (!/^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(base)){
    throw new Error('INVALID_WEBAPP_URL');
  }

  const upper = String(code||'').toUpperCase();
  const shortcut = { FI5:'fi5Quote', SAS:'sasQuote', TI3:'isyQuote' }[upper] || '';

  // Small helper: fetch and try to parse JSON safely (donâ€™t throw on 200/HTML bodies)
  async function request(url, opts){
    const ctrl = new AbortController();
    const id = setTimeout(()=> ctrl.abort(), 12000); // a bit more lenient
    try{
      const res = await fetch(url, { cache:'no-store', ...opts, signal: ctrl.signal });
      const text = await res.text().catch(()=> '');
      let json = null;
      // Try JSON only if it looks like JSON
      try{ json = JSON.parse(text); }catch(_){ json = null; }
      return { status: res.status, ok: res.ok, json, raw: text };
    }catch(err){
      return { status: 0, ok:false, json:null, raw: (err && err.name==='AbortError') ? 'TIMEOUT' : 'LOAD_FAILED' };
    }finally{ clearTimeout(id); }
  }

  // Normalize a potential quote-shaped object
  function normalizeQuote(j){
    if (!j || typeof j !== 'object') return null;
    const unit = (j.unitTRY!=null) ? Number(j.unitTRY) : NaN;
    if (j.ok && unit>0) return { ok:true, code: (j.code||upper), unitTRY: unit, source: j.source||'' };
    return null;
  }

  // Try a sequence of GET endpoints first (some deploys only allow GET)
  const getURLs = [
    `${base}?action=fundQuote&code=${encodeURIComponent(upper)}&t=${Date.now()}`,
    `${base}?code=${encodeURIComponent(upper)}&action=fundQuote&t=${Date.now()}`,
  ];
  if (shortcut){
    getURLs.push(`${base}?action=${encodeURIComponent(shortcut)}&t=${Date.now()}`);
  }

  for (const u of getURLs){
    const r = await request(u, { method:'GET' });
    const q = normalizeQuote(r.json);
    if (q) return q;             // success
    // If server answered 200 but not a quote (e.g., ping JSON), just continue without throwing
    if (r.raw === 'TIMEOUT' || r.raw === 'LOAD_FAILED'){
      // soft fail; continue trying other strategies â€” donâ€™t surface as an error yet
      continue;
    }
  }

  // Try POST (JSON)
  {
    const r = await request(base, {
      method:'POST',
      headers: { 'Content-Type':'application/json;charset=utf-8' },
      body: JSON.stringify({ action:'fundQuote', code: upper })
    });
    const q = normalizeQuote(r.json);
    if (q) return q;
  }

  // Try POST (form-urlencoded)
  {
    const form = new URLSearchParams();
    form.set('action','fundQuote');
    form.set('code', upper);
    const r = await request(base, {
      method:'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=utf-8' },
      body: form.toString()
    });
    const q = normalizeQuote(r.json);
    if (q) return q;
  }

  // Nothing worked â†’ signal upper layer to use cache without logging scary errors
  throw new Error('NO_QUOTE');
}

function cacheless(url){
  const u = new URL(url, location.href);
  // Add a cache-busting param to avoid any intermediary caches
  u.searchParams.set('_', Date.now());
  // IMPORTANT: Do NOT set any custom headers here â€” Apps Script Web Apps
  // will preflight on non-simple headers and return 405 to the CORS OPTIONS request.
  // Keep this a simple GET so the request does not trigger a preflight.
  return fetch(u.toString(), {
    method: 'GET',
    cache: 'no-store',
    redirect: 'follow'
  });
}

// === TEFAS fon fiyatlarÄ±nÄ± Apps Script'ten Ã§ek (FI5, SAS, TI3) ===
async function refreshFundQuotes(){
  try{
    const funds = [
      { code:'FI5', input:'fi5UnitInput', lsUnit:'popdog_fi5_unit_try', lsAt:'popdog_fi5_updated_at' },
      { code:'SAS', input:'sasUnitInput', lsUnit:'popdog_sas_unit_try', lsAt:'popdog_sas_updated_at' },
      { code:'TI3', input:'isyUnitInput', lsUnit:'popdog_isy_unit_try', lsAt:'popdog_isy_updated_at' }, // Ä°ÅY = TI3
    ];
    const base = getSheetWebAppURL();
    for (const f of funds){
      try{
        // Build GET URL (prefer action=fundQuote&code=...)
        const r = await cacheless(`${base}?action=fundQuote&code=${encodeURIComponent(f.code)}`);
        let j = null;
        try {
          const txt = await r.text();
          j = JSON.parse(txt);
        } catch(_){}
        // Normalize: expect shape { ok:true, unitTRY: number }
        const unitRaw = (j && typeof j.unitTRY !== 'undefined') ? j.unitTRY : null;
        const unit = Number(unitRaw);
        if (!j || !j.ok || !(unit > 0)) {
          throw new Error('Invalid payload');
        }
        // SANE PRICE GUARD
        const codeUp = String(f.code || '').toUpperCase();
        const cap = (codeUp === 'FI5') ? 2000 : 10000;
        if (!(unit > 0 && unit < cap)) {
          throw new Error('Insane price rejected');
        }

        // BaÅŸarÄ±lÄ± â†’ kaydet + UI
        localStorage.setItem(f.lsUnit, String(unit));
        localStorage.setItem(f.lsAt, String(Date.now()));
        const inp = document.getElementById(f.input);
        if (inp) inp.value = String(unit);

        // Kaynak yaz
        const noteEl = document.getElementById((f.input||'').replace('UnitInput','Note'));
        if (noteEl) noteEl.textContent = (j.source ? `Kaynak: ${j.source}` : '');
      }catch(e){
        // BaÄŸlantÄ±/timeout/yanÄ±t bozuksa â†’ Ã¶nbellek fallback
        const cached = Number(localStorage.getItem(f.lsUnit)||'0');
        const inp = document.getElementById(f.input);
        if (cached>0 && inp){
          inp.value = String(cached);
          const noteEl = document.getElementById((f.input||'').replace('UnitInput','Note'));
          const at = Number(localStorage.getItem(f.lsAt)||'0');
          const ageMin = at? Math.round((Date.now()-at)/60000) : null;
          if (noteEl) noteEl.textContent = `Ã–nbellekten kullanÄ±ldÄ±${ageMin!=null ? ` â€¢ ${ageMin} dk Ã¶nce` : ''}`;
        }
        console.warn('fundQuote fetch failed:', String(f.code).toLowerCase(), e && e.message ? e.message : e);
      }
    }
    // Kartlardaki toplamlarÄ±/hesap notlarÄ±nÄ± tazele
    try{ renderLoansBlock(); }catch(_){}
  }catch(e){
    console.warn('refreshFundQuotes() top-level error', e);
  }
}

// === AltÄ±n gram fiyatÄ±nÄ± Apps Script Ã¼zerinden Ã§ek (CORS'suz) ===
async function refreshGoldFromScript(){
  try{
    const base = getSheetWebAppURL();
    if (!/^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(base)){
      throw new Error('INVALID_WEBAPP_URL');
    }

    const url = `${base}?action=goldQuote&t=${Date.now()}`;
    const res = await fetch(url, { method:'GET', cache:'no-store' });
    const txt = await res.text().catch(()=> '');
    let j = null;
    try{ j = JSON.parse(txt); }catch(_){ j = null; }

    if (!j || !j.ok || typeof j.gramTRY === 'undefined'){
      throw new Error('Invalid payload');
    }

    const gram = Number(j.gramTRY);
    if (!(gram > 0)){
      throw new Error('Invalid price');
    }

    // Cache to localStorage
    try{
      localStorage.setItem('popdog_gold_gram_try', String(gram));
      localStorage.setItem('popdog_gold_updated_at', String(Date.now()));
    }catch(_){}

    const input = document.getElementById('goldGramInput');
    const note  = document.getElementById('goldNote');

    if (input){
      // TÃ¼rkÃ§e formatla veya dÃ¼z sayÄ± bÄ±rak; mevcut logic input'u parse ediyor
      input.value = String(gram);
      // Mevcut hesaplama mantÄ±ÄŸÄ±nÄ± tetiklemek iÃ§in input event'i gÃ¶nder
      try{
        const evt = new Event('input', { bubbles:true });
        input.dispatchEvent(evt);
      }catch(_){}
    }

    if (note){
      note.textContent = j.source
        ? `Kaynak: ${j.source}`
        : 'AltÄ±n gram fiyatÄ± Apps Script Ã¼zerinden gÃ¼ncellendi.';
    }
  }catch(e){
    // Hata durumunda, varsa Ã¶nbelleÄŸi kullan
    const input = document.getElementById('goldGramInput');
    const note  = document.getElementById('goldNote');
    try{
      const cached = Number(localStorage.getItem('popdog_gold_gram_try') || '0');
      const at     = Number(localStorage.getItem('popdog_gold_updated_at') || '0');
      if (cached > 0 && input){
        input.value = String(cached);
        try{
          const evt = new Event('input', { bubbles:true });
          input.dispatchEvent(evt);
        }catch(_){}
        if (note){
          const ageMin = at ? Math.round((Date.now() - at)/60000) : null;
          note.textContent = ageMin != null
            ? `Gram fiyatÄ± Ã¶nbellekten kullanÄ±ldÄ± â€¢ ${ageMin} dk Ã¶nce`
            : 'Gram fiyatÄ± Ã¶nbellekten kullanÄ±ldÄ±.';
        }
        return;
      }
    }catch(_){}
    if (note){
      note.textContent = 'AltÄ±n fiyatÄ± otomatik alÄ±namadÄ±, lÃ¼tfen gram fiyatÄ±nÄ± elle girin.';
    }
    console.warn('refreshGoldFromScript() error:', e && e.message ? e.message : e);
  }
}

// Simple interactive setter for the Web App URL
async function setupSheetWebAppURL(infoEl){
  try{
    const cur = getSheetWebAppURL() || '';
    const hint = '(Ã–rn: https://script.google.com/macros/s/AKfyc.../exec)';
    const pasted = prompt('Apps Script Web App URLâ€™nizi yapÄ±ÅŸtÄ±rÄ±n\n' + hint, cur);
    if(!pasted){ if(infoEl) infoEl.textContent = 'Ä°ptal edildi.'; return; }
    const ok = /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(pasted.trim());
    if(!ok){ if(infoEl) infoEl.textContent = 'âš ï¸ GeÃ§erli bir /exec URL girin.'; return; }
    localStorage.setItem('popdog_sheet_webapp_url', pasted.trim());
    if(infoEl) infoEl.textContent = 'âœ“ URL kaydedildi. Sayfa tazelenecekâ€¦';
    setTimeout(()=> location.reload(), 400);
  }catch(e){
    if(infoEl) infoEl.textContent = 'âš ï¸ URL kaydedilemedi: ' + (e?.message || e);
  }
}
/* === Apps Script WebApp Compatibility (action/rows keys) === */
const WEBAPP_COMPAT_KEY = 'popdog_webapp_compat';

function getWebAppCompat(){
  try{
    const j = JSON.parse(localStorage.getItem(WEBAPP_COMPAT_KEY) || '{}');
    return (j && typeof j === 'object') ? j : {};
  }catch(_){ return {}; }
}

/* Quick interactive compat setup:
   - rowsKey (default: 'rows')
   - actionKey (default: 'action')
   - dailyAction (default: 'appendDaily')
   - expenseAction (default: 'appendExpense')
*/
async function setupWebAppCompat(infoEl){
  try{
    const cur = getWebAppCompat();
    const rowsKey = prompt('Web App: satÄ±r listesinin parametre adÄ± nedir?\n(Ã¶rn. rows, data, values, payload)', cur.rowsKey || 'rows') || '';
    const actionKey = prompt('Web App: aksiyon parametresi adÄ±?\n(Ã¶rn. action, mode, type â€” boÅŸ bÄ±rakabilirsiniz)', cur.actionKey || 'action') || '';
    const dailyAction = prompt('GÃ¼nlÃ¼k rapor yazma aksiyon deÄŸeri?', cur.dailyAction || 'appendDaily') || '';
    const expenseAction = prompt('Gider ekleme aksiyon deÄŸeri?', cur.expenseAction || 'appendExpense') || '';
    const cfg = { rowsKey: rowsKey.trim(), actionKey: actionKey.trim(), dailyAction: dailyAction.trim(), expenseAction: expenseAction.trim() };
    localStorage.setItem(WEBAPP_COMPAT_KEY, JSON.stringify(cfg));
    if(infoEl) infoEl.textContent = 'âœ“ Uyumluluk kaydedildi. Tekrar deneyebilirsiniz.';
    return cfg;
  }catch(e){
    if(infoEl) infoEl.textContent = 'âš ï¸ Uyumluluk ayarÄ± kaydedilemedi: ' + (e?.message || e);
    return null;
  }
}
// === Hardcoded default CSV URLs (fallbacks if nothing set) ===
const DEFAULT_SHEET_CSV  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=1778107676&single=true&output=csv';
const DEFAULT_INV_CSV    = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=1049936864&single=true&output=csv';
const DEFAULT_ORDERS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=72488526&single=true&output=csv';
const DEFAULT_EXPENSES_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGeA8uJtVjS__AI54-xcHmlteK-lazVNdkv5e20_zyDI3gZTiI2tN1jIEXIG41mZJuxq4YOBfuRN68/pub?gid=798821160&single=true&output=csv';

/* ================== THEME ================== */
const root = document.documentElement;
function setTheme(mode){ if(mode==='dark'){ root.classList.add('dark'); } else { root.classList.remove('dark'); } localStorage.setItem('popdog_theme', mode); }
document.getElementById('themeBtn').onclick = ()=> setTheme(root.classList.contains('dark')?'light':'dark');
(function(){ setTheme(localStorage.getItem('popdog_theme')||'light'); })();

/* ================== HELPERS ================== */
const nfTL  = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 });
const nfUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
const numberTL  = n => nfTL.format(Math.round(n||0));
const numberUSD = n => nfUSD.format(Math.round(n||0));

/* ================== LOANS STATE HELPERS ================== */
// Zee.Dog varsayÄ±lan bekleyen Ã¶demeler (USD)
const DEFAULT_ZEE_AWAIT = [
  { id:'YK#033',   usd:4626.02, status:'waiting' },
  { id:'YK#034',   usd:39425.33, status:'waiting' },
  { id:'YK#034.1', usd:11827.00, status:'waiting' },
  { id:'YK#034.2', usd:27597.00, status:'waiting' },
  { id:'YK#035',   usd:37589.19, status:'waiting' },
  { id:'YK#035.1', usd:11276.76, status:'waiting' },
  { id:'YK#035.2', usd:26312.43, status:'waiting' },
];
(function(){
  if (typeof window.defaultLoansState === 'undefined') {
    window.defaultLoansState = {
            loans: {
        biz:  { total: 24, paid: 0, instTRY: 0,        remainTRY: 0,         principalTRY: 0,         monthlyRate: 0 },
        car:  { total: 24, paid: 0, instTRY: 0,        remainTRY: 0,         principalTRY: 0,         monthlyRate: 0 },
        biz2: { total: 24, paid: 0, instTRY: 71452.86, remainTRY: 1714868.61, principalTRY: 1714868.61, monthlyRate: 0 }
      },
    zeeAwait: DEFAULT_ZEE_AWAIT.slice()
    };
  }
  if (typeof window.getLoansState !== 'function'){
    window.getLoansState = function(){
      try{
        const raw = localStorage.getItem('popdog_loans_state');
        if (!raw) return JSON.parse(JSON.stringify(window.defaultLoansState));
        const obj = JSON.parse(raw);
        const d = JSON.parse(JSON.stringify(window.defaultLoansState));
        const out = Object.assign({}, d, obj || {});
        out.loans = Object.assign({}, d.loans, out.loans || {});
        out.zeeAwait = Array.isArray(out.zeeAwait) && out.zeeAwait.length ? out.zeeAwait : DEFAULT_ZEE_AWAIT.slice();
        out.loans.biz  = Object.assign({}, d.loans.biz,  out.loans.biz  || {});
        out.loans.car  = Object.assign({}, d.loans.car,  out.loans.car  || {});
        out.loans.biz2 = Object.assign({}, d.loans.biz2, out.loans.biz2 || {});
        return out;
      }catch(_){ return JSON.parse(JSON.stringify(window.defaultLoansState)); }
    };
  }
  if (typeof window.setLoansState !== 'function'){
    window.setLoansState = function(st){
      try{ localStorage.setItem('popdog_loans_state', JSON.stringify(st || {})); }catch(_){}
    };
  }
  if (typeof window.bumpLoansPaidIfMatches !== 'function'){
    window.bumpLoansPaidIfMatches = function(subcat, amountTRY){
      try{
        const s = String(subcat || '').toLowerCase();
        if (!s) return;
        const amt = Number(amountTRY || 0);
        const st = getLoansState();
        const isBiz = /ticari|iÅŸletme|taksitli.*ticari/.test(s);
        const isCar = /araÃ§|oto|otomobil|taÅŸÄ±t/.test(s);
        if (isBiz){
          st.loans.biz.paid = Math.max(0, Number(st.loans.biz.paid || 0)) + 1;
          if (amt > 0) st.loans.biz.remainTRY = Math.max(0, Number(st.loans.biz.remainTRY || 0) - amt);
          setLoansState(st);
        } else if (isCar){
          st.loans.car.paid = Math.max(0, Number(st.loans.car.paid || 0)) + 1;
          if (amt > 0) st.loans.car.remainTRY = Math.max(0, Number(st.loans.car.remainTRY || 0) - amt);
          setLoansState(st);
        }
      }catch(_){}
    };
  }
})();

function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function yyyymmddUTC(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

/* TRY sayÄ±larÄ± iÃ§in saÄŸlam parser */
function parseTL(v){
  if(v==null || v==='') return 0;
  if(typeof v === 'number') return v;
  let s = String(v).trim().replace(/\s|â‚º|TRY|TL/gi,'').replace(/\u00A0/g,'');
  if(s === '-' || s === 'â€“' || s === 'â€”') return 0;
  if(/^-?\d+$/.test(s)) return Number(s);
  if(s.includes('.') && s.includes(',')){
    const lastDot = s.lastIndexOf('.'), lastComma = s.lastIndexOf(',');
    if(lastComma > lastDot){ s = s.replace(/\./g,'').replace(',', '.'); } else { s = s.replace(/,/g,''); }
    const n = Number(s); return isNaN(n)?0:n;
  }
  if(s.includes(',') && !s.includes('.')){
    s = s.replace(/\./g,''); s = s.replace(',', '.');
    const n = Number(s); return isNaN(n)?0:n;
  }
  const n = Number(s.replace(/,/g,'')); return isNaN(n)?0:n;
}

function parseTRDateString(s){
  const m = s.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
  if(!m) return '';
  let dd=+m[1], mm=+m[2], yy=+m[3]; if(yy<100) yy += 2000;
  return yyyymmddUTC(yy, mm, dd);
}
function parseUSD(v){
  if(v==null || v==='') return 0;
  if(typeof v === 'number') return v;
  let s = String(v).trim();
  s = s.replace(/USD/gi,'').replace(/\$/g,'').replace(/\s/g,'').replace(/\u00A0/g,'');
  if(s === '-' || s === 'â€“' || s === 'â€”') return 0;
  if(/^-?\d+$/.test(s)) return Number(s);
  if(s.includes('.') && s.includes(',')){
    s = s.replace(/,/g,'');
    const n = Number(s);
    return isNaN(n)?0:n;
  }
  const n = Number(s.replace(/,/g,''));
  return isNaN(n)?0:n;
}
 
function getTryPerUsd(){
  try{
    const s = localStorage.getItem('popdog_fx_try_per_usd');
    const n = s ? Number(s) : 0;
    if (n && !isNaN(n)) return n;

    // if a session-level USD/TRY exists, invert it
    if (typeof fxRateUSDPerTRY === 'number' && fxRateUSDPerTRY > 0){
      return 1 / fxRateUSDPerTRY;
    }
    return 0;
  }catch(e){ return 0; }
}

// === Case-insensitive field getter (first non-empty) ===
function getFieldCI(row, candidates){
  if(!row) return '';
  const keys = Object.keys(row);
  // quick map of lower->actual
  const map = {};
  keys.forEach(k => { map[String(k).toLowerCase()] = k; });
  for (const want of candidates){
    const real = map[String(want).toLowerCase()];
    if (real && row[real] != null && String(row[real]).trim() !== ''){
      return row[real];
    }
  }
  return '';
}

// === Expenses'tan TRY tutarÄ± gÃ¼venli okuma (USD ise kurla Ã§evirir) â€” case-insensitive ===
function readExpenseAmountTRY(row){
  // 1) DoÄŸrudan TRY kolonlarÄ±
  const TRY_KEYS = ['AmountTRY','TRY','Amount (TRY)','Tutar','Amount_Try','TRY Amount'];
  {
    const v = getFieldCI(row, TRY_KEYS);
    if (v !== '') {
      const n = parseTL(v);
      if (n > 0) return n;
    }
  }
  // 2) USD kolonlarÄ±ndan Ã§eviri
  const USD_KEYS = ['AmountUSD','USD','Amount (USD)','USD Amount'];
  {
    const v = getFieldCI(row, USD_KEYS);
    if (v !== ''){
      const usd = parseUSD(v);
      const fx = getTryPerUsd();
      if (usd > 0 && fx > 0) return usd * fx;
    }
  }
  // 3) Tek bir generic "Amount" kolonu varsa dene
  {
    const v = getFieldCI(row, ['Amount']);
    if (v !== ''){
      const s = String(v);
      if (/\$|USD/i.test(s)){
        const usd = parseUSD(s);
        const fx = getTryPerUsd();
        if (usd > 0 && fx > 0) return usd * fx;
      }
      const n = parseTL(s);
      if (n > 0) return n;
    }
  }
  return 0;
}

// === SatÄ±rdan subcategory metnini okuma (case-insensitive) ===
function readExpenseSubcat(row){
  const keys = (typeof SUBCAT_KEYS !== 'undefined' && Array.isArray(SUBCAT_KEYS) && SUBCAT_KEYS.length)
    ? SUBCAT_KEYS
    : ['Subcategory','Sub-Category','Subcat','Alt Kategori','AltKategori','Detail','Kalem'];
  const v = getFieldCI(row, keys);
  return v !== '' ? String(v).trim() : '';
}

/* === Bu AyÄ±n Giderleri: Kategori + Alt Kategori listesi === */
async function renderThisMonthExpenses(){
  try{
    const tbody = document.getElementById('tblExpThisMonth');
    if (!tbody) return;

    // CSV'yi yÃ¼kle
    const rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);

    // Bu ayÄ±n baÅŸlangÄ±Ã§/bitiÅŸi
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth(); // 0-index

    // Bu aya ait satÄ±rlarÄ± filtrele
    const inMonth = (rows||[]).filter(r=>{
      const ds = String(r.Date || r.date || '').slice(0,10);
      const d  = new Date(ds);
      return !isNaN(+d) && d.getFullYear() === y && d.getMonth() === m;
    });

    // === Totals & MoM ===
    const curTotal = inMonth.reduce((acc, r) => acc + readExpenseAmountTRY(r), 0);

    // Previous month (handles year wrap automatically)
    const prevStart = new Date(y, m - 1, 1);
    const prevY = prevStart.getFullYear();
    const prevM = prevStart.getMonth();
    const prevMonthRows = (rows || []).filter(r => {
      const ds = String(r.Date || r.date || '').slice(0,10);
      const d  = new Date(ds);
      return !isNaN(+d) && d.getFullYear() === prevY && d.getMonth() === prevM;
    });
    const prevTotal = prevMonthRows.reduce((acc, r) => acc + readExpenseAmountTRY(r), 0);

    // Write header totals
    const totalEl = document.getElementById('expThisMonthTotal');
    if (totalEl) totalEl.textContent = numberTL(curTotal);

    const momEl = document.getElementById('expThisMonthMoM');
    if (momEl){
      let text = 'MoM: â€“';
      momEl.classList.remove('kpi-up','kpi-down');
      if (prevTotal > 0){
        const pct = ((curTotal - prevTotal) / prevTotal) * 100;
        const sign = pct > 0 ? '+' : '';
        text = `MoM: ${sign}${pct.toFixed(1)}%`;
        momEl.classList.add(pct >= 0 ? 'kpi-up' : 'kpi-down');
      } else if (curTotal > 0){
        text = 'MoM: +âˆ% (ilk ay)';
        momEl.classList.add('kpi-up');
      }
      momEl.textContent = text;
    }

    if (!inMonth.length){
      tbody.innerHTML = '<tr><td class="hint py-2" colspan="5">Bu ay iÃ§in gider bulunamadÄ±.</td></tr>';
      return;
    }

    // SatÄ±rlarÄ± tarihe gÃ¶re artan sÄ±rada gÃ¶ster
    inMonth.sort((a,b)=>{
      const ad = new Date(String(a.Date||a.date||'').slice(0,10));
      const bd = new Date(String(b.Date||b.date||'').slice(0,10));
      return ad - bd;
    });

    // YardÄ±mcÄ±lar
    const fmtTL = (n)=> nfTL.format(Math.round(n||0));
    const getCat = (r)=> getFieldCI(r, ['Category','Kategori','Main Category','Ana Kategori','Cat']) || '';
    // Nihai alt kategori (varsa FinalSubcategory Ã¶ncelikli)
    const getFinalSub = (r)=> getFieldCI(r, ['FinalSubcategory','Final Subcategory','Final','Nihai Alt Kategori']) ||
                              getFieldCI(r, ['Subcategory','Sub-Category','Alt Kategori','AltKategori','Detail','Kalem']) || '';
    // Kaynak (ham) Subcategory
    const getRawSub = (r)=> getFieldCI(r, ['Subcategory','Sub-Category','Alt Kategori','AltKategori','Detail','Kalem']) || '';

    // Render
    const html = inMonth.map(r=>{
      const date = String(r.Date || r.date || '').slice(0,10);
      const cat  = getCat(r);
      const fsub = getFinalSub(r);
      const rsub = getRawSub(r);
      const amt  = readExpenseAmountTRY(r); // TRY tutarÄ± gÃ¼venli okuma
      return `<tr>
        <td class="py-1 pr-3">${date}</td>
        <td class="py-1 pr-3">${cat}</td>
        <td class="py-1 pr-3">${fsub}</td>
        <td class="py-1 pr-3">${rsub}</td>
        <td class="py-1 pr-0 text-right">${fmtTL(amt)}</td>
      </tr>`;
    }).join('');
    tbody.innerHTML = html;
  }catch(e){
    console.warn('renderThisMonthExpenses() error:', e);
    const tbody = document.getElementById('tblExpThisMonth');
    if (tbody) tbody.innerHTML = '<tr><td class="hint py-2" colspan="5">Liste yÃ¼klenemedi.</td></tr>';
  }
}

/* === Bu AyÄ±n Giderleri: Kategori altÄ±nda (FinalSubcategory â€“ Subcategory) kÄ±rÄ±lÄ±mÄ± === */
async function renderThisMonthExpensesByCategory(){
  try{
    const wrap = document.getElementById('expThisMonthByCat');
    if (!wrap) return;

    // CSV'yi yÃ¼kle
    const rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);

    // Bu ayÄ±n baÅŸlangÄ±Ã§/bitiÅŸi
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth(); // 0-index

    // Bu aya ait satÄ±rlarÄ± filtrele
    const inMonth = (rows||[]).filter(r=>{
      const ds = String(r.Date || r.date || '').slice(0,10);
      const d  = new Date(ds);
      return !isNaN(+d) && d.getFullYear() === y && d.getMonth() === m;
    });

    // HiÃ§ veri yoksa
    if (!inMonth.length){
      wrap.innerHTML = '<div class="hint">Bu ay iÃ§in gider bulunamadÄ±.</div>';
      const totEl = document.getElementById('expByCatTotal');
      if (totEl) totEl.textContent = 'â€“';
      return;
    }

    // Kategori -> { sum, items: Map(label -> sum) }
    const totals = new Map();
    let grand = 0;

    inMonth.forEach(r=>{
      const cat = getFieldCI(r, ['Category','Kategori','Main Category','Ana Kategori','Cat']) || 'DiÄŸer';
      const fsubRaw = getFieldCI(r, ['FinalSubcategory','Final Subcategory','Final','Nihai Alt Kategori']) || '';
      const subRaw  = getFieldCI(r, ['Subcategory','Sub-Category','Alt Kategori','AltKategori','Detail','Kalem']) || '';
      const label = (function(){
        if (fsubRaw && subRaw && String(fsubRaw) !== String(subRaw)) return `${fsubRaw} â€“ ${subRaw}`;
        if (fsubRaw) return String(fsubRaw);
        if (subRaw)  return String(subRaw);
        return 'DiÄŸer';
      })();
      const amt = readExpenseAmountTRY(r);
      if (!(amt > 0)) return;
      grand += amt;

      if (!totals.has(cat)) totals.set(cat, { sum:0, items:new Map() });
      const entry = totals.get(cat);
      entry.sum += amt;
      entry.items.set(label, (entry.items.get(label)||0) + amt);
    });

    // Render: Kategorileri toplam tutara gÃ¶re bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±rala
    const cats = Array.from(totals.entries()).sort((a,b)=> b[1].sum - a[1].sum);

    let html = '';
    cats.forEach(([cat, obj])=>{
      const items = Array.from(obj.items.entries()).sort((a,b)=> b[1] - a[1]);
      const listHTML = items.map(([label, val])=> `<li>${label} â€” <strong>${numberTL(val)}</strong></li>`).join('');
      html += `
        <div class="mt-2">
          <div class="font-medium">${cat} â€” Toplam Tutar: ${numberTL(obj.sum)}</div>
          <ul class="ml-4 list-disc">
            ${listHTML}
          </ul>
        </div>
      `;
    });

    const totEl = document.getElementById('expByCatTotal');
    if (totEl) totEl.textContent = numberTL(grand);
    wrap.innerHTML = html || '<div class="hint">Bu ay iÃ§in gider bulunamadÄ±.</div>';
  }catch(e){
    console.warn('renderThisMonthExpensesByCategory() error:', e);
    const wrap = document.getElementById('expThisMonthByCat');
    if (wrap) wrap.innerHTML = '<div class="hint">Liste yÃ¼klenemedi.</div>';
    const totEl = document.getElementById('expByCatTotal');
    if (totEl) totEl.textContent = 'â€“';
  }
}

/* === Expenses CSV'den kredi taksitlerini say ve Loans UI'Ä± gÃ¼ncelle === */
async function refreshLoansFromExpenses(){
  try{
    // CSV'yi oku (mevcut loader'Ä±nÄ± kullanÄ±yoruz)
    const rows = await loadExpensesCsv(DEFAULT_EXPENSES_CSV);

    // Mevcut loans config/state'i al
    const st = (typeof getLoansState === 'function') ? getLoansState() : (window.defaultLoansState || {
      loans:{
        biz:{ total:24, paid:0, instTRY:0, remainTRY:0, principalTRY:0, monthlyRate:0 },
        car:{ total:24, paid:0, instTRY:0, remainTRY:0, principalTRY:0, monthlyRate:0 },
        biz2: { total:24, paid:0, instTRY:71452.86, remainTRY:1714868.61, principalTRY:1714868.61, monthlyRate:0 }
      },
      zeeAwait:[]
    });

    // === Filtre koÅŸullarÄ± (daha sÄ±kÄ± ve AY bazÄ±nda tekil sayÄ±m) ===
    // "Taksitli Ticari Kredi" sayÄ±mÄ±:
    //  - Subcategory = "Kredi" (case-insensitive, tam eÅŸleÅŸme)
    //  - Tutar â‰ˆ 143.155 TL (instTRY varsa ona Â±500 TL tolerans; yoksa hedefe Â±500 TL)
    //  - AynÄ± ay iÃ§inde birden fazla satÄ±r varsa 1 taksit say (month-dedup)
    //
    // "AraÃ§ Kredisi":
    //  - Subcategory "Kredi" ve satÄ±rda araÃ§/taÅŸÄ±t ipucu (subcategory veya final sub)
    //  - Tutar mantÄ±klÄ± bandda; AY bazÄ±nda tekil.
    const NORM = s => String(s||'').toLowerCase().trim();

    const BIZ_TARGET = Number(st?.loans?.biz?.instTRY) > 0 ? Number(st.loans.biz.instTRY) : 143_155;
    const BIZ_EPS    = 500; // Â±500 TL tolerans

    // AraÃ§ ipuÃ§larÄ±
    const CAR_HINT_RE = /(araÃ§|taÅŸÄ±t|oto|otomobil)/i;
    const CAR_TARGET  = Number(st?.loans?.car?.instTRY) > 0 ? Number(st.loans.car.instTRY) : 30_000;
    const CAR_EPS     = 1_500; // Â±1.5K TL varsayÄ±lan tolerans

    // Distinct month sets (YYYY-MM)
    const bizMonths = new Set();
    const carMonths = new Set();

    // YardÄ±mcÄ±: YYYY-MM anahtarÄ±
    const monthKeyFromRow = (r) => {
      try{
        const dstr = String(r.Date || r.date || '').slice(0,10);
        if(!dstr) return '';
        const dt = new Date(dstr);
        if (isNaN(+dt)) return '';
        return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
      }catch(_){ return ''; }
    };

    (rows||[]).forEach(r=>{
      const subRaw = readExpenseSubcat(r);
      const sub = NORM(subRaw);
      if (!sub) return;

      const amt = readExpenseAmountTRY(r);
      if (!(amt > 0)) return;

      const monthK = monthKeyFromRow(r);
      if (!monthK) return;

      // FinalSubcategoryâ€™yi de ipucu olarak okuyalÄ±m
      const finSub = NORM(r.FinalSubcategory || r['Final Subcategory'] || r.Final || '');

      // --- AraÃ§ kredisi ayÄ±klama ---
      const isCarHint = CAR_HINT_RE.test(sub) || CAR_HINT_RE.test(finSub);

      // YalnÄ±zca "Kredi" alt kategorisini say (tam eÅŸleÅŸme)
      const isSubKredi = sub === 'kredi' || finSub === 'kredi';

      // === Ä°ÅŸletme/Ticari kredi ===
      if (isSubKredi && !isCarHint){
        const near = Math.abs(amt - BIZ_TARGET) <= BIZ_EPS;
        if (near) bizMonths.add(monthK);
      }

      // === AraÃ§ kredisi ===
      if (isSubKredi && isCarHint){
        const nearCar = Math.abs(amt - CAR_TARGET) <= CAR_EPS;
        if (nearCar) carMonths.add(monthK);
      }
    });

    // AY bazÄ±nda tekil sayÄ±m
    const bizPaid = bizMonths.size;
    const carPaid = carMonths.size;

    // State'i gÃ¼ncelle
    st.loans = st.loans || {};
    st.loans.biz = Object.assign({ total:24, instTRY:143000, remainTRY:0 }, st.loans.biz||{});
    st.loans.car = Object.assign({ total:24, instTRY:30000,  remainTRY:0 }, st.loans.car||{});
    st.loans.biz2 = Object.assign(
      { total:24, instTRY:71452.86, remainTRY:1714868.61, principalTRY:1714868.61, monthlyRate:0, paid:0 },
      st.loans.biz2 || {}
    );
    st.loans.biz.paid = bizPaid;
    st.loans.car.paid = carPaid;

    // Kalan toplamÄ± kabaca taksit* (kalan adet) olarak gÃ¼ncelle (opsiyonel)
    const bizRemainCnt = Math.max(0, (st.loans.biz.total||0) - bizPaid);
    const carRemainCnt = Math.max(0, (st.loans.car.total||0) - carPaid);
    if (st.loans.biz.instTRY>0) st.loans.biz.remainTRY = bizRemainCnt * Number(st.loans.biz.instTRY||0);
    if (st.loans.car.instTRY>0) st.loans.car.remainTRY = carRemainCnt * Number(st.loans.car.instTRY||0);

    // Kaydet + UI
    if (typeof setLoansState === 'function') setLoansState(st);
    try{
      localStorage.removeItem('popdog_expenses_cache');
    }catch(_){}
    if (typeof renderLoansBlock === 'function') renderLoansBlock();

  }catch(e){
    console.warn('refreshLoansFromExpenses() error:', e);
  }
}

// === Zee.Dog: Expenses'tan paid olanlarÄ± iÅŸaretle + TRY hesapla ===
async function refreshZeeAwaitFromExpenses(){
  try{
    // Åimdilik sade versiyon: sadece state iÃ§indeki listeyi default ile senkronize et
    const base = (window.defaultLoansState || { zeeAwait: [] });
    const st = (typeof getLoansState === 'function') ? getLoansState() : { zeeAwait: [] };

    const haveList = Array.isArray(st.zeeAwait) && st.zeeAwait.length;
    const defList  = Array.isArray(base.zeeAwait) ? base.zeeAwait : (DEFAULT_ZEE_AWAIT || []);

    st.zeeAwait = haveList ? st.zeeAwait : defList.map(it => Object.assign({}, it));

    if (typeof setLoansState === 'function') setLoansState(st);
    if (typeof renderLoansBlock === 'function') renderLoansBlock();
  }catch(e){
    console.warn('refreshZeeAwaitFromExpenses() error:', e);
  }
}